# 03.05 (實作) 建立 LINE Rich Menu (圖文選單) 並透過 n8n 管理

嗨，歡迎來到 n8n 與 WordPress 協作的實作課程！在前幾個章節中，我們已經了解了 n8n 的基本概念與操作。今天，我們將動手做一個非常實用且強大的應用：**透過 n8n 來建立與管理 LINE 官方帳號的 Rich Menu (圖文選單)**。

LINE 圖文選單是用戶與你的品牌互動的第一個接觸點，它極大地影響了使用者體驗。傳統上，我們只能在 LINE Official Account Manager 後台手動設定，但這樣做缺乏彈性。

**為什麼要用 n8n 來管理 Rich Menu？**

*   **動態化與個人化：** 你可以根據用戶的標籤（例如：VIP 客戶、新客戶）或行為（例如：剛完成購買），為他們顯示不同的圖文選單。
*   **自動化排程：** 可以設定在特定時間自動更換圖文選單，例如在母親節檔期自動換上活動選單，活動結束後自動換回來。
*   **版本控制：** 所有的設定都以 n8n workflow 的形式儲存，方便追蹤、複製與修改。
*   **整合 WordPress/WooCommerce：** 可以將選單按鈕的行為與你的電商網站深度整合，例如觸發一個 postback 事件，讓 n8n 查詢該用戶在 WooCommerce 的訂單狀態。

在本堂課中，我們將一步步帶你完成從設計、建立、上傳到啟動一個 Rich Menu 的完整流程。

---

### 課前準備

在開始之前，請確保你已經準備好以下項目：

1.  **一個 LINE Official Account (官方帳號)**：並且你擁有該帳號的管理員權限。
2.  **LINE Messaging API 的 Channel Access Token**：
    *   請登入 [LINE Developers Console](https://developers.line.biz/console/)。
    *   選擇你的 Provider，然後點擊你的 Messaging API Channel。
    *   切換到 `Messaging API` 頁籤。
    *   在頁面最下方，你會找到「**Channel access token**」。請點擊 `Issue` 按鈕產生一組長效型的 token 並將它複製下來。**這個 token 非常重要，請妥善保管**。
    ``
3.  **一個 n8n 執行環境**：可以是 n8n Cloud 或你自行架設的服務。
4.  **一張設計好的圖文選單圖片**：
    *   **尺寸**：2500px × 1686px 或 2500px × 843px。
    *   **格式**：JPG 或 PNG。
    *   **檔案大小**：小於 1MB。
    *   你可以使用 Canva, Figma, Photoshop 等工具來製作。為了方便教學，你可以先下載我們的範例圖片：[範例圖片連結](https://moksaweb.com/wp-content/uploads/2023/10/rich-menu-example.png)

---

### 實作流程總覽

我們的 n8n 工作流程會包含以下幾個關鍵步驟：

1.  **建立 Rich Menu 物件**：告訴 LINE 這個選單的尺寸、名稱、以及最重要的「可點擊區域 (Areas)」與對應的「動作 (Actions)」。成功後會取得一組 `richMenuId`。
2.  **上傳圖片**：將我們設計好的圖片上傳到剛剛建立的 `richMenuId` 上。
3.  **設定為預設選單**：將這個 Rich Menu 設為所有用戶看到的預設選單。

現在，讓我們開始動手吧！

### 步驟 1：規劃 Rich Menu 的點擊區域與 JSON 結構

這是整個流程中最關鍵的一步。我們需要用 JSON 格式來定義選單的結構。一個 Rich Menu 物件主要包含 `size`, `name`, `chatBarText`, 和 `areas`。

`areas` 是一個陣列，裡面定義了每一個可點擊的區塊，每個區塊包含 `bounds` (位置與大小) 和 `action` (點擊後的動作)。

*   `bounds`: 包含 `x`, `y`, `width`, `height`。你可以使用 [LINE Bot Designer](https://developers.line.biz/zh-hant/services/bot-designer/) 來視覺化地規劃座標。
*   `action`: 動作類型，常見的有：
    *   `uri`: 開啟一個網頁。
    *   `message`: 幫用戶送出一段指定的文字。
    *   `postback`: 送出一個隱藏的資料給你的 Webhook，用來觸發後續的 n8n 自動化流程，**這是最高階也最好用的技巧**。

假設我們的選單 (2500x1686px) 被切分為六個等大的區塊，以下是我們的 JSON 範例：

```json
{
  "size": {
    "width": 2500,
    "height": 1686
  },
  "selected": false,
  "name": "Moksa Default Menu",
  "chatBarText": "看看我們有什麼服務",
  "areas": [
    {
      "bounds": { "x": 0, "y": 0, "width": 833, "height": 843 },
      "action": { "type": "uri", "label": "品牌官網", "uri": "https://moksaweb.com" }
    },
    {
      "bounds": { "x": 833, "y": 0, "width": 834, "height": 843 },
      "action": { "type": "uri", "label": "熱銷商品", "uri": "https://your-shop.com/shop/" }
    },
    {
      "bounds": { "x": 1667, "y": 0, "width": 833, "height": 843 },
      "action": { "type": "uri", "label": "最新文章", "uri": "https://your-shop.com/blog/" }
    },
    {
      "bounds": { "x": 0, "y": 843, "width": 833, "height": 843 },
      "action": { "type": "postback", "label": "查詢訂單", "data": "action=query_order" }
    },
    {
      "bounds": { "x": 833, "y": 843, "width": 834, "height": 843 },
      "action": { "type": "message", "label": "聯絡客服", "text": "你好，我需要聯絡客服" }
    },
    {
      "bounds": { "x": 1667, "y": 843, "width": 833, "height": 843 },
      "action": { "type": "uri", "label": "會員中心", "uri": "https://your-shop.com/my-account/" }
    }
  ]
}
```

**Moksa 技巧：** 請務必將這段 JSON 程式碼複製下來，我們稍後會在 n8n 中使用。其中「查詢訂單」的 `postback` action，就是未來串接 WooCommerce 查詢訂單狀態的關鍵起點。

---

### 步驟 2：在 n8n 建立工作流程並設定憑證

1.  登入你的 n8n，建立一個新的工作流程 (Workflow)。
2.  在左側面板點擊 `Credentials`，然後點擊 `Add credential`。
3.  在搜尋框中輸入 `LINE`，選擇 `LINE` 憑證。
``
4.  在 **Credential Name** 欄位，輸入一個好記的名稱，例如 `My LINE OA API`。
5.  在 **Channel Access Token** 欄位，貼上你從 LINE Developers Console 複製的 `Channel Access Token`。
6.  點擊 `Save` 儲存。

### 步驟 3：建立 Rich Menu 物件 (節點 1)

1.  在你的 n8n 工作流程中，新增一個 `HTTP Request` 節點。
2.  設定節點參數如下：
    *   **Authentication**: `Header Auth`
    *   **Name**: `Authorization`
    *   **Value**: `Bearer YOUR_CHANNEL_ACCESS_TOKEN` (請換成你的 token)。
    *   **Method**: `POST`
    *   **URL**: `https://api.line.me/v2/bot/richmenu`
    *   **Body Content Type**: `JSON`
    *   **Body**: 貼上我們在 **步驟 1** 準備好的 JSON 程式碼。
``
3.  點擊 `Execute Node` 來執行這個節點。如果一切順利，你應該會在右邊的 Output 看到 LINE API 回傳的結果，其中包含一組 **`richMenuId`**。這代表 Rich Menu 物件已經成功建立！
``

### 步驟 4：上傳 Rich Menu 圖片 (節點 2)

接下來，我們要將圖片與剛剛建立的 `richMenuId` 綁定。

1.  在剛剛的 `HTTP Request` 節點後方，再新增一個 `HTTP Request` 節點。
2.  設定節點參數如下：
    *   **Authentication**: `Header Auth`
    *   **Name**: `Authorization`
    *   **Value**: `Bearer YOUR_CHANNEL_ACCESS_TOKEN` (再次貼上你的 token)。
    *   **Method**: `POST`
    *   **URL**: 這裡我們要動態地從上一個節點取得 `richMenuId`。點擊右邊的 `f(x)` 圖示，設定表達式 (Expression) 如下：
        `https://api-data.line.me/v2/bot/richmenu/{{$node["HTTP Request"].json["richMenuId"]}}/content`
    *   **Send Body**: `true`
    *   **Body Content Type**: `File`
    *   **Input Data Field Name**: `file` (這是 n8n 預設值，不用改)
    *   **File Path**: 輸入你的圖文選單圖片在電腦上的**絕對路徑** (如果你的 n8n 是本機執行)，或是使用 `Read Binary File` 節點來讀取檔案。
    *   **Moksa 技巧：** 最簡單的方式是先用 `HTTP Request` 節點去下載公開網路上的圖片，再將其串接給這個節點。
    *   **Request Headers**: 新增一個 Header
        *   **Name**: `Content-Type`
        *   **Value**: `image/png` (如果你的圖片是 JPG，請改為 `image/jpeg`)
``
3.  執行這個節點。如果成功，Output 會是空的 `{}`，這代表圖片已成功上傳。

### 步驟 5：將 Rich Menu 設為預設 (節點 3)

最後一步，就是讓所有用戶都能看到這個新的圖文選單。

1.  在第二個 `HTTP Request` 節點後方，新增第三個 `HTTP Request` 節點。
2.  設定節點參數如下：
    *   **Authentication**: `Header Auth`
    *   **Name**: `Authorization`
    *   **Value**: `Bearer YOUR_CHANNEL_ACCESS_TOKEN` (最後一次貼上你的 token)。
    *   **Method**: `POST`
    *   **URL**: 同樣使用表達式，從**第一個節點**取得 `richMenuId`：
        `https://api.line.me/v2/bot/user/all/richmenu/{{$node["HTTP Request"].json["richMenuId"]}}`
    *   **Send Body**: `false` (這個請求不需要 Body)。
``
3.  執行這個節點。如果成功，Output 也會是空的 `{}`。

---

### 驗收成果

恭喜你！你已經成功透過 n8n 部署了你的 LINE 圖文選單。

現在，打開你的手機 LINE App，進入你的官方帳號聊天室。你可能需要**關閉再重新進入**聊天室，才會看到更新後的圖文選單。點擊上面的按鈕，測試看看每個動作是否都如預期般運作。

``

### 總結與展望

今天，我們完成了一個非常實用的自動化流程，學會了如何透過 n8n 和 LINE Messaging API 來完全控制圖文選單。這不僅僅是「建立」而已，整個工作流程本身就是一個可以重複使用的「部署腳本」。

在未來的課程中，你可以基於今天的成果，發揮更多想像：

*   **動態選單切換**：建立一個 Webhook 節點，接收來自 WooCommerce 的訂單完成事件，然後執行 n8n 流程，使用 `https://api.line.me/v2/bot/user/{userId}/richmenu/{richMenuId}` 這個 API，**只為該位客戶**換上專屬的「售後服務」圖文選單。
*   **A/B 測試**：建立兩個不同的 Rich Menu，並將用戶分流，為他們設定不同的選單，以測試哪種版位的點擊成效更好。

n8n 的強大之處在於它能將各種服務的 API 像積木一樣組合起來。希望這堂課能為你開啟自動化行銷的大門！我們下堂課見！