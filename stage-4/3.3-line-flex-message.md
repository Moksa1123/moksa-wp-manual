# 03.03 (實作) LINE Flex Message 深度實戰 (含 LINE Flex Message Simulator)

嗨，歡迎來到 n8n 與 WordPress 協作的深度實戰課程！在上個章節，我們已經學會如何透過 n8n 發送基本的 LINE Notify 或 Messaging API 文字訊息。然而，LINE 的強大之處遠不止於此。今天，我們要來學習如何使用 **LINE Flex Message**，製作出視覺豐富、排版靈活、具備互動按鈕的卡片式訊息。

這項技術將會徹底改變你的 LINE 自動化通知，無論是 WooCommerce 的訂單確認、會員升級通知，還是課程學習進度提醒，都能變得更加專業且吸睛。而我們將會使用 LINE 官方提供的神器——**Flex Message Simulator**——來大幅降低開發的難度。

準備好了嗎？讓我們開始打造令人驚豔的 LINE 訊息吧！

---

### 什麼是 LINE Flex Message？

**LINE Flex Message**，官方中文稱作**「可撓性訊息」**，是一種基於 CSS Flexible Box (Flexbox) 模型設計的訊息格式。簡單來說，它讓你不再受限於固定的文字或圖片訊息樣式，而是可以像堆疊積木一樣，自由組合、排列各種元件，創造出類似 App 或網頁卡片的複雜版面。

它的主要構成元素包含：

*   **容器 (Container):** 整個 Flex Message 的最外層，最常見的是 **Bubble (氣泡)** 和 **Carousel (輪播)** 兩種。Carousel 容器可以讓你橫向滑動多個 Bubble。
*   **區塊 (Block):** 構成 Bubble 的主要部分，包含 **Header (頂部)**, **Hero (主視覺區)**, **Body (內容區)**, **Footer (底部區)**。你可以自由選擇需要哪些區塊。
*   **元件 (Component):** 每個區塊中可以放置的具體內容，例如 **Text (文字)**, **Image (圖片)**, **Button (按鈕)**, **Icon (圖示)**, **Separator (分隔線)** 等。

這些元素的組合提供了極高的設計彈性，但同時也意味著手動撰寫它的 JSON 結構非常複雜且容易出錯。這就是為什麼我們需要接下來要介紹的核心工具。

### 核心工具：LINE Flex Message Simulator

為了幫助開發者輕鬆設計 Flex Message，LINE 官方提供了一個非常強大的網頁工具：**LINE Flex Message Simulator**。

*   **官方網址：** [https://developers.line.biz/flex-simulator/](https://developers.line.biz/flex-simulator/)

這個工具是一個**「所見即所得」的視覺化編輯器**。你可以在左側的面板上透過點擊和設定來排版你的訊息，右側會即時預覽在手機上的樣子，最重要的是，它會**即時產生對應的 JSON 程式碼**！

這意味著，我們完全不需要手動去寫複雜的 JSON，只需要在 Simulator 上設計好我們想要的樣子，然後把產生出來的 JSON 複製到 n8n 的節點中即可。

``
*這張截圖應顯示 LINE Flex Message Simulator 的主介面，標示出左側的元件區、中間的預覽區、以及右側的 JSON 程式碼區。*

---

### 實戰目標：設計一個 WooCommerce 新訂單通知

為了讓大家更有感覺，我們的實戰目標是設計一個比上一章節更專業的「WooCommerce 新訂單通知」。這個通知將會包含：

1.  商店 Logo 與標題。
2.  訂單成立的關鍵資訊 (訂單編號、訂單金額)。
3.  一個可以點擊後台訂單連結的按鈕。

我們將一步步在 Simulator 中完成設計，然後將其整合到 n8n 工作流中。

### 步驟化教學

#### 步驟 1：開啟並熟悉 Flex Message Simulator

首先，請在瀏覽器中開啟 [Flex Message Simulator](https://developers.line.biz/flex-simulator/)。

花幾分鐘熟悉一下它的介面：

*   **左上角 (Showcase):** 提供大量預設好的範本，是我們學習和修改的絕佳起點。
*   **左下角 (Tree view):** 以樹狀結構顯示目前訊息的所有元件，方便你選取和調整。
*   **中間 (Viewport):** 即時預覽你的 Flex Message 在手機上的樣子。
*   **右側 (Property pane & Code pane):**
    *   **Property:** 當你選取一個元件時，這裡會顯示該元件的所有可設定屬性 (如：文字內容、顏色、大小、間距等)。
    *   **Code:** 顯示整個 Flex Message 的完整 JSON 結構。

#### 步驟 2：選擇一個範本開始

對於初學者，**Moksa 技巧**是**永遠不要從零開始**。點擊左上角的「Showcase」，你會看到許多設計精美的範本。

為了我們的訂單通知，我們可以選擇一個結構類似的範本，例如「Receipt」(收據)。點擊它，你會看到中間的預覽和右邊的 JSON Code 都會立刻更新。

``
*這張截圖應顯示點擊 "Showcase" 後，選擇 "Receipt" 範本的畫面。*

#### 步驟 3：客製化你的訊息內容 (視覺化編輯)

現在，我們要基於這個「Receipt」範本進行修改。

1.  **修改標題：**
    *   在中間的預覽區，點擊 "RECEIPT" 這段文字。
    *   右邊的 **Property** 面板會自動跳到這個 Text 元件的設定。
    *   在 **text** 欄位中，將內容修改為「**MoksaWeb 新訂單通知**」。
    *   你可以順便調整 **size** (大小)、**weight** (粗細) 和 **color** (顏色)。

2.  **修改內容區：**
    *   範本中的 body 區域有很多項目，我們先簡化它。
    *   在左下角的 **Tree view** 中，找到 `body` > `contents` 下的多個 `box` 元件。你可以點擊不需要的項目旁邊的垃圾桶圖示將其刪除。
    *   我們保留兩個 `box` 即可，一個用來放「訂單編號」，一個用來放「訂單總額」。
    *   點擊第一個 `box` 裡的文字，在 **Property** 面板修改 **text** 為「訂單編號 #ORDER_NUMBER_PLACEHOLDER」。**這裡的佔位符很重要，稍後會在 n8n 中替換。**
    *   用同樣的方式，修改第二個 `box` 的文字為「訂單總額 $ORDER_TOTAL_PLACEHOLDER」。

3.  **修改按鈕：**
    *   捲動到訊息底部，點擊 "View Details" 按鈕。
    *   在 **Property** 面板中：
        *   找到 **action** 屬性，點擊它來編輯按鈕行為。
        *   將 **Type** 設定為 `uri` (代表點擊後會開啟一個網址)。
        *   在 **Label** 欄位輸入「**查看訂單詳情**」。
        *   在 **URI** 欄位輸入「ORDER_URL_PLACEHOLDER」。這也是一個佔位符。

經過以上修改，我們已經有了一個客製化的訂單通知範本。

``
*這張截圖應顯示經過客製化修改後的 Flex Message 預覽畫面。*

#### 步驟 4：取得 Flex Message 的 JSON 程式碼

設計完成後，最關鍵的一步來了。

1.  切換到右側面板的 **「Code」** 頁籤。
2.  你會看到完整的 JSON 程式碼。
3.  點擊右上角的 **「Copy」** 按鈕，將整段 JSON 複製到你的剪貼簿。

``
*這張截圖應高亮顯示 "Code" 頁籤以及 "Copy" 按鈕。*

#### 步驟 5：在 n8n 中設定 HTTP Request 節點

回到你的 n8n 工作流。我們假設你已經有一個接收 WooCommerce Webhook 的觸發節點。現在，我們要設定發送 Flex Message 的 **HTTP Request** 節點。

1.  新增一個 **HTTP Request** 節點。
2.  **Authentication:** 選擇 `Header Auth`。
3.  **Name:** 輸入 `Authorization`。
4.  **Value:** 輸入 `Bearer YOUR_CHANNEL_ACCESS_TOKEN` (請換成你自己的 LINE Channel Access Token)。
5.  **Request Method:** 選擇 `POST`。
6.  **URL:** 輸入 `https://api.line.me/v2/bot/message/push`。
7.  **Body Content Type:** 選擇 `JSON`。
8.  **Body:** 點擊 `Add Property`，欄位名稱輸入 `to`，Value 則填入你要接收通知的 LINE User ID (例如，從前一個節點傳入的 `{{ $('Webhook').item.json.body.customer_id }}`，或者先用你自己的 ID 測試)。

``
*這張截圖應顯示 n8n 中 HTTP Request 節點的基本設定畫面。*

#### 步驟 6：將 JSON 貼入 Body 並使其「動態化」

這是整合的最後一步，也是最需要細心的一步。

1.  在 **Body** 區塊，再次點擊 `Add Property`，欄位名稱輸入 `messages`。
2.  將 `messages` 的類型從 `String` 切換為 `Array`。
3.  現在，`messages` 下方會出現一個 `Property 0`。點擊 `Add Expression`。
4.  在打開的 **Expression Editor** 中，貼上你從 Flex Message Simulator 複製的**整段 JSON 程式碼**。

**至關重要的一步：動態化！**

我們需要將 JSON 中的佔位符，替換成 n8n 的表達式，來從觸發節點獲取真實的訂單資料。

*   找到 `"text": "訂單編號 #ORDER_NUMBER_PLACEHOLDER"`，將其修改為：
    ```json
    "text": "訂單編號 #{{ $('Webhook').item.json.body.number }}"
    ```
*   找到 `"text": "訂單總額 $ORDER_TOTAL_PLACEHOLDER"`，將其修改為：
    ```json
    "text": "訂單總額 ${{ $('Webhook').item.json.body.total }}"
    ```
*   找到 `"uri": "ORDER_URL_PLACEHOLDER"`，將其修改為：
    ```json
    "uri": "{{ $('Webhook').item.json.body._links.self[0].href.replace('/wp-json/wc/v3/', '/wp-admin/post.php?action=edit&post=') }}"
    ```
    *   **Moksa 技巧：** 上面這個 URI 的表達式是一個進階用法，它將 WooCommerce API 回傳的訂單網址，巧妙地轉換成管理者可以直接在後台編輯的網址，非常實用！

**最後，別忘了 `altText`！**

在 JSON 的最外層，有一個 `"altText"` 屬性。這是當用戶的 LINE 版本不支援 Flex Message，或是在手機推播通知中顯示的替代文字。**請務必設定一個有意義的 `altText`**，例如：

```json
"altText": "您有一筆來自 MoksaWeb 的新訂單！編號 #{{ $('Webhook').item.json.body.number }}"
```

完成後的 Expression 看起來會像這樣：

```json
{
  "type": "flex",
  "altText": "您有一筆來自 MoksaWeb 的新訂單！編號 #{{ $('Webhook').item.json.body.number }}",
  "contents": {
    "type": "bubble",
    "body": {
      // ... (中間省略)
      "contents": [
        {
          "type": "text",
          "text": "MoksaWeb 新訂單通知",
          // ...
        },
        {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "訂單編號 #{{ $('Webhook').item.json.body.number }}"
            },
            {
              "type": "text",
              "text": "訂單總額 ${{ $('Webhook').item.json.body.total }}"
            }
          ]
        }
      ]
    },
    "footer": {
      // ...
      "contents": [
        {
          "type": "button",
          "action": {
            "type": "uri",
            "label": "查看訂單詳情",
            "uri": "{{ $('Webhook').item.json.body._links.self[0].href.replace('/wp-json/wc/v3/', '/wp-admin/post.php?action=edit&post=') }}"
          }
        }
      ]
    }
  }
}
```

#### 步驟 7：執行與測試

所有設定都完成了！現在，你可以手動執行這個節點（或觸發一次 WooCommerce 的新訂單 Webhook），然後檢查你的手機。

如果一切順利，你將會收到一張設計精美、資訊清晰、且按鈕可以點擊的 LINE Flex Message 通知！

---

### 總結與 Moksa 技巧

恭喜你！你已經掌握了 n8n 結合 LINE Flex Message 的核心技術。這是一個非常強大的組合，能讓你的自動化流程在使用者體驗上提升好幾個檔次。

**重點回顧：**

1.  **Flex Message** 提供高度客製化的訊息排版能力。
2.  **Flex Message Simulator** 是我們設計訊息、產生 JSON 的必要神器。
3.  **核心流程：** 在 Simulator 設計 -> 複製 JSON -> 貼到 n8n -> 用表達式替換佔位符，使其動態化。

**Moksa 技巧補充：**

*   **先設計，後整合：** 養成習慣，先在 Simulator 中專心把視覺和版面設計好，確認無誤後再進行 n8n 的整合工作，這樣效率最高。
*   **`altText` 是你的好朋友：** 絕對不要忽略 `altText`，它決定了用戶在通知欄第一眼看到的內容，是吸引他們點開的關鍵。
*   **善用官方範例與文件：** LINE Developer 的文件和 Simulator 中的 Showcase 範本是你最好的靈感來源，多看多模仿，你很快就能設計出更複雜的版面，例如包含商品圖片的輪播訊息。
*   **JSON 結構檢查：** 如果訊息發送失敗，90% 的問題都出在 JSON 格式錯誤。仔細檢查你的大括號 `{}`、中括號 `[]`、引號 `""` 和逗號 `,` 是否都正確無誤。