# 05.01 n8n 進階技巧：模組化工作流 (Execute Workflow)

嗨，歡迎來到 n8n 與 WordPress 協作的進階課程！我是你在 Moksa 的導師。

在前面的章節中，我們學會了如何建立單一的工作流來處理特定的自動化任務。然而，當你的自動化系統越來越複雜時，你會發現某些工作流變得非常龐大、難以維護，而且很多功能區塊 (例如：發送 LINE 通知、更新 Google Sheet) 會在不同的工作流中重複出現。

這堂課，我們要來學習一個 n8n 的核心進階技巧：「**模組化工作流 (Modular Workflow)**」。透過 `Execute Workflow` 這個節點，我們可以將一個龐大的工作流拆分成數個小而美的「**子工作流**」，就像堆疊樂高積木一樣，讓你的自動化流程更清晰、更易於管理，也更容易重複使用。

---

### 學習目標

*   理解「模組化工作流」的核心概念與優勢。
*   學會建立一個可被重複呼叫的「子工作流」(Sub-workflow)。
*   學會使用 `Execute Workflow` 節點在「主工作流」中呼叫子工作流並傳遞資料。
*   掌握一個實際的 WooCommerce 案例：將「發送 LINE 通知」的功能模組化。

### 為什麼要模組化？

在我們開始實作之前，讓我們先建立一個重要的觀念，這也是軟體開發中的黃金準則：**DRY (Don't Repeat Yourself)**，不要重複做一樣的事情。

模組化的好處有：

1.  **可重複使用 (Reusability):** 你可以建立一個「通用 LINE 通知模組」，然後在「新訂單通知」、「出貨通知」、「棄單召回」等多個不同的工作流中重複呼叫它，而不需要每次都重新設定 LINE Notify 節點。
2.  **易於維護 (Maintainability):** 想像一下，如果未來你的 LINE Notify 權杖（Token）需要更換，你只需要修改那一個「通用 LINE 通知模組」即可。如果你有 10 個工作流都內建了 LINE 通知功能，你就必須手動修改 10 次，非常耗時且容易出錯。
3.  **清晰簡潔 (Clarity):** 主工作流的邏輯會變得非常清晰。它看起來會像「收到新訂單 -> **執行 LINE 通知模組** -> 更新 Google Sheet」，而不是一個充滿各種細節設定、雜亂無章的龐大流程。

### 應用情境

我們將以一個非常實用的電商情境來當作範例：

*   **主工作流 (Main Workflow):** 當 WooCommerce 網站有一筆新訂單成立時，自動觸發。
*   **子工作流 (Sub-workflow):** 一個專門負責「發送 LINE Notify 通知」的模組。
*   **目標:** 主工作流在收到新訂單後，將訂單資訊（如訂單編號、金額）傳遞給子工作流，由子工作流來完成發送 LINE 通知的任務。

---

## 第一部分：建立可重複使用的「子工作流」(Sub-workflow)

我們的第一步是建立那個「小而美」的、專門負責發送 LINE 通知的模組。

### 步驟 1：建立新工作流並設定觸發方式

這個子工作流需要一個「入口」來接收來自其他工作流的資料。最適合的觸發器就是 `Webhook`。

1.  在 n8n 儀表板，點擊「Add workflow」建立一個新的空白工作流。
2.  將這個工作流命名為「**[Module] Generic LINE Notify Sender**」。**Moksa 技巧：** 在模組化的工作流名稱前加上 `[Module]` 或 `[Sub]` 的前綴，可以幫助你在管理大量工作流時快速識別它們的用途。
3.  點擊 `+` 按鈕，新增一個 `Webhook` 節點。
4.  `Webhook` 節點不需要做任何特別的設定，它預設就會等待 `POST` 請求。
5.  在 `Webhook` 節點的右側，你會看到 `Test URL` 和 `Production URL`。**請注意：我們之後要用的是 `Production URL`**。我們先把它放在這裡，等等會用到。

`[截圖：顯示一個新的工作流，只有一個 Webhook 節點，並標示出 Production URL 的位置]`

### 步驟 2：加入 LINE Notify 節點

1.  在 `Webhook` 節點後方，點擊 `+` 新增一個 `LINE Notify` 節點。
2.  在 `Credential for LINE Notify API` 欄位，選擇你已經設定好的 LINE Notify 憑證。
3.  在 **`Message`** 欄位，我們要接收從主工作流傳來的訊息。這裡我們需要用「表達式 (Expression)」來動態獲取資料。點擊欄位旁的齒輪圖示，選擇「Add Expression」。
4.  輸入以下表達式：`{{ $json.body.message }}`
    *   這段語法的意思是：從 `Webhook` 節點收到的 `JSON` 資料中，找到 `body` 物件底下的 `message` 屬性。我們約定好，所有呼叫這個模組的工作流，都必須把想發送的訊息放在名為 `message` 的欄位裡。

`[截圖：LINE Notify 節點的設定畫面，特別是 Message 欄位中填寫表達式的樣子]`

### 步驟 3：儲存並啟用子工作流

**這是最重要的一步！** 子工作流如果沒有被「啟用 (Activate)」，主工作流就無法呼叫它。

1.  點擊右上角的「**Save**」按鈕儲存你的設定。
2.  將右上角的開關從「**Inactive**」切換到「**Active**」。
3.  再次回到 `Webhook` 節點，點擊複製圖示，將「**Production URL**」複製到你的剪貼簿。這個 URL 就是我們子工作流的「API 端點」，主工作流將透過這個網址來呼叫它。

`[截圖：顯示工作流右上角的 Active 開關，以及再次提醒複製 Production URL]`

到這裡，我們的通用 LINE 通知模組就完成了！它現在是一個啟用狀態，並且靜靜地等待著被呼叫。

---

## 第二部分：在「主工作流」中呼叫子工作流

現在，讓我們來建立處理新訂單的主工作流。

### 步驟 1：建立新工作流並設定 WooCommerce 觸發

1.  回到 n8n 儀表板，再次點擊「Add workflow」建立一個新的工作流。
2.  將這個工作流命名為「**WooCommerce New Order Notification**」。
3.  點擊 `+` 按鈕，新增 `WooCommerce Trigger` 節點。
4.  在 `Credentials for WooCommerce API` 選擇你的網站憑證。
5.  在 `Event` 欄位，選擇「**Order Created**」。
6.  點擊「**Fetch test event**」來獲取一筆範例訂單資料，以方便我們後續的設定。

`[截圖：WooCommerce Trigger 節點的設定畫面，Event 選擇 Order Created]`

### 步驟 2：準備要傳遞的資料 (使用 Set 節點)

雖然我們可以把資料處理直接寫在 `Execute Workflow` 節點裡，但一個好的習慣是使用 `Set` 節點來專門整理我們要傳遞出去的資料，這會讓流程更清晰。

1.  在 `WooCommerce Trigger` 節點後方，點擊 `+` 新增一個 `Set` 節點。
2.  在 `Set` 節點的設定中：
    *   將 `Keep Only Set` 維持關閉 (unchecked)。
    *   在 `Add Value` 下方，選擇 `String`。
    *   在 **`Name`** 欄位，輸入我們與子工作流約定好的名稱：`message`。
    *   在 **`Value`** 欄位，我們要用表達式組合出通知訊息。點擊「Add Expression」，輸入：
        ```
        新訂單通知！
        訂單編號：#{{ $json.id }}
        訂單狀態：{{ $json.status }}
        總金額：{{ $json.total }}
        ```
        **Moksa 技巧：** 你可以從左側的 `INPUT` 窗格中，直接點擊 `WooCommerce Trigger` 節點輸出的資料欄位，n8n 會自動幫你產生對應的表達式，非常方便！

`[截圖：Set 節點的設定畫面，顯示 Name 為 message，Value 為組合後的訊息表達式]`

### 步驟 3：使用 Execute Workflow 節點呼叫子工作流

重頭戲來了！

1.  在 `Set` 節點後方，點擊 `+` 新增 `Execute Workflow` 節點。
2.  在節點的設定中：
    *   **`Source`**: 選擇 `URL`。
    *   **`Workflow URL`**: **貼上**我們在第一部分複製的那個子工作流的「**Production URL**」。
    *   **`Source Data`**: 這裡的預設選項是 `From JSON`，它會把目前節點 (`Set`) 的輸出結果當作呼叫子工作流時的 `body` 內容。這正是我們想要的，因為 `Set` 節點的輸出就包含了我們精心準備的 `message` 欄位。

`[截圖：Execute Workflow 節點的設定畫面，標示出 URL 和 Source Data 的設定]`

### 步驟 4：測試與啟用主工作流

1.  現在，點擊右下角的「**Test step**」來執行整個主工作流。
2.  你會看到流程依序執行：
    *   `WooCommerce Trigger` 抓到測試訂單。
    *   `Set` 節點產生了包含 `message` 的 JSON 資料。
    *   `Execute Workflow` 節點將這些資料發送到子工作流的 URL。
3.  如果一切順利，你的手機 LINE 就會立刻收到一條格式化好的新訂單通知！
4.  測試成功後，記得儲存並「**Active**」這個主工作流。

`[截圖：顯示成功收到的 LINE Notify 訊息畫面]`

現在，只要你的 WooCommerce 網站有任何新訂單，這個自動化流程就會被觸發，呼叫我們的通用模組來發送通知。

---

### Moksa 技巧與最佳實踐

*   **錯誤處理:** `Execute Workflow` 節點有一個「Continue On Fail」的選項。如果呼叫子工作流失敗（例如子工作流被停用或網址錯誤），主工作流是否要繼續執行下去？你可以根據業務需求來決定。
*   **回傳資料:** 子工作流也可以將處理結果回傳給主工作流。你只需要在子工作流的最後加上一個 `Respond to Webhook` 節點，就可以將資料傳回。這在需要子工作流執行計算或查詢後返回結果的情境中非常有用。
*   **版本控制:** 當你的模組需要更新時，可以先複製一個版本進行修改與測試，確認無誤後再替換掉舊的 Production URL，確保線上服務不中斷。
*   **更多模組化點子:**
    *   建立一個「更新 Google Sheet」的通用模組。
    *   建立一個「在 FluentCRM 中新增 Tag」的模組。
    *   建立一個「查詢客戶 LINE UID」的模組。

### 總結

恭喜你！你已經掌握了 n8n 中非常強大且核心的 `Execute Workflow` 技巧。透過將重複的功能模組化，你不僅大大提升了開發效率，也讓你的自動化系統變得更加健壯、更易於管理。

從現在開始，當你設計新的工作流時，請時常思考：「這個功能未來會不會在其他地方也用到？我是否應該將它抽出來做成一個獨立的模組？」養成這個習慣，將讓你在自動化的道路上走得更遠、更穩。

下一堂課，我們將探索更多 n8n 的進階節點與應用，我們課堂上見！