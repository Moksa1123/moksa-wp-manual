# 05.03 n8n 錯誤處理 (Error Workflow) 與日誌監控

你好，我是 Moksa 的首席課程導師。

在我們之前的課程中，你已經學會如何建立各種自動化工作流，串接 WordPress 與其他服務。但當你的自動化流程越來越複雜、越來越重要時，一個關鍵問題隨之而來：「如果工作流在半夜執行失敗了，我該如何知道？」

所謂「魔鬼藏在細節裡」，一個穩定可靠的自動化系統，其價值不僅在於它「成功」時能做什麼，更在於它「失敗」時，我們是否有能力**即時發現、快速診斷、並有效解決**。如果一個訂單處理流程無聲無息地失敗了，可能會導致客戶沒有收到商品、發票開立錯誤，甚至商譽受損。

這堂課，我們將深入探討 n8n 中至關重要的**錯誤處理 (Error Handling)** 機制。我們將學習如何建立一個專門的「錯誤處理工作流 (Error Workflow)」，並設定日誌監控，確保你的自動化帝國穩定運行，讓你高枕無憂。

---

### n8n 內建的錯誤處理選項

在我們建立一個完整的 Error Workflow 之前，讓我們先了解每個 n8n 節點內建的基礎錯誤處理設定。

當你點擊任何一個節點時，切換到「Settings」分頁，你會看到兩個與錯誤處理相關的選項。

``

*   **Continue on Fail (發生錯誤時繼續):**
    *   **作用：** 當這個選項被勾選時，如果該節點執行失敗，整個工作流**不會**立刻停止，而是會繼續往下一個節點執行。失敗的節點會輸出一個空的 `item`。
    *   **使用時機：** 適用於那些「非關鍵性」的步驟。例如，你想更新 Google Sheets 的某個儲存格，但同時也想發送一封 Email。即使更新 Google Sheets 失敗了，你仍然希望 Email 能夠成功寄出。在這種情況下，你就可以在 Google Sheets 節點上勾選此選項。

*   **Retry on Fail (發生錯誤時重試):**
    *   **作用：** 當節點執行失敗時，n8n 會自動嘗試重新執行該節點數次。你可以設定重試的次數 (Retries) 和每次重試的間隔時間 (Retry Interval)。
    *   **使用時機：** 非常適合處理「暫時性」的錯誤。例如，某個服務的 API 伺服器剛好在忙碌中，導致連線超時。過幾秒鐘再試一次可能就成功了。像是呼叫外部 API、讀取資料庫等操作，都很適合開啟這個選項。

> **Moksa 技巧：**
> 這兩個內建選項是你的第一道防線，但它們無法主動通知你「發生了錯誤」。對於所有關鍵性的商業流程 (例如：訂單處理、會員註冊、金流確認)，我們強烈建議使用接下來要介紹的 **Error Workflow** 模式，進行更積極的監控與處理。

---

### (實作) 建立你的專屬錯誤監控中心：Error Workflow

Error Workflow 是一個**獨立且專門用來處理「其他工作流錯誤」的工作流**。它的概念是，當任何一個主要工作流 (Main Workflow) 執行失敗時，n8n 會自動將錯誤的詳細資訊，發送給這個指定的 Error Workflow 來處理。

這樣做的好處是：
1.  **集中管理：** 你只需要維護一個錯誤處理流程，而不是在每個工作流中都重複建立錯誤通知的邏輯。
2.  **標準化通知：** 無論是哪個工作流出錯，你收到的通知格式都是一致的，方便快速判斷。
3.  **保持主要流程簡潔：** 讓主要工作流專注於核心業務邏輯，錯誤處理的邏輯則分離出去。

現在，讓我們來實際打造一個。

#### 步驟 1：建立新的工作流並設定觸發器

1.  在 n8n 儀表板，點擊「Add workflow」建立一個全新的工作流。
2.  將這個工作流命名為一個容易辨識的名稱，例如「**Moksa - Global Error Handler**」。
3.  刪除預設的「Start」節點。
4.  點擊 `+` 按鈕，搜尋並加入「**Error Trigger**」節點。

``

這個「**Error Trigger**」節點是 Error Workflow 的心臟。它不需要任何設定，它的作用就是被動地等待其他工作流的錯誤訊號。

#### 步驟 2：解析錯誤資訊並格式化訊息

當一個錯誤發生時，Error Trigger 會收到包含大量有用資訊的 JSON 資料。我們需要將這些資訊整理成人類易於閱讀的格式。

1.  在「Error Trigger」節點後方，加入一個「**Set**」節點。
2.  在「Set」節點中，我們設定一個新的欄位，名為 `friendlyMessage`。
3.  點擊 `friendlyMessage` 欄位右側的「Add Expression」，貼上以下表達式：

```
發生錯誤！請立即處理！

工作流名稱 (Workflow): {{ $json.workflow.name }}
工作流 ID (ID): {{ $json.workflow.id }}
執行 ID (Execution): {{ $json.execution.id }}
錯誤節點 (Node): {{ $json.error.node.name }} ({{ $json.error.node.type }})
錯誤訊息 (Message):
{{ $json.error.message }}

---
錯誤堆疊 (Stack):
{{ $json.error.stack }}
```

``

這個表達式會從傳入的錯誤資料中，提取出最重要的資訊，並組合成一段清晰的文字訊息。

> **Moksa 技巧：**
> 錯誤資料中，`execution.id` 非常重要。你可以直接在 n8n 的「Executions」頁面搜尋這個 ID，就能立刻找到那次失敗的執行紀錄，查看每一步的詳細輸入與輸出，大幅加速除錯過程。

#### 步驟 3：發送即時錯誤通知 (整合 LINE Notify)

光有訊息還不夠，我們需要讓這個訊息在錯誤發生的第一時間就通知到我們。Email 可能會被忽略，但 LINE 的通知通常更即時。

1.  在「Set」節點後方，加入「**LINE Notify**」節點。
2.  **Credential for LINE API:** 選擇你預先設定好的 LINE Notify 憑證。
3.  **Resource:** 選擇 `Message`。
4.  **Message:** 點擊右側的齒輪圖示，選擇「Add Expression」，然後選擇 `friendlyMessage` 這個我們剛剛在 Set 節點建立的欄位。`{{ $json.friendlyMessage }}`
5.  執行一次測試，你的 LINE 應該會收到一條格式化好的測試訊息。

``

#### 步驟 4：(進階) 將錯誤記錄到 Google Sheets

除了即時通知，將每次的錯誤記錄下來，有助於我們分析錯誤發生的頻率與模式。Google Sheets 是一個很方便的日誌工具。

1.  在你的 Google Drive 建立一個新的 Google Sheet，命名為「n8n 錯誤日誌 (Error Log)」。
2.  建立以下欄位：`Timestamp`, `WorkflowName`, `WorkflowID`, `NodeName`, `ErrorMessage`, `ExecutionURL`。
3.  回到 n8n，在「Set」節點後方 (可以跟 LINE Notify 並行)，加入「**Google Sheets**」節點。
4.  **Credential for Google Sheets API:** 選擇你的 Google 帳號憑證。
5.  **Operation:** 選擇 `Append or Update`。
6.  **Sheet ID:** 貼上你的 Google Sheet ID。
7.  **Range:** 填寫工作表名稱，例如 `Sheet1`。
8.  **Columns to send:** 點擊「Add Column」並將對應的欄位用表達式填入：
    *   `Timestamp`: `{{ $now.toFormat("yyyy-MM-dd HH:mm:ss") }}`
    *   `WorkflowName`: `{{ $json.workflow.name }}`
    *   `WorkflowID`: `{{ $json.workflow.id }}`
    *   `NodeName`: `{{ $json.error.node.name }}`
    *   `ErrorMessage`: `{{ $json.error.message }}`
    *   `ExecutionURL`: `{{ $json.execution.url }}`
9.  完成設定。

``

#### 步驟 5：啟用 Error Workflow

最後，也是最重要的一步：點擊畫面右上角的「**Active**」開關，將這個 Error Workflow **啟用**。一個沒有被啟用的工作流是無法被觸發的。

---

### 如何將 Error Workflow 應用到你的主要工作流？

我們已經建立好了錯誤監控中心，現在需要告訴其他主要的工作流：「如果出錯了，就去找這個監控中心回報！」

設定非常簡單：

1.  回到你任何一個**主要的工作流** (例如：WooCommerce 新訂單處理流程)。
2.  點擊畫面上方中間的「**Settings**」齒輪圖示，打開工作流設定面板。
3.  在設定面板中，找到「**Error Workflow**」這個下拉選單。
4.  從選單中，選擇我們剛剛建立的「**Moksa - Global Error Handler**」。
5.  關閉設定面板，並**儲存**你的主要工作流。

``

完成了！就是這麼簡單。現在，只要這個主要工作流在執行過程中發生任何**未被處理**的錯誤 (也就是沒有勾選 Continue on Fail 的節點出錯)，n8n 就會自動觸發你的 Error Workflow，接著你就會在 LINE 上收到即時通知，同時錯誤紀錄也會被寫入 Google Sheets。

### 總結與提醒

在這堂課，你學會了建構一個專業級的 n8n 自動化監控系統。

*   我們了解了節點內建的 `Continue on Fail` 和 `Retry on Fail` 的使用時機。
*   我們親手打造了一個集中式的 **Error Workflow**，使用 **Error Trigger** 來接收錯誤訊號。
*   我們學會了如何格式化錯誤訊息，並透過 **LINE Notify** 實現即時警報。
*   我們還進一步將錯誤資訊記錄到 **Google Sheets**，作為長期的分析日誌。
*   最後，我們學會了如何在主要工作流的設定中，指定這個 Error Workflow。

> **Moksa 終極技巧：主動測試你的錯誤流程！**
> 永遠不要假設你的錯誤處理流程會正常運作。你可以故意在一個測試用的工作流中，設定一個一定會失敗的節點 (例如：一個 HTTP Request 節點去請求一個不存在的網址)，然後將它的 Error Workflow 指向你的監控中心。手動執行這個測試工作流，看看你是否能準確地收到 LINE 通知和看到 Google Sheets 的新紀錄。**相信測試，而不是相信運氣**，這是專業自動化玩家的座右銘。

請務必為你所有上線服務中的、重要的工作流，都設定好 Error Workflow。這將是你維護系統穩定性的最強後盾。