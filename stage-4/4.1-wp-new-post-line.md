# 04.01 (實作) WordPress 新文章發布，自動推播 LINE Flex Message 風格的豐富訊息

嗨，歡迎來到 n8n 與 WordPress 協作的自動化世界！我是 Moksa 的首席課程導師。

今天這堂課，我們要來實作一個非常實用且酷炫的自動化流程：當你在 WordPress 網站上發布一篇新文章時，n8n 會自動擷取文章資訊，並發送一則帶有圖片和連結、類似 **Flex Message 風格的豐富訊息**到你指定的 LINE Notify 群組中。

這不僅能讓你的團隊第一時間掌握網站內容更新，也能作為一個簡易的內容推播頻道，通知你的忠實讀者。

---

### 學習目標

*   了解如何透過 Webhook 觸發 n8n 工作流程。
*   學會串接 WordPress 與 n8n，讓兩者能夠溝通。
*   學會使用 LINE Notify API 發送客製化訊息。
*   掌握如何組合動態資料（文章標題、網址、特色圖片）來建立豐富的通知訊息。

### 前置準備

在開始之前，請確保你已經準備好以下項目：

1.  一個可以正常運作的 WordPress 網站（具備管理員權限）。
2.  一個可以正常運作的 n8n 服務（無論是 n8n.cloud 或自行架設的版本）。
3.  一個 LINE 帳號，並建立一個或選擇一個你想要接收通知的群組。

### 什麼是 LINE Notify？

在我們開始之前，有一個重要的觀念需要釐清。我們這次使用的是 **LINE Notify** 服務，它是一個**專門用來「接收通知」**的官方服務，設定簡單、免費。

它與我們常聽到的 **LINE Messaging API (LINE 官方帳號)** 不同。Messaging API 功能更強大，可以建立聊天機器人、使用真正的 Flex Message JSON，但設定也相對複雜。

**Moksa 技巧：** 對於「系統到人」的單向通知情境，例如：新文章通知、新訂單通知、主機異常警告等，**LINE Notify 是最輕量、最快速、最穩定的選擇**。我們將利用它的參數，組合出一個視覺上媲美 Flex Message 的豐富通知。

---

## 實作流程

整個自動化流程可以拆解為三個主要部分：

1.  **LINE 端**：取得 LINE Notify 的權杖 (Token)。
2.  **n8n 端**：建立工作流程，設定 Webhook 接收資料，並設定 HTTP Request 節點發送給 LINE。
3.  **WordPress 端**：安裝外掛或使用程式碼，在「發布文章」時，將文章資料送到 n8n 的 Webhook。

讓我們一步一步來完成它吧！

### 步驟 1：取得 LINE Notify 權杖 (Token)

這個權杖就像是 n8n 要傳送訊息給你的專屬鑰匙。

1.  前往 [LINE Notify 官方網站](https://notify-bot.line.me/zh_TW/) 並登入你的 LINE 帳號。
2.  登入後，點選右上角的帳號名稱，選擇「**個人頁面**」。
``
3.  在個人頁面中，向下捲動到「發行存取權杖」區塊，點擊「**發行權杖**」。
4.  接著會彈出設定視窗：
    *   **權杖名稱**：輸入一個你好辨識的名稱，例如：「WordPress 新文章通知」。這個名稱會顯示在 LINE 通知訊息的開頭。
    *   **選擇您要接收通知的聊天室**：在這裡，你可以選擇「透過1對1聊天接收LINE Notify的通知」（也就是只傳給你自己），或是選擇一個你已經加入的群組。**Moksa 技巧：** 建議為這類通知建立一個專門的 LINE 群組，例如「官網小編同步群」，並將 LINE Notify 官方帳號邀請至該群組後，再進行設定。
``
5.  選擇完畢後，點擊「**發行**」。
6.  畫面會顯示一組獨一無二的權杖。**請立刻複製這組權杖並妥善保存！** 因為這個視窗關閉後，你**再也無法看到完整的權杖**。如果不小心弄丟了，只能重新發行一個。

``

太棒了！我們已經拿到通往 LINE 的鑰匙了。

### 步驟 2：在 n8n 建立工作流程

現在，我們要來打造自動化的核心。

1.  登入你的 n8n，並建立一個新的工作流程 (Workflow)。
2.  點擊 `+` 按鈕，新增第一個節點，搜尋並選擇「**Webhook**」。
3.  Webhook 節點會自動產生一組 **Test URL**。這就是 WordPress 要送資料的目的地。點擊旁邊的複製按鈕，將這組 URL 複製下來。
``
4.  **非常重要**：點擊右下角的「**Listen for Test Event**」按鈕。n8n 現在會進入等待模式，等著接收來自 WordPress 的第一筆測試資料，以便它能了解資料的結構。

``

現在，讓 n8n 保持在這個等待畫面，我們接著去設定 WordPress。

### 步驟 3：設定 WordPress 發送 Webhook

我們要讓 WordPress 在「發布新文章」這個事件發生時，自動把文章的標題、網址、特色圖片等資料，透過剛剛複製的 Webhook URL 送給 n8n。

這裡我們提供兩種方法，你可以根據自己的熟悉程度選擇。

#### 方法 A：使用外掛 (推薦初學者)

最簡單的方式是安裝一個專門處理 Webhook 的外掛。市面上有許多選擇，例如 `WP Webhooks` 或 `Simple WordPress Webhooks`。

1.  在 WordPress 後台，前往「外掛」>「安裝外掛」，搜尋 "Webhook"。
2.  安裝並啟用一個看起來評價不錯且近期有更新的外掛 (例如：WP Webhooks)。
3.  進入該外掛的設定頁面，找到類似「Send Data」或「Triggers」的選項。
4.  設定觸發條件 (Trigger) 為「**Post Published**」或「**文章已發布**」。
5.  在「**Webhook URL**」欄位，貼上我們剛剛從 n8n 複製的 **Test URL**。
6.  儲存設定。

#### 方法 B：使用 Code Snippet (Moksa 技巧，適合進階者)

如果你不喜歡安裝額外外掛，可以將一小段 PHP 程式碼加入你的網站。這能讓網站更輕量。

1.  我們推薦使用 `Code Snippets` 這支外掛來管理程式碼，而不是直接修改 `functions.php`，這樣更安全。
2.  在 WordPress 後台，前往「程式碼片段」>「新增」。
3.  為這個片段命名，例如：「n8n - 新文章發布通知」。
4.  將以下程式碼貼入程式碼區塊：

```php
function moksa_send_post_to_n8n_on_publish( $ID, $post ) {
    // 確保這是一個新發布的文章，而不是更新舊文章
    // 如果你也想在「更新」文章時觸發，可以移除這個 if 判斷
    if ( $post->post_date !== $post->post_modified ) {
        return;
    }

    // 這裡換成你從 n8n 複製的 Webhook Test URL
    $webhook_url = '在這裡貼上你的N8N_WEBHOOK_TEST_URL';

    // 取得文章資料
    $featured_image_url = get_the_post_thumbnail_url($ID, 'full');
    $excerpt = get_the_excerpt($ID);

    $body = [
        'post_id'      => $ID,
        'post_title'   => $post->post_title,
        'post_url'     => get_permalink( $ID ),
        'post_excerpt' => $excerpt ? $excerpt : '（沒有摘要）',
        'featured_image' => $featured_image_url ? $featured_image_url : '', // 如果沒有特色圖片，就送空字串
    ];

    $args = [
        'body'        => json_encode($body),
        'headers'     => [
            'Content-Type' => 'application/json',
        ],
        'timeout'     => 60,
        'redirection' => 5,
        'blocking'    => true, // 設為 false 可以在背景發送，不影響使用者操作體驗
        'httpversion' => '1.0',
        'sslverify'   => false,
        'data_format' => 'body',
    ];

    wp_remote_post( $webhook_url, $args );
}
// 當文章從任何狀態轉變為 'publish' 時觸發
add_action( 'transition_post_status', function( $new_status, $old_status, $post ) {
    if ( 'publish' === $new_status && 'publish' !== $old_status ) {
        moksa_send_post_to_n8n_on_publish( $post->ID, $post );
    }
}, 10, 3 );
```

5.  **務必**將程式碼中的 `'在這裡貼上你的N8N_WEBHOOK_TEST_URL'` 換成你自己的 Webhook Test URL。
6.  選擇「只在網站前台運行」，然後儲存並啟用這個程式碼片段。

#### 發送測試資料

無論你選擇方法 A 或 B，下一步都是發送測試資料。

1.  在 WordPress 新增一篇測試文章。
2.  **務必**為這篇文章設定「**標題**」、「**內容**」，以及最重要的「**特色圖片**」。
3.  點擊「**發布**」。

發布成功後，切換回 n8n 的視窗。你會看到 Webhook 節點顯示「Workflow tested successfully!」，並且已經成功接收到來自 WordPress 的資料結構！

``

### 步驟 4：設定 n8n 發送 LINE 通知

我們已經成功接收到資料了，現在要把這些資料整理一下，送給 LINE。

1.  在 n8n 中，點擊 Webhook 節點右邊的 `+`，新增一個節點。
2.  搜尋並選擇「**HTTP Request**」。
3.  設定 HTTP Request 節點的參數：
    *   **Authentication**: 選擇 `Header Auth`。
    *   **Name**: 輸入 `Authorization`。
    *   **Value**: 輸入 `Bearer ` (注意 Bearer 後面有一個空格)，然後貼上你在**步驟 1** 取得的 **LINE Notify 權杖**。看起來會像這樣：`Bearer your_line_notify_token_here`。
    *   **Request Method**: 選擇 `POST`。
    *   **URL**: 輸入 `https://notify-api.line.me/api/notify`。
    *   **Send Body**: 保持 `true`。
    *   **Body Content Type**: 選擇 `application/x-www-form-urlencoded`。
4.  接下來是設定 **Body Parameters**，這是最有趣的部份！我們要組合出通知訊息。
    *   點擊「Add Parameter」。
    *   第一筆參數：
        *   **Name**: 輸入 `message`。
        *   **Value**: 這裡是我們要組合的文字訊息。點擊 Value 欄位右邊的「Expressions」按鈕，打開表達式編輯器。我們要從前面 Webhook 收到的資料中，把文章標題和網址組合進來。
        *   貼上以下內容：

        ```
        新文章發布！

        📝 標題：{{ $json.body.post_title }}

        👇 點擊閱讀：
        {{ $json.body.post_url }}
        ```
        **Moksa 技巧：** `{{ ... }}` 是 n8n 的表達式語法，`$json.body.post_title` 代表從收到的 JSON 資料中，取得 body 物件底下的 post_title 欄位。你可以從左邊的 `INPUT` 預覽中，拖拉欄位來自動產生表達式。

    *   再次點擊「Add Parameter」，新增第二筆。
        *   **Name**: 輸入 `imageThumbnail`。
        *   **Value**: 在表達式編輯器中，從 Webhook 節點的資料中找到並拖入代表**特色圖片網址**的欄位。如果使用我們提供的程式碼，它會是 `{{ $json.body.featured_image }}`。
    *   再次點擊「Add Parameter」，新增第三筆。
        *   **Name**: 輸入 `imageFullsize`。
        *   **Value**: 這裡也填入跟 `imageThumbnail` 一樣的特色圖片網址 `{{ $json.body.featured_image }}`。

5.  全部設定好後，你的 HTTP Request 節點看起來應該會像這樣：
``

### 步驟 5：最終測試與啟用

一切就緒，讓我們來做最後的測試！

1.  點擊 HTTP Request 節點下方的「**Execute Node**」。
2.  n8n 會用上一次從 Webhook 收到的測試資料，真實地向 LINE Notify API 發送一次請求。
3.  立刻檢查你的手機！你的 LINE 應該會收到一則帶有圖片、標題和連結的漂亮通知！
``
4.  如果測試成功，回到 n8n 的 Webhook 節點，將 URL 從 **Test URL** 切換為 **Production URL**。
``
5.  **務必**將 WordPress 裡的 Webhook URL 也更新為這組 **Production URL**。
6.  最後，點擊 n8n 工作流程右上角的開關，將它從 **Inactive** 切換為 **Active**，並**儲存**你的工作流程。

**恭喜你！** 你的 WordPress 與 LINE 自動化通知流程已經正式上線了！從現在開始，每當你發布一篇新文章，你的 LINE 群組就會即時收到通知。

### 總結與延伸應用

今天我們完成了一個非常實用的自動化流程，這只是 n8n 強大功能的冰山一角。你可以基於這個流程做更多延伸：

*   **加入條件判斷**：使用 `IF` 節點，判斷文章的「分類」，只有特定分類的文章才發送通知。
*   **分眾推播**：根據不同的文章分類，發送到不同的 LINE Notify 群組。
*   **結合 WooCommerce**：觸發條件改成「新訂單成立」，將訂單資訊即時通知給出貨團隊。
*   **錯誤處理**：設定 Error Trigger，當工作流程失敗時，發送通知給網站管理員。

希望這堂課對你有幫助，動手試試看，你會愛上自動化為你省下的時間與精力！