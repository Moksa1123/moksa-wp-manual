# 03.06 (實務) LINE Webhooks：接收使用者訊息與事件 (打造互動式 LINE Bot)

嗨，歡迎來到 n8n 與 WordPress 協作的實務課程！

在前面的章節中，我們學會了如何從 n8n「主動」發送訊息到 LINE。然而，一個真正強大的聊天機器人 (Bot) 不僅僅是單向推播，更重要的是能夠「接收」並「回應」使用者的訊息。這就是 **Webhook** 的威力所在。

本章節，我們將一步步帶你完成最重要的設定：**串接 LINE Webhook 與 n8n**。完成後，你的 n8n 工作流將能夠即時接收到使用者傳送給 LINE 官方帳號的任何訊息或事件（例如：加入好友、封鎖），為打造全自動的互動式客服、行銷機器人奠定最穩固的基礎。

---

### 學習目標

*   理解 Webhook 的基本運作原理。
*   在 n8n 中建立一個 Webhook 節點並取得專屬網址。
*   在 LINE Developers Console 中設定 Webhook URL。
*   成功測試並接收來自 LINE 的使用者訊息資料 (JSON 格式)。
*   建立一個簡單的「鸚鵡機器人 (Echo Bot)」來驗證雙向通訊。

### 前置準備

在開始之前，請確保你已經準備好：

1.  一個可以正常運作的 n8n 環境 (Cloud 或 Self-hosted)。
2.  一個 LINE Developers 帳號，並已建立一個 Messaging API Channel。
3.  已在 n8n 中設定好 LINE 的憑證 (Credentials)。
4.  你的手機已安裝 LINE App，並將你的 LINE Bot 加入好友，方便測試。

---

### 步驟 1：在 n8n 建立 Webhook 觸發節點

Webhook 就像是 n8n 給外部服務（例如 LINE）的一個專屬門鈴。當有事件發生時，LINE 就會來按這個門鈴，並把相關的資料遞送進來。我們的第一步，就是先在 n8n 裡把這個門鈴安裝好。

1.  登入你的 n8n，建立一個新的工作流程 (Workflow)。
2.  點擊 `+` 按鈕，搜尋並加入第一個節點：「**Webhook**」。
    ``
3.  點開 Webhook 節點的設定，你會看到幾個重要的欄位：
    *   **HTTP Method:** 維持預設的 `POST` 即可。LINE 的 Webhook 使用 POST 方法傳送資料。
    *   **Webhook URLs:** 這裡有兩個網址，`Test` 和 `Production`。
        *   **Test URL:** 用於開發與測試階段。你必須手動點擊「Listen for Test Event」才會接收一次性的資料。
        *   **Production URL:** 當你的工作流「啟用 (Active)」後，這個網址會 7x24 小時持續接收資料。

4.  **Moksa 技巧：** 在開發階段，我們**永遠**使用 **Test URL**。這能確保我們能專注在當前的測試，避免混亂。請點擊 `Test URL` 旁邊的複製按鈕，將這段網址複製起來。

    ``

---

### 步驟 2：設定 LINE Developers Console

現在我們有了 n8n 的門鈴網址，接下來要去 LINE 的後台，告訴 LINE「以後有訊息，就往這個網址送」。

1.  前往 [LINE Developers Console](https://developers.line.biz/console/)。
2.  選擇你正在使用的 Provider，然後點擊你的 Messaging API Channel。
3.  切換到「**Messaging API**」這個頁籤。
4.  往下找到「**Webhook settings**」區塊。
5.  點擊「**Webhook URL**」旁邊的「Edit」按鈕，將剛剛從 n8n 複製的 **Test URL** 貼上。
    ``
6.  貼上後，點擊「Update」儲存。
7.  最關鍵的一步：找到下方的「**Use webhook**」，點擊「Edit」並選擇「**Enabled (啟用)**」。
    ``

> **重要觀念：** 如果沒有啟用「Use webhook」，即使你填寫了正確的網址，LINE 依然不會發送任何資料給 n8n。

---

### 步驟 3：調整 LINE Official Account Manager 回應模式

當我們啟用 Webhook 後，等於是告訴 LINE：「現在開始，所有訊息的回應都由我的程式 (n8n) 全權接管」。為了避免 LINE 內建的自動回應功能與我們的 n8n 機器人打架，我們必須進行以下設定。

1.  在 LINE Developers Console 的「Messaging API」頁籤最上方，可以找到前往 LINE Official Account Manager 的連結，點擊進入。
2.  在左側選單中，找到「**聊天室相關**」 > 「**回應設定**」。
3.  在右側的詳細設定中，進行以下調整：
    *   **回應模式:** **必須**設定為「**聊天機器人**」。
    *   **自動回應訊息:** 設定為「**停用**」。
    *   **歡迎訊息:** 建議也設定為「**停用**」。因為之後我們可以用 n8n 打造更個人化的歡迎訊息。
    ``

完成這個設定後，LINE 官方帳號的控制權就完全交給 n8n 了。

---

### 步驟 4：接收第一則來自 LINE 的訊息

萬事俱備，只欠東風！讓我們來實際測試一下串接是否成功。

1.  回到 n8n 的工作流程，點擊 Webhook 節點右下角的「**Listen for Test Event**」按鈕。n8n 會開始轉圈圈，顯示「Waiting for webhook call...」。
    ``
2.  打開你的手機 LINE App，找到你的 LINE Bot，隨意發送一則訊息，例如：「`哈囉，n8n！`」。
3.  立刻切換回 n8n 的畫面。如果一切順利，你會看到 Webhook 節點出現一個綠色的勾勾，並且右側的 `JSON` 欄位會顯示出來自 LINE 的完整資料！

    ``

這代表你的 n8n 已經成功接收到使用者訊息了！恭喜你，完成了最關鍵的一步！

---

### 步驟 5：解讀 LINE Webhook 的資料結構 (JSON)

讓我們花點時間看看 n8n 收到的這包資料是什麼。這對於後續開發至關重要。

```json
{
  "destination": "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "events": [
    {
      "type": "message",
      "message": {
        "type": "text",
        "id": "12345678901234567",
        "text": "哈囉，n8n！"
      },
      "webhookEventId": "01H2J3K4L5M6N7P8Q9R0S1T2V3",
      "deliveryContext": {
        "isRedelivery": false
      },
      "timestamp": 1681977600000,
      "source": {
        "type": "user",
        "userId": "Uyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy"
      },
      "replyToken": "nHuyWiB7yP5Zw52FIkcQobQuGDXCTA",
      "mode": "active"
    }
  ]
}
```

這是一包 JSON 格式的資料，我們需要關注以下幾個**核心欄位**：

*   `events`: 一個陣列 (Array)。LINE 會把多個事件包在裡面一次送出，但通常情況下裡面只會有一個事件物件。所以我們在 n8n 中通常會用 `events[0]` 來取得第一個事件。
*   `events[0].type`: **事件類型**。最重要的欄位之一。`message` 代表是使用者傳送訊息，其他常見的還有 `follow` (加入好友)、`unfollow` (封鎖/刪除好友)、`postback` (點擊按鈕) 等。
*   `events[0].message.text`: 當事件類型是 `message` 且訊息類型是 `text` 時，這個欄位會包含**使用者傳送的文字內容**。
*   `events[0].source.userId`: **使用者的唯一 ID**。這非常重要，你可以用這個 ID 來識別是哪位使用者，並將其與你的 WordPress/WooCommerce 會員資料庫關聯。
*   `events[0].replyToken`: **回覆權杖**。這是 LINE 給你的一次性「回覆許可證」。**你必須使用這個 Token 才能回覆該則訊息**，而且它有時效性（通常是 30 秒），用過一次就會失效。

---

### 步驟 6：(實作) 打造一個「鸚鵡機器人」 (Echo Bot)

理論不如實作。讓我們利用剛剛學到的知識，建立一個簡單的「鸚鵡機器人」，功能是：使用者說什麼，它就回覆什麼。

1.  在剛剛的 Webhook 節點後面，新增一個「**LINE**」節點。
2.  設定 LINE 節點：
    *   **Credentials:** 選擇你設定好的 LINE 憑證。
    *   **Resource:** 選擇 `Message`。
    *   **Operation:** 選擇 `Reply`。
    *   **Reply Token:** 這是必填欄位。點擊右邊的「Add Expression」，我們要從 Webhook 節點的資料中把它抓出來。輸入：`{{ $json.events[0].replyToken }}`
    *   **Messages:** 點擊「Add Message」，選擇 `Text` 類型。
    *   **Text:** 同樣點擊「Add Expression」，我們要抓取使用者傳送的文字。輸入：`{{ $json.events[0].message.text }}`

    你的 LINE 節點設定看起來應該像這樣：
    ``

3.  **再次測試！**
    *   點擊 Webhook 節點的「Listen for Test Event」。
    *   用手機傳送一則新訊息給你的 LINE Bot，例如：「`Moksa 的課程太棒了！`」。
    *   回到 n8n，你會看到 Webhook 收到資料，並且 LINE 節點也成功執行。
    *   最重要的是，檢查你的手機，你會驚喜地發現，你的 LINE Bot 已經原封不動地回覆了你一句：「`Moksa 的課程太棒了！`」。

### 總結

太棒了！你已經成功掌握了 n8n 接收 LINE 訊息的核心技術。Webhook 是所有自動化互動的起點，今天的「鸚鵡機器人」雖然簡單，但它驗證了整個資訊流的暢通：

**使用者發訊 → LINE → n8n Webhook (接收) → n8n LINE 節點 (處理與回覆) → LINE → 回傳給使用者**

有了這個基礎，下一章節我們就能開始打造更複雜、更聰明的邏輯，例如：關鍵字自動回覆、串接 WordPress 資料庫查詢訂單、觸發 FluentCRM 自動化流程等等。請務必親手完成本章節的練習，我們下堂課見！