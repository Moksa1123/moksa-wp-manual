# 01.04 (實務) n8n 核心節點操作 (Set, Merge, IF, Code) 與資料結構處理

哈囉，歡迎來到 n8n 與 WordPress 協作的實務課程！我是你在 Moksa 的課程導師。

在前面的章節中，我們已經成功安裝了 n8n，並對其基本介面有了初步的認識。從這堂課開始，我們將深入 n8n 的心臟地帶，學習四個最核心、也最常用的節點：`Set`, `Merge`, `IF`, 和 `Code`。

掌握這四個節點，就像是學會了 automations (自動化) 世界裡的「聽、說、讀、寫」。無論你的自動化流程多麽複雜，都離不開它們的身影。它們是處理、轉換、過濾和創造資料的基石。

在這堂課中，我們將會以一個非常經典的 WooCommerce 情境作為範例：「**當網站接到一筆新訂單時，自動判斷訂單金額，並將整理過的資料寫入 Google Sheets**」。透過這個實例，你將會深刻理解每個節點的用途與威力。

---

### 課前準備：理解 n8n 的資料結構 - JSON

在開始操作節點之前，我們必須先理解 n8n 是如何「看待」資料的。n8n 中流動的所有資料，基本上都是 **JSON (JavaScript Object Notation)** 格式。

別被這個名詞嚇到了，你可以把它想像成一個「清單」，清單裡有很多個「項目 (Item)」，每個項目又有很多「欄位 (Key)」和「值 (Value)」。

一個典型的 WooCommerce 新訂單資料，在 n8n 裡看起來會像這樣：

```json
[
  {
    "order_id": 12345,
    "customer_name": "王小明",
    "total": "2500.00",
    "payment_method": "ecpay_credit_card",
    "line_items": [
      {
        "product_id": 101,
        "name": "Moksa 紀念 T-shirt",
        "quantity": 2
      }
    ]
  }
]
```

*   最外層的 `[ ]` 代表這是一個**清單 (Array)**。
*   中間的 `{ }` 代表一個**項目 (Item)**，這裡只有一個項目，就是這筆訂單。
*   `"order_id": 12345` 就是一個**欄位 (Key)** 與 **值 (Value)** 的組合。

我們的目標，就是用接下來的四個核心節點，來隨心所欲地操作這些項目與欄位。

---

### 1. Set 節點：新增、修改或保留資料

`Set` 節點是資料處理的第一步，也是最單純的。它的主要功能就是：**在項目中新增一個新欄位，或修改一個已有的欄位值**。

**使用情境：**
*   從訂單總額中，計算出 5% 的行銷費用。
*   為訂單加上一個固定的「處理中」狀態標籤。
*   將複雜的日期格式，轉換成 `YYYY-MM-DD` 的簡單格式。

#### 操作步驟

假設我們的 WooCommerce Trigger 節點已經傳來了訂單資料，我們想新增一個 `commission` (佣金) 欄位，值是訂單總額的 10%。

**步驟 1：新增 Set 節點**
在你的工作流中，點擊 `+` 按鈕，搜尋並選擇 `Set` 節點。

``

**步驟 2：設定欄位**
*   **Name:** 輸入你想新增的欄位名稱。這裡我們輸入 `commission`。
*   **Value:** 輸入這個欄位的值。我們可以使用「運算式 (Expressions)」來動態抓取前面節點的資料。點擊 Value 欄位右邊的 `f(x)` 圖示。

``

**步驟 3：撰寫運算式**
在運算式編輯器中，n8n 會很聰明地提示你前面節點有哪些資料可以用。

1.  從左側的 `Input Data > JSON` 中，找到代表訂單總額的 `total` 欄位並點擊它。
2.  你會看到編輯器中出現了類似 `{{ $json["total"] }}` 的語法。
3.  在這後面，直接輸入數學運算式 `* 0.1`。
4.  完整的運算式會是：`{{ $json["total"] * 0.1 }}`。

``

**步驟 4：執行與驗證**
執行這個節點，你會在右邊的輸出 (Output) 中看到，除了原本的訂單資料外，還多了一個 `commission` 欄位，而且值已經被正確計算出來了。

**Moksa 技巧：** `Set` 節點下方有一個 **Keep Only Set** 的選項。勾選它之後，n8n 會丟棄所有原始資料，**只保留**你在這個 Set 節點中設定的欄位。這在只需要傳遞少量、乾淨資料到下個節點時非常好用！

---

### 2. IF 節點：建立邏輯判斷與分流

`IF` 節點是自動化流程的「岔路口」。它允許你設定一個或多個條件，根據條件是否成立，讓資料走向不同的路徑 (True / False)。

**使用情境：**
*   **如果**訂單金額大於 $2,000 元，就發送 LINE 通知給老闆 (True 路徑)。
*   **如果**訂單的付款方式是「銀行轉帳」，就寄送匯款提醒信 (True 路徑)，否則就直接歸檔 (False 路徑)。
*   **如果**顧客的 Email 包含 `@gmail.com`，就加上特定標籤。

#### 操作步驟

延續上面的範例，我們來建立一個判斷：**如果訂單總額 (total) 大於 2000 元，就走 True 路徑**。

**步驟 1：新增 IF 節點**
在 Set 節點後面，新增一個 `IF` 節點。你會看到它有兩個輸出點：`true` 和 `false`。

**步驟 2：設定判斷條件**
*   **Value 1:** 點擊 `f(x)` 圖示，用運算式選擇我們要判斷的欄位，也就是訂單總額：`{{ $json["total"] }}`。
*   **Operation:** 選擇判斷的類型。這裡我們要判斷「大於」，所以選擇 `Number` -> `Larger Than`。
*   **Value 2:** 輸入我們要比較的值，這裡直接輸入 `2000`。

``

**步驟 3：執行與驗證**
執行整個流程。
*   如果你的測試訂單金額是 $2500，你會看到資料從 `true` 的出口流出。
*   如果測試訂單金額是 $1500，資料就會從 `false` 的出口流出。

現在，你就可以在 `true` 和 `false` 的路徑後面，分別接上不同的節點，例如在 `true` 路徑接上一個 `OrderChatz` 節點來發送 LINE 通知，在 `false` 路徑則什麼都不做。

---

### 3. Merge 節點：合併不同來源的資料

`Merge` 節點就像一個「資訊匯集中心」。當你的工作流有兩個或以上的資料來源，而你想把它們的資訊合併在一起時，就需要用到它。

**使用情境：**
*   **情境一 (最常用)：** 一筆新訂單進來 (資料來源 1)，我們用顧客的 Email 去 FluentCRM 或 Google Sheets 查詢他的會員等級 (資料來源 2)，然後把「會員等級」這個資訊**合併**回訂單資料中。
*   **情境二：** 每天早上 9 點，從 WooCommerce 撈取昨日訂單 (資料來源 1)，同時從 Google Analytics 撈取昨日流量 (資料來源 2)，將兩份報表合併成一份，發送到 Slack。

#### 操作步驟

我們來模擬上述的**情境一**。假設在 IF 節點的 `true` 路徑後，我們去一個 Google Sheets 找到了這位大戶顧客的會員等級是 "VIP"。

**步驟 1：新增 Merge 節點**
將 IF 節點的 `true` 輸出，以及另一個模擬「查詢顧客資料」的節點 (這裡我們先用一個 Set 節點代替)，都連接到一個新的 `Merge` 節點上。

``

**步驟 2：設定合併模式 (Mode)**
Merge 節點最重要的設定就是 `Mode`。
*   **Append:** 這是預設模式。它會把兩個來源的資料清單簡單地接在一起。例如來源 1 有 1 個項目，來源 2 有 1 個項目，結果就會變成 2 個項目。
*   **Merge By Index:** 它會把兩個來源中「位置相同」的項目合併。來源 1 的第 1 個項目，跟來源 2 的第 1 個項目合併。
*   **Merge By Key:** **這是最常用也最強大的模式**。它會根據你指定的「共同欄位」(例如 `email` 或 `order_id`)，去進行智慧配對和合併。

**步驟 3：使用 Merge By Key**
1.  將 **Mode** 設定為 `Merge By Key`。
2.  **Key - Input 1:** 輸入來源 1 用來配對的欄位，例如 `customer_email`。
3.  **Key - Input 2:** 輸入來源 2 用來配對的欄位，也應該是 `customer_email`。
4.  **Keep Mismatches:** 決定如果找不到配對時該怎麼辦。通常會保留來源 1 的資料。

``

**步驟 4：執行與驗證**
執行後，你會在輸出中看到，原本的訂單資料，現在多了一個從來源 2 合併過來的 `membership_level: "VIP"` 欄位。這筆資料變得更完整、更有價值了！

---

### 4. Code 節點：終極的資料處理武器

當 `Set`, `IF`, `Merge` 都無法滿足你刁鑽的需求時，就是 `Code` 節點 (舊版稱 Function 節點) 上場的時候了。它允許你用 **JavaScript** 程式碼來對資料進行任何你能想像到的處理。

**使用情境：**
*   將訂單中的多個產品名稱，組合成一個用逗號分隔的單一字串。
*   執行複雜的數學計算或邏輯判斷。
*   呼叫外部 API，並對回傳的資料進行特殊格式化。
*   完全重構傳入的 JSON 資料結構。

#### 操作步驟

我們來挑戰一個常見的需求：**產生一段給 LINE Notify 使用的、格式化過的訂單摘要文字**。

**步驟 1：新增 Code 節點**
在你的工作流中，新增一個 `Code` 節點。

**步驟 2：撰寫 JavaScript 程式碼**
在左邊的 `JavaScript Code` 編輯區塊中，貼上以下程式碼。n8n 會將每一個傳入的項目 (item) 執行一次這段程式碼。

```javascript
// 取得傳入的 item 資料
const order = items[0].json;

// 建立一個新的物件來存放我們要回傳的資料
let newItem = {};

// 組合摘要訊息
let summary = `🔔 新 VIP 訂單通知！\n`;
summary += `訂單編號：${order.order_id}\n`;
summary += `顧客姓名：${order.customer_name}\n`;
summary += `訂單總額：$${order.total}`;

// 將原始訂單資料與新的摘要訊息一起放回 newItem
newItem.original_data = order;
newItem.line_notify_message = summary;

// 回傳處理過後的新 item
return newItem;
```

``

**程式碼解說：**
1.  `const order = items[0].json;`：這是 n8n 的固定寫法，用來取得當前正在處理的那個項目的所有 JSON 資料。
2.  我們用 `summary += ...` 的方式，像蓋房子一樣，一行一行地把我們要的文字組合起來。`${...}` 是 JavaScript 中用來嵌入變數到字串裡的語法。
3.  `newItem.line_notify_message = summary;`：我們在一個全新的物件 `newItem` 中，新增了一個名為 `line_notify_message` 的欄位，並把組合好的文字放進去。
4.  `return newItem;`：**這是最重要的部分**。這段程式碼的「輸出」就是你 `return` 的東西。

**步驟 3：執行與驗證**
執行節點後，你會看到輸出結果變成了一個全新的結構，裡面包含了 `original_data` 和我們剛剛用程式碼產生的 `line_notify_message`。接下來，你就可以直接把 `line_notify_message` 這個欄位的內容，傳送給 LINE Notify 節點了！

---

### 總結與 Moksa 技巧

恭喜你！你已經完成了 n8n 最核心的四個節點的學習。

*   **Set:** 簡單的資料**新增與修改**。
*   **IF:** 建立**條件判斷**與流程分支。
*   **Merge:** **合併**多個來源的資料。
*   **Code:** 用程式碼進行**終極、複雜**的資料處理。

**Moksa 技巧：**

1.  **善用 Pin Data：** 在每個節點的右上角，有一個圖釘按鈕「Pin」。點擊後可以將該節點的輸出資料「釘選」起來，方便你在設定後面節點的運算式時，隨時參考與選取，而不需要一直重新執行流程。
2.  **節點命名：** 當流程變複雜時，請務必為你的節點重新命名，例如「Set - 計算佣金」、「IF - 訂單是否 > 2000」。這會讓你的工作流在幾個月後依然清晰可讀。
3.  **由簡入繁：** 剛開始學習時，先專注於用 `Set` 和 `IF` 解決問題。當你發現用 `Set` 需要做好幾個節點才能完成一件事情時，再考慮是否可以用一個 `Code` 節點來簡化它。

這四個節點是你未來打造任何自動化流程的基礎。請務必花時間多多練習，嘗試用自己的 WooCommerce 網站觸發真實的訂單資料，並觀察這些資料在節點之間是如何流動與變化的。

在下個章節，我們將會介紹更多實用的工具型節點，讓你的自動化流程更加強大。我們下次見！