# 05.04 n8n 部署與維護策略 (Docker Compose, PM2, 版本更新)

嗨，歡迎來到 n8n 與 WordPress 協作的進階課程！在前幾個章節中，我們已經學會了如何在 n8n 中建立強大的自動化流程。現在，是時候將我們的 n8n 實例從開發環境（例如桌面版或 `npx` 暫時執行）轉移到一個**穩定、可靠、可長期運作的正式環境**中了。

一個不穩定的 n8n 實例，意味著你的棄單召回、訂單通知、CRM 同步等重要流程都可能隨時中斷，這對電商營運是個巨大的風險。因此，本章節的目標，就是教會你如何像專業人士一樣部署與維護你的 n8n 主機。

我們將會探討兩種主流的部署方式：**Docker Compose** 和 **PM2**。

*   **Docker Compose (Moksa 推薦)**: 這是目前最現代化、最推薦的部署方式。它透過「容器化」技術，將 n8n 與其所有依賴的環境打包在一起，實現了環境隔離、輕鬆遷移、快速更新的優點。雖然初次學習曲線稍高，但絕對值得投資。
*   **PM2**: 這是一個 Node.js 的進程管理器。如果你的主機環境已經有 Node.js，且你對 Docker 還不熟悉，PM2 是一個相對簡單快速的選項。它能確保 n8n 在背景持續運行，並在意外崩潰時自動重啟。

接下來，讓我們一步步深入了解這兩種部署方式以及後續的維護策略。

---

### 1. 使用 Docker Compose 部署 n8n (推薦方案)

Docker 就像是為應用程式準備的一個個標準化的「貨櫃」，不管在哪台機器上，只要有 Docker 環境，這個貨櫃就能完美運行，不必擔心主機環境差異造成的各種問題。而 Docker Compose 則是管理這些貨櫃的「總指揮」。

#### 前置準備

在開始之前，請確保你的伺服器（通常是 Linux VPS，例如 DigitalOcean, Linode, Cloudways 等）已經安裝了以下兩個工具：

1.  **Docker**: [官方安裝指南](https://docs.docker.com/engine/install/)
2.  **Docker Compose**: [官方安裝指南](https://docs.docker.com/compose/install/)

#### 部署步驟

**步驟 1：建立專案目錄與設定檔**

首先，透過 SSH 連線到你的主機，並建立一個專門給 n8n 的資料夾。

```bash
# 建立一個名為 n8n-docker 的資料夾
mkdir n8n-docker

# 進入該資料夾
cd n8n-docker
```

接著，我們要建立一個最重要的設定檔：`docker-compose.yml`。這個檔案定義了 n8n 服務該如何運行。

```bash
# 使用 nano 或 vim 編輯器建立檔案
nano docker-compose.yml
```

將以下內容貼到 `docker-compose.yml` 檔案中：

```yaml
version: '3.7'

services:
  n8n:
    image: n8nio/n8n
    container_name: n8n_main
    restart: always
    ports:
      - "127.0.0.1:5678:5678"
    environment:
      - N8N_HOST=${SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://${SUBDOMAIN}.${DOMAIN_NAME}/
      - GENERIC_TIMEZONE=Asia/Taipei
      # 建議加入 n8n 的基礎認證，增加安全性
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=你的管理員帳號
      - N8N_BASIC_AUTH_PASSWORD=你的超強密碼
    volumes:
      - ./n8n_data:/home/node/.n8n

```

**步驟 2：建立環境變數檔案 (`.env`)**

在 `docker-compose.yml` 中，我們使用了一些變數 (例如 `${SUBDOMAIN}`)，這樣可以讓設定更乾淨。現在，我們來建立一個 `.env` 檔案來存放這些變數。

```bash
nano .env
```

貼上以下內容，並**修改成你自己的網域資訊**：

```env
# 你的 n8n 要使用的子網域
SUBDOMAIN=n8n

# 你的主要網域
DOMAIN_NAME=yourdomain.com
```

**步驟 3：啟動 n8n 容器**

一切準備就緒！在 `n8n-docker` 資料夾下，執行以下指令來啟動 n8n。

```bash
docker-compose up -d
```

*   `-d` 參數代表 "detached mode"，意思是在背景執行。

你可以使用 `docker-compose ps` 來確認 n8n 容器是否正在運行。

``
*示意圖：`docker-compose ps` 指令成功顯示 n8n 容器正在運行的畫面。*

**步驟 4：設定反向代理 (Reverse Proxy)**

你會注意到，在 `docker-compose.yml` 的 `ports` 設定中，我們寫的是 `127.0.0.1:5678:5678`。這表示 n8n 的 5678 埠**只對主機本機開放**，外部無法直接存取。這是為了安全！

我們需要一個像 Nginx 或 Caddy 這樣的 Web Server 作為「反向代理」，來接收公開的網路請求（例如 `https://n8n.yourdomain.com`），並將請求安全地轉發到 n8n 服務。同時，它也負責處理 **SSL 憑證**。

以下是一個 Nginx 的設定範例 (通常放在 `/etc/nginx/sites-available/n8n.conf`):

```nginx
server {
    listen 80;
    server_name n8n.yourdomain.com;

    # HTTP 自動轉 HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name n8n.yourdomain.com;

    # SSL 憑證路徑 (請使用 Certbot 自動產生)
    ssl_certificate /etc/letsencrypt/live/n8n.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/n8n.yourdomain.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:5678; # 將請求轉發到 n8n
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        proxy_set_header host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
    }
}
```

設定好 Nginx 並重啟後，你就可以透過 `https://n8n.yourdomain.com` 訪問你的 n8n 實例了！

---

### 2. 使用 PM2 部署 n8n (備用方案)

如果你對 Docker 還不熟悉，或者你的主機環境不適合運行 Docker，PM2 是另一個可靠的選擇。

#### 前置準備

確保你的伺服器已經安裝了 **Node.js** (建議 v16 或更高版本) 和 **npm**。

#### 部署步驟

**步驟 1：全域安裝 PM2 與 n8n**

```bash
# 安裝 PM2
npm install pm2 -g

# 安裝 n8n
npm install n8n -g
```

**步驟 2：使用 PM2 啟動 n8n**

最簡單的啟動方式是直接執行：

```bash
pm2 start n8n
```

但是，這樣做我們無法傳入重要的環境變數（例如資料庫設定、時區等）。因此，**Moksa 技巧**是使用設定檔來管理。

**步驟 3：建立 PM2 設定檔 (`ecosystem.config.js`)**

在你的家目錄或一個你喜歡的位置，建立一個 `ecosystem.config.js` 檔案。

```bash
nano ecosystem.config.js
```

貼上以下內容，並**修改成你自己的設定**：

```javascript
module.exports = {
  apps: [
    {
      name: 'n8n',
      script: 'n8n', // 直接執行 n8n 命令
      args: 'start',
      env: {
        NODE_ENV: 'production',
        // 這裡的網域設定與 Docker 類似
        N8N_HOST: 'n8n.yourdomain.com',
        N8N_PORT: 5678,
        N8N_PROTOCOL: 'https',
        WEBHOOK_URL: 'https://n8n.yourdomain.com/',
        GENERIC_TIMEZONE: 'Asia/Taipei',
        // 同樣建議開啟基礎認證
        N8N_BASIC_AUTH_ACTIVE: true,
        N8N_BASIC_AUTH_USER: '你的管理員帳號',
        N8N_BASIC_AUTH_PASSWORD: '你的超強密碼',
      },
    },
  ],
};
```

**步驟 4：透過設定檔啟動**

現在，使用這個設定檔來啟動 n8n：

```bash
pm2 start ecosystem.config.js
```

**步驟 5：設定開機自動啟動 (非常重要)**

為了確保伺服器重開機後 n8n 能自動運行，你需要執行以下指令：

```bash
# 產生開機啟動腳本
pm2 startup

# 儲存目前的進程列表，讓開機時載入
pm2 save
```

PM2 會給你一行指令，你需要複製並執行它，以完成開-機啟動的設定。

``
*示意圖：`pm2 startup` 指令後，提示使用者複製並執行另一行指令的畫面。*

同樣地，你也需要設定 Nginx 反向代理，將 `https://n8n.yourdomain.com` 的流量轉發到 `http://127.0.0.1:5678`，設定方式與 Docker 方案完全相同。

---

### 3. n8n 版本更新與維護策略

部署完成只是第一步，持續的維護才能確保系統的穩定與安全。

#### **備份！備份！備份！**

在進行任何更新操作之前，**永遠要先備份**。

*   **Docker 用戶**: 你的 n8n 資料都存放在 `docker-compose.yml` 中 `volumes` 指定的 `n8n_data` 資料夾裡。你只需要將這個資料夾完整備份即可。
    ```bash
    # 在 n8n-docker 的上一層目錄執行
    tar -czvf n8n_backup_$(date +%Y%m%d).tar.gz n8n-docker/n8n_data/
    ```
*   **PM2 用戶**: 你的 n8n 資料預設存放在 `~/.n8n`。備份這個資料夾即可。
    ```bash
    tar -czvf n8n_backup_$(date +%Y%m%d).tar.gz ~/.n8n/
    ```

#### Docker Compose 更新流程

Docker 的更新流程非常優雅。

**步驟 1：拉取最新的 n8n 映像檔**

在你的 `n8n-docker` 資料夾中執行：

```bash
docker-compose pull
```

這個指令會檢查 `docker-compose.yml` 中定義的所有服務 (在這裡就是 n8n)，並從 Docker Hub 下載最新的映像檔。

**步驟 2：重新啟動容器**

```bash
docker-compose up -d
```

Docker Compose 非常聰明，它會發現 n8n 的映像檔已經更新，然後會自動停止舊的容器，並用新的映像檔啟動一個新的容器。你的資料和設定因為掛載 (volumes) 了 `n8n_data` 資料夾，會被無縫接軌到新容器中。

**步驟 3 (選用)：清理舊的映像檔**

為了節省硬碟空間，你可以定期清理沒在使用的舊映像檔。

```bash
docker image prune
```

#### PM2 更新流程

**步驟 1：停止 n8n 服務**

```bash
pm2 stop n8n
```

**步驟 2：更新全域 n8n 套件**

```bash
npm install n8n@latest -g
```

**步驟 3：重新啟動 n8n 服務**

```bash
pm2 restart n8n
```

### **Moksa 維護技巧**

1.  **監控服務**: 使用像 [UptimeRobot](https://uptimerobot.com/) (有免費方案) 這類的服務，去監控你的 n8n URL (`https://n8n.yourdomain.com/`)。一旦服務中斷，你就能在第一時間收到通知。
2.  **定期檢查日誌**: 當工作流出現非預期的錯誤時，第一時間應該檢查 n8n 的日誌。
    *   Docker: `docker-compose logs -f --tail=100`
    *   PM2: `pm2 logs n8n`
3.  **閱讀更新日誌 (Changelog)**: 在更新 n8n 版本前，花幾分鐘閱讀官方的[版本更新日誌](https://github.com/n8n-io/n8n/releases)。有時候會有重大變更 (Breaking Changes)，提前了解可以避免很多問題。

---

恭喜你！學完本章節後，你已經具備了獨立部署、更新與維護一個生產級 n8n 實例的專業能力。一個穩定的自動化引擎，將是你未來串接 WordPress 與 WooCommerce 各種商業邏輯的堅實基礎。