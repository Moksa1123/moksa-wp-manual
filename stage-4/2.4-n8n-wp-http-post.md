# 02.04 (實作) 使用 HTTP Request 節點寫入 WP 資料 (POST/PUT, 更新文章/ACF)

嗨，歡迎回來！在上一堂課，我們學會了如何使用 n8n 的 HTTP Request 節點搭配 `GET` 方法，從 WordPress 網站「讀取」文章、產品等資料。這為我們的自動化流程打開了第一扇門。

今天，我們要更進一步，學習如何「寫入」和「更新」資料。這才是自動化的精髓所在！我們將學會使用 `POST` 或 `PUT` 方法，透過 WordPress REST API 來更新一篇文章的標題、內容，甚至是更複雜的 ACF (Advanced Custom Fields) 欄位。

掌握這個技能後，你將能夠建立各種強大的自動化應用，例如：
*   從 Google Sheet 或 Airtable 同步資料，自動更新網站上的產品價格或庫存狀態。
*   建立一個內部表單，讓非技術人員也能安全地更新網站上的特定資訊。
*   自動將其他系統的事件日誌，寫入到 WordPress 的一個自訂文章類型中。

準備好了嗎？讓我們開始動手實作吧！

---

### 課前準備

在開始之前，請確保你已經準備好以下項目：

1.  **一個運作中的 n8n 執行個體**：可以是 n8n Cloud 或你自行架設的版本。
2.  **一個 WordPress 測試站**：
    *   已安裝並啟用 **Advanced Custom Fields (ACF)** 外掛。
    *   已建立一篇文章，我們將用它來當作本次操作的目標。記下這篇文章的 **文章 ID** (Post ID)。
    *   已為「文章」建立一個 ACF 欄位群組，並新增兩個欄位：
        *   **欄位標籤:** `商品狀態` / **欄位名稱:** `product_status` (欄位類型: 文字)
        *   **欄位標籤:** `最後更新來源` / **欄位名稱:** `last_update_source` (欄位類型: 文字)
3.  **WordPress 應用程式密碼 (Application Password)**：這是我們用來授權 n8n 寫入資料的關鍵。如果你忘記如何建立，請參考 [WordPress 官方文件](https://learn.wordpress.org/tutorial/application-passwords/) 或複習前面的章節。

---

### 核心觀念：使用「應用程式密碼」進行驗證

當我們只是讀取公開資料時 (`GET`)，通常不需要驗證。但一旦要修改、新增或刪除資料 (`POST`, `PUT`, `DELETE`)，WordPress 就必須確認「你是誰？」以及「你是否有權限這麼做？」。

這就是「應用程式密碼」派上用場的地方。它允許外部應用程式（如 n8n）在不暴露你真實登入密碼的情況下，安全地代表你執行操作。

在 n8n 中，我們將使用 **HTTP Basic Auth** 的方式來傳遞這個驗證資訊。

*   **Username:** 你的 WordPress 使用者名稱。
*   **Password:** 你產生的「應用程式密碼」（**注意：請使用不含空格的完整密碼字串**）。

---

### 第一部分：(實作) 更新一篇現有的 WordPress 文章

讓我們先從簡單的開始：更新一篇文章的標題和內容。

#### 步驟 1：建立 n8n 工作流程與認證資訊

1.  登入 n8n，建立一個新的工作流程。
2.  第一個節點使用預設的 **Manual** 觸發器即可。
3.  新增一個 **HTTP Request** 節點。
4.  在 HTTP Request 節點的設定畫面中，點擊 **Authentication** 旁邊的下拉選單，選擇 `Basic Auth`。
5.  點擊 **Credential for Basic Auth** 旁邊的下拉選單，選擇 `Create New Credential`。
6.  在跳出的視窗中，填入以下資訊：
    *   **Name:** 給這個認證一個好記的名字，例如 `我的 WordPress 網站 - Admin`。
    *   **User:** 你的 WordPress **使用者名稱**。
    *   **Password:** 貼上你先前產生的 WordPress **應用程式密碼**。
7.  點擊 **Save**。

``

#### 步驟 2：設定 HTTP Request 節點 (更新基本欄位)

現在我們要設定節點，告訴 n8n 要更新「哪篇文章」的「哪些資料」。

1.  **Method:** 選擇 `POST`。
    *   **Moksa 技巧**：在 WordPress REST API 中，當你指定了文章 ID 時，`POST` 通常被用來「更新」現有文章，而 `PUT` 則是用來「替換」整篇文章。在多數情況下，使用 `POST` 更為直覺且安全。
2.  **URL:** 輸入你的 WordPress REST API 端點。格式如下，請將 `<YOUR_POST_ID>` 換成你準備好的文章 ID。
    ```
    https://your-domain.com/wp-json/wp/v2/posts/<YOUR_POST_ID>
    ```
    例如：`https://moksaweb.com/wp-json/wp/v2/posts/123`
3.  **Send Body:** 保持啟用。
4.  **Body Content Type:** 選擇 `JSON`。
5.  在 **Body** 欄位中，輸入我們想要更新的資料，格式為 JSON：
    ```json
    {
      "title": "這是一個由 n8n 自動更新的新標題！",
      "content": "這段內容也是透過 n8n 的 HTTP POST 請求自動寫入的。現在時間是 {{ $now }}。"
    }
    ```
    *   **Moksa 技巧**：我們在這裡使用了一個 n8n 的內建變數 `{{ $now }}`，這樣每次執行時都會寫入當下的時間，方便我們驗證更新是否成功。

``

#### 步驟 3：執行與驗證

1.  點擊 HTTP Request 節點右上角的「播放」按鈕 (Execute Node)。
2.  如果一切順利，右側的 Output 視窗會顯示綠色，並回傳一大包 JSON 資料，這就是更新後的文章物件。
3.  回到你的 WordPress 網站，重新整理那篇文章的編輯頁面或前台頁面。
4.  你會驚喜地發現，文章的標題和內容已經被成功更新了！

---

### 第二部分：(進階實作) 更新文章的 ACF 欄位

更新標準欄位很棒，但真正的威力在於能控制自訂欄位。現在，我們來試著更新先前建立的兩個 ACF 欄位。

#### 步驟 1：找出 ACF 欄位的 API 結構

**這是最關鍵的一步！** 我們必須先知道 ACF 欄位在 REST API 中是如何呈現的。

1.  **Moksa 技巧**：在動手「寫入」前，永遠先用 `GET` 請求來「讀取」目標物件的結構。
2.  將你的 HTTP Request 節點的 **Method** 暫時改為 `GET`。
3.  URL 維持不變 (`https://.../posts/<YOUR_POST_ID>`)。
4.  將 **Body** 欄位暫時清空。
5.  執行節點。
6.  在回傳的 JSON 結果中，找到一個名為 `acf` 的物件。你會看到我們建立的欄位都在裡面，並且有它們目前的值。

``

這一步讓我們確認了兩件事：
*   ACF 欄位是包在一個名為 `acf` 的物件中。
*   欄位名稱就是我們設定的 `product_status` 和 `last_update_source`。

**常見問題：** 如果你在回傳的資料中找不到 `acf` 物件怎麼辦？
請到 WordPress 後台 -> 自訂欄位 -> 你的欄位群組 -> 編輯 -> 設定 -> **在 REST API 中顯示 (Show in REST API)**，並確認這個選項是**開啟**的。

``

#### 步驟 2：修改 HTTP Request 節點的 Body

現在我們知道了正確的結構，可以來修改我們的 `POST` 請求了。

1.  將 HTTP Request 節點的 **Method** 改回 `POST`。
2.  在 **Body** 欄位中，我們在原有的 JSON 基礎上，加上 `acf` 物件：
    ```json
    {
      "title": "由 n8n 更新標題與 ACF 欄位",
      "content": "這次連 ACF 欄位也一起更新了！",
      "acf": {
        "product_status": "特價促銷中",
        "last_update_source": "n8n Workflow"
      }
    }
    ```

``

#### 步驟 3：再次執行與驗證

1.  點擊 **Execute Node**。
2.  執行成功後，回到 WordPress 的文章編輯頁面。
3.  你會看到不僅標題和內容更新了，連下方的「商品狀態」和「最後更新來源」這兩個 ACF 欄位的值也成功被寫入了！

---

### 總結與常見錯誤排查

恭喜你！你已經掌握了透過 n8n 對 WordPress 進行核心資料操作的強大能力。今天我們學會了：
1.  如何使用 WordPress 應用程式密碼在 n8n 中設定 Basic Auth 認證。
2.  如何使用 `POST` 方法更新 WordPress 文章的基本欄位（標題、內容）。
3.  如何先用 `GET` 請求偵測 ACF 欄位的 API 結構。
4.  如何在 `POST` 請求的 Body 中加入 `acf` 物件來更新自訂欄位資料。

**常見錯誤排查 (Troubleshooting):**

*   **收到 401 Unauthorized 或 `rest_cannot_edit` 錯誤**：
    *   **原因**：認證失敗或權限不足。
    *   **解決**：請檢查你的 n8n Credential 中的使用者名稱和應用程式密碼是否完全正確（**密碼不要有空格**）。同時，請確保該 WordPress 使用者角色為「編輯」或「管理員」。

*   **收到 404 Not Found 錯誤**：
    *   **原因**：網址錯誤。
    *   **解決**：請仔細檢查你的 URL，確認網域名稱、API 路徑 (`/wp-json/wp/v2/posts/`) 和文章 ID 是否正確無誤。

*   **ACF 欄位沒有被更新**：
    *   **原因**：欄位名稱錯誤或設定問題。
    *   **解決**：
        1.  再次確認 Body 中的 `acf` 物件裡的**欄位名稱**是否與你在 ACF 中設定的「欄位名稱」完全一致（大小寫有別）。
        2.  回到 ACF 欄位群組的設定，確保 **在 REST API 中顯示 (Show in REST API)** 已啟用。

在下一堂課，我們將探索更複雜的應用，例如如何自動「建立」一篇全新的文章，以及如何操作 WooCommerce 的產品資料。敬請期待！