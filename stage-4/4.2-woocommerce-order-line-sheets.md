# 04.02 (實作) WooCommerce 新訂單通知 LINE 客服並同步記錄到 Google Sheets

嗨，歡迎來到 n8n 與 WordPress 協作的實戰課程！在之前的章節中，我們已經理解了 n8n 的基本概念與操作介面。從這堂課開始，我們將動手打造一個非常實用，也是許多電商經營者最需要的自動化流程：**當 WooCommerce 網站有新訂單成立時，自動發送通知到指定的 LINE 群組，並同時將訂單資料寫入 Google Sheets 進行備份與數據分析。**

這個流程可以為你的團隊帶來巨大的效益：
*   **即時性：** 客服或倉管人員可以在第一時間收到訂單通知，立即準備出貨。
*   **協同作業：** 團隊成員無需登入 WordPress 後台，就能在熟悉的 LINE 介面中掌握訂單資訊。
*   **數據集中：** 將所有訂單資料自動彙整到 Google Sheets，方便後續進行財務對帳、銷售分析或製作報表。
*   **降低錯誤：** 自動化可以完全取代人工複製貼上的作業，大幅降低人為疏失的機率。

準備好了嗎？讓我們開始動手吧！

---

### Part 1：前置準備 (事前設定)

在開始建立 n8n 工作流之前，我們需要先準備好三個服務的「鑰匙」，也就是 API 憑證或權杖，讓 n8n 可以合法地與它們溝通。

#### 步驟 1: 取得 LINE Notify 的權杖 (Token)

LINE Notify 是一個免費的服務，可以讓我們透過程式發送訊息到個人或群組。

1.  前往 [LINE Notify 官方網站](https://notify-bot.line.me/zh_TW/) 並登入你的 LINE 帳號。
2.  點擊右上角的帳號，選擇「**個人頁面**」。
    `[截圖：LINE Notify 個人頁面按鈕位置]`
3.  向下滑動到「發行權杖」區塊，點擊「**發行權杖**」。
4.  設定權杖資訊：
    *   **權杖名稱：** 給它一個好辨識的名字，例如「WooCommerce 訂單通知」。
    *   **選擇您要接收通知的聊天室：** 這裡請選擇你希望接收通知的 LINE 群組。**Moksa 技巧：** 建議為客服或出貨團隊建立一個專用的 LINE 群組，並**務必**將「LINE Notify」官方帳號也邀請加入該群組，否則它將無法發送訊息。
    `[截圖：選擇要發送通知的 LINE 群組]`
5.  點擊「**發行**」。
6.  你會看到一組長長的亂碼，這就是你的**權杖 (Token)**。請**立刻複製**並妥善保存在你的密碼管理工具或一個暫時的安全筆記本中。**這個權杖只會顯示一次，關閉視窗後就再也找不回來了！**
    `[截圖：顯示 LINE Notify 權杖的畫面，並標示複製按鈕]`

#### 步驟 2: 準備 Google Sheets 表格與 API 憑證

1.  前往 [Google Sheets](https://docs.google.com/spreadsheets/)，建立一份新的空白試算表。
2.  將它命名為「WooCommerce 訂單記錄」。
3.  在第一列 (Row 1) 建立我們需要的欄位標頭，例如：
    *   `A1`: **訂單編號**
    *   `B1`: **訂購日期**
    *   `C1`: **顧客姓名**
    *   `D1`: **顧客 Email**
    *   `E1`: **訂單總額**
    *   `F1`: **付款方式**
    *   `G1`: **訂單連結**
    `[截圖：已建立好欄位的 Google Sheets 表格]`

4.  接下來，我們要為 n8n 取得操作這份試算表的權限。這需要前往 Google Cloud Console 建立 API 憑證。
    *   前往 [Google Cloud Console](https://console.cloud.google.com/)。
    *   建立一個新專案 (如果沒有的話)，例如命名為 `n8n-integration`。
    *   在左側選單中，前往「API 和服務」>「已啟用的 API 和服務」。
    *   點擊「**+ 啟用 API 和服務**」，搜尋「**Google Sheets API**」並將它**啟用**。
    *   啟用後，點擊左側的「**憑證**」。
    *   點擊「**+ 建立憑證**」，選擇「**OAuth 用戶端 ID**」。
    *   應用程式類型選擇「**網頁應用程式**」。
    *   名稱自訂，例如 `n8n-sheets-credential`。
    *   在「**已授權的重新導向 URI**」部分，點擊「**+ 新增 URI**」。這個 URI 要回到 n8n 介面取得。
        *   **Moksa 技巧：** 先在 n8n 介面新增一個 Google Sheets 節點，在「Credential」選擇「Create New」，n8n 會顯示一個 `OAuth Callback URL`，將這個 URL 完整複製並貼到 Google Cloud Console 的重新導向 URI 欄位中。
        `[截圖：n8n 顯示 OAuth Callback URL 的畫面]`
    *   點擊「**建立**」，你就會獲得一組**用戶端 ID (Client ID)** 和**用戶端密碼 (Client Secret)**。請將它們複製並保存好。

---

### Part 2：建立 n8n 工作流 (Workflow)

前置作業都完成了，現在讓我們進入 n8n，把所有零件組裝起來！

#### 步驟 1: 設定 WooCommerce 觸發節點 (Trigger)

工作流的第一步，永遠是「觸發條件」。我們的條件是「WooCommerce 有一筆新訂單」。

1.  在 n8n 中建立一個新的工作流 (Workflow)。
2.  點擊 `+` 按鈕，搜尋並選擇「**WooCommerce Trigger**」節點。
3.  在右側的設定面板中：
    *   **Authentication:** 選擇 `Access Token`。
    *   **Credential:** 點擊 `Create New`。
        *   **Name:** 自訂一個名稱，如 `Moksa-WC-API`。
        *   **Base URL:** 輸入你的網站網址，例如 `https://yourdomain.com`。
        *   **Consumer Key & Consumer Secret:** 這需要到 WordPress 後台產生。請前往 **WooCommerce > 設定 > 進階 > REST API**，點擊「新增金鑰」，描述自訂，權限選擇「**讀取/寫入**」，產生後將 `Consumer Key` 和 `Consumer Secret` 複製貼上。
        `[截圖：WooCommerce REST API 金鑰產生畫面]`
    *   **Resource:** 選擇 `Order`。
    *   **Event:** 選擇 `Created` (訂單建立時)。
4.  設定完成後，你會在節點下方看到一個 **Webhook URL**。請**複製**這個網址。
    `[截圖：WooCommerce Trigger 節點顯示 Webhook URL 的位置]`
5.  回到你的 WordPress 後台，前往 **WooCommerce > 設定 > 進階 > Webhook**。
6.  點擊「**新增 Webhook**」：
    *   **名稱:** 自訂，例如 `n8n New Order`。
    *   **狀態:** 設定為「**啟用**」。
    *   **主題:** 選擇「**訂單已建立**」。
    *   **傳送 URL:** 貼上剛剛從 n8n 複製的 Webhook URL。
    *   **密碼:** 留空即可。
    *   **API 版本:** 選擇 `WP REST API Integration v3`。
7.  儲存 Webhook。
8.  回到 n8n，點擊「**Listen for Test Event**」。n8n 會開始等待接收資料。
9.  現在，請到你的 WooCommerce 網站**下一筆測試訂單**。完成結帳後，你會看到 n8n 的 WooCommerce Trigger 節點成功接收到一筆 JSON 格式的訂單資料！
    `[截圖：n8n 成功接收到測試訂單資料的畫面]`

#### 步驟 2: 設定 LINE Notify 通知節點

1.  點擊 WooCommerce Trigger 節點右邊的 `+`，搜尋並新增「**LINE**」節點。
2.  在右側設定面板中：
    *   **Resource:** 選擇 `Message`。
    *   **Operation:** 選擇 `Notify`。
    *   **Credential:** 點擊 `Create New`。
        *   **Name:** 自訂名稱，如 `LINE Notify - 客服群組`。
        *   **Access Token:** 貼上我們在 **Part 1, 步驟 1** 取得的 LINE Notify 權杖。
    *   **Message:** 這是我們要發送的訊息內容。我們可以動態地從上一個節點（訂單資料）中抓取資訊。點擊欄位右側的 `</>` 圖示，可以打開變數選擇器。
        *   **Moksa 技巧：** 撰寫一個清晰易讀的訊息範本，例如：

        ```
        🔔 新訂單通知！

        訂單編號：#{{ $json["body"]["id"] }}
        顧客姓名：{{ $json["body"]["billing"]["first_name"] }} {{ $json["body"]["billing"]["last_name"] }}
        訂單金額：NT$ {{ $json["body"]["total"] }}
        付款方式：{{ $json["body"]["payment_method_title"] }}

        👇 點此查看訂單詳情：
        {{ $json["body"]["meta_data"][1]["value"] }}
        ```
        *   **注意：** 訂單詳情後台連結的路徑可能會因網站設定而異，`{{ $json["body"]["meta_data"][1]["value"] }}` 是常見的路徑，你可以從測試資料中找到正確的 `_edit_lock` 或類似的 meta key。

    `[截圖：LINE 節點的 Message 欄位設定，並標示出如何從左側拖曳變數]`

#### 步驟 3: 設定 Google Sheets 記錄節點

1.  點擊 LINE 節點右邊的 `+`，搜尋並新增「**Google Sheets**」節點。
2.  在右側設定面板中：
    *   **Authentication:** 選擇 `OAuth2`。
    *   **Credential:** 點擊 `Create New`，這時 n8n 會要求你輸入在 **Part 1, 步驟 2** 取得的 **Client ID** 和 **Client Secret**。填入後，n8n 會引導你登入 Google 帳號並授權。
    *   **Operation:** 選擇 `Append` (附加資料到最後一列)。
    *   **Spreadsheet ID:** 從你的 Google Sheets 網址中複製試算表的 ID。例如網址是 `.../spreadsheets/d/THIS_IS_THE_ID/edit`，`THIS_IS_THE_ID` 就是你的 Spreadsheet ID。
    *   **Sheet Name:** 輸入你的工作表名稱，預設是 `Sheet1`。
    *   **Columns > Mode:** 選擇 `Map each column below`。
    *   **Map Columns:** 點擊 `Add Mapping`，將我們在 Google Sheets 建立的欄位與 WooCommerce 訂單資料一一對應起來。
        *   **Key:** 輸入你在 Google Sheets 建立的欄位名稱，例如 `訂單編號`。
        *   **Value:** 從變數選擇器中，將 WooCommerce Trigger 節點的對應資料拖曳進來，例如 `{{ $json["body"]["id"] }}`。
        *   重複此步驟，直到所有欄位都對應完成。
            *   **訂單編號:** `{{ $json["body"]["id"] }}`
            *   **訂購日期:** `{{ $json["body"]["date_created"] }}`
            *   **顧客姓名:** `{{ $json["body"]["billing"]["first_name"] }} {{ $json["body"]["billing"]["last_name"] }}`
            *   **顧客 Email:** `{{ $json["body"]["billing"]["email"] }}`
            *   **訂單總額:** `{{ $json["body"]["total"] }}`
            *   **付款方式:** `{{ $json["body"]["payment_method_title"] }}`
            *   **訂單連結:** `{{ $json["body"]["meta_data"][1]["value"] }}`
    `[截圖：Google Sheets 節點已完成所有欄位對應的畫面]`

---

### Part 3：最終測試與啟用

現在，我們的自動化流程已經完整建立。在正式啟用前，讓我們做最後的端對端測試。

1.  點擊 n8n 工作流畫面上方的「**Save**」按鈕，儲存你的設定。
2.  點擊右上角的開關，將工作流從 **Inactive** 切換為 **Active**。
    `[截圖：n8n 工作流右上角的啟用開關]`
3.  **再次**回到你的 WooCommerce 網站，用正常流程下一筆全新的訂單。
4.  檢查你的 LINE 客服群組，應該在幾秒鐘內就會收到格式化後的訂單通知訊息。
    `[截圖：手機 LINE 收到自動化通知的成功畫面]`
5.  打開你的 Google Sheets「WooCommerce 訂單記錄」試算表，應該會看到一筆新的資料列，包含了剛剛那筆訂單的所有資訊。
    `[截圖：Google Sheets 成功新增一筆訂單記錄的畫面]`

如果兩邊都成功收到了資料，恭喜你！你已經成功打造了一個強大的電商自動化流程！

### 總結與 Moksa 技巧

在這堂課中，我們從零開始，串接了 WooCommerce、LINE Notify 和 Google Sheets，實現了新訂單的自動化通知與記錄。這個流程看似簡單，卻是數位轉型與提升營運效率的關鍵第一步。

**Moksa 技巧與延伸思考：**

*   **增加判斷邏輯：** 你可以在流程中加入一個 `IF` 節點。例如：判斷訂單金額 (`total`) 是否大於 5000 元，如果大於，就額外發送一則通知給主管；或者判斷付款方式 (`payment_method`) 是否為「銀行轉帳」，如果是，就發送一則包含匯款資訊的提醒給客服。
*   **串接更多服務：** 訂單成立後，除了通知與記錄，你還可以串接 **FluentCRM** 節點，為購買特定商品的顧客自動貼上標籤，方便日後進行精準的 Email 行銷。
*   **錯誤處理：** 在 n8n 中可以設定錯誤處理流程 (Error Workflow)，例如當 Google Sheets 因故寫入失敗時，自動發送一則錯誤通知給你，確保你不會遺漏任何一筆訂單。

請務必動手實作一遍，你會對自動化的威力有更深刻的體會。我們下堂課見！