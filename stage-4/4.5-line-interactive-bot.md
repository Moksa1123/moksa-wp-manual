# 4.5 (實作) 打造 LINE 互動式客服：使用者輸入關鍵字查詢 WordPress 文章或 WooCommerce 訂單狀態

你好，我是 Moksa 的首席課程導師。

在之前的課程中，我們已經了解了 n8n 的基本操作。今天，我們要來做一個非常實用且強大的整合應用：建立一個 24 小時不打烊的 LINE 互動式客服機器人。

這個機器人將能夠理解使用者傳送的訊息，並根據內容自動去我們的 WordPress 網站中，查詢相關的文章，或是去 WooCommerce 查詢特定訂單的最新狀態，然後即時回覆給使用者。這不僅能大幅提升使用者體驗，更能有效降低我們團隊處理重複性客服問題的人力成本。

**Moksa 技巧：** 在開始之前，值得一提的是，如果你的需求是較為單純的 LINE 客戶服務與推播，Moksa 團隊也推薦使用 **OrderChatz** 這款專為 WooCommerce 設計的 LINE 整合外掛。它提供了開箱即用的訂單通知、客服對話與 AI 自動回應功能。而我們今天這堂課要學習的 n8n 方法，則提供了**無可比擬的彈性與客製化能力**，適合需要打造高度自訂流程的進階使用者。

這堂課的目標，是帶你一步步串接三個核心服務：
1.  **LINE Messaging API:** 用來接收與回覆使用者的訊息。
2.  **n8n:** 作為整個自動化流程的大腦與中樞。
3.  **WordPress / WooCommerce REST API:** 讓 n8n 能夠安全地存取我們網站的資料。

準備好了嗎？讓我們開始動手實作吧！

---

### Part 1: 前置準備

在開始建構 n8n 工作流程之前，我們需要先確保所有必要的帳號、權限和金鑰都已準備就緒。

#### **步驟 1：取得 LINE Messaging API 的金鑰**

1.  登入 [LINE Developers Console](https://developers.line.biz/console/)。
2.  選擇或建立一個你的 Provider。
3.  建立一個新的 Channel，並選擇 **Messaging API** 類型。
4.  進入你的 Channel，切換到 **"Messaging API"** 頁籤。
5.  在頁面最下方，找到 **Channel access token**，點擊 "Issue" 按鈕。這串 `long-lived` 的 token 就是我們要的，請先將它複製下來存好。
6.  接著，在同一個頁籤中，找到 **"Webhook settings"** 區塊，等一下我們會需要回來這裡設定 n8n 提供的網址。

``

#### **步驟 2：產生 WooCommerce REST API 金鑰**

為了讓 n8n 能夠「讀取」WooCommerce 的訂單資料，我們需要為它產生一組專屬的 API 金鑰。

1.  登入你的 WordPress 後台。
2.  前往 **WooCommerce** > **設定** > **進階** > **REST API**。
3.  點擊「**新增金鑰**」或「**建立 API 金鑰**」。
4.  在「**描述**」欄位中，輸入一個好辨識的名稱，例如 `n8n LINE Bot`。
5.  在「**權限**」欄位，選擇「**讀取 (Read)**」。**Moksa 技巧：** 這是非常重要的**安全性原則**，我們的機器人只需要查詢訂單，不需要寫入或刪除，因此給予最小化的「讀取」權限即可，避免潛在風險。
6.  點擊「**產生 API 金鑰**」。
7.  系統會顯示一組「**Consumer key**」和「**Consumer secret**」。**請務必立刻將這兩組金鑰複製並儲存到安全的地方**，因為 `Consumer secret` 在離開此頁面後將無法再次看到。

``

---

### Part 2: n8n 工作流程設計與實作

現在，我們的所有鑰匙都備齊了，可以開始在 n8n 裡搭建我們的自動化工廠。

#### **步驟 1：建立 Webhook 觸發器，接收 LINE 訊息**

1.  在 n8n 中，建立一個新的 Workflow。
2.  第一個節點 (Node)，請選擇 **Webhook**。
3.  你會看到 n8n 為你產生了 **Test URL** 和 **Production URL**。開發階段，我們先使用 **Test URL**。請點擊旁邊的複製按鈕，將 **Test URL** 複製下來。

``

4.  回到你的 LINE Developers Console，在 **Messaging API** 頁籤的 **Webhook settings** 中，將剛剛複製的 n8n **Test URL** 貼到 **"Webhook URL"** 欄位中，並**儲存**。
5.  同時，請**務必開啟 "Use webhook"** 的開關。
6.  現在，回到 n8n，點擊 Webhook 節點右上角的 **"Listen for test event"**。
7.  拿出你的手機，對你的 LINE 官方帳號發送一則測試訊息，例如 "Hello"。
8.  如果一切順利，n8n 的 Webhook 節點會立刻顯示它收到了資料。這代表 n8n 與 LINE 的通道已經打通了！

#### **步驟 2：使用 IF 節點判斷使用者意圖**

我們需要一個機制來判斷使用者是想「查訂單」還是「查文章」。一個簡單有效的規則是：**如果訊息以 `#` 開頭，就當作是訂單編號查詢。**

1.  在 Webhook 節點後方，新增一個 **IF** 節點。
2.  在 **Value 1** 欄位，我們要抓取使用者傳送的訊息內容。點擊右邊的「表示式編輯器 (Expression Editor)」，輸入以下路徑：
    `{{ $json.events[0].message.text }}`
3.  在 **Operation** 欄位，選擇 **String** > **starts with**。
4.  在 **Value 2** 欄位，輸入 `#`。
5.  這樣設定的意思是：「如果使用者訊息的文字內容，是以 # 符號開頭的」。

``

IF 節點會有兩個輸出：`true` (符合條件) 和 `false` (不符合條件)。接下來我們要分別處理這兩條路徑。

#### **步驟 3：(分支 True) 查詢 WooCommerce 訂單**

當使用者輸入 `#12345` 時，會走到這個分支。

1.  從 IF 節點的 `true` 輸出點拉出，新增一個 **HTTP Request** 節點。
2.  **Authentication:** 選擇 **WooCommerce API**。
3.  點擊 **Credential for WooCommerce API** 右邊的 **- Create New -**。
4.  在跳出的視窗中，**Name** 輸入 `My WooCommerce Store`，**Base URL** 輸入你的網站網址 (例如 `https://your-domain.com`)，並貼上我們在 Part 1 步驟 2 取得的 **Consumer Key** 與 **Consumer Secret**。儲存。
5.  **Resource:** 選擇 **Order**。
6.  **Operation:** 選擇 **Get**。
7.  **Order ID:** 我們需要從使用者的訊息中，取出 `#` 後面的數字。使用以下表示式：
    `{{ $json.events[0].message.text.substring(1) }}`
    (`substring(1)` 的作用是移除字串中的第一個字元，也就是 `#`)。

``

8.  **Moksa 技巧：** 為了讓回覆的訊息更人性化，我們在 HTTP Request 節點後方，再新增一個 **Set** 節點，用來組合回覆的文字。
    *   **Name:** `ReplyMessage`
    *   **Value:** `您好，訂單 #{{ $('HTTP Request').item.json.id }} 的狀態是：【{{ $('HTTP Request').item.json.status }}】。` (請注意，`status` 的值可能是 `processing`, `completed` 等英文，你可以進一步用 Function 節點將其轉換為中文)。

#### **步驟 4：(分支 False) 查詢 WordPress 文章**

當使用者輸入的是一般文字時，會走到這個分支。

1.  從 IF 節點的 `false` 輸出點拉出，新增一個 **HTTP Request** 節點。
2.  **Authentication:** 選擇 **None** (因為 WordPress 的文章通常是公開的)。
3.  **Method:** 選擇 **GET**。
4.  **URL:** 我們要使用 WordPress 內建的 REST API 來搜尋文章。URL 格式如下，並使用表示式帶入使用者輸入的關鍵字：
    `https://your-domain.com/wp-json/wp/v2/posts?search={{ $json.events[0].message.text }}`
5.  同樣地，在這個節點後方也新增一個 **Set** 節點來組合回覆訊息。文章搜尋可能會找到多筆或找不到，我們這裡先做最簡單的處理：回覆第一筆找到的文章。
    *   **Name:** `ReplyMessage`
    *   **Value (使用表示式):**
        ```javascript
        const items = $('HTTP Request1').item.json;
        if (items.length > 0) {
          return `為您找到相關文章：\n\n【${items[0].title.rendered}】\n${items[0].link}`;
        } else {
          return `抱歉，找不到與「${$('IF').item.json.events[0].message.text}」相關的文章。請試試其他關鍵字。`;
        }
        ```

``

#### **步驟 5：整合並回覆訊息到 LINE**

現在，我們兩條分支都有了準備好的回覆訊息 (`ReplyMessage`)。最後一步就是將這個訊息發送回給使用者。

1.  在兩個 Set 節點後方，新增最後一個 **HTTP Request** 節點。你可以將兩個 Set 節點的輸出都連到這個最終的 HTTP Request 節點上。
2.  **Method:** 選擇 **POST**。
3.  **URL:** `https://api.line.me/v2/bot/message/reply`
4.  **Authentication:** 選擇 **Header Auth**。
5.  點擊 **Credential for Header Auth** 右邊的 **- Create New -**。
    *   **Name:** `LINE Messaging API`
    *   **Header Name:** `Authorization`
    *   **Header Value:** 輸入 `Bearer ` (注意 Bearer 後面有一個空格)，然後貼上你在 Part 1 步驟 1 取得的 **Channel access token**。儲存。
6.  **Body Content Type:** 選擇 **JSON**。
7.  在 **Body** 欄位中，我們要填入符合 LINE API 格式的 JSON 內容：

    ```json
    {
      "replyToken": "{{ $('Webhook').item.json.events[0].replyToken }}",
      "messages": [
        {
          "type": "text",
          "text": "{{ $json.ReplyMessage }}"
        }
      ]
    }
    ```
    **Moksa 技巧：** `replyToken` 是 LINE 用來標示該回覆哪一則訊息的憑證，它有時效性。我們使用 `$('Webhook').item.json...` 的方式，確保是抓取到最一開始觸發流程的那個 Webhook 節點的資料，這是最穩定的作法。

``

---

### Part 3: 啟用與測試

1.  恭喜你！整個流程已經搭建完畢。請點擊右上角的 **"Save"** 儲存你的工作流程。
2.  點擊左上角的開關，將狀態從 **Inactive** 切換為 **Active**。
3.  這時 n8n 會使用 **Production URL**，請記得回到 LINE Developers Console，將 Webhook URL 更新為 n8n Webhook 節點中的 **Production URL**。

現在，拿起你的手機，開始跟你的智慧客服互動吧！
*   **測試訂單查詢：** 發送 `#<一個你網站上真實存在的訂單編號>` (例如: `#13579`)
*   **測試文章查詢：** 發送你網站上有的關鍵字 (例如: `WooCommerce 教學`)
*   **測試查無資料：** 發送一個不存在的訂單編號或文章關鍵字。

---

### 總結與延伸思考

今天，你成功地利用 n8n 打造了一個功能強大的 LINE 互動客服。它串接了 LINE 的即時通訊能力與 WordPress 的內容管理、WooCommerce 的電商資料庫，實現了真正的自動化服務。

這個工作流程還有許多可以優化與擴充的地方：
1.  **更豐富的回覆格式：** 除了純文字，你可以研究 LINE 的 [Flex Message](https://developers.line.biz/en/docs/messaging-api/using-flex-messages/)，用卡片式圖文選單來呈現搜尋到的文章列表，體驗會更好。
2.  **更嚴謹的錯誤處理：** 當 WooCommerce API 查詢不到訂單時，目前節點可能會報錯。你可以使用 **Error Trigger** 節點來捕捉錯誤，並回覆更友善的「查無此訂單」訊息。
3.  **安全性強化：** 查詢訂單時，可以進一步要求使用者輸入訂單的 Email 或手機號碼進行雙重驗證，確保只有本人才能查詢。
4.  **串接真人客服：** 當機器人無法解決問題時，可以設計一個關鍵字 (例如 `轉接專人`)，觸發 n8n 發送通知 (例如到 Slack 或 Email) 給客服團隊介入處理。

n8n 的可能性無窮無盡，希望這堂課能為你開啟自動化的新大門。持續探索，你會發現它能為你的事業帶來巨大的價值。我們下堂課見！