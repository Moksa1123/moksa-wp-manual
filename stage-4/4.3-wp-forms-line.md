# 04.03 (實作) 處理 WordPress 表單 (如 WPForms) 提交，自動回覆 LINE 訊息

嗨，歡迎來到 n8n 與 WordPress 協作的實戰課程！在之前的章節中，我們已經了解了 n8n 的基本概念與強大之處。今天，我們將動手做一個非常實用且常見的自動化應用：當使用者在你的 WordPress 網站上提交表單時，n8n 會自動發送一則 LINE 訊息。

這個應用場景非常廣泛，例如：
*   **新客戶諮詢通知：** 當有潛在客戶提交「聯絡我們」表單時，立即發送 LINE 通知給業務或客服人員，不錯過任何商機。
*   **活動報名確認：** 使用者報名活動後，自動發送一則 LINE 訊息給他，告知報名成功，並附上活動資訊。
*   **資料提交感謝訊息：** 使用者提交任何表單後，發送一則感謝訊息給對方，提升使用者體驗。

在本堂課中，我們將以 **WPForms** 作為 WordPress 的表單外掛，並以「發送通知給網站管理者」作為主要教學範例。

---

### 課程目標

*   學習如何設定 WPForms 的 Webhook 功能。
*   學習如何在 n8n 中建立一個接收 Webhook 資料的自動化工作流。
*   學習如何串接 n8n 與 LINE Messaging API。
*   完成一個從 WordPress 表單提交到 LINE 訊息發送的完整自動化流程。

### 前置作業

在開始之前，請確保你已經準備好以下項目：

1.  **n8n 服務：** 無論是 n8n Cloud 或是自行架設的版本。
2.  **WordPress 網站：** 並已安裝 **WPForms Pro**。
    *   **Moksa 技巧：** WPForms 的 Webhook 功能是 Pro 版本限定的。如果你使用其他表單外掛，如 Fluent Forms 或 Gravity Forms，它們通常也內建了 Webhook 功能，操作邏輯大同小異。
3.  **一個 LINE Official Account (官方帳號)：** 用於發送訊息。
4.  **一個 LINE Developers 帳號：** 用來取得串接所需的 API 金鑰。

---

### 第一部分：取得 LINE API 與個人 User ID

要讓 n8n 能夠代表你的 LINE 官方帳號發送訊息，我們需要一組「鑰匙」。同時，為了測試方便，我們也需要知道自己的 LINE User ID，才能指定 n8n 發訊息給自己。

#### 步驟 1: 取得 LINE Channel Access Token

1.  登入 [LINE Developers Console](https://developers.line.biz/console/)。
2.  選擇你的 Provider (供應商)，然後選擇你要使用的 LINE 官方帳號對應的 Channel。
3.  進入 Channel 後，切換到「**Messaging API**」這個頁籤。
4.  滑到頁面最下方，你會看到「**Channel access token**」。點擊「**Issue**」按鈕來產生一組**長時效 (long-lived)** 的權杖。
5.  產生後，你會得到一串很長的亂碼，這就是你的 **Channel Access Token**。**請務必妥善保管，不要外洩**。我們先將它複製下來備用。

`` (LINE Developers Console 中 Channel Access Token 的位置截圖)

#### 步驟 2: 取得你的 LINE User ID (用於測試)

要知道你的個人 LINE User ID 最簡單的方法，就是「**主動傳訊息給你自己的 LINE 官方帳號**」。

1.  用你的個人 LINE App，加入你自己的官方帳號為好友。
2.  隨便傳送一則訊息給它，例如「Hello」。
3.  接著，回到 LINE Developers Console，在同一個 Channel 的「**Messaging API**」頁籤中，找到「**Webhook URL**」的設定。暫時打開 Webhook 功能，並隨便填入一個網址 (例如 `https://google.com` )，然後點擊「Verify」。
4.  當你傳送訊息給官方帳號時，LINE 會把包含你 User ID 的資料傳送到這個 Webhook URL。很多工具可以幫我們接收這個資料，但在 n8n 課程中，最快的方式就是直接用 n8n 的 Webhook 節點來接收！(我們會在下個部分實作)

另一種更簡單的方式是，你可以透過 LINE 官方帳號後台 (LINE Official Account Manager)，在「分析」>「訊息」中，有時能看到互動用戶的資訊，但最可靠的還是透過 Webhook 接收。

**Moksa 技巧：** 我們先記住這個流程，待會建立 n8n 工作流時，可以順便用 Webhook 節點來取得自己的 User ID。

---

### 第二部分：建立 n8n 自動化工作流 (Workflow)

現在，我們要開始建立 n8n 的自動化流程了。

#### 步驟 1: 建立 Webhook 觸發節點

1.  登入你的 n8n，建立一個新的 Workflow。
2.  點擊 `+` 按鈕，在搜尋框中輸入 `Webhook`，並選取它。
3.  Webhook 節點會自動產生。你會在右側看到它的設定。
4.  在「**Webhook URLs**」區塊，點擊「**Copy**」按鈕，複製這段 **Test URL**。這就是 n8n 用來接收資料的專屬網址。

`` (n8n Webhook 節點與複製 Test URL 的畫面截圖)

#### 步驟 2: 在 WordPress 的 WPForms 中設定 Webhook

1.  回到你的 WordPress 後台，找到 WPForms > **All Forms**，編輯你想要串接的表單 (例如「聯絡我們」表單)。
2.  在表單編輯器中，點擊左側的「**Settings**」，然後選擇「**Webhooks**」。
3.  點擊「**Add New Webhook**」按鈕。
4.  在「**Webhook URL**」欄位中，貼上你剛剛從 n8n 複製的 **Test URL**。
5.  其他設定可以暫時保持預設值。最後，點擊右上角的「**Save**」儲存表單設定。

`` (WPForms 中設定 Webhook URL 的畫面截圖)

#### 步驟 3: 觸發 Webhook 以取得測試資料

這是 n8n 開發流程中最重要的一步：讓 n8n 知道表單會傳來什麼樣格式的資料。

1.  回到 n8n 的 Webhook 節點畫面，點擊右下角的「**Listen for Test Event**」按鈕。n8n 會進入等待模式。
2.  現在，打開你的 WordPress 網站前台，找到你剛剛設定的那個表單頁面。
3.  **完整地填寫表單的所有欄位**，然後點擊「提交」。
4.  提交成功後，切換回 n8n 的畫面。你會看到 Webhook 節點下面出現了綠色的勾勾，並且右側的 Output 區塊顯示出剛剛你填寫的表單資料！

`` (n8n Webhook 節點成功接收到 WPForms 資料的 JSON 格式截圖)

**Moksa 技巧：** 請花點時間看一下接收到的資料結構。你會發現 WPForms 把所有欄位都放在 `body > wpforms > fields` 這個物件裡，並用數字 `0`, `1`, `2`... 作為 key。記住這個結構，我們馬上會用到。

#### 步驟 4: 加入 LINE 節點並設定訊息內容

1.  點擊 Webhook 節點右邊的 `+` 按鈕，搜尋並加入「**LINE**」節點。
2.  在 LINE 節點的設定中：
    *   **Authentication:** 選擇 `Access Token`。
    *   **Credentials for LINE API:** 點擊 `Create New`。
        *   **Credential Name:** 給它一個好辨識的名字，例如 `我的Moksa網站LINE`。
        *   **Channel Access Token:** 貼上我們在**第一部分步驟 1** 取得的那一長串 Token。
        *   點擊 `Save`。
    *   **Resource:** 選擇 `Message`。
    *   **Operation:** 選擇 `Push`。
    *   **To User/Group/Room ID:** 貼上你自己的 **LINE User ID** (或是任何你想通知的對象的 User ID)。
    *   **Messages:** 點擊 `Add Message Item`，選擇 `Text`。
    *   **Text:** 這是最關鍵的部分。我們要組合一段包含表單資料的動態訊息。點擊欄位右邊的「齒輪」圖示 > `Add Expression`。
    *   在 Expression Editor (運算式編輯器) 中，我們可以從左邊的 `INPUT DATA` > `Webhook` 節點中，拖拉資料進來。
    *   你可以這樣撰寫訊息，請注意 `fields` 後面的數字要對應到你收到的資料：

    ```
    🔔 新表單提交通知！

    姓名：{{ $json.body.wpforms.fields['0'] }}
    Email：{{ $json.body.wpforms.fields['1'] }}
    訊息內容：
    {{ $json.body.wpforms.fields['2'] }}
    ```

`` (n8n LINE 節點的完整設定畫面，特別是 Expression Editor 的部分)

3.  設定完成後，點擊右下角的「**Execute Node**」來測試這個 LINE 節點。如果設定無誤，你的手機 LINE 應該會立刻收到一則格式化好的通知訊息！

---

### 第三部分：啟用與最終測試

1.  **儲存與啟用 Workflow:** 在 n8n 畫面的左上角，給你的 Workflow 一個名稱 (例如：WPForms to LINE Notify)。然後點擊右上角的「**Save**」按鈕儲存。最後，將左上角的 **Inactive** 開關切換為 **Active**。
2.  **更換 Webhook URL:**
    *   **重要！** 當 Workflow 啟用後，Webhook 節點會給你一個 **Production URL**。請複製這個 Production URL。
    *   回到 WordPress 的 WPForms Webhook 設定中，將原本的 **Test URL** 換成這個 **Production URL**，並儲存。
3.  **進行最終測試：** 再次回到網站前台，像個真實使用者一樣提交表單。這次，因為 Workflow 已經是 Active 狀態，n8n 會在背景自動執行，你應該會在幾秒內收到 LINE 通知。

恭喜你！你已經成功建立了一個全自動的網站表單通知系統。

### 進階挑戰：如何回覆給「提交表單的使用者」本人？

我們剛剛的範例是通知「網站管理者」。但如果想在使用者提交表單後，用 LINE **回覆給使用者本人**呢？

這會遇到一個核心問題：**我們在表單中，如何取得使用者的 LINE User ID？**

這通常需要更進階的設計，這裡提供兩個主流的思路：

1.  **引導使用者加入 LINE 好友並綁定：**
    *   在網站上設計一個流程，引導使用者先加入你的 LINE 官方帳號成為好友。
    *   當使用者加入好友時，你可以透過 Webhook 取得他的 User ID，並將其與他在你網站上的會員帳號 (Email) 進行綁定 (例如存在 User Meta 中)。
    *   當這位已登入的會員提交表單時，你就能從後端取得他綁定的 User ID，並將其作為一個隱藏欄位一起提交出去，這樣 n8n 就能知道要回覆給誰了。

2.  **使用 LINE Login：**
    *   在表單頁面或網站上整合 LINE Login 功能。
    *   當使用者透過 LINE Login 登入後，你就能取得他的 LINE User ID。
    *   同樣地，你可以將這個 ID 存在一個隱藏的表單欄位中，隨表單一起提交。

這兩個方法都需要額外的開發或使用特定外掛來實現，但這也展示了 n8n 與 WordPress/LINE 整合的巨大潛力。當你能夠將網站用戶與 LINE 用戶的身份連結起來時，就能創造出非常多樣化且強大的自動化行銷應用！