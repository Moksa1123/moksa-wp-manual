# 5.5 (實作) 串接「綠界 ECPay」電子發票 (含 B2B/B2C 發票設定)

嗨，大家好！歡迎來到 MoksaWP 網站營運實戰班。我是你的導師。

在之前的課程中，我們已經成功串接了綠界的金流服務。現在，我們要來處理營運中非常重要的一環——**自動化開立電子發票**。這不僅能大幅節省你的人力與時間成本，更是符合台灣稅法規範的標準做法。

本章節將帶你一步步完成 WooCommerce 與「綠界 ECPay 電子發票」的串接設定，包含個人戶 (B2C) 與公司戶 (B2B) 的發票選項。

---

### 課前準備 (Prerequisites)

在開始之前，請確保你已經完成以下事項：

1.  **啟用綠界電子發票服務**：你必須已經登入綠界廠商後台，申請並**啟用**「電子發票」服務。這通常需要幾個工作天的審核時間。
2.  **安裝必要外掛**：
    *   `ECPay Payment Gateway for WooCommerce` (綠界金流主外掛)
    *   `ECPay Invoice for WooCommerce` (綠界電子發票外掛)
3.  **準備好 API 金鑰**：我們需要從綠界後台取得串接用的 **MerchantID**、**HashKey** 與 **HashIV**。

如果都準備好了，我們就開始吧！

### 步驟 1：取得綠界電子發票 API 金鑰

首先，我們需要登入綠界廠商後台，取得串接所需的機敏資料。

1.  登入「[綠界科技廠商管理後台](https://vendor.ecpay.com.tw/)」。
2.  在左側選單中，找到「**系統開發管理**」 > 「**系統介接設定**」。
``
3.  在這個頁面，你會看到三組非常重要的資訊：
    *   **商店代號 (MerchantID)**
    *   **介接 HashKey**
    *   **介接 HashIV**
4.  請將這三組代碼**完整複製**下來，建議先貼在一個安全的文字編輯器中備用。

> **Moksa 技巧**：**HashKey** 與 **HashIV** 是極度機密的資料，相當於你網站金流的密碼。**絕對不要**外洩給任何人，也不要用 Email 或通訊軟體傳送。

### 步驟 2：設定 WooCommerce 中的綠界發票外掛

接下來，回到你的 WordPress 後台，我們要開始設定發票外掛了。

1.  從左側選單進入「**WooCommerce**」 > 「**設定**」。
2.  點擊頁面上方的「**整合 (Integration)**」分頁。
3.  你會看到一個子選單，點擊「**綠界科技電子發票**」。
``
4.  現在，我們來逐一設定頁面上的欄位：

    *   **啟用/停用 (Enable/Disable)**：勾選「**啟用綠界科技電子發票**」。
    *   **商店代號 (MerchantID)**：貼上你從綠界後台複製的 **MerchantID**。
    *   **HashKey**：貼上你複製的 **HashKey**。
    *   **HashIV**：貼上你複製的 **HashIV**。

    ``

    *   **測試模式 (Test Mode)**：
        *   **重要觀念**：在網站尚未正式上線前，**強烈建議勾選「啟用測試模式」**。在測試模式下開立的發票**不會**真正上傳到財政部，方便你進行無限次的結帳流程測試。網站正式營運後，記得**回來取消勾選**此項。

### 步驟 3：設定 B2C 與 B2B 發票類型

這是本堂課的重點。往下捲動，你會看到「**發票設定**」區塊。這裡決定了客人在結帳頁面會看到哪些發票選項。

``

1.  **個人電子發票 (B2C)**
    *   **發票類型**：勾選你想要提供給個人消費者的選項。
    *   **Moksa 技巧**：根據我們的營運經驗，建議至少啟用以下選項，以符合大多數消費者的使用習慣：
        *   `捐贈`：讓顧客可以將發票捐給社福團體。
        *   `手機條碼`：這是目前最主流的載具。
        *   `會員載具`：系統會自動用顧客的網站 Email 作為載具，發票儲存在你的網站會員系統中。

2.  **公司戶電子發票 (B2B)**
    *   **發票類型**：勾選 `公司`。
    *   **重要觀念**：一旦你勾選了「公司」，結帳頁面就會**自動出現**「**統一編號**」與「**發票抬頭**」這兩個必填欄位，讓需要報帳的企業客戶可以順利輸入。

3.  **預設捐贈碼**：
    *   如果你啟用了「捐贈」選項，可以在此欄位填入你合作的社福團體捐贈碼。當顧客選擇捐贈但未指定對象時，系統就會使用這個預設值。

### 步驟 4：設定發票開立觸發時機

往下找到「**自動開立**」的設定區塊。

*   **觸發時機 (Trigger)**：這個設定非常關鍵，它決定了系統要在「什麼時候」自動開立發票。
*   **Moksa 技巧**：我們**強烈建議**將觸發時機設定為「**訂單狀態更新為「已完成」(Completed)**」。
    *   **為什麼？** 因為 WooCommerce 的「已完成」狀態通常代表你已經「確認收款」且「商品已出貨」。在這個時間點開立發票，可以避免後續因顧客取消訂單、付款失敗或退貨，而需要處理作廢發票的麻煩。
    *   反之，如果你設定為「處理中」，可能會發生顧客下單後立刻收到發票，但最後卻沒付款，造成後續帳務處理的困擾。

``

設定完成後，捲到頁面最下方，點擊「**儲存變更**」。

### 步驟 5：實際測試結帳流程

設定完成後，最重要的就是「**測試**」。

1.  請用瀏覽器的「無痕模式」或登出管理員帳號，模擬一般顧客的身份。
2.  前往你的商店，將任一商品加入購物車，並進入「**結帳頁面**」。
3.  在結帳表單下方，你現在應該會看到全新的「**電子發票**」區塊。
``
4.  **測試 B2C**：
    *   點選「個人 - 電子發票」。
    *   嘗試切換「手機條碼」、「會員載具」、「捐贈」等選項，確認欄位是否正常顯示。
5.  **測試 B2B**：
    *   點選「公司 - 電子發票(公司戶)」。
    *   確認「**統一編號 (必填)**」與「**公司抬頭 (必填)**」欄位是否正確出現。
``
6.  選擇一個付款方式（在測試模式下，你可以使用綠界提供的測試信用卡號），並實際下單完成一筆交易。

### 步驟 6：從後台確認發票開立狀態

完成測試訂單後，回到 WordPress 管理後台。

1.  進入「**WooCommerce**」 > 「**訂單**」，找到你剛剛建立的那筆測試訂單。
2.  手動將訂單狀態從「處理中」更改為「**已完成**」，然後點擊「**更新**」。
3.  因為我們將觸發時機設定為「已完成」，此時系統應該已經自動向綠界請求開立發票。
4.  在訂單頁面的右側欄，找到「**綠界科技電子發票**」的區塊。如果一切順利，你應該會看到系統回傳的**發票號碼**、**開立時間**與**隨機碼**。
``
5.  你也可以登入綠界的廠商後台，在「**發票管理作業**」>「**發票查詢與異動**」中，確認是否有這筆發票的開立紀錄。

---

### 總結與注意事項

恭喜你！你已經成功讓你的 WooCommerce 商店具備了自動開立 B2B/B2C 電子發票的強大功能。

最後，再次提醒幾個重點：

*   **正式上線前**：請務必回到發票設定頁面，**取消勾選「啟用測試模式」**，你的發票才會真正開立並上傳至財政部。
*   **金鑰安全**：**MerchantID**、**HashKey** 與 **HashIV** 是最高機密，請務必妥善保管。
*   **作廢與折讓**：如果遇到顧客退貨，需要作廢或開立折讓單，操作流程通常會在「綠界廠商後台」進行，而非 WordPress 後台。

透過這套自動化流程，你將能更專注於產品與行銷，把繁瑣的行政工作交給系統處理。我們下個章節見！