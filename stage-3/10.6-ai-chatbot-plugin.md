# 10.06 (實作) 打造一個「AI 聊天機器人」外掛 (串接 Gemini API)

嗨，歡迎來到 MoksaWP 的進階開發課程！在本章節中，我們將動手實作一個非常有趣且實用的專案：打造一個整合 Google Gemini API 的 AI 聊天機器人 WordPress 外掛。

這個專案不僅能讓你熟悉如何與外部 API 進行串接，還會涵蓋 WordPress 外掛開發中的幾個核心觀念，包含：建立設定頁面、使用 Shortcode (短代碼) 嵌入內容、透過 AJAX 實現前後端非同步溝通，以及最重要的——如何安全地處理 API 金鑰。

**本堂課的學習目標：**

1.  了解如何從 Google AI Studio 取得 Gemini API 金鑰。
2.  學會使用 WordPress Settings API 建立一個簡易的後台設定頁面。
3.  掌握如何透過 Shortcode 建立一個可隨處嵌入的前端聊天介面。
4.  實作 WordPress 中的 AJAX，讓前端 JavaScript 能與後端 PHP 安全地通訊。
5.  學會使用 `wp_remote_post()` 函式向 Gemini API 發送請求並處理回傳的資料。

準備好了嗎？讓我們開始吧！

---

### 前置準備

在開始之前，請確保你已經準備好以下項目：

1.  **一個 Google 帳號：** 用來申請 Gemini API 金鑰。
2.  **本機開發環境：** 我們強烈建議使用 **LocalWP**。
3.  **程式碼編輯器：** 例如 **VS Code**。

---

### 步驟 1：取得 Google Gemini API 金鑰

我們的聊天機器人需要一顆強大的「大腦」，那就是 Google Gemini。要使用它，我們必須先取得 API 金鑰 (API Key)。

1.  前往 [Google AI Studio](https://aistudio.google.com/)。
2.  使用你的 Google 帳號登入。
3.  點擊左上角的「**Get API key**」按鈕。
``
4.  在跳出的視窗中，點擊「**Create API key in new project**」。
5.  系統會立刻產生一組 API 金鑰。請**立刻複製**這組金鑰並妥善保管，因為它只會顯示這一次。我們稍後會將它儲存在 WordPress 的設定中。
``

**Moksa 技巧：** **絕對不要**將 API 金鑰直接寫在程式碼（例如 PHP 或 JavaScript 檔案）中。這是一個嚴重的安全漏洞。最好的做法是將它儲存在資料庫的 `wp_options` 資料表中，並透過後台設定頁面來管理。

---

### 步驟 2：建立外掛基本結構

現在，讓我們來建立外掛的基礎檔案。

1.  在你的 WordPress 網站的 `wp-content/plugins/` 資料夾中，建立一個新的資料夾，例如 `moksa-ai-chatbot`。
2.  在 `moksa-ai-chatbot` 資料夾中，建立一個 PHP 主檔案，例如 `moksa-ai-chatbot.php`。
3.  打開 `moksa-ai-chatbot.php`，並貼上以下的外掛標頭資訊：

```php
<?php
/**
 * Plugin Name:       Moksa AI Chatbot
 * Plugin URI:        https://moksaweb.com
 * Description:       A simple AI chatbot powered by Google Gemini API.
 * Version:           1.0.0
 * Author:            Moksa Team
 * Author URI:        https://moksaweb.com
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       moksa-ai-chatbot
 * Domain Path:       /languages
 */

// 防止直接訪問檔案
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

// 我們所有的程式碼都將會寫在這裡...
```

4.  在 WordPress 後台的「外掛」頁面，啟用「Moksa AI Chatbot」這個外掛。

---

### 步驟 3：建立設定頁面來儲存 API 金鑰

我們需要一個地方讓使用者輸入並儲存他們的 Gemini API 金鑰。這裡我們將使用 WordPress強大的 **Settings API**。

將以下程式碼加入到你的 `moksa-ai-chatbot.php` 檔案中：

```php
// 1. 新增後台選單
add_action('admin_menu', 'moksa_chatbot_add_admin_menu');
function moksa_chatbot_add_admin_menu() {
    add_options_page(
        'Moksa AI Chatbot 設定',
        'Moksa AI Chatbot',
        'manage_options',
        'moksa_ai_chatbot',
        'moksa_chatbot_options_page_html'
    );
}

// 2. 註冊設定欄位
add_action('admin_init', 'moksa_chatbot_settings_init');
function moksa_chatbot_settings_init() {
    register_setting('moksa_chatbot_settings', 'moksa_chatbot_api_key');

    add_settings_section(
        'moksa_chatbot_section_api',
        'API 金鑰設定',
        'moksa_chatbot_section_api_callback',
        'moksa_ai_chatbot'
    );

    add_settings_field(
        'moksa_chatbot_api_key_field',
        'Gemini API 金鑰',
        'moksa_chatbot_api_key_field_render',
        'moksa_ai_chatbot',
        'moksa_chatbot_section_api'
    );
}

// 3. 渲染設定頁面的 HTML
function moksa_chatbot_options_page_html() {
    if (!current_user_can('manage_options')) {
        return;
    }
    ?>
    <div class="wrap">
        <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
        <form action="options.php" method="post">
            <?php
            settings_fields('moksa_chatbot_settings');
            do_settings_sections('moksa_ai_chatbot');
            submit_button('儲存設定');
            ?>
        </form>
    </div>
    <?php
}

// 4. 渲染區塊說明文字 (可選)
function moksa_chatbot_section_api_callback() {
    echo '<p>請在此輸入您從 Google AI Studio 取得的 API 金鑰。</p>';
}

// 5. 渲染 API 金鑰的輸入欄位
function moksa_chatbot_api_key_field_render() {
    $api_key = get_option('moksa_chatbot_api_key');
    ?>
    <input type="password" name="moksa_chatbot_api_key" value="<?php echo esc_attr($api_key); ?>" size="50">
    <?php
}
```

儲存檔案後，前往 WordPress 後台的「設定」選單，你會看到一個新的子選單「**Moksa AI Chatbot**」。點擊進去，就可以看到我們剛剛建立的設定頁面了。

``

現在，將你**步驟 1** 中取得的 API 金鑰貼到輸入框中，並點擊「**儲存設定**」。你的金鑰現在已經被安全地儲存在資料庫中了。

---

### 步驟 4：建立前端聊天機器人介面 (Shortcode)

接下來，我們要建立一個 Shortcode (短代碼)，讓使用者可以在任何頁面或文章中透過輸入 `[moksa_ai_chatbot]` 來顯示聊天機器人介面。

1.  在 `moksa-ai-chatbot` 資料夾內，建立一個 `assets` 資料夾，並在其中再建立 `js` 和 `css` 兩個資料夾。
2.  在 `assets/js` 中建立 `chatbot.js` 檔案。
3.  在 `assets/css` 中建立 `chatbot.css` 檔案。

接著，將以下程式碼加入到 `moksa-ai-chatbot.php`：

```php
// 註冊 Shortcode
add_shortcode('moksa_ai_chatbot', 'moksa_chatbot_shortcode_render');

function moksa_chatbot_shortcode_render() {
    // 只有在 Shortcode 存在時才載入相關的 JS 和 CSS
    wp_enqueue_style('moksa-chatbot-css', plugin_dir_url(__FILE__) . 'assets/css/chatbot.css');
    wp_enqueue_script('moksa-chatbot-js', plugin_dir_url(__FILE__) . 'assets/js/chatbot.js', array('jquery'), '1.0.0', true);

    // 使用 wp_localize_script 將後端資料傳遞給 JavaScript (非常重要！)
    wp_localize_script('moksa-chatbot-js', 'moksa_chatbot_ajax', array(
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce'    => wp_create_nonce('moksa_chatbot_nonce')
    ));

    // 準備 Shortcode 的 HTML 輸出
    ob_start();
    ?>
    <div id="moksa-chatbot-container">
        <div id="moksa-chatbot-messages">
            <div class="moksa-chatbot-message bot">你好！我是 Moksa AI 助理，有什麼可以幫助你的嗎？</div>
        </div>
        <div id="moksa-chatbot-input-area">
            <input type="text" id="moksa-chatbot-input" placeholder="在這裡輸入訊息...">
            <button id="moksa-chatbot-send-btn">發送</button>
        </div>
    </div>
    <?php
    return ob_get_clean();
}
```

**Moksa 技巧：**
*   我們使用 `ob_start()` 和 `ob_get_clean()` 來緩衝 HTML 輸出，這是 Shortcode 函式回傳 HTML 的標準做法。
*   最重要的技巧是使用 `wp_localize_script()`。它可以在前端安全地存取後端變數，例如 `admin-ajax.php` 的 URL 和用於安全驗證的 **Nonce**，避免了將這些資訊直接寫在 JS 檔案中的風險。

現在，為你的聊天機器人添加一些基本樣式。打開 `assets/css/chatbot.css` 並貼上以下內容：

```css
#moksa-chatbot-container {
    max-width: 400px;
    margin: 20px auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    font-family: sans-serif;
}

#moksa-chatbot-messages {
    height: 300px;
    padding: 10px;
    overflow-y: auto;
    background-color: #f9f9f9;
    display: flex;
    flex-direction: column;
}

.moksa-chatbot-message {
    padding: 8px 12px;
    border-radius: 18px;
    margin-bottom: 8px;
    max-width: 80%;
    line-height: 1.4;
}

.moksa-chatbot-message.user {
    background-color: #007cba;
    color: white;
    align-self: flex-end;
}

.moksa-chatbot-message.bot {
    background-color: #e5e5ea;
    color: black;
    align-self: flex-start;
}

.moksa-chatbot-message.loading {
    background-color: #e5e5ea;
    color: #888;
    align-self: flex-start;
    font-style: italic;
}

#moksa-chatbot-input-area {
    display: flex;
    border-top: 1px solid #ddd;
}

#moksa-chatbot-input {
    flex-grow: 1;
    border: none;
    padding: 10px;
    outline: none;
}

#moksa-chatbot-send-btn {
    background-color: #007cba;
    color: white;
    border: none;
    padding: 0 20px;
    cursor: pointer;
}

#moksa-chatbot-send-btn:hover {
    background-color: #005a87;
}
```

---

### 步驟 5：撰寫 JavaScript 與 AJAX 處理

現在輪到前端的魔法了。我們要讓輸入框和按鈕動起來。打開 `assets/js/chatbot.js` 檔案，貼上以下程式碼：

```javascript
jQuery(document).ready(function($) {
    const messagesContainer = $('#moksa-chatbot-messages');
    const inputField = $('#moksa-chatbot-input');
    const sendButton = $('#moksa-chatbot-send-btn');

    // 處理發送按鈕點擊事件
    sendButton.on('click', sendMessage);

    // 處理在輸入框中按下 Enter 鍵
    inputField.on('keypress', function(e) {
        if (e.which === 13) { // 13 是 Enter 鍵的 keycode
            sendMessage();
        }
    });

    function sendMessage() {
        const userMessage = inputField.val().trim();
        if (userMessage === '') {
            return;
        }

        // 1. 在介面上顯示使用者的訊息
        appendMessage(userMessage, 'user');
        inputField.val(''); // 清空輸入框

        // 2. 顯示 "正在輸入..." 的提示
        const loadingMessage = appendMessage('AI 正在思考中...', 'loading');

        // 3. 發送 AJAX 請求到後端
        $.ajax({
            url: moksa_chatbot_ajax.ajax_url, // 來自 wp_localize_script
            type: 'POST',
            data: {
                action: 'moksa_chatbot_get_response', // 我們後端要監聽的 action
                nonce: moksa_chatbot_ajax.nonce,      // 安全驗證碼
                message: userMessage
            },
            success: function(response) {
                // 移除 "正在輸入..."
                loadingMessage.remove();
                
                if (response.success) {
                    // 顯示 AI 的回覆
                    appendMessage(response.data, 'bot');
                } else {
                    // 顯示錯誤訊息
                    appendMessage(response.data, 'bot');
                }
            },
            error: function() {
                // 移除 "正在輸入..."
                loadingMessage.remove();
                appendMessage('抱歉，發生未知錯誤，請稍後再試。', 'bot');
            }
        });
    }

    // 用來將訊息附加到聊天視窗的輔助函式
    function appendMessage(text, type) {
        const messageElement = $('<div class="moksa-chatbot-message"></div>').addClass(type).text(text);
        messagesContainer.append(messageElement);
        // 自動捲動到最下方
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
        return messageElement;
    }
});
```

這段 JS 程式碼做了幾件事：
1.  監聽「發送」按鈕和 Enter 鍵。
2.  當使用者發送訊息時，先在介面上顯示出來。
3.  發送一個 **AJAX** 請求到 WordPress 的後端。請求中包含了 `action`、`nonce` 和使用者訊息。
4.  在收到後端的回應後，將 AI 的回覆顯示在介面上。

---

### 步驟 6：建立後端 AJAX 端點並串接 Gemini API

這是最後，也是最核心的一步。我們要建立一個 PHP 函式來接收前端的 AJAX 請求，然後呼叫 Gemini API，最後將結果回傳。

將以下程式碼加入到 `moksa-ai-chatbot.php`：

```php
// 註冊 AJAX actions (一個給登入使用者，一個給未登入訪客)
add_action('wp_ajax_moksa_chatbot_get_response', 'moksa_chatbot_handle_ajax_request');
add_action('wp_ajax_nopriv_moksa_chatbot_get_response', 'moksa_chatbot_handle_ajax_request');

function moksa_chatbot_handle_ajax_request() {
    // 1. 安全性檢查：驗證 Nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'moksa_chatbot_nonce')) {
        wp_send_json_error('安全性驗證失敗！');
        return;
    }

    // 2. 取得使用者訊息
    $user_message = isset($_POST['message']) ? sanitize_text_field($_POST['message']) : '';
    if (empty($user_message)) {
        wp_send_json_error('訊息不可為空！');
        return;
    }

    // 3. 從資料庫取得 API 金鑰
    $api_key = get_option('moksa_chatbot_api_key');
    if (empty($api_key)) {
        wp_send_json_error('管理員尚未設定 API 金鑰。');
        return;
    }

    // 4. 準備並發送請求到 Gemini API
    $api_url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' . $api_key;

    $request_body = array(
        'contents' => array(
            array(
                'parts' => array(
                    array(
                        'text' => $user_message
                    )
                )
            )
        )
    );

    $args = array(
        'body'    => json_encode($request_body),
        'headers' => array(
            'Content-Type' => 'application/json',
        ),
        'timeout' => 30, // 設定 30 秒超時
    );

    // 使用 WordPress 的 HTTP API 函式來發送請求
    $response = wp_remote_post($api_url, $args);

    // 5. 處理 Gemini API 的回覆
    if (is_wp_error($response)) {
        wp_send_json_error('與 AI 服務器通訊失敗。');
        return;
    }

    $response_body = wp_remote_retrieve_body($response);
    $data = json_decode($response_body, true);

    // 從複雜的 JSON 結構中提取我們需要的文字
    $ai_reply = $data['candidates'][0]['content']['parts'][0]['text'] ?? '抱歉，我無法理解您的問題。';

    wp_send_json_success(nl2br($ai_reply)); // 使用 nl2br 讓換行符號變成 <br>
}
```

**Moksa 技巧：**
*   **安全性第一：** 我們在函式的一開始就使用 `wp_verify_nonce()` 進行驗證，確保請求是從我們的網站發出的，而不是惡意的 CSRF 攻擊。
*   **WordPress 標準函式：** 我們使用 `wp_remote_post()` 來發送外部 HTTP 請求，而不是 `curl`。這是 WordPress 的標準做法，它更安全，並且整合了 WordPress 的 HTTP 核心。
*   **標準化回覆：** 我們使用 `wp_send_json_success()` 和 `wp_send_json_error()` 來回傳 JSON 格式的資料。這會自動設定正確的 headers 並終止 PHP 執行，是處理 AJAX 的最佳實踐。

---

### 步驟 7：實際測試與總結

恭喜你！你已經完成了所有程式碼的撰寫。現在來實際測試一下：

1.  確保你已經在設定頁面儲存了你的 Gemini API 金鑰。
2.  新增一個頁面或文章。
3.  在內容編輯器中，加入我們的短代碼：`[moksa_ai_chatbot]`。
4.  發布頁面並檢視前台。
5.  你應該會看到聊天機器人的介面，試著跟它聊聊天吧！

``

**本章節重點回顧 (Moksa 技巧)：**

*   **API 金鑰管理：** 永遠使用 WordPress Options API 和設定頁面來儲存敏感資料，絕不硬編碼在檔案中。
*   **條件式資源載入：** 只在 Shortcode 被使用時才用 `wp_enqueue_script` 和 `wp_enqueue_style` 載入相關資源，這是效能優化的關鍵。
*   **安全的 AJAX：** 永遠使用 **Nonce** 來驗證 AJAX 請求的合法性，並透過 `wp_localize_script` 將 Nonce 和 ajax_url 傳遞到前端。
*   **善用 WordPress Core API：** 盡可能使用 WordPress 內建的函式，如 `wp_remote_post`、`get_option`、`sanitize_text_field` 等，它們能讓你的程式碼更安全、更穩定、更具相容性。

這個外掛雖然簡單，但它涵蓋了外掛開發的許多重要環節。你可以以此為基礎，繼續擴展它的功能，例如：
*   增加儲存對話紀錄的功能 (可以考慮使用 Custom Post Type)。
*   讓 AI 扮演特定的角色 (例如，透過修改發送給 API 的 prompt)。
*   整合 WooCommerce，讓 AI 能夠回答商品相關問題。

希望你喜歡這個實作練習！在下一個章節，我們將會探索更進階的主題。