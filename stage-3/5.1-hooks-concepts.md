# 05.01 Hooks 核心觀念 (Action vs Filter)

嗨，歡迎來到 MoksaWP 開發課程的第五章！從這個章節開始，我們將正式踏入 WordPress 開發最核心、也最迷人的領域。而這一切的基礎，都建立在一個你絕對必須精通的觀念之上：**Hooks (掛鉤)**。

在 WordPress 的世界裡，幾乎所有的外掛和佈景主題都是透過 Hooks 來與 WordPress 核心、以及其他外掛進行互動。可以說，**掌握 Hooks，你就掌握了客製化 WordPress 的鑰匙**。

今天這堂課，我們的目標很單純但極為重要：徹底搞懂 WordPress 兩種最主要的 Hooks — **Action Hooks** 與 **Filter Hooks** 之間的區別。

---

### 什麼是 Hooks？一個簡單的比喻

想像一下，WordPress 的核心程式碼就像一棟已經蓋好的大樓骨架。它有完整的樓層、樑柱和管線，定義了整棟大樓的運作流程（例如：從載入 `index.php` 到顯示文章內容）。

而 **Hooks 就是這棟大樓預先留好的「插座」和「管線接口」**。

*   **插座 (Action Hooks):** 讓你可以「插入電器」來**做一些額外的事情**。例如，在「客廳」這個位置（`wp_head`），你可以插入一盞燈 (加入一段 CSS)、一台電視 (加入一段 Google Analytics 的 JS)。你只是在那個時間點「做」一件事，並不會改變大樓本身的結構。
*   **管線接口 (Filter Hooks):** 讓你可以「串接水管」來**過濾或修改流經的物質**。例如，在「廚房水龍頭」的出水口（`the_title`），你可以串接一個濾水器，把流出來的「自來水」（文章標題）過濾成「乾淨的飲用水」（修改後的文章標題）。你改變了流過這裡的內容，然後再把它傳下去。

透過這些預留的接口，開發者就可以在不修改大樓主體結構（WordPress 核心程式碼）的前提下，安全、有彈性地擴充或修改大樓的功能。這也是為什麼我們**永遠不該去修改 WordPress 核心檔案**，因為所有事情都應該透過 Hooks 來完成。

---

### 1. Action Hooks：在「特定時間點」執行「特定動作」

**Action Hooks 的核心精神是：「Do Something. (做點什麼)」**。

它的作用是在 WordPress 執行到某個特定流程時，觸發一個信號，告訴所有正在「監聽」這個信號的函式：「嘿！現在輪到你們出場了，快執行你們該做的事吧！」

*   **觸發信號的函式：** `do_action( 'hook_name', $arg1, $arg2, ... );`
*   **監聽信號的函式：** `add_action( 'hook_name', 'your_function_name', $priority, $accepted_args );`

#### `add_action()` 參數詳解

*   `'hook_name'`: (**必填**) 你想要掛載的 Action Hook 的名稱。
*   `'your_function_name'`: (**必填**) 當這個 Action 被觸發時，你想要執行的函式名稱。
*   `$priority`: (選填) 執行的優先順序，是一個數字，預設為 `10`。**數字越小，越早執行**。如果你希望你的函式比其他同樣掛在這個 Hook 上的函式更早執行，你可以設定為 `9` 或更小。
*   `$accepted_args`: (選填) 你的函式準備接收多少個從 `do_action()` 傳過來的參數，預設為 `1`。

**重要觀念：Action Hooks 的函式通常不需要 `return` (回傳) 任何值。** 它的目的就是執行一個動作，做完就結束了。

#### 【Moksa 實戰範例】

**情境：** 我們希望當 WooCommerce 訂單狀態轉為「已完成」時，自動將訂單的詳細資訊寫入一個 log 檔案中，方便日後追蹤。這就是一個典型的「做某件事」的場景。

**步驟 1：找到合適的 Action Hook**
查閱 WooCommerce 的開發者文件，或直接在程式碼中搜尋，我們會發現 `woocommerce_order_status_completed` 這個 Action Hook 非常適合。它會在訂單狀態變為 `completed` 時被觸發，並且會傳入 `$order_id` 這個參數。

**步驟 2：撰寫我們的自訂函式**
我們可以在佈景主題的 `functions.php` 檔案，或是自訂的外掛中，加入以下程式碼：

```php
/**
 * 當訂單完成時，紀錄訂單資訊到 log 檔案中
 *
 * @param int $order_id 訂單 ID
 */
function moksa_log_completed_order( $order_id ) {
    // 檢查 $order_id 是否存在
    if ( ! $order_id ) {
        return;
    }

    // 取得訂單物件
    $order = wc_get_order( $order_id );
    
    // 如果無法取得訂單物件，就中止
    if ( ! $order ) {
        return;
    }

    // 準備要紀錄的訊息
    $log_message = sprintf(
        "訂單 #%s 已完成。總金額: %s %s\n",
        $order->get_order_number(),
        $order->get_total(),
        $order->get_currency()
    );

    // 定義 log 檔案路徑
    $log_file = WP_CONTENT_DIR . '/moksa-order-log.txt';

    // 將訊息寫入檔案 (附加模式)
    file_put_contents( $log_file, $log_message, FILE_APPEND );
}

// 將我們的函式掛載到 WooCommerce 的 Action Hook 上
// 因為我們的函式需要接收 1 個參數 ($order_id)，所以 $accepted_args 設定為 1
add_action( 'woocommerce_order_status_completed', 'moksa_log_completed_order', 10, 1 );

```

**Moksa 技巧：** 在這個範例中，我們只是簡單地寫入 log。但實際上，你可以做更複雜的事，例如：
*   呼叫外部 API，將訂單資訊傳送到 ERP 系統。
*   觸發 FluentCRM，將客戶加入一個特定的 Tag。
*   透過 OrderChatz 的 API，發送一條 LINE 訊息給管理者。

這些都是「動作」，所以都應該使用 Action Hooks。

---

### 2. Filter Hooks：在「傳遞過程中」修改「特定資料」

**Filter Hooks 的核心精神是：「Change Something. (改變點什麼)」**。

它的作用是讓資料在被使用或輸出到畫面前，先經過一道或多道「過濾程序」。每個掛載在 Filter Hook 上的函式，都可以接收傳進來的資料，對其進行修改，然後**必須**將修改後的資料 `return` (回傳) 出去，交給下一個函式處理，或是交還給 WordPress 繼續後續流程。

*   **應用過濾器的函式：** `$modified_value = apply_filters( 'hook_name', $original_value, $arg1, ... );`
*   **掛上過濾器的函式：** `add_filter( 'hook_name', 'your_function_name', $priority, $accepted_args );`

`add_filter()` 的參數用法與 `add_action()` 完全相同。

**最重要的觀念：Filter Hooks 的函式最後一定要 `return` 一個值！** 如果你忘記 `return`，就等於把資料變成 `null`，這通常會導致網站出現錯誤或非預期的行為。

#### 【Moksa 實戰範例】

**情境：** 我們希望在所有 WooCommerce 商品的標題前面，都自動加上 "【Moksa 嚴選】" 的前綴文字，以突顯品牌。這就是一個典型的「修改資料」的場景。

**步驟 1：找到合適的 Filter Hook**
我們知道要修改的是文章/商品的標題，WordPress 最常用來過濾標題的 Hook 就是 `the_title`。

**步驟 2：撰寫我們的自訂函式**
同樣地，在 `functions.php` 或自訂外掛中加入以下程式碼：

```php
/**
 * 修改文章/商品標題，加上品牌前綴
 *
 * @param string $title 原始的文章標題
 * @param int    $id    文章的 ID
 * @return string      修改後的文章標題 (必須回傳！)
 */
function moksa_add_brand_prefix_to_title( $title, $id ) {
    // 檢查目前是否在主迴圈中 (避免修改到選單、小工具等地方的標題)
    // 並且確認這是一個 product (商品)
    if ( is_singular( 'product' ) && in_the_loop() && is_main_query() ) {
        // 在原始標題前加上前綴
        return '【Moksa 嚴選】 ' . $title;
    }

    // 如果不符合我們的條件，就原封不動地回傳原始標題
    return $title;
}

// 將我們的函式掛載到 WordPress 的 Filter Hook 上
// 因為我們的函式需要接收 2 個參數 ($title, $id)，所以 $accepted_args 設定為 2
add_filter( 'the_title', 'moksa_add_brand_prefix_to_title', 10, 2 );

```
``
*示意圖：商品頁面標題成功被加上了「【Moksa 嚴選】」的前綴。*

**Moksa 技巧：** 在 Filter 函式中加入判斷條件非常重要。在上面的例子中，我們加入了 `is_singular('product')` 等判斷，確保這個修改只會發生在「單一商品頁面」的「主標題」上，而不會影響到網站其他地方（如側邊欄的「最新商品」小工具）的標題，讓修改更精準。

---

### 總結：Action vs. Filter 的終極對比

為了讓你更深刻地記住兩者的區別，這裡提供一個快速對照表：

| 特性 | Action Hook | Filter Hook |
| :--- | :--- | :--- |
| **主要目的** | **執行**一個動作 (Do Something) | **修改**一個資料 (Change Something) |
| **回傳值** | **不需要** `return` | **必須要** `return` 修改後的值 |
| **核心函式** | `do_action()` / `add_action()` | `apply_filters()` / `add_filter()` |
| **比喻** | 鬧鐘、廣播、事件通知 | 濾水器、加工廠、翻譯機 |
| **使用時機** | 發送 Email、寫入 log、呼叫 API、載入 JS/CSS | 修改文章內容、更改商品價格、變更 CSS class、自訂麵包屑 |

### 課程作業與思考

1.  **思考一下：** 如果你想在使用者註冊成功後，自動發送一封自訂的歡迎 Email，你應該使用 Action Hook 還是 Filter Hook？你會去尋找哪個關鍵字的 Hook？ (提示：`user_register`)
2.  **動手做：** 嘗試使用 `woocommerce_sale_price_html` 這個 Filter Hook，將特價商品的價格顯示格式從 `$100 $80` 修改為 `$80 (原價 $100)` 的格式。

理解 Action 和 Filter 是成為一位合格 WordPress 開發者的第一步，也是最重要的一步。在接下來的課程中，我們將會大量地使用這兩種 Hooks 來打造屬於我們自己的強大功能。請務必花時間消化、練習，將這個觀念內化成你的直覺！