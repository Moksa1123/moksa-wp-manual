# 10.04 (實務) (Gemini/Claude) 幫您除錯 (Debug)

嗨，各位 Moksa 的開發者夥伴！

歡迎來到佈景主題與外掛開發課程中最真實、也最刺激的一環：**除錯 (Debugging)**。寫程式的過程，有 20% 的時間在創造，而 80% 的時間可能都在尋找那個讓你百思不得其解的 Bug。這堂課，我們將學習如何結合傳統的 WordPress 除錯技巧與現代強大的 AI 工具 (如 Google Gemini 或 Anthropic Claude)，讓你成為一個更有效率、更聰明的除錯專家。

**學習目標：**
1.  掌握 WordPress 核心的除錯設定。
2.  學會使用 `Query Monitor` 快速定位問題。
3.  精通向 AI (Gemini/Claude) 提問的藝術，獲得高品質的解決方案。
4.  透過實戰案例，演練從發現錯誤到解決問題的完整流程。

---

### Part 1: 傳統但必要的除錯基礎

在我們召喚 AI 大神之前，必須先打好馬步。學會如何讓 WordPress「開口說話」，告訴我們它哪裡痛，是除錯的第一步。

#### 步驟 1: 開啟 WordPress 內建除錯模式

WordPress 內建了一套除錯系統，我們只需要在 `wp-config.php` 檔案中開啟它即可。這個檔案位於您網站的根目錄。

1.  使用 VS Code 或任何程式碼編輯器，打開 `wp-config.php` 檔案。
2.  找到 `/* That's all, stop editing! Happy publishing. */` 這行註解。
3.  在**這行註解的上方**，加入或修改以下程式碼：

```php
// 開啟除錯模式
define( 'WP_DEBUG', true );

// 將錯誤訊息寫入日誌檔案，而不是直接顯示在畫面上
if ( WP_DEBUG ) {
    define( 'WP_DEBUG_DISPLAY', false );
    define( 'WP_DEBUG_LOG', true );
}
```

*   `define( 'WP_DEBUG', true );`：這是總開關，會開啟 WordPress 的除錯模式。
*   `define( 'WP_DEBUG_DISPLAY', false );`：**Moksa 技巧**，這非常重要！我們**不希望**網站前台直接把錯誤訊息顯示給訪客看，這很不專業也不安全。將它設為 `false`。
*   `define( 'WP_DEBUG_LOG', true );`：這會將所有的 PHP 錯誤、警告 (Warning) 和通知 (Notice) 全部記錄到一個名為 `debug.log` 的檔案中。

4.  儲存 `wp-config.php` 檔案。現在，當網站有任何問題時，錯誤訊息會自動記錄到 `/wp-content/debug.log` 這個檔案裡。你隨時可以打開這個檔案，查看詳細的錯誤報告。

#### 步驟 2: 安裝與善用 Query Monitor

如果說 `debug.log` 是網站的健康檢查報告，那麼 `Query Monitor` 就是隨身攜帶的聽診器。它是所有 WordPress 開發者必備的神器。

1.  到 WordPress 後台 > **外掛** > **安裝外掛**，搜尋「Query Monitor」並安裝啟用。
2.  啟用後，您會在頂部的管理工具列看到一串新的數據。

``

`Query Monitor` 可以幫助我們：
*   **查看 PHP 錯誤：** 任何的 Notice, Warning, Fatal Error 都會在這裡即時顯示，比查看 `debug.log` 更快。
*   **分析資料庫查詢：** 檢查哪些查詢花了最久時間 (Slow Queries)，或者是否有重複的查詢 (Duplicate Queries)，是效能優化的關鍵。
*   **檢視掛鉤與動作 (Hooks & Actions)：** 查看目前頁面觸發了哪些 `action` 和 `filter`，以及它們的執行順序。
*   **檢查載入的腳本與樣式：** 查看是哪個外掛或主題載入了哪些 CSS 和 JavaScript 檔案。

**Moksa 技巧：** 在開發時，請**永遠保持 `Query Monitor` 啟用**。很多潛在的問題，例如 PHP Notice，雖然不會讓網站立刻掛掉，但都是不良程式碼的警訊，應該在開發階段就全部清除。

---

### Part 2: 讓 AI 成為你的除錯夥伴

當我們透過 `debug.log` 或 `Query Monitor` 找到錯誤訊息後，有時候光看訊息還是不知道問題出在哪裡。這就是 AI 登場的最佳時機！

但請記住：**AI 的回答品質，取決於你提問的品質。**

#### 步驟 3: 撰寫「高品質」的 AI 除錯提示 (Prompt)

一個好的除錯提示，應該包含以下四個核心要素：

1.  **提供完整情境 (Context):**
    *   **你的目標是什麼？** (e.g., "我正在寫一個 WooCommerce 的功能，希望在使用者將商品加入購物車時，自動新增一個 50 元的包裝費。")
    *   **你的環境是什麼？** (e.g., "我使用 WordPress 6.4, WooCommerce 8.5, PHP 8.1。")
    *   **Moksa 技巧：** 如果問題跟特定外掛有關，務必提及，例如 "我使用了 Advanced Custom Fields (ACF) 建立了一個欄位..."。

2.  **貼上精確的錯誤訊息 (Error Message):**
    *   **完整複製貼上**從 `debug.log` 或 `Query Monitor` 看到的錯誤訊息。不要自己手動打字或摘要。
    *   例如：`PHP Fatal error: Uncaught Error: Call to a member function get_price() on bool in /var/www/html/wp-content/themes/my-theme/functions.php:123`

3.  **附上相關的程式碼片段 (Code Snippet):**
    *   將造成錯誤的**整個函式 (function)** 都貼上來，而不只是錯誤的那一行。AI 需要上下文才能理解程式碼的邏輯。
    *   使用 Markdown 的程式碼區塊 (```php ... ```) 來包覆程式碼，讓 AI 更容易閱讀。

4.  **描述你已嘗試過的解法 (What You've Tried):**
    *   告訴 AI 你已經做了哪些嘗試。這能避免它給你重複且無效的建議。
    *   例如："我已經試過用 `var_dump()` 去檢查變數，發現它回傳了 `null`，但我不懂為什麼。"

---

### Part 3: 實戰演練

現在，讓我們用兩個常見的案例，來實際演練如何結合傳統方法與 AI 進行除錯。

#### 範例一：解決 PHP Fatal Error

*   **情境：** 你想在 `functions.php` 寫一段程式碼，當購物車內商品總價超過 1000 元時，就免運費。
*   **你的程式碼：**
    ```php
    add_filter( 'woocommerce_package_rates', 'moksa_hide_shipping_when_free_is_available', 100 );

    function moksa_hide_shipping_when_free_is_available( $rates ) {
        $free = array();
        foreach ( $rates as $rate_id => $rate ) {
            // 只處理 'free_shipping' 的運送方式
            if ( 'free_shipping' === $rate->method_id ) {
                $free[ $rate_id ] = $rate;
                break;
            }
        }
        // 如果購物車總額大於 1000 且有免運選項，就只回傳免運
        if ( WC()->cart->get_total() > 1000 && ! empty( $free ) ) {
            return $free;
        }

        return $rates;
    }
    ```
*   **問題：** 網站前端出現白畫面 (White Screen of Death)，`Query Monitor` 或 `debug.log` 顯示了錯誤。
*   **錯誤訊息：** `PHP Fatal error: Uncaught Error: Call to a member function get_total() on null in /.../functions.php on line 12`

##### 除錯流程：

1.  **分析錯誤：** 錯誤訊息說 `get_total()` 這個函式被用在一個 `null` 的東西上了。這代表 `WC()->cart` 在某個時間點是 `null`，也就是說購物車物件還沒被初始化。
2.  **建構 AI 提示：**

    ``
    ```text
    你好，我是一位 WordPress/WooCommerce 開發者。

    # 我的目標
    我想要實作一個功能：當 WooCommerce 購物車總金額超過 1000 元時，就自動套用免運費，並隱藏其他運費選項。

    # 我的環境
    - WordPress 6.4
    - WooCommerce 8.5
    - PHP 8.1

    # 我的程式碼 (位於 functions.php)
    ```php
    add_filter( 'woocommerce_package_rates', 'moksa_hide_shipping_when_free_is_available', 100 );

    function moksa_hide_shipping_when_free_is_available( $rates ) {
        $free = array();
        foreach ( $rates as $rate_id => $rate ) {
            if ( 'free_shipping' === $rate->method_id ) {
                $free[ $rate_id ] = $rate;
                break;
            }
        }
        // 如果購物車總額大於 1000 且有免運選項，就只回傳免運
        if ( WC()->cart->get_total() > 1000 && ! empty( $free ) ) {
            return $free;
        }

        return $rates;
    }
    ```

    # 錯誤訊息
    我遇到了這個 PHP Fatal error:
    `PHP Fatal error: Uncaught Error: Call to a member function get_total() on null in /.../functions.php on line 12`
    (第 12 行是 `if ( WC()->cart->get_total() > 1000 && ! empty( $free ) )`)

    # 我的嘗試
    我猜測可能是 `WC()->cart` 在這個 filter hook 執行的時候還不存在，但我不太確定為什麼，以及該如何修正。

    請幫我分析問題的原因，並提供修正後的程式碼。
    ```

3.  **AI 可能的回應與分析：**
    一個好的 AI 模型可能會告訴你：
    > "這個錯誤發生是因為 `woocommerce_package_rates` 這個 filter hook 在某些情境下（例如後台或 REST API 請求）執行時，購物車物件（`WC()->cart`）尚未被完全載入，因此會回傳 `null`。直接呼叫 `get_total()` 就會導致致命錯誤。
    >
    > **一個更安全的作法是先檢查 `WC()->cart` 是否存在且不是 `null`。** 另外，`get_total()` 回傳的是一個包含 HTML 標籤的格式化價格字串，不適合做數字比較。你應該使用 `WC()->cart->get_cart_contents_total()` 來取得純數字的商品總價。
    >
    > 這裡是修正後的程式碼："

    ```php
    add_filter( 'woocommerce_package_rates', 'moksa_hide_shipping_when_free_is_available', 100 );

    function moksa_hide_shipping_when_free_is_available( $rates ) {
        // **Moksa 技巧：永遠在使用物件前先檢查它是否存在**
        if ( ! is_null( WC()->cart ) ) {
            $free = array();
            foreach ( $rates as $rate_id => $rate ) {
                if ( 'free_shipping' === $rate->method_id ) {
                    $free[ $rate_id ] = $rate;
                    break;
                }
            }
            
            // 使用 get_cart_contents_total() 來做數字比較
            if ( WC()->cart->get_cart_contents_total() > 1000 && ! empty( $free ) ) {
                return $free;
            }
        }

        return $rates;
    }
    ```
    這個回應不僅修正了錯誤，還教了你一個更穩健的開發習慣和正確的 API 使用方法。

---

### 總結：AI 除錯的思維模式

AI 是一個強大的副駕駛，但方向盤仍然在你手中。請建立以下心態：

*   **AI 是加速器，不是萬靈丹：** 它可以快速提供可能的解決方向，但最終的判斷和決策者是你。
*   **驗證與測試：** **永遠不要**直接複製 AI 產生的程式碼貼到你的正式站。務必在 **LocalWP** 或 Staging 環境中進行完整測試，確保它能如預期般運作，且沒有產生新的副作用。
*   **這是一個學習機會：** 當 AI 提出一個你沒見過的函式或概念時（例如上面例子中的 `get_cart_contents_total()`），花點時間去 WooCommerce 官方文件查證它的用途。這是精進自己技術的絕佳機會。
*   **注意資訊安全：** 在你的提示中，**絕對不要**貼上任何敏感資訊，例如資料庫連線字串、API 金鑰、客戶資料等。

現在，你已經掌握了結合經典工具與前沿 AI 的除錯流程。動手去解決那些惱人的 Bug 吧！Happy debugging！