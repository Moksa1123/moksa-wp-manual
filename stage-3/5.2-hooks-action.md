# 05.02 (實作) add_action (在特定時間點「執行」)

嗨，各位 Moksa 的開發者們！歡迎來到 WordPress 開發的核心領域。今天我們要學習的 `add_action()`，可以說是整個 WordPress 生態系中**最重要、也最基礎**的函式之一。

如果你想讓你的佈景主題或外掛「動起來」，在 WordPress 運行的某個特定時間點去執行你指定的任務，那麼 `add_action()` 就是你的鑰匙。它就像是 WordPress 預留給我們的「插座」，讓我們可以把自己的功能「插」上去，而不需要去修改 WordPress 的核心程式碼。

---

### 什麼是動作鉤點 (Action Hooks)？

在我們開始寫程式碼之前，你必須先理解一個核心觀念：「**鉤點 (Hooks)**」。

WordPress 的核心程式在執行的過程中，會在許多關鍵的時間點「廣播」一個訊息，例如：「嘿！我現在正準備要載入網站的頁首 (`<head>`) 了喔！」或者「嘿！有一筆 WooCommerce 訂單剛剛完成了！」。

這些「廣播點」就稱為**動作鉤點 (Action Hooks)**。而我們的 `add_action()` 函式，作用就是去「監聽」這些廣播，一旦監聽到我們指定的廣播 (鉤點)，就立刻執行我們寫好的函式 (Callback Function)。

這種機制讓 WordPress 變得**極度靈活且可擴充**，也是為什麼整個生態系能有數萬個外掛可以共存的原因。

---

### `add_action()` 函式詳解

`add_action()` 的基本語法結構如下：

```php
add_action( string $hook_name, callable $callback_function, int $priority = 10, int $accepted_args = 1 );
```

讓我們來拆解這四個參數：

1.  `$hook_name` (字串, **必填**):
    *   **說明：** 你想要掛勾的「動作鉤點」的名稱。例如 `wp_head`, `wp_footer`, `init` 等。
    *   **Moksa 技巧：** 如何找到這些鉤點名稱？你可以查閱 [WordPress Developer Resources](https://developer.wordpress.org/reference/hooks/)，或是在 WordPress/WooCommerce 核心檔案中搜尋 `do_action('...')`。

2.  `$callback_function` (函式名稱, **必填**):
    *   **說明：** 當指定的 `$hook_name` 觸發時，你想要執行的函式名稱。這個函式是你自己定義的。
    *   **Moksa 技巧：** 為了避免和 WordPress 核心或其他外掛的函式名稱衝突，強烈建議你的函式名稱要加上**專屬的前綴**，例如 `moksa_my_awesome_function`。

3.  `$priority` (整數, 選填):
    *   **說明：** 執行優先級，預設值是 `10`。這個數字**越小，代表越早執行**。如果有多個函式掛在同一個鉤點上，WordPress 就會依照這個數字的順序來執行它們。
    *   **範例：** 如果你想確保你的功能在所有其他外掛之後才執行，你可以把 `priority` 設定成一個很大的數字，例如 `99`。

4.  `$accepted_args` (整數, 選填):
    *   **說明：** 你的回呼函式 (`$callback_function`) 準備接收幾個「參數 (Arguments)」，預設值是 `1`。
    *   **重要觀念：** 某些鉤點在觸發時，會同時「傳遞」一些有用的資訊過來，例如 `save_post` 鉤點會傳遞 `post_id`。如果你的函式需要接收這些資訊，你就必須把這個參數設定成對應的數量。

---

### 實作一：在網站頁尾 (Footer) 加上一行版權宣告

這是一個最經典的入門範例。我們的目標是在每個頁面的 `</body>` 標籤前，自動加上一行 Moksa 的版權宣告文字。

**步驟 1：打開你的程式碼編輯器 (VS Code)**

我們將把程式碼加在子佈景主題的 `functions.php` 檔案中。這是一個**最佳實踐**，可以確保在主佈景主題更新後，你的客製化程式碼不會消失。

**步驟 2：撰寫你的回呼函式與 `add_action`**

在 `functions.php` 的最下方，加入以下 PHP 程式碼：

```php
/**
 * 在網站頁尾加入 Moksa 版權宣告
 * 這是我們的回呼函式 (Callback Function)
 */
function moksa_add_copyright_in_footer() {
    // 準備要輸出的 HTML 文字
    $copyright_text = '<p style="text-align: center; color: #777;">&copy; ' . date('Y') . ' Moksa Inc. All Rights Reserved.</p>';

    // 使用 echo 輸出
    echo $copyright_text;
}

/**
 * 將我們的函式掛到 'wp_footer' 這個鉤點上
 * 'wp_footer' 是 WordPress 在 </body> 標籤前會觸發的標準鉤點
 */
add_action( 'wp_footer', 'moksa_add_copyright_in_footer' );
```

**步驟 3：儲存檔案並查看結果**

儲存 `functions.php` 檔案後，回到你的網站前台，重新整理頁面。你會發現在頁面的最下方出現了我們剛剛加入的版權宣告文字。

``
*（示意圖：網站前台頁尾出現了 "© 2024 Moksa Inc. All Rights Reserved." 的文字）*

---

### 實作二：(Moksa 進階) 當 WooCommerce 訂單完成時，寫入一筆 Log 紀錄

現在，讓我們來做一個更貼近我們 Moksa 技術棧的實務範例。

**情境：** 當任何一筆訂單的狀態被後台管理者手動或透過金流（如綠界 ECPay）自動更新為「**已完成 (Completed)**」時，我們希望系統自動在伺服器的 `debug.log` 檔案中記錄這筆訂單的 ID 和完成時間。這在未來追蹤問題或數據分析時非常有用。

**步驟 1：啟用 WordPress 的除錯模式**

首先，我們需要讓 WordPress 可以寫入 Log。請打開你網站根目錄的 `wp-config.php` 檔案，找到 `WP_DEBUG` 並修改/新增以下設定：

```php
define( 'WP_DEBUG', true ); // 開啟除錯模式
define( 'WP_DEBUG_LOG', true ); // 允許將錯誤/訊息寫入 /wp-content/debug.log
define( 'WP_DEBUG_DISPLAY', false ); // 不要在畫面上顯示錯誤，這很重要！
@ini_set( 'display_errors', 0 );
```

**Moksa 技巧：** 在 LocalWP 環境中，你可以直接在網站控制台點擊 "Open site shell"，然後使用 `wp config set WP_DEBUG_LOG true` 這類 WP-CLI 指令來快速設定。

**步驟 2：撰寫回呼函式與 `add_action`**

同樣在 `functions.php` 中，加入以下程式碼：

```php
/**
 * 當 WooCommerce 訂單狀態變為 'completed' 時觸發
 *
 * @param int $order_id 訂單 ID
 */
function moksa_log_when_order_completed( $order_id ) {
    // 檢查 $order_id 是否存在，確保程式穩定
    if ( ! $order_id ) {
        return;
    }

    // 透過訂單 ID 取得 WooCommerce 訂單物件
    $order = wc_get_order( $order_id );

    // 如果無法取得訂單物件，就直接結束函式
    if ( ! $order ) {
        return;
    }
    
    // 準備要記錄的訊息
    $log_message = sprintf(
        '訂單 #%d 已於 %s 完成。顧客 Email: %s',
        $order->get_id(), // 取得訂單 ID
        current_time('mysql'), // 取得當前 WordPress 設定的時區時間
        $order->get_billing_email() // 取得顧客的帳單 Email
    );

    // 使用 error_log() 將訊息寫入 debug.log
    error_log( $log_message );
}

/**
 * 將我們的函式掛到 'woocommerce_order_status_completed' 鉤點上
 * 這個鉤點是 WooCommerce 專屬的，當訂單狀態轉為 'completed' 時觸發
 *
 * 注意：這個鉤點會傳遞一個 $order_id 參數給我們的函式，
 * 所以 add_action 的第四個參數 ($accepted_args) 必須設定為 1。
 */
add_action( 'woocommerce_order_status_completed', 'moksa_log_when_order_completed', 10, 1 );
```

**步驟 3：測試流程**

1.  前往 `WooCommerce` -> `訂單`。
2.  找到一筆「處理中」的訂單，點進去編輯。
3.  將「**訂單狀態**」手動修改為「**已完成**」。
4.  點擊右側的「**更新**」按鈕。

``
*（示意圖：在 WooCommerce 訂單編輯頁面，將訂單狀態下拉選單改為「已完成」）*

**步驟 4：檢查 Log 檔案**

此時，你可以透過 FTP 或 LocalWP 的 "Open site shell" 功能，查看 `wp-content/debug.log` 這個檔案。你應該會看到類似下面這樣一行新的紀錄：

```log
[dd-Mon-YYYY hh:mm:ss UTC] 訂單 #12345 已於 2024-05-20 14:30:00 完成。顧客 Email: customer@example.com
```

恭喜你！你已經成功地利用 `add_action` 串連了 WooCommerce 的核心事件，並執行了你的客製化功能。從這裡出發，你可以將 `error_log()` 替換成任何你需要的商業邏輯，例如：

*   發送一封客製化的感謝 Email。
*   透過 API 將訂單資料傳送到外部的 CRM 系統 (如 FluentCRM)。
*   觸發 OrderChatz 發送 LINE 通知給管理者。
*   給予購買此訂單的會員 YITH 會員資格或點數。

`add_action` 的可能性是無窮的，它正是所有 WordPress 強大功能的基石。請務必熟悉並掌握它！