# 09.05 (實務) Block 的進階設定 (InspectorControls, RichText)

嗨，各位 Moksa 的學員，大家好！我是你們的導師。

在前面的章節中，我們已經學會了如何使用 `@wordpress/create-block` 指令來快速建立一個區塊的基本結構。然而，一個真正實用的區塊，不應該只是靜態地顯示內容。它必須讓使用者（例如網站編輯）能夠**自由地輸入文字**，並且在**側邊欄提供各種設定選項**，例如對齊方式、顏色、間距等等。

今天這堂課，我們將深入探討兩個 Gutenberg 開發中最核心的元件：`RichText` 和 `InspectorControls`。它們分別負責「區塊內的即時編輯」與「右側邊欄的設定面板」，是打造優質編輯體驗的基石。

---

### 學習目標

*   掌握使用 `RichText` 元件，讓使用者可以直接在區塊中編輯文字。
*   學會使用 `InspectorControls` 在右側邊欄建立設定面板。
*   了解如何結合 `@wordpress/components` 套件中的元件（如 `PanelBody`, `SelectControl`, `ColorPalette`）來豐富設定選項。
*   實作出一個可以自訂文字內容、對齊方式、文字顏色的動態區塊。

### 前置準備

在開始之前，請確認你已經：

1.  使用 **LocalWP** 建立了一個本地 WordPress 測試站。
2.  使用 `npx @wordpress/create-block moksa-advanced-block` 指令建立了一個新的區塊。
3.  使用 **VS Code** 開啟了該外掛的資料夾。
4.  在終端機中，進入外掛目錄並執行 `npm start`，讓開發環境處於監聽模式。

---

### 步驟 1：認識 `RichText` - 實現所見即所得的編輯

`RichText` 是由 `@wordpress/block-editor` 套件提供的一個 React 元件，它能讓我們在區塊中建立一個類似傳統編輯器的區域，讓使用者可以直接輸入文字、設定粗體、斜體等。

我們的目標是將預設的靜態 `<p>` 段落，改造成一個可編輯的區域。

#### 1.1 在 `block.json` 中定義屬性 (Attribute)

首先，我們需要一個地方來儲存使用者輸入的內容。在 Gutenberg 中，這個儲存單位就是 **Attribute**。

打開 `src/block.json`，找到 `attributes` 物件，我們來新增一個名為 `content` 的屬性。

```json
{
  "$schema": "https://schemas.wp.org/trunk/block.json",
  "apiVersion": 3,
  "name": "create-block/moksa-advanced-block",
  "version": "0.1.0",
  // ... 其他設定 ...
  "attributes": {
    "content": {
      "type": "string",
      "source": "html",
      "selector": "p"
    }
  },
  // ... 其他設定 ...
}
```

**Moksa 技巧：**
*   `"type": "string"`：定義這個屬性儲存的資料類型是字串。
*   `"source": "html"`：告訴 WordPress 從 HTML 中提取資料。
*   `"selector": "p"`：指定 WordPress 從 `p` 這個 HTML 標籤中去尋找要儲存的內容。這個 `selector` 必須與我們在 `save.js` 中渲染的標籤一致。

#### 1.2 修改 `edit.js` 使用 `RichText` 元件

接下來，我們要修改編輯器畫面的呈現。打開 `src/edit.js`。

```javascript
// 1. 從 @wordpress/block-editor 引入 RichText
import { useBlockProps, RichText } from '@wordpress/block-editor';
import { __ } from '@wordpress/i18n';
import './editor.scss';

export default function Edit({ attributes, setAttributes }) {
  // 2. 從 attributes 中解構出 content
  const { content } = attributes;

  // 3. 建立一個更新 content 的函式
  const onChangeContent = (newContent) => {
    setAttributes({ content: newContent });
  };

  return (
    // 4. 將原本的 <p> 換成 <RichText> 元件
    <RichText
      {...useBlockProps()}
      tagName="p" // 指定渲染的 HTML 標籤
      value={content} // 將屬性值綁定到元件上
      onChange={onChangeContent} // 當內容改變時，呼叫更新函式
      placeholder={__('請在此輸入內容...', 'moksa-advanced-block')} // 預設提示文字
    />
  );
}
```

#### 1.3 修改 `save.js` 來儲存內容

編輯器畫面改好了，我們還需要告訴 WordPress 如何將 `content` 屬性的內容儲存到資料庫中。

打開 `src/save.js`。

```javascript
// 1. 從 @wordpress/block-editor 引入 RichText
import { useBlockProps, RichText } from '@wordpress/block-editor';

export default function save({ attributes }) {
  // 2. 從 attributes 中解構出 content
  const { content } = attributes;
  const blockProps = useBlockProps.save();

  // 3. 使用 RichText.Content 來顯示儲存的內容
  //    這是一個靜態元件，只負責渲染，沒有編輯功能
  return (
    <RichText.Content
      {...blockProps}
      tagName="p"
      value={content}
    />
  );
}
```

現在，回到你的 WordPress 編輯器，重新整理頁面並插入你的「Moksa Advanced Block」。你會發現原本的靜態文字不見了，取而代之的是一個可以讓你自由輸入文字的區塊！

``
*(截圖：一個可編輯的區塊，顯示著「請在此輸入內容...」的提示文字)*

---

### 步驟 2：使用 `InspectorControls` 打造側邊欄設定

光能輸入文字還不夠，我們希望能控制它的外觀，例如**對齊方式**。這就要用到 `InspectorControls` 了。

`InspectorControls` 也是 `@wordpress/block-editor` 提供的元件，它本身是一個容器。我們放進去的任何東西，都會被渲染到編輯器右邊的「區塊」設定面板中。

#### 2.1 在 `block.json` 新增 `alignment` 屬性

跟剛才一樣，先定義一個屬性來儲存對齊設定。

打開 `src/block.json`，在 `attributes` 中新增 `alignment`。

```json
"attributes": {
  "content": {
    "type": "string",
    "source": "html",
    "selector": "p"
  },
  "alignment": {
    "type": "string",
    "default": "none"
  }
}
```

**Moksa 技巧：** 這裡我們給 `alignment` 一個 `"default": "none"` 的預設值，避免在第一次插入區塊時，因為沒有值而出錯。

#### 2.2 修改 `edit.js` 加入設定面板

現在回到 `src/edit.js`，我們要進行比較大的改造。

```javascript
import { __ } from '@wordpress/i18n';
// 1. 引入 InspectorControls 和其他需要的元件
import { useBlockProps, RichText, InspectorControls, BlockControls, AlignmentToolbar } from '@wordpress/block-editor';
import { PanelBody, SelectControl } from '@wordpress/components'; // PanelBody 用來建立可收合的區塊
import './editor.scss';

export default function Edit({ attributes, setAttributes }) {
  // 2. 解構出新的屬性
  const { content, alignment } = attributes;

  // 3. 建立對應的更新函式
  const onChangeContent = (newContent) => {
    setAttributes({ content: newContent });
  };

  const onChangeAlignment = (newAlignment) => {
    setAttributes({ alignment: newAlignment });
  };
  
  // 4. 更新 blockProps，將對齊的 class 加入
  const blockProps = useBlockProps({
    className: `has-text-align-${alignment}`,
  });

  return (
    <>
      {/* 5. 建立 InspectorControls 區塊 */}
      <InspectorControls>
        {/* PanelBody 提供一個漂亮的、可收合的 UI */}
        <PanelBody title={__('對齊設定', 'moksa-advanced-block')}>
          {/* 這是一個下拉選單元件 */}
          <SelectControl
            label={__('文字對齊', 'moksa-advanced-block')}
            value={alignment}
            options={[
              { label: __('無', 'moksa-advanced-block'), value: 'none' },
              { label: __('置左', 'moksa-advanced-block'), value: 'left' },
              { label: __('置中', 'moksa-advanced-block'), value: 'center' },
              { label: __('置右', 'moksa-advanced-block'), value: 'right' },
            ]}
            onChange={onChangeAlignment}
          />
        </PanelBody>
      </InspectorControls>
      
      {/* (可選) Moksa 技巧：同時也提供工具列的對齊選項，體驗更好！ */}
      <BlockControls>
        <AlignmentToolbar
          value={alignment}
          onChange={onChangeAlignment}
        />
      </BlockControls>
      
      {/* 6. 將更新後的 blockProps 傳給 RichText */}
      <RichText
        {...blockProps} // 注意這裡的改變
        tagName="p"
        value={content}
        onChange={onChangeContent}
        placeholder={__('請在此輸入內容...', 'moksa-advanced-block')}
      />
    </>
  );
}
```

**重點解析：**
*   我們使用了 `<>` (React Fragment) 來包裹多個最外層的元件。
*   `InspectorControls` 內部的 `PanelBody` 和 `SelectControl` 都是從 `@wordpress/components` 來的，這是 WordPress 官方的 UI 元件庫。
*   我們透過 `useBlockProps` 將 `has-text-align-left` 這類的 class name 動態加到區塊上。WordPress 核心已經內建了這些 class 的 CSS，所以我們不需要自己寫。
*   **Moksa 技巧：** `BlockControls` 可以讓我們在區塊上方的工具列也新增控制選項，`AlignmentToolbar` 就是一個預設的對齊工具列，這能提供更直覺的操作體驗。

#### 2.3 修改 `save.js` 以儲存對齊樣式

最後，別忘了更新 `save.js`，讓它也能夠把對齊的 class name 存到前端。

```javascript
import { useBlockProps, RichText } from '@wordpress/block-editor';

export default function save({ attributes }) {
  const { content, alignment } = attributes;
  
  // 將 alignment class 加入 blockProps
  const blockProps = useBlockProps.save({
    className: `has-text-align-${alignment}`,
  });

  return (
    <RichText.Content
      {...blockProps} // 將帶有 class 的 props 傳下去
      tagName="p"
      value={content}
    />
  );
}
```

回到編輯器，重新整理後插入你的區塊。你會看到右邊的設定欄出現了「對齊設定」的面板！

``
*(截圖：右側邊欄出現了「對齊設定」面板，裡面有一個下拉選單可以選擇置左、置中、置右)*

當你切換下拉選單時，區塊內的文字就會即時改變對齊方式。儲存文章後，前台也會顯示正確的對齊效果。

---

### 總結與 Moksa 技巧回顧

恭喜你！你已經掌握了 Gutenberg 區塊開發中最重要的兩個概念，並打造了一個真正具有互動性的客製化區塊。

讓我們回顧一下今天的重點：

1.  **資料驅動 (Data-Driven)：** 任何需要變動或儲存的設定，都應該先在 `block.json` 中定義一個 **Attribute**。這是 Gutenberg 開發的核心思想。
2.  **`RichText` 負責內容：** 當你需要讓使用者在區塊內「所見即所得」地編輯文字時，`RichText` 就是你的最佳選擇。
3.  **`InspectorControls` 負責設定：** 所有不適合直接在區塊上操作的「設定」，都應該放在 `InspectorControls` 中，它會將你的設定 UI 渲染到右側邊欄。
4.  **善用 WordPress 元件庫：** `@wordpress/components` 提供了大量現成的 UI 元件（如 `PanelBody`, `SelectControl`, `ColorPalette`, `ToggleControl` 等），直接使用它們可以確保你的區塊設定介面與 WordPress 核心風格一致，也能大幅節省開發時間。
5.  **`edit` 與 `save` 的同步：** 在 `edit.js` 中新增的功能，一定要記得在 `save.js` 中做對應的修改，確保後台的編輯效果能夠正確地儲存到前台。

在接下來的課程中，我們將會探索更多 `@wordpress/components` 中的元件，並學習如何製作更複雜、更強大的區塊。繼續加油！