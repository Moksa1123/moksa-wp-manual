# 03.06 (實作) WordPress 資料庫操作 ($wpdb)

嗨，歡迎來到 MoksaWP 的開發課程！在前面的章節中，我們已經了解了 WordPress 的底層架構。今天，我們將深入核心，學習如何直接與 WordPress 資料庫進行溝通。這項技能對於開發複雜功能、自訂報表或與其他系統整合至關重要。

我們要學習的主角是 WordPress 提供的一個全域物件 (Global Object)：`$wpdb`。

---

### 什麼是 $wpdb？為什麼要用它？

`$wpdb` 是 WordPress 提供的一個**資料庫抽象層 (Database Abstraction Layer)**。簡單來說，它是一個專門用來安全、方便地執行資料庫查詢的工具。

你可能會想：「我懂 PHP 和 SQL，為什麼不直接用 `mysqli_query()` 或 `PDO` 就好？」

**Moksa 技巧：** 永遠、永遠不要在 WordPress 中直接使用原生的 PHP 資料庫函式。請務必使用 `$wpdb`，理由如下：

1.  **安全性 (Security):** `$wpdb` 內建了防禦 **SQL 注入 (SQL Injection)** 攻擊的機制，特別是它的 `prepare()` 方法。這是最重要的原因。
2.  **相容性 (Compatibility):** 它可以確保你的程式碼在不同的資料庫環境下（雖然 WordPress 主要是 MySQL/MariaDB）也能正常運作。
3.  **便利性 (Convenience):** 它提供了許多方便的輔助函式 (Helper Functions) 來獲取不同格式的資料，例如 `get_row`, `get_var`, `get_results` 等，大大簡化了程式碼。
4.  **前綴處理 (Prefix Handling):** WordPress 的資料表前綴 (Table Prefix) 在安裝時可以自訂 (例如 `wp_`, `abc_`)。`$wpdb` 會自動處理這些前綴，讓你的外掛或佈景主題在任何網站上都能正確運作。

### 基礎：如何使用 $wpdb

因為 `$wpdb` 是一個全域變數，所以在你的函式 (function) 中使用它之前，必須先用 `global` 關鍵字將它引入到函式的作用域 (scope) 內。

```php
function my_custom_database_function() {
    global $wpdb;

    // 現在你可以在這裡使用 $wpdb 物件了
    // $results = $wpdb->get_results( ... );
}
```

### 安全第一：使用 $wpdb->prepare()

這是操作 `$wpdb` 最核心、最重要的觀念。**任何包含變數的 SQL 查詢，都必須經過 `prepare()` 方法處理**，以防止 SQL 注入攻擊。

`prepare()` 的作用是將你的 SQL 查詢語句和要傳入的變數分開處理。它會將變數中的特殊字元進行轉義 (escape)，使其無法破壞原有的 SQL 語法結構。

它的語法結構如下：

`$wpdb->prepare( 'SQL 語句與預留位置', value1, value2, ... );`

預留位置 (Placeholders) 有三種：
*   `%s` - 字串 (String)
*   `%d` - 整數 (Integer)
*   `%f` - 浮點數 (Float)

**一個錯誤的例子（非常危險！）：**

```php
// 錯誤示範！千萬不要這樣寫！
$user_id = $_GET['user_id']; // 假設這是從 URL 來的，可能是惡意的值
$results = $wpdb->get_results( "SELECT * FROM {$wpdb->prefix}users WHERE ID = $user_id" );
```

**正確且安全的寫法：**

```php
// 正確示範！
$user_id = $_GET['user_id'];
$results = $wpdb->get_results(
    $wpdb->prepare(
        "SELECT * FROM {$wpdb->prefix}users WHERE ID = %d",
        $user_id // 將變數作為第二個參數傳入
    )
);
```
**Moksa 技巧：** 請將 `prepare()` 養成肌肉記憶。即使你覺得傳入的變數很安全，也堅持使用它。這是專業開發者的基本素養。

### 常用的 $wpdb 方法

`$wpdb` 提供了幾種不同方法來應對不同的查詢需求。

#### 1. `$wpdb->get_results()` - 獲取多筆資料

當你需要回傳多筆資料（多個橫列）時，使用這個方法。它會回傳一個**物件陣列 (Array of Objects)**。

**範例：** 查詢所有狀態為「處理中」的 WooCommerce 訂單。

```php
global $wpdb;

// WooCommerce 訂單的 post_type 是 'shop_order'
// 訂單狀態是 post_status
$sql = "SELECT ID, post_date FROM {$wpdb->prefix}posts WHERE post_type = %s AND post_status = %s";

$prepared_sql = $wpdb->prepare($sql, 'shop_order', 'wc-processing');

$processing_orders = $wpdb->get_results($prepared_sql);

if ($processing_orders) {
    echo '<h3>處理中的訂單：</h3>';
    echo '<ul>';
    foreach ($processing_orders as $order) {
        echo '<li>訂單 ID: ' . $order->ID . ' - 日期: ' . $order->post_date . '</li>';
    }
    echo '</ul>';
} else {
    echo '目前沒有處理中的訂單。';
}
```

#### 2. `$wpdb->get_row()` - 獲取單筆資料

當你確定查詢只會回傳一筆資料時使用。它會回傳一個**單一物件 (Single Object)**。

**範例：** 透過 Email 取得特定使用者的註冊日期。

```php
global $wpdb;

$user_email = 'customer@example.com';
$sql = "SELECT user_registered FROM {$wpdb->prefix}users WHERE user_email = %s";
$prepared_sql = $wpdb->prepare($sql, $user_email);

$user_row = $wpdb->get_row($prepared_sql);

if ($user_row) {
    echo '使用者 ' . $user_email . ' 的註冊日期是: ' . $user_row->user_registered;
}
```

#### 3. `$wpdb->get_var()` - 獲取單一值

當你只需要查詢結果中的一個欄位值時使用，非常適合用來計數或取得單一 meta 值。

**範例：** 計算目前網站上有多少「已發佈」的文章。

```php
global $wpdb;

$sql = "SELECT COUNT(ID) FROM {$wpdb->prefix}posts WHERE post_type = %s AND post_status = %s";
$prepared_sql = $wpdb->prepare($sql, 'post', 'publish');

$post_count = $wpdb->get_var($prepared_sql);

echo '網站上共有 ' . $post_count . ' 篇已發佈的文章。';
```

#### 4. `$wpdb->query()` - 執行通用查詢

當你執行的 SQL 操作**不會回傳資料**時，例如 `INSERT`, `UPDATE`, `DELETE`，就使用這個方法。它會回傳受影響的資料筆數。

**範例：** 更新某篇 WooCommerce 商品的庫存狀態。
(注意：實務上建議使用 `wc_update_product_stock_status()` 函式，這裡僅為演示 `$wpdb` 用法)

```php
global $wpdb;

$product_id = 123;
$new_stock_status = 'outofstock';

$rows_affected = $wpdb->query(
    $wpdb->prepare(
        "UPDATE {$wpdb->prefix}postmeta SET meta_value = %s WHERE post_id = %d AND meta_key = %s",
        $new_stock_status,
        $product_id,
        '_stock_status'
    )
);

echo '已更新 ' . $rows_affected . ' 筆資料。';
```
雖然 `$wpdb->query()` 可以用，但 WordPress 提供了更方便、更安全的寫法...

#### 5. `$wpdb->insert()`, `$wpdb->update()`, `$wpdb->delete()`

這些是更高階的輔助函式，讓你不需要手動撰寫完整的 `INSERT`, `UPDATE`, `DELETE` SQL 語句，更加安全且易讀。

**範例：`insert()` - 新增一筆自訂資料**

```php
global $wpdb;

$table_name = $wpdb->prefix . 'custom_logs'; // 假設我們有一個自訂的 log 資料表

$wpdb->insert(
    $table_name,
    array(
        'timestamp' => current_time('mysql'),
        'level'     => 'info',
        'message'   => '使用者執行了特定操作',
    ),
    array(
        '%s', // timestamp 格式
        '%s', // level 格式
        '%s', // message 格式
    )
);
```

**範例：`update()` - 更新一筆自訂資料**

```php
global $wpdb;

$table_name = $wpdb->prefix . 'custom_logs';

$wpdb->update(
    $table_name,
    array(
        'level' => 'warning', // 要更新的欄位
    ),
    array( 'ID' => 10 ), // 更新條件 (WHERE)
    array(
        '%s', // level 的格式
    ),
    array( '%d' ) // WHERE 條件的格式
);
```
---

### 實作：建立一個儀表板小工具，顯示待處理的「綠界 ATM」訂單數量

現在，我們來將所學應用在一個 Moksa 技術棧的真實情境中。我們要在 WordPress 後台儀表板上，新增一個小工具，讓管理者可以一眼看到目前有多少客戶選擇「綠界 ATM」付款但尚未完成付款（訂單狀態為「保留」）。

#### 步驟 1：註冊儀表板小工具

我們需要使用 `wp_dashboard_setup` 這個 action hook 來新增我們的小工具。你可以將這段程式碼加到你的子佈景主題的 `functions.php` 檔案，或是一個自訂的功能外掛中。

```php
// 將此程式碼加入 functions.php 或自訂外掛

add_action('wp_dashboard_setup', 'moksa_register_atm_orders_widget');

function moksa_register_atm_orders_widget() {
    wp_add_dashboard_widget(
        'moksa_atm_orders_widget',         // Widget slug
        '待處理的綠界 ATM 訂單',           // Widget 標題
        'moksa_display_atm_orders_widget'  // 顯示內容的函式
    );
}
```

#### 步驟 2：撰寫顯示內容的函式 (包含 $wpdb 查詢)

這是我們實作的核心。我們需要撰寫 `moksa_display_atm_orders_widget` 這個函式，它會去資料庫查詢符合條件的訂單數量並顯示出來。

*   **訂單狀態：** 「保留 (On Hold)」，在資料庫中是 `wc-on-hold`。
*   **付款方式：** WooCommerce 會將付款方式的 ID 存在 `postmeta` 資料表中，meta_key 為 `_payment_method`。綠界 ATM 的 ID 通常是 `ecpay_atm`。

```php
// 接續上面的程式碼

function moksa_display_atm_orders_widget() {
    // 步驟 2.1: 引入 $wpdb
    global $wpdb;

    // 步驟 2.2: 撰寫 SQL 查詢
    // 我們需要 JOIN posts 和 postmeta 兩個資料表
    // posts 表用來篩選 post_type 和 post_status
    // postmeta 表用來篩選付款方式 (_payment_method)
    $sql = "
        SELECT COUNT(p.ID)
        FROM {$wpdb->prefix}posts AS p
        INNER JOIN {$wpdb->prefix}postmeta AS pm ON p.ID = pm.post_id
        WHERE p.post_type = %s
        AND p.post_status = %s
        AND pm.meta_key = %s
        AND pm.meta_value = %s
    ";

    // 步驟 2.3: 使用 prepare() 準備查詢
    $prepared_sql = $wpdb->prepare(
        $sql,
        'shop_order',    // post_type
        'wc-on-hold',    // post_status
        '_payment_method', // meta_key
        'ecpay_atm'      // meta_value (綠界 ATM 的 ID)
    );

    // 步驟 2.4: 使用 get_var() 獲取數量
    $order_count = $wpdb->get_var($prepared_sql);

    // 步驟 2.5: 顯示結果
    echo '<div class="main">';
    if ($order_count > 0) {
        // 建立一個連結，直接連到篩選好的訂單列表頁面
        $link = admin_url('edit.php?post_type=shop_order&post_status=wc-on-hold&_payment_method=ecpay_atm');
        echo '<p>目前有 <a href="' . esc_url($link) . '" style="font-size: 2em; text-decoration: none; vertical-align: middle;">' . $order_count . '</a> 筆待確認的 ATM 訂單。</p>';
        echo '<p>客戶可能已付款但系統尚未收到通知，請定時前往綠界後台確認。</p>';
    } else {
        echo '<p>目前沒有待處理的 ATM 訂單，太棒了！</p>';
    }
    echo '</div>';
}
```

#### 步驟 3：查看成果

將以上兩段程式碼都加入後，重新整理你的 WordPress 後台儀表板，你應該就能看到這個新工具了！

``

### 總結

今天我們學習了 WordPress 開發中不可或缺的一環：`$wpdb`。請記住最重要的幾個原則：

*   **永遠使用 `$wpdb`**，不要用原生 PHP 函式。
*   **`prepare()` 是你的好朋友**，養成保護自己網站的習慣。
*   **選擇正確的方法**：`get_results` (多筆), `get_row` (單筆), `get_var` (單一值)。
*   **善用輔助函式**：`insert`, `update`, `delete` 讓你的程式碼更簡潔、安全。

直接操作資料庫賦予了你極大的彈性與能力，但同時也伴隨著責任。務必謹慎、安全地進行每一次的查詢。

想了解更多 `$wpdb` 的進階用法，可以隨時查閱 [WordPress 官方開發者文件](https://developer.wordpress.org/reference/classes/wpdb/)。

現在，動手試試看，將今天學到的技巧應用到你自己的專案中吧！