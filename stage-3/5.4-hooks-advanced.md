# 05.04 (實務) Hooks 進階 (優先權、自訂 Hook)

嗨，歡迎來到 MoksaWP 開發課程！

在前幾堂課，我們已經學會了 WordPress Hooks (鉤點) 的基本概念，理解了 `add_action()` 和 `add_filter()` 的強大之處。今天，我們要深入探討兩個進階但極為重要的主題：**優先權 (Priority)** 與 **自訂 Hook (Custom Hooks)**。

掌握這兩個觀念，是你從「會用」Hooks 晉升到「精通」Hooks 的關鍵一步。它能讓你更精準地控制程式碼的執行順序，並寫出更模組化、更具擴充性的專業級外掛與佈景主題。

---

### 1. 深入理解 Hook 的「優先權 (Priority)」

你可能已經注意到，`add_action()` 和 `add_filter()` 函式其實可以接受更多參數。其中，第三個參數就是「優先權」。

```php
// 基本用法
add_action( 'hook_name', 'your_function_name' );

// 包含優先權與可接受參數數量的用法
add_action( 'hook_name', 'your_function_name', 10, 2 );
```

*   **`hook_name`**: 要掛載的鉤點名稱。
*   **`your_function_name`**: 要執行的函式名稱。
*   **`priority` (優先權)**: 一個整數，用來決定函式的執行順序。**數字越小，越早執行**。預設值是 **10**。
*   **`accepted_args` (接受參數數量)**: 你的函式預計接收多少個從 Hook 傳來的參數。預設值是 **1**。

**為什麼優先權這麼重要？**

當多個函式掛載到同一個 Hook 時，WordPress 就會根據 `priority` 的數值來決定它們的執行順序。這在以下情境中至關重要：

1.  **覆寫或調整外掛/佈景主題的預設行為：** 例如，WooCommerce 在商品頁面上掛載了很多預設元件，如果你想在「價格」之前插入一個自訂訊息，你就需要設定一個比「價格」元件更早執行的優先權。
2.  **確保依賴關係：** 如果你的函式需要用到另一個外掛初始化的資料，你就必須將你的函式優先權設定得比該外掛晚 (也就是數字更大)，確保在你的程式碼執行時，所需資料已經準備就緒。

#### (實作) 在 WooCommerce 商品頁中插入自訂訊息

我們的目標是：在單一商品頁面的「價格」和「簡短描述」之間，加入一個「全館免運」的提示訊息。

**步驟 1：分析預設元件的優先權**

首先，我們需要知道 WooCommerce 是如何安排這些元件的。它們都掛載在 `woocommerce_single_product_summary` 這個 Action Hook 上。預設的優先權如下：

*   `woocommerce_template_single_title` (標題): **5**
*   `woocommerce_template_single_rating` (評分): **10**
*   `woocommerce_template_single_price` (價格): **10**
*   `woocommerce_template_single_excerpt` (簡短描述): **20**
*   `woocommerce_template_single_add_to_cart` (加入購物車按鈕): **30**
*   `woocommerce_template_single_meta` (分類、標籤): **40**

**Moksa 技巧：** 如何找到這些優先權？除了查閱 WooCommerce 原始碼，最好的方法是使用 **Query Monitor** 這個外掛。啟用後，在前台頁面頂端的管理列找到 Query Monitor，點擊「Hooks & Actions」，就可以清楚看到每個頁面載入了哪些 Hooks，以及掛載在上面的所有函式與其優先權。

``[Query Monitor 顯示 woocommerce_single_product_summary 鉤點資訊的截圖]``

**步驟 2：撰寫我們的自訂函式與掛載**

我們的目標是在價格 (10) 和簡短描述 (20) 之間。因此，我們可以選擇一個介於 10 和 20 之間的數字作為優先權，例如 **15**。

請將以下程式碼加入到你的子佈景主題 `functions.php` 或是一個自訂的功能外掛中。

```php
<?php

/**
 * 在 WooCommerce 商品頁的價格下方加入免運提示
 */
function moksa_add_free_shipping_notice() {
    // 透過 is_product() 確保只在單一商品頁執行
    if ( is_product() ) {
        echo '<div class="shipping-notice" style="color: #2a8a2a; margin: 10px 0;">✨ 全館滿千免運中！ ✨</div>';
    }
}

// 將我們的函式掛載到 'woocommerce_single_product_summary'
// 並將優先權設定為 15，確保它在價格 (10) 之後，簡短描述 (20) 之前執行
add_action( 'woocommerce_single_product_summary', 'moksa_add_free_shipping_notice', 15 );
```

**步驟 3：驗證結果**

儲存檔案後，重新整理你的任何一個商品頁面。你會看到「全館免運中！」的訊息，精準地出現在了價格和簡短描述之間。

``[WooCommerce 商品頁成功顯示免運訊息的截圖]``

---

### 2. 建立與使用「自訂 Hook (Custom Hooks)」

學會使用別人建立的 Hook 很棒，但要成為一位專業的開發者，你必須學會**創造自己的 Hooks**。

**為什麼要自訂 Hook？**

當你在開發自己的佈景主題或外掛時，建立自訂 Hook 等於是在你的程式碼中**預留了「擴充點」**。這讓其他開發者（或是未來的你）可以在不修改你核心程式碼的前提下，輕易地新增、修改或移除功能。這是所有大型、成功的 WordPress 專案（如 WooCommerce, LearnDash, Elementor）的核心架構理念。

**建立自訂 Hook 的方法：**

1.  **建立自訂 Action Hook:** 使用 `do_action( 'your_custom_hook_name', $param1, $param2 );`
    *   這會在你的程式碼中建立一個執行點。任何掛載到 `your_custom_hook_name` 的函式都會在這裡被觸發。
    *   你可以選擇性地傳遞參數（如 `$param1`）給掛載的函式使用。

2.  **建立自訂 Filter Hook:** 使用 `apply_filters( 'your_custom_hook_name', $value_to_filter, $param1 );`
    *   這會在你的程式碼中建立一個「過濾點」。
    *   `$value_to_filter` 是要被處理的初始值。
    *   任何掛載到 `your_custom_hook_name` 的函式都可以接收這個值，對其進行修改，然後**必須** `return` 回來。
    *   最終 `apply_filters` 會回傳經過所有掛載函式處理後的最終結果。

#### (實作) 為我們的課程資訊卡片增加擴充性

假設我們正在開發一個 Moksa 的課程外掛，其中有一個函式 `moksa_render_course_card()` 用來顯示課程卡片。

**版本 1.0 (沒有擴充性)**

```php
// 這段程式碼在我們的外掛主檔案中
function moksa_render_course_card( $course_id ) {
    $title = get_the_title( $course_id );
    $instructor = get_post_meta( $course_id, '_course_instructor', true );

    echo '<div class="course-card">';
    echo '<h3>' . esc_html( $title ) . '</h3>';
    echo '<p>講師：' . esc_html( $instructor ) . '</p>';
    echo '</div>';
}
```

這個版本運作良好，但如果有一天，行銷部門說「我們想在所有課程卡片的講師資訊下方，加上一個早鳥優惠價」，我們要怎麼辦？直接修改 `moksa_render_course_card` 這個函式嗎？這樣做很危險，未來更新外掛時很容易出錯。

**版本 2.0 (使用自訂 Action Hook)**

現在，我們用自訂 Hook 來讓它變得更專業、更具擴充性。

**步驟 1：在核心函式中加入 `do_action()`**

我們修改 `moksa_render_course_card()`，在講師資訊下方加入一個自訂的 Action Hook，並將 `$course_id` 傳遞過去。

```php
// 這段程式碼在我們的外掛主檔案中
function moksa_render_course_card( $course_id ) {
    $title = get_the_title( $course_id );
    $instructor = get_post_meta( $course_id, '_course_instructor', true );

    echo '<div class="course-card">';
    echo '<h3>' . esc_html( $title ) . '</h3>';
    echo '<p>講師：' . esc_html( $instructor ) . '</p>';

    /**
     * Moksa 自訂 Action Hook
     * 允許在課程卡片的講師資訊後添加額外內容。
     *
     * @param int $course_id 課程文章 ID。
     */
    do_action( 'moksa_after_course_card_instructor', $course_id );

    echo '</div>';
}
```

**Moksa 技巧：** 為你的自訂 Hook 撰寫清晰的註解（DocBlocks）是一個非常專業的習慣。它解釋了這個 Hook 的作用、位置以及它傳遞了哪些參數，方便其他開發者理解與使用。

**步驟 2：在 `functions.php` 中使用我們的自訂 Hook**

現在，我們可以輕鬆地在佈景主題的 `functions.php` 中掛載一個新函式到 `moksa_after_course_card_instructor`，來完成行銷部門的需求。

```php
// 這段程式碼在子佈景主題的 functions.php 中
function moksa_add_early_bird_price( $course_id ) {
    $early_bird_price = get_post_meta( $course_id, '_early_bird_price', true );

    if ( ! empty( $early_bird_price ) ) {
        echo '<p style="color: red;">早鳥優惠價：$' . esc_html( $early_bird_price ) . '</p>';
    }
}

// 注意！這裡我們掛載的是自己建立的 Hook 名稱
add_action( 'moksa_after_course_card_instructor', 'moksa_add_early_bird_price', 10, 1 );
```

**版本 3.0 (使用自訂 Filter Hook)**

更進一步，如果我們想讓卡片的標題可以被外部程式碼修改（例如加上 "[熱門]" 字樣）呢？這時就該使用 Filter Hook。

**步驟 1：在核心函式中加入 `apply_filters()`**

```php
// 這段程式碼在我們的外掛主檔案中
function moksa_render_course_card( $course_id ) {
    $title = get_the_title( $course_id );
    
    /**
     * Moksa 自訂 Filter Hook
     * 允許過濾/修改課程卡片的標題文字。
     *
     * @param string $title     原始的課程標題。
     * @param int    $course_id 課程文章 ID。
     */
    $filtered_title = apply_filters( 'moksa_course_card_title', $title, $course_id );

    $instructor = get_post_meta( $course_id, '_course_instructor', true );

    echo '<div class="course-card">';
    echo '<h3>' . esc_html( $filtered_title ) . '</h3>'; // 使用過濾後的標題
    echo '<p>講師：' . esc_html( $instructor ) . '</p>';
    do_action( 'moksa_after_course_card_instructor', $course_id );
    echo '</div>';
}
```

**步驟 2：在 `functions.php` 中使用我們的自訂 Filter**

```php
// 這段程式碼在子佈景主題的 functions.php 中
function moksa_add_hot_tag_to_title( $title, $course_id ) {
    // 假設我們用一個 meta 欄位來判斷是否為熱門課程
    $is_hot = get_post_meta( $course_id, '_is_hot_course', true );

    if ( $is_hot ) {
        $title = '[熱門] ' . $title;
    }

    // Filter 函式最重要的一步：務必 return 修改後的值！
    return $title;
}

add_filter( 'moksa_course_card_title', 'moksa_add_hot_tag_to_title', 10, 2 );
```

現在，只要我們在後台將某個課程標記為「熱門」，它的卡片標題就會自動加上 `[熱門]` 前綴，而這一切都不需要去修改外掛的核心檔案！

### 總結

今天我們學習了 Hooks 的兩個進階用法：

1.  **優先權 (Priority):** 透過設定 `add_action` / `add_filter` 的第三個參數，我們可以精準控制函式的執行順序，讓我們能在既有的架構中「見縫插針」，達成我們的客製化需求。
2.  **自訂 Hook (Custom Hooks):** 透過在自己的程式碼中使用 `do_action` 和 `apply_filters`，我們可以建立自己的擴充點，讓程式碼變得模組化、可維護且易於團隊協作。

熟練運用這兩項技巧，你將能更優雅、更安全地客製化 WordPress 的一切，並且開始建構真正專業、強大的 WordPress 解決方案。在接下來的課程中，我們會不斷地看到並使用這些觀念。