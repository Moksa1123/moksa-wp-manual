# 12.03 (實務) CI/CD 流程 (使用 GitHub Actions 自動部署)

嗨，歡迎來到 MoksaWP 開發課程的進階章節！在前幾個章節中，我們已經學會了如何使用 Git 進行版本控制，並在 LocalWP 環境中開發佈景主題與外掛。然而，當專案完成後，我們該如何「優雅」、「安全」且「自動化」地將程式碼部署到正式站伺服器上呢？

傳統的 FTP 手動上傳方式不僅耗時，更容易因為人為疏失（傳錯檔案、漏傳檔案）而導致網站發生嚴重錯誤。為了解決這個問題，業界普遍採用 **CI/CD (持續整合/持續部署)** 的流程。

在這個章節，我們將會學習如何利用全球最大的程式碼託管平台 **GitHub** 內建的強大工具 — **GitHub Actions**，來打造一個自動化部署流程。未來，你只需要在自己的電腦上完成開發，執行 `git push` 將程式碼推送到 GitHub，GitHub Actions 就會像一位不知疲倦的助理，自動幫你把最新的程式碼安全地部署到伺服器上。

---

### 學習目標

*   理解 CI/CD 的核心概念與優勢。
*   學會設定伺服器端的 SSH 金鑰，以實現安全的免密碼登入。
*   學會設定 GitHub Repository 的 Secrets，安全地存放敏感資訊。
*   親手撰寫第一份 GitHub Actions 的 Workflow 設定檔 (YAML)。
*   完成一個完整的「本地 Push -> GitHub -> 自動部署到伺服器」的流程。

---

### 前置準備

在開始之前，請確保你已經準備好以下項目：

1.  **一個遠端的 Linux 主機權限：** 你需要有伺服器的 SSH 登入權限。這可以是你的 Staging (測試) 環境或 Production (正式) 環境。
2.  **一個 GitHub Repository：** 你的外掛或佈景主題專案已經使用 Git 進行版控，並推送到了 GitHub 上。
3.  **本地開發環境：** 你的電腦中已安裝好 Git 與 VS Code。

---

### CI/CD 流程概覽

我們的目標是建立以下自動化流程：

`開發環境 (LocalWP) -> git push -> GitHub -> GitHub Actions 自動化 -> 正式站伺服器`

`[截圖：CI/CD 流程圖，簡單呈現 Local -> GitHub -> Server 的箭頭指向]`

整個流程的核心在於 GitHub Actions。它是一個由 GitHub 提供的自動化服務，可以監聽你 Repository 中的特定事件（例如 `push`），然後執行你預先定義好的一系列指令（稱為 Workflow）。

---

### 步驟一：準備伺服器與 SSH 金鑰

為了讓 GitHub Actions 能夠「登入」你的伺服器並部署檔案，我們不能使用傳統的帳號密碼（這非常不安全）。我們將使用 **SSH 金鑰對 (Key Pair)** 來進行驗證。

1.  **在本機電腦產生 SSH 金鑰對：**
    打開你的終端機 (Terminal 或命令提示字元)，輸入以下指令。這會產生一對金鑰：私鑰 (`deploy_key`) 與公鑰 (`deploy_key.pub`)。

    ```bash
    # -t 指定演算法, -b 指定長度, -f 指定檔案名稱, -N "" 表示不需要密碼
    ssh-keygen -t rsa -b 4096 -f deploy_key -N ""
    ```

2.  **複製公鑰 (`deploy_key.pub`) 的內容：**
    使用以下指令查看並複製公鑰的內容。將整段 `ssh-rsa` 開頭的字串完整複製起來。

    ```bash
    cat deploy_key.pub
    ```

3.  **將公鑰新增到伺服器的信任列表：**
    *   使用 SSH 登入你的遠端伺服器。
    *   找到 `~/.ssh/authorized_keys` 這個檔案（如果不存在，請手動建立 `~/.ssh` 資料夾與該檔案）。
    *   將剛剛複製的**公鑰**內容，貼到 `authorized_keys` 檔案的**新的一行**並儲存。

    **Moksa 技巧：** 這個步驟的意義是告訴你的伺服器：「未來只要持有對應私鑰的機器人（也就是 GitHub Actions）來敲門，就直接讓他進來，不需要問密碼。」

---

### 步驟二：設定 GitHub Repository Secrets

我們絕對**不可以**將剛剛產生的**私鑰 (`deploy_key`)** 直接放到程式碼中，這是極度危險的行為。我們需要使用 GitHub 的 **Secrets** 功能來安全地儲存它。

1.  **進入你的 GitHub Repository 頁面。**
2.  點擊右上角的 **Settings** > 左側選單的 **Secrets and variables** > **Actions**。
3.  點擊 **New repository secret** 按鈕，我們需要新增以下幾個 Secrets：

    *   **`SSH_PRIVATE_KEY`**:
        *   **Name:** `SSH_PRIVATE_KEY`
        *   **Secret:** 貼上你本機 `deploy_key` **私鑰**檔案的**完整內容** (以 `-----BEGIN OPENSSH PRIVATE KEY-----` 開頭的那一份)。

    *   **`REMOTE_HOST`**:
        *   **Name:** `REMOTE_HOST`
        *   **Secret:** 填寫你伺服器的 **IP 位址**或**網域名稱**。

    *   **`REMOTE_USER`**:
        *   **Name:** `REMOTE_USER`
        *   **Secret:** 填寫你用來登入伺服器的**使用者名稱** (例如 `ubuntu`, `root` 或 `moksa`)。

    *   **`TARGET_DIR`**:
        *   **Name:** `TARGET_DIR`
        *   **Secret:** 填寫你要部署到伺服器上的**絕對路徑**。例如，如果你的外掛要部署到 `wp-content/plugins/my-awesome-plugin`，路徑可能就會是 `/var/www/html/wp-content/plugins/my-awesome-plugin/`。

`[截圖：GitHub Secrets 設定頁面，顯示已新增的四個 Secret]`

---

### 步驟三：撰寫 GitHub Actions Workflow 檔案

現在，萬事俱備，只欠東風。我們要在專案中新增一個特別的設定檔，來告訴 GitHub Actions 該做什麼。

1.  在你的專案根目錄下，建立一個資料夾 `.github`。
2.  在 `.github` 資料夾內，再建立一個資料夾 `workflows`。
3.  在 `workflows` 資料夾內，建立一個檔案，例如 `deploy.yml`。

    你的檔案結構看起來應該是這樣：
    ```
    my-awesome-plugin/
    ├── .github/
    │   └── workflows/
    │       └── deploy.yml
    ├── my-awesome-plugin.php
    └── ... 其他檔案
    ```

4.  **編輯 `deploy.yml` 檔案，貼上以下內容：**

    ```yaml
    # Workflow 的名稱
    name: Deploy to Production

    # 觸發條件：當 push 到 main 分支時觸發
    on:
      push:
        branches:
          - main

    # 工作流程
    jobs:
      deploy:
        # 運行的虛擬機環境
        runs-on: ubuntu-latest

        # 此 job 的步驟
        steps:
          # 步驟 1: 從 Repository checkout 程式碼
          - name: Checkout code
            uses: actions/checkout@v3

          # 步驟 2: 使用 rsync 部署檔案
          - name: Deploy files
            uses: easingthemes/ssh-deploy@v4.1.10
            with:
              # SSH 私鑰 (從 Secrets 讀取)
              SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
              # 遠端主機 IP 或網域 (從 Secrets 讀取)
              REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
              # 遠端主機使用者 (從 Secrets 讀取)
              REMOTE_USER: ${{ secrets.REMOTE_USER }}
              # 來源目錄 (這裡的 '.' 代表整個 repo)
              SOURCE: "./"
              # 目標目錄 (從 Secrets 讀取)
              TARGET: ${{ secrets.TARGET_DIR }}
              # 排除的檔案或目錄
              EXCLUDE: "/.git/, /.github/, /node_modules/"
    ```

**程式碼解說：**

*   `name`: 這個 Workflow 在 GitHub Actions 頁面顯示的名稱。
*   `on.push.branches`: 這定義了觸發條件。這裡設定為只有當 `main` 分支有 `push` 事件時，才會啟動。
*   `jobs.deploy.runs-on`: 指定這個工作要在哪個作業系統上運行，`ubuntu-latest` 是最常見的選擇。
*   `steps`: 這是最重要的部分，定義了具體的執行步驟。
    *   `actions/checkout@v3`: 這是一個官方提供的 Action，用途是將你的 Repository 程式碼下載到虛擬機中。
    *   `easingthemes/ssh-deploy@v4.1.10`: 這是一個社群開發的 Action，專門用來透過 SSH 部署檔案。我們透過 `with` 傳入參數，而這些參數的值大多是從我們剛剛設定的 `secrets` 中讀取 (`${{ secrets.SECRET_NAME }}`)。
    *   `SOURCE`: 指定要部署的來源。`"./"` 代表整個專案的根目錄。如果你的外掛檔案是放在 `src` 資料夾，這裡就可以寫 `"./src/"`。
    *   `TARGET`: 指定要部署到伺服器的目標路徑。
    *   `EXCLUDE`: **Moksa 技巧：** 部署時，我們不希望把版本控制的 `.git` 資料夾、GitHub Actions 設定檔 `.github` 或開發用的 `node_modules` 等無關檔案也傳上去。使用 `EXCLUDE` 可以保持伺服器上的檔案乾淨。

---

### 步驟四：觸發與驗證

1.  **Commit 並 Push 你的變更：**
    將剛剛建立的 `.github/workflows/deploy.yml` 檔案 commit 並 push 到你的 `main` 分支。

    ```bash
    git add .
    git commit -m "feat: Add GitHub Actions for auto-deployment"
    git push origin main
    ```

2.  **在 GitHub 上觀察 Actions 運行：**
    *   回到你的 GitHub Repository 頁面，點擊上方的 **Actions** 標籤。
    *   你會看到一個新的 Workflow 正在運行（或已完成）。
    *   點進去看詳細的執行日誌 (Log)，你可以看到每一步驟的執行狀況。如果出現綠色勾勾，代表部署成功！

    `[截圖：GitHub Actions 頁面，顯示一個成功運行的 Workflow，並有綠色打勾]`

3.  **驗證伺服器檔案：**
    *   SSH 登入你的伺服器。
    *   前往你設定的 `TARGET_DIR` 目錄。
    *   使用 `ls -al` 指令檢查檔案是否都已經是最新版本。

恭喜你！你已經成功建立了一套專業的 CI/CD 自動化部署流程。從現在開始，你再也不需要手動 FTP 上傳檔案了。每一次的 `git push`，都會為你觸發一次安全、可靠、可追溯的部署。