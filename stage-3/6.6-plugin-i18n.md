# 06.06 (實務) 國際化 (i18n) (讓您的外掛支援多國語言)

嗨，歡迎來到 MoksaWP 開發課程！我是你在 Moksa 的首席課程導師。

在之前的章節中，我們學會了如何建立功能強大的外掛。但要讓你的外掛走向世界，接觸到更廣大的使用者，就必須讓它能夠被翻譯成各種語言。這個過程，在開發領域中被稱為「**國際化**」（Internationalization），常縮寫為 **i18n**（因為在 "i" 和 "n" 之間有 18 個字母）。

本章節的目標，就是帶你完整走過一遍將 WordPress 外掛「國際化」的標準流程。我們將學習如何撰寫可供翻譯的程式碼、如何產生翻譯檔，以及如何讓 WordPress 正確載入這些翻譯。

---

### 1. 核心觀念：i18n vs L10n

在開始動手前，我們必須先釐清兩個非常重要的概念：

*   **國際化 (Internationalization - i18n):**
    *   這是**開發者**的責任。
    *   指的是在撰寫程式碼的階段，就預先將所有「寫死的文字」（hard-coded strings）用 WordPress 提供的特殊函式包裝起來，使其具備「可被翻譯」的特性。
    *   簡單來說，就是**讓你的外掛做好被翻譯的準備**。

*   **在地化 (Localization - L10n):**
    *   這是**翻譯者**的工作。
    *   指的是針對一個已經完成 i18n 的外掛，實際去建立特定語言的翻譯檔案（例如：繁體中文、日文、西班牙文等）。
    *   簡單來說，就是**實際進行翻譯的動作**。

作為一名專業的開發者，你的首要任務就是把 i18n 的工作做好，為後續的 L10n 鋪好道路。

### 2. 文字定義域 (Text Domain)

在 WordPress 的世界裡，每個外掛或佈景主題都應該有一個獨一無二的「**文字定義域 (Text Domain)**」。

**Text Domain** 就像是你外掛的專屬字典名稱。當 WordPress 看到一段需要翻譯的文字時，它會透過這個 Text Domain 去尋找對應的翻譯檔案和翻譯內容。

**Moksa 技巧：**
*   **Text Domain 必須是唯一的**，通常會使用外掛的「slug」（在 WordPress.org 上的唯一識別碼）或專案名稱。例如，如果你的外掛資料夾是 `my-awesome-plugin`，你的 Text Domain 就可以設為 `my-awesome-plugin`。
*   這個值必須在兩個地方宣告：
    1.  外掛主檔案的註解標頭 (Plugin Header)。
    2.  載入翻譯檔案的函式中。

``
*一個宣告了 Text Domain 的外掛標頭範例*

```php
<?php
/**
 * Plugin Name:       My Awesome Plugin
 * Plugin URI:        https://moksaweb.com/
 * Description:       A demonstration plugin for i18n.
 * Version:           1.0.0
 * Author:            Moksa Team
 * Author URI:        https://moksaweb.com/
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       my-awesome-plugin
 * Domain Path:       /languages
 */
```

請特別注意 `Text Domain` 和 `Domain Path` 這兩行。
*   **Text Domain:** `my-awesome-plugin` 就是我們這個外掛的字典名稱。
*   **Domain Path:** `/languages` 告訴 WordPress，我們的翻譯檔案將會存放在外掛根目錄下的 `languages` 資料夾中。這是 WordPress 的標準作法。

---

### 3. (實作) 讓你的程式碼「可被翻譯」

現在，讓我們開始動手修改程式碼。核心工作就是將所有使用者會看到的「靜態文字」，用 WordPress 的翻譯函式 (Gettext functions) 包裝起來。

#### 最常用的翻譯函式

以下是幾個最核心且你必須熟記的函式：

1.  `__()` (兩個底線)
    *   **用途:** **取得**並**回傳**一個已翻譯的字串。最常用在需要將字串存入變數、作為函式參數，或是在 PHP 和 HTML 混編的 return 語句中。
    *   **範例:**
        ```php
        // 原本的寫法
        $label = 'Hello World';

        // i18n 的寫法
        $label = __( 'Hello World', 'my-awesome-plugin' );
        ```

2.  `_e()` (底線 e)
    *   **用途:** **直接輸出 (echo)** 一個已翻譯的字串。`_e()` 等同於 `echo __()`。常用於直接在 HTML 模板中顯示文字。
    *   **範例:**
        ```php
        // 原本的寫法
        <h2>Settings Page</h2>

        // i18n 的寫法
        <h2><?php _e( 'Settings Page', 'my-awesome-plugin' ); ?></h2>
        ```

**Moksa 技巧：** 請注意，這兩個函式都有兩個參數：
*   **第一個參數:** 你想要翻譯的原始英文字串。
*   **第二個參數:** 你的 **Text Domain**。**這個絕對不能忘！**

#### 處理複數 (Plurals) 的函式

當你的字串需要根據數量變化時（例如 "1 comment" vs "2 comments"），就必須使用 `_n()`。

*   `_n()`
    *   **用途:** 根據一個數字，回傳對應的單數或複數字串。
    *   **範例:**
        ```php
        $comment_count = 5;
        printf(
            _n(
                '%s comment',          // 單數形式
                '%s comments',         // 複數形式
                $comment_count,        // 用來判斷的數字
                'my-awesome-plugin'    // Text Domain
            ),
            number_format_i18n( $comment_count ) // 將數字格式化並傳入 %s
        );
        // 如果 $comment_count 是 1, 輸出 "1 comment"
        // 如果 $comment_count 是 5, 輸出 "5 comments"
        ```

#### 包含情境 (Context) 的函式

有時候，同一個英文單字在不同情境下有不同意思。例如 "Post" 可以是名詞「文章」，也可以是動詞「張貼」。為了讓翻譯者能精準翻譯，我們需要提供「情境」。

*   `_x()`
    *   **用途:** 提供額外的情境說明文字，回傳翻譯後的字串。
    *   **範例:**
        ```php
        // 作為動詞
        $button_text = _x( 'Add New', 'a new portfolio item', 'my-awesome-plugin' );

        // 作為名詞
        $page_title = _x( 'Add New', 'the title of the page', 'my-awesome-plugin' );
        ```
    *   第二個參數就是給翻譯者的情境說明。

**Moksa 技巧：** 開發時，**永遠優先使用英文**作為原始字串。這是 WordPress 的社群標準，也是讓你的外掛能被全球貢獻者翻譯的基礎。

---

### 4. (實作) 載入翻譯檔案

程式碼都包裝好了，但 WordPress 還不知道要去哪裡找翻譯。我們需要在外掛初始化時，告訴它去載入我們的翻譯檔案。

**步驟 1：建立載入函式**
在你的外掛主檔案中，新增一個函式，並使用 `load_plugin_textdomain()`。

```php
function my_awesome_plugin_load_textdomain() {
    load_plugin_textdomain(
        'my-awesome-plugin', // 你的 Text Domain
        false,
        dirname( plugin_basename( __FILE__ ) ) . '/languages/' // 相對路徑
    );
}
```

**步驟 2：掛載到 `plugins_loaded` 動作**
將這個函式掛載 (hook) 到 `plugins_loaded` 這個 action 上。這能確保在外掛程式碼執行前，翻譯就已經準備好了。

```php
add_action( 'plugins_loaded', 'my_awesome_plugin_load_textdomain' );
```

完整的程式碼看起來會像這樣：

``
*載入 Text Domain 的完整程式碼範例*

```php
<?php
/**
 * Plugin Name:       My Awesome Plugin
 * Text Domain:       my-awesome-plugin
 * Domain Path:       /languages
 */

// 避免直接存取檔案
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 載入外掛的翻譯檔案
 */
function my_awesome_plugin_load_textdomain() {
    load_plugin_textdomain(
        'my-awesome-plugin',
        false,
        dirname( plugin_basename( __FILE__ ) ) . '/languages/'
    );
}
add_action( 'plugins_loaded', 'my_awesome_plugin_load_textdomain' );

/**
 * 範例功能：在後台顯示一個歡迎訊息
 */
function my_awesome_plugin_admin_notice() {
    ?>
    <div class="notice notice-success is-dismissible">
        <p><?php _e( 'Welcome to my awesome plugin!', 'my-awesome-plugin' ); ?></p>
    </div>
    <?php
}
add_action( 'admin_notices', 'my_awesome_plugin_admin_notice' );
```

---

### 5. (實作) 產生與使用翻譯檔案

到目前為止，我們完成了 i18n 的準備工作。接下來，我們要進入 L10n 的階段：產生真正的翻譯檔。

翻譯檔案主要有三種類型：
*   `.pot` (Portable Object Template): **翻譯模板檔**。它會掃描你的程式碼，將所有需要翻譯的字串擷取出來，但不包含任何翻譯。這是給翻譯者的「原文稿」。
*   `.po` (Portable Object): **翻譯來源檔**。翻譯者會複製 `.pot` 檔並將其重新命名（例如 `my-awesome-plugin-zh_TW.po`），然後在這個檔案裡逐一填入翻譯。這是人類可讀的檔案。
*   `.mo` (Machine Object): **機器編譯檔**。當翻譯者儲存 `.po` 檔時，翻譯軟體會自動產生一個對應的 `.mo` 檔。這個檔案是二進位的，經過優化，專門給電腦（也就是 WordPress）快速讀取。**WordPress 實際上只會讀取 .mo 檔**。

#### 步驟 1：使用 WP-CLI 產生 `.pot` 檔案

雖然有很多工具可以產生 `.pot` 檔，但在 Moksa 的開發流程中，我們強烈推薦使用 **WP-CLI**，因為它最快、最標準化。

1.  打開你的終端機 (Terminal) 或命令提示字元 (Command Prompt)。
2.  使用 `cd` 指令切換到你的外掛根目錄。
3.  執行以下指令：

    ```bash
    wp i18n make-pot . languages/my-awesome-plugin.pot
    ```

    *   `.` 代表「掃描當前目錄下所有檔案」。
    *   `languages/my-awesome-plugin.pot` 是指將產生的 `.pot` 檔案存放到 `languages` 資料夾下，並命名為 `my-awesome-plugin.pot`。

``
*使用 WP-CLI 成功產生 .pot 檔案的終端機畫面*

執行成功後，你應該會在 `languages` 資料夾內看到 `my-awesome-plugin.pot` 這個檔案。

#### 步驟 2：使用 Poedit 進行翻譯

**Poedit** 是一款免費且非常流行的 `.po` 檔案編輯器，跨平台支援 Windows, macOS 和 Linux。

1.  下載並安裝 Poedit (https://poedit.net/)。
2.  打開 Poedit，選擇「**從 POT 檔案建立新翻譯**」。
3.  選擇你剛剛用 WP-CLI 產生的 `my-awesome-plugin.pot` 檔案。
4.  Poedit 會詢問你要翻譯成哪種語言。我們選擇「**中文 (台灣)**」。
    ``
    *在 Poedit 中選擇翻譯語言的畫面*
5.  開始翻譯！在 Poedit 的介面中，上半部是原始字串，下半部是翻譯輸入框。將 `Welcome to my awesome plugin!` 翻譯成 `歡迎使用我的超棒外掛！`。
    ``
    *在 Poedit 中編輯翻譯字串的畫面*
6.  完成後，點擊「**儲存**」。Poedit 會自動幫你命名檔案。根據 WordPress 的命名慣例，繁體中文的檔案會是：
    *   `my-awesome-plugin-zh_TW.po`
    *   `my-awesome-plugin-zh_TW.mo` (自動產生)
7.  請確保這兩個檔案都儲存在外掛的 `languages` 資料夾底下。

#### 步驟 3：測試翻譯結果

最後一步，就是驗證我們的努力是否成功。

1.  登入你的 WordPress 後台。
2.  前往「**設定**」>「**一般**」。
3.  將「**網站語言**」設定為「**繁體中文**」。
4.  儲存變更。
5.  重新整理頁面，如果你在後台有掛載 `admin_notices`，你應該會看到原本的英文訊息 `Welcome to my awesome plugin!` 已經變成了 `歡迎使用我的超棒外掛！`。

``
*WordPress 後台成功顯示翻譯後訊息的截圖*

恭喜你！你已經成功地將你的外掛國際化，並完成了第一份在地化翻譯檔案。現在，世界各地的使用者都有機會使用他們的母語來操作你的外掛了！

### 總結

本章節我們學習了 WordPress 外掛國際化的完整流程：
1.  **理解 i18n 與 L10n 的區別**：開發者負責 i18n，翻譯者負責 L10n。
2.  **設定 Text Domain**：在外掛標頭和載入函式中定義唯一的字典名稱。
3.  **使用翻譯函式**：用 `__()`, `_e()`, `_n()` 等函式包裝所有靜態字串。
4.  **載入 Text Domain**：在 `plugins_loaded` 動作上使用 `load_plugin_textdomain` 函式。
5.  **產生與翻譯**：使用 **WP-CLI** 產生 `.pot` 模板，再用 **Poedit** 建立 `.po` 和 `.mo` 翻譯檔。

掌握 i18n 是成為一名專業 WordPress 開發者的必經之路。從現在開始，請養成習慣，在你寫的每一個外掛中都實踐這個標準流程。