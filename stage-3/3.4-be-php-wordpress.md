# 03.04 (實務) WordPress 中的 PHP (全域變數、常用函式)

你好，歡迎來到 MoksaWP 佈景主題與外掛開發的實務課程。我是你的導師。

在前面的章節，我們已經建立了 PHP 的基礎。現在，我們要正式踏入 WordPress 的世界，學習如何在這個強大的 CMS 框架下運用 PHP。WordPress 雖然是用 PHP 寫的，但它建立了一個龐大且成熟的生態系，包含許多專屬的「**全域變數**」與「**常用函式**」。

學會使用這些 WordPress 提供的工具，而不是用原生 PHP 去「土法煉鋼」，是成為一位合格 WordPress 開發者的關鍵第一步。這不僅能讓你的程式碼更簡潔、更安全，也能確保你的作品與 WordPress 核心以及其他外掛有更好的相容性。

這堂課，我們將聚焦在兩個核心主題：
1.  **WordPress 全域變數 (Global Variables)**：了解那些 WordPress 已經幫我們準備好、可以直接取用的重要資料。
2.  **WordPress 常用函式 (Common Functions)**：掌握最常被使用的 WordPress API 函式，讓你事半功倍。

---

## 1. WordPress 全域變數 (Global Variables)

在 WordPress 的執行環境中，系統會預先定義一些全域變數，並在裡面存放著重要的物件或資料。我們可以在主題或外掛的任何地方，透過 PHP 的 `global` 關鍵字來存取它們。

**為什麼要使用全域變數？** 因為它們是通往 WordPress 核心資料的捷徑。例如，當你需要直接操作資料庫、獲取當前文章的詳細資訊，或是判斷目前所在的頁面時，這些全域變數就非常有用。

**如何存取？** 非常簡單，只需要在你的函式中使用 `global` 關鍵字宣告即可。

```php
function my_custom_function() {
    // 宣告我們要使用 WordPress 的 $wpdb 這個全域變數
    global $wpdb;

    // 現在 $wpdb 物件就可以在這個函式內使用了
    $results = $wpdb->get_results( "SELECT * FROM {$wpdb->prefix}posts" );
    // ...
}
```

以下是幾位在開發中最常打交道的「老朋友」：

### `$wpdb`
這是 WordPress 資料庫操作的類別 (Class) 實例。所有與資料庫的直接互動，都應該透過 `$wpdb` 來完成。

*   **用途**：執行自訂的 SQL 查詢，讀取、新增、更新、刪除資料庫中的任何資料。
*   **範例**：查詢所有已發布的文章數量。

    ```php
    global $wpdb;
    // {$wpdb->prefix} 會自動替換成你的資料表前綴 (e.g., wp_)
    $post_count = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->prefix}posts WHERE post_status = 'publish'" );
    echo '網站上共有 ' . $post_count . ' 篇文章。';
    ```
*   **Moksa 技巧**：基於安全性，**任何時候**當你的 SQL 查詢包含外部變數時（例如來自 `$_GET` 或 `$_POST` 的值），都**必須**使用 `$wpdb->prepare()` 方法來避免 SQL Injection 攻擊。這是 WordPress 開發的**黃金準則**。

### `$post`
這個變數儲存了當前文章或頁面的**所有資訊**，它是一個 `WP_Post` 物件。

*   **用途**：在 WordPress 的主循環 (The Loop) 之外，獲取特定文章的資料，如 ID、標題、內容、作者等。
*   **範例**：在網站的頁尾 (footer.php) 顯示當前頁面的 ID。

    ```php
    // 在 The Loop 外需要先宣告
    global $post;
    // 檢查 $post 是否為一個有效的物件
    if ( is_a( $post, 'WP_Post' ) ) {
        echo '目前頁面的 ID 是：' . $post->ID;
    }
    ```
*   **注意**：在主循環（例如 `while ( have_posts() ) : the_post();`）裡面，你通常不需要 `global $post;`，因為 WordPress 已經幫你設定好了。但在自訂函式或模板檔案的其他地方，就需要手動宣告。

### `$wp_query`
這是 WordPress 的主要查詢物件 (`WP_Query`)。它決定了目前頁面要顯示哪些文章。你可以透過它來了解當前查詢的各種資訊。

*   **用途**：判斷目前是否在首頁、分類頁，或獲取查詢結果的總頁數等。
*   **範例**：在分類頁面的標題旁，顯示該分類下共有幾篇文章。

    ```php
    // is_archive() 是一個判斷式函式，用來確認是否在分類、標籤等彙整頁
    if ( is_archive() ) {
        global $wp_query;
        echo '本分類下共有 ' . $wp_query->found_posts . ' 篇文章。';
    }
    ```

### `$current_user`
這個變數包含了當前登入使用者的資訊。如果使用者未登入，它就不會被設定。

*   **用途**：獲取使用者的 ID、帳號、顯示名稱、Email 等。
*   **範例**：在頁首顯示歡迎訊息。

    ```php
    global $current_user;
    // 透過 wp_get_current_user() 函式來取得，是更推薦的作法
    // 但了解 global $current_user 仍然重要
    $user = wp_get_current_user();
    if ( $user->ID != 0 ) { // ID 不為 0 表示已登入
        echo '歡迎回來，' . esc_html( $user->display_name ) . '！';
    }
    ```

---

## 2. WordPress 常用函式 (Common Functions)

WordPress 提供了數千個「輔助函式 (Helper Functions)」，讓我們可以用非常簡單的方式完成複雜的任務。記住，**「永遠先找找看 WordPress 有沒有內建函式可以做這件事」**，這是一個好習慣。

這些函式可以大致分為幾類：

### 取得網站資訊 (Site Info)

*   `get_bloginfo( 'name' )`：取得網站標題。
*   `get_bloginfo( 'description' )`：取得網站標語。
*   `home_url()`：取得網站首頁網址。通常用於 logo 或首頁按鈕的連結。
*   `site_url()`：取得 WordPress 核心檔案所在的網址。
*   **Moksa 技巧**：`home_url()` 和 `site_url()` 在多數情況下相同，但在特殊設定（例如將 WordPress 安裝在子目錄）下會不同。**一般來說，網站前端的連結請使用 `home_url()`**。
*   `get_template_directory_uri()`：取得**父佈景主題**資料夾的網址。用於載入圖片、CSS、JS 檔案。
*   `get_stylesheet_directory_uri()`：取得**子佈景主題**資料夾的網址。如果未使用子主題，則回傳的結果與前者相同。**Moksa 技巧**：為了讓你的主題保有擴充性，**一律建議使用 `get_stylesheet_directory_uri()`** 來載入主題的靜態資源。

### 文章與頁面相關 (Post & Page)

WordPress 函式有個常見的命名規則：`the_` 開頭的函式會**直接印出 (echo)** 結果，而 `get_the_` 開頭的函式會**回傳 (return)** 結果讓你存到變數中。

*   `the_title()` / `get_the_title()`：印出/回傳文章標題。
*   `the_content()` / `get_the_content()`：印出/回傳文章內容。`the_content()` 會自動套用段落 `<p>`、短代碼等 WordPress 預設的 filter。
*   `the_permalink()` / `get_permalink()`：印出/回傳文章的固定網址。
*   `the_post_thumbnail()` / `get_the_post_thumbnail()`：印出/回傳文章的特色圖片 (`<img>` 標籤)。
*   `get_post_meta( $post_id, $key, $single )`：取得儲存在文章中的自訂欄位 (Custom Field) 值。這是 ACF、Pods 等外掛儲存資料的核心函式。
*   `update_post_meta( $post_id, $key, $value )`：新增或更新自訂欄位的值。

### 開發與載入資源 (Development & Enqueue)

*   `wp_enqueue_script()`：**正確地**載入 JavaScript 檔案。
*   `wp_enqueue_style()`：**正確地**載入 CSS 樣式表。
*   **Moksa 技巧**：**絕對不要**直接在 `header.php` 或 `footer.php` 裡寫 `<script>` 或 `<link>` 標籤來載入你的 JS/CSS。使用 `wp_enqueue_script/style` 搭配 `add_action('wp_enqueue_scripts', 'your_function_name')` 才是標準作法。這樣 WordPress 才能管理依賴性、避免重複載入，並讓快取外掛 (如 WP Rocket) 正確優化。

    ````php
    // 在 functions.php 中
    function moksa_enqueue_assets() {
        // 載入 style.css
        wp_enqueue_style(
            'moksa-main-style', // 自訂一個獨一無二的 handle (ID)
            get_stylesheet_uri() // get_stylesheet_uri() 是 style.css 的專用函式
        );

        // 載入 custom.js
        wp_enqueue_script(
            'moksa-custom-script',
            get_stylesheet_directory_uri() . '/assets/js/custom.js',
            array( 'jquery' ), // 依賴 jQuery，WordPress 會確保先載入 jQuery
            '1.0.0', // 版本號
            true // true 表示放在頁尾 </body> 前載入
        );
    }
    add_action( 'wp_enqueue_scripts', 'moksa_enqueue_assets' );
    ````

### 判斷式函式 (Conditional Tags)

這些函式非常實用，它們會回傳 `true` 或 `false`，讓你可以在特定條件下執行特定程式碼。

*   `is_front_page()`：是否在網站首頁？
*   `is_single()`：是否在單一「文章」頁面？
*   `is_page()`：是否在單一「頁面」頁面？
*   `is_archive()`：是否在任何彙整頁（分類、標籤、作者、日期）？
*   `is_category()`：是否在分類彙整頁？
*   `is_user_logged_in()`：使用者是否登入？
*   `current_user_can( 'capability' )`：當前使用者是否擁有某個權限？例如 `current_user_can('manage_options')` 用來判斷是否為管理員。

### (實作) 綜合應用範例

**需求：** 我們希望在每一篇「文章」的內容結尾，自動加上一行作者的署名。

這個需求結合了「判斷式函式」和「文章相關函式」，並會使用到下個章節才會詳細說明的「Filter Hook」。

**步驟 1：打開 `functions.php`**
在你的子佈景主題資料夾中，找到 `functions.php` 檔案並用 VS Code 打開。

**步驟 2：貼上以下程式碼**
將下方的程式碼片段完整地貼到 `functions.php` 的最下方。

````php
/**
 * 在文章內容結尾自動加上作者署名
 *
 * @param string $content 文章原始內容.
 * @return string 修改後的文章內容.
 */
function moksa_add_author_signature( $content ) {
    // 使用 is_single() 判斷式，確保只在「單篇文章」頁面生效
    // 使用 in_the_loop() 確保我們是在 WordPress 主循環中，避免修改到選單等非主要內容
    if ( is_single() && in_the_loop() && is_main_query() ) {
        // 取得作者的顯示名稱
        $author_name = get_the_author();
        
        // 組合要附加的 HTML 內容
        $signature = '<p style="text-align: right; font-style: italic;">—— ' . esc_html( $author_name ) . '</p>';
        
        // 將署名附加到原始內容 ($content) 的後面並回傳
        return $content . $signature;
    }
    
    // 如果不符合條件，務必回傳原始的 $content
    return $content;
}

// 將我們的函式掛載到 a 'the_content' 這個 filter hook 上
add_filter( 'the_content', 'moksa_add_author_signature' );
````
````

**步驟 3：儲存並查看結果**
儲存 `functions.php` 檔案，然後到網站前台隨便點開一篇文章，你應該可以在文章內容的最下面看到多出了一行作者署名。但是當你去看「頁面」或是「分類列表頁」，則不會看到這行字。

這就是 WordPress 函式強大的地方，短短幾行程式碼，就完成了精準的判斷與內容修改。

---

### 總結

今天我們學習了 WordPress 開發中最重要的 PHP 基礎：全域變數與常用函式。

*   **全域變數** (`$wpdb`, `$post`...) 讓我們可以方便地存取 WordPress 核心的資料與物件。
*   **常用函式** (`get_bloginfo`, `the_title`, `is_single`...) 則組成了 WordPress 的 API，讓我們可以用標準化、安全且有效率的方式與 WordPress 互動。

請務必花時間熟悉這些變數和函式，並養成在開發前先到 [WordPress Developer Resources](https://developer.wordpress.org/reference/) 查閱官方文件的習慣。這會讓你的開發之路走得更順、更遠。

在下一個章節，我們將會深入探討驅動 WordPress 的核心機制：**Hooks (掛鉤)，也就是 Actions (動作) 與 Filters (過濾器)**。我們今天範例中用到的 `add_filter()` 就是其中之一，敬請期待！