# 05.05 (實務) 如何使用 Query Monitor 追蹤 Hooks

嗨，歡迎來到 MoksaWP 的開發者課程！在前面的章節中，我們已經深入理解了 WordPress Hooks (包含 Actions 與 Filters) 的強大之處，它們是 WordPress 能夠如此靈活、可擴充的核心。

然而，在實際開發中，尤其是在一個安裝了多個外掛與複雜佈景主題的網站上，你很快會遇到一個挑戰：「**到底是哪個函式在什麼時候修改了我的內容？**」、「**這個頁面到底執行了哪些 Actions？順序是什麼？**」。如果沒有好的工具，除錯過程就像大海撈針。

這堂課，我們要介紹的，就是所有 WordPress 開發者都應該安裝在開發環境的瑞士刀——**Query Monitor**。它能讓我們清晰地透視 WordPress 在背後運行的每一個細節，而我們今天將專注於如何使用它來追蹤、分析與除錯 Hooks。

---

### 什麼是 Query Monitor？

Query Monitor 是一個**免費**的 WordPress 外掛，它在 WordPress 的管理工具列 (Admin Bar) 中新增了一個詳細的除錯面板。它不僅僅能看 Hooks，還能監控：

*   資料庫查詢 (Database Queries)
*   PHP 錯誤與警告 (PHP Errors)
*   載入的腳本與樣式 (Scripts & Styles)
*   HTTP API 請求
*   頁面載入時間與記憶體使用量
*   ...以及我們今天的主角：**Hooks & Actions**

**Moksa 技巧：** 在 Moksa 的標準開發流程中，**LocalWP** 環境裡必定會安裝 Query Monitor。它就像是開發者的 X 光眼鏡，能幫我們省下數小時的除錯時間。

### 安裝與啟用

安裝過程非常簡單，就跟安裝一般外掛一樣。

*   **步驟 1:** 進入 WordPress 後台，前往「外掛」>「安裝外掛」。
*   **步驟 2:** 在搜尋框中輸入「**Query Monitor**」。
*   **步驟 3:** 找到由 John Blackbourn 開發的外掛，點擊「立即安裝」並「啟用」。

啟用後，你應該會在頂部的管理工具列看到一組新的數據，這就是 Query Monitor 的入口。

``
*示意圖：啟用 Query Monitor 後，頂部管理工具列出現的數據面板。*

---

### (實作) 使用 Query Monitor 追蹤 Hooks

讓我們開始進入實作環節。當你將滑鼠移到管理工具列的 Query Monitor 數據上時，會彈出一個下拉選單。

#### 步驟 1: 開啟 Hooks 面板

點擊下拉選單中的「**Hooks & Actions**」選項。這會帶你到 Query Monitor 的主面板，並自動切換到對應的頁籤。

``
*示意圖：從 Query Monitor 下拉選單中選擇 "Hooks & Actions"。*

#### 步驟 2: 篩選與搜尋特定的 Hook

進入面板後，你會看到當前頁面載入時所觸發的**所有** Hooks，數量可能非常驚人 (數百甚至上千個)。這時，**篩選功能**就顯得至關重要。

在面板的左上方，你會看到一個「**Hook Name**」的搜尋框。

**範例：追蹤 `the_content` Filter**

`the_content` 是一個非常核心的 Filter，它負責過濾文章或頁面的主內容。許多外掛（如 SEO 外掛、內容區塊外掛）都會掛載函式到這個 Hook 上。

1.  前往任何一篇你的網站文章前台頁面。
2.  打開 Query Monitor 的「Hooks & Actions」面板。
3.  在「**Hook Name**」搜尋框中輸入 `the_content`。

你將會看到所有附加到 `the_content` 這個 Filter 上的函式列表。

``
*示意圖：Query Monitor 面板中，篩選出所有與 `the_content` 相關的函式。*

#### 步驟 3: 解讀 Hook 的詳細資訊

篩選結果會以表格形式呈現，每一行都代表一個掛載在該 Hook 上的函式。表格包含了以下幾個關鍵欄位：

*   **Hook:** Hook 的名稱，例如 `the_content`。
*   **Priority:** **優先級**。數字越小，越早執行。預設是 10。這對於判斷函式執行順序至關重要。
*   **Callback:** **回呼函式**。實際被執行的函式名稱。你可以看到是哪個類別的哪個方法，或是哪個獨立的函式。
*   **Component:** **元件**。這是 Query Monitor 最強大的功能之一！它會告訴你這個函式是來自於**哪個外掛、哪個佈景主題，或是 WordPress 核心**。這在除錯外掛衝突時是無價之寶。
*   **Location:** **位置**。精確地告訴你這個函式定義在**哪個檔案的第幾行**。

---

### (進階實務) 解決 WooCommerce 實際問題

理論說完了，讓我們來解決一個在 WooCommerce 開發中非常常見的問題。

**情境：** 「我的商品頁面上，價格的顯示格式很奇怪，多了一段我不想要的文字。我想找出是哪個外掛或佈景主題搞的鬼。」

這個問題通常是某個函式透過 Filter 修改了 WooCommerce 的價格 HTML 輸出所導致的。

*   **步驟 1: 找出目標 Hook**
    根據 WooCommerce 的開發經驗，我們知道控制價格 HTML 輸出的關鍵 Filter 是 `woocommerce_get_price_html`。

*   **步驟 2: 在商品頁面中，使用 Query Monitor 進行追蹤**
    1.  前往任何一個單一商品的前台頁面。
    2.  打開 Query Monitor 的「Hooks & Actions」面板。
    3.  在「**Hook Name**」搜尋框中輸入 `woocommerce_get_price_html`。

*   **步驟 3: 分析結果並定位問題**
    Query Monitor 會列出所有修改價格顯示的函式。你可能會看到類似這樣的列表：

| Priority | Callback                                      | Component          | Location                                           |
| :------- | :-------------------------------------------- | :----------------- | :------------------------------------------------- |
| 10       | `WC_Product_Simple::get_price_html()`         | WooCommerce (Core) | `/wp-content/plugins/woocommerce/...`              |
| 20       | `some_currency_switcher_plugin_function()`    | Currency Switcher  | `/wp-content/plugins/currency-switcher/...`        |
| **99**   | **`my_theme_custom_price_display()`**         | **My Awesome Theme** | **/wp-content/themes/my-awesome-theme/functions.php:258** |

``
*示意圖：Query Monitor 顯示有多個函式掛載在 `woocommerce_get_price_html` 上。*

透過這個列表，我們可以清楚地做出判斷：
1.  WooCommerce 核心函式最先執行 (Priority 10)。
2.  接著一個匯率轉換外掛執行了它的函式 (Priority 20)。
3.  最後，我們使用中的佈景主題 (`My Awesome Theme`) 用一個**非常高的優先級 (99)** 執行了 `my_theme_custom_price_display()` 這個函式。

**結論：** 問題很可能就出在 `my-awesome-theme/functions.php` 的第 258 行。這時，我們就可以直接打開這個檔案進行檢查或修改。

### Moksa 技巧與注意事項

1.  **追蹤「呼叫者 (Caller)」:** 在「Hooks & Actions」面板的篩選器中，除了可以用 Hook Name 搜尋，還可以切換到「**Caller**」。這可以幫你找出是**哪段程式碼觸發**了某個 `do_action()` 或 `apply_filters()`。這在追蹤複雜的程式邏輯時非常有用。

2.  **搭配 VS Code 快速定位:** 當你在 Query Monitor 的 `Location` 欄位看到檔案路徑與行數時，可以直接在 **VS Code** 中使用 `Cmd+P` (macOS) 或 `Ctrl+P` (Windows)，輸入檔案名稱，再用 `:` 加上行數（例如 `functions.php:258`），就可以瞬間跳到問題程式碼的位置。

3.  **僅在開發環境使用:** **非常重要！** Query Monitor 為了收集資訊，會增加伺服器的負擔，稍微影響網站效能。因此，它是一個**開發工具**，只應該在 **LocalWP** 這類的本機環境或臨時的測試網站 (Staging) 上啟用。**絕對不要在正式上線的網站對一般訪客啟用 Query Monitor。**

### 總結

掌握 Query Monitor 是從 WordPress 使用者晉升為開發者的重要一步。它將 WordPress 從一個黑盒子變成了一個透明的系統，讓你可以精準地定位問題、理解外掛與佈景主題的運作方式，並更有信心地進行客製化開發。

請務必花時間在你的開發環境中熟悉它，嘗試去追蹤不同頁面、不同操作下的 Hooks，這將為你未來的開發之路打下堅實的基礎。