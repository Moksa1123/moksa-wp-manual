# 02.07 (實務) 使用 NPM 與 Webpack 管理前端資源

你好！我是 Moksa 的首席課程導師。在之前的章節中，我們可能還是使用比較傳統的方式來管理 CSS 和 JavaScript 檔案，例如直接在佈景主題或外掛中建立 `style.css` 和 `main.js`，然後手動引入。這種方式在小型專案中尚可應付，但隨著專案規模變大、功能變複雜，你會很快遇到以下痛點：

*   **手動壓縮 (Minify):** 為了效能，你需要手動壓縮 JS/CSS 檔案，非常耗時。
*   **瀏覽器快取:** 更新 CSS/JS 後，常因為瀏覽器快取而看不到最新效果，需要不斷地「清除快取後強制重新整理」。
*   **無法使用新語法:** 無法直接使用像 SCSS/SASS 這樣的 CSS 預處理器，或是 ES6+ 的現代 JavaScript 語法，因為瀏覽器不完全支援。
*   **相依性管理混亂:** 當你需要引用第三方函式庫 (如 Swiper.js, AOS.js)，你需要手動下載檔案、放到專案中，版本更新時更是惡夢。

為了解決這些問題，現代化的前端開發流程引入了 **NPM** 與 **Webpack** 這兩大利器。這堂課，我們將從零開始，學習如何將這套現代化工作流程整合到你的 WordPress 佈景主題或外掛開發中。

---

### 什麼是 NPM 與 Webpack？

在我們開始動手前，先花點時間理解這兩個工具的核心概念：

1.  **NPM (Node Package Manager):**
    *   它是世界上最大的軟體註冊庫。你可以把它想像成一個**超大型的程式碼零件倉庫**。
    *   當你需要某個前端函式庫（例如：一個輪播特效、一個燈箱效果），你不需要再去官網下載，只需要透過指令 `npm install [套件名稱]`，NPM 就會自動幫你下載並管理版本。
    *   它透過一個名為 `package.json` 的檔案來記錄你的專案需要哪些「零件」，方便團隊協作與專案遷移。

2.  **Webpack:**
    *   它是一個**模組打包工具 (Module Bundler)**。
    *   它的核心任務是：讀取你撰寫的現代化原始碼（例如 SCSS、ES6+ JavaScript），經過一系列的「加工處理」（例如：將 SCSS 編譯成 CSS、將 ES6+ 轉譯成瀏覽器相容的 ES5），最後將所有相關的檔案「打包」成少數幾個最佳化過的靜態檔案（例如 `bundle.js`、`main.css`）。
    *   **Moksa 技巧：** 簡單來說，**你寫的是給「開發者」看的原始碼，Webpack 則幫你產出給「瀏覽器」看的最終檔案**。這中間的轉換過程，就是它發揮價值的地方。

### 前置準備

在開始之前，請確保你的開發環境已具備以下條件：

*   **Node.js 與 NPM:** Webpack 是基於 Node.js 運行的。請先到 [Node.js 官網](https://nodejs.org/) 下載並安裝 LTS (長期支援) 版本。安裝完成後，NPM 也會一併安裝。
    *   打開你的終端機 (Terminal 或 VS Code 的內建終端機)，輸入以下指令來確認是否安裝成功：
        ```bash
        node -v
        npm -v
        ```
        如果能看到版本號，代表安裝成功。
        `[截圖]`
*   **本機開發環境:** 我們假設你已經使用 **LocalWP** 建立好了一個本地的 WordPress 站點。
*   **程式碼編輯器:** 我們推薦使用 **VS Code**，它內建了強大的終端機功能。
*   **一個空的 WordPress 專案資料夾:** 你可以選擇在一個自訂的佈景主題或外掛資料夾中進行操作。本教學將以在佈景主題 `wp-content/themes/my-custom-theme` 中實作為例。

---

### (實作) 建立現代化前端工作流

接下來，我們將一步步建立起整個開發流程。

#### 步驟 1: 初始化 NPM 專案

首先，我們要讓 NPM 來管理我們的專案。

1.  打開 VS Code，並開啟你的佈景主題資料夾 (e.g., `my-custom-theme`)。
2.  在 VS Code 中打開終端機 (快捷鍵 `Ctrl` + `~`)。
3.  確認你的路徑在佈景主題的根目錄下，然後輸入以下指令：
    ```bash
    npm init -y
    ```
4.  這個指令會做什麼？
    *   `init` 代表初始化一個新的 NPM 專案。
    *   `-y` 旗標代表「Yes」，它會自動幫你回答所有預設問題，快速生成一個名為 `package.json` 的檔案。

`[截圖]`

現在你的專案根目錄下應該會多出一個 `package.json` 檔案，這是我們專案的「身分證」，裡面記錄了專案名稱、版本、以及最重要的「相依套件」。

#### 步驟 2: 安裝 Webpack 與相關核心套件

接下來，我們要安裝 Webpack 以及它運作所需要的「加工工具」(也就是 Loaders 和 Plugins)。

在終端機中，執行以下指令：

```bash
npm install webpack webpack-cli --save-dev
```

然後，安裝處理 CSS/SCSS 與 JS 的必要套件：

```bash
npm install --save-dev @babel/core @babel/preset-env babel-loader sass sass-loader css-loader mini-css-extract-plugin
```

讓我們來解析一下這些套件：

*   `webpack`, `webpack-cli`: Webpack 的核心與命令列工具。
*   `--save-dev` (`-D`): 这是一个**重要觀念**。它告訴 NPM，這些套件只在「開發過程」中需要，最終上線的網站並不需要它們。這會將套件記錄在 `package.json` 的 `devDependencies` 區塊。
*   `@babel/core`, `@babel/preset-env`, `babel-loader`: 這是 Babel 的組合，負責將 ES6+ 的新潮 JavaScript 語法，轉譯成絕大多數瀏覽器都看得懂的舊版 ES5 語法。
*   `sass`, `sass-loader`: 負責處理和編譯 `.scss` 或 `.sass` 檔案。
*   `css-loader`: 負責解析 CSS 中的 `@import` 和 `url()`。
*   `mini-css-extract-plugin`: **Moksa 技巧：** 這個外掛非常重要！它會將 Webpack 處理好的 CSS 從 JS 檔案中**抽離**出來，變成一個獨立的 `.css` 檔案。這才是 WordPress 引入 CSS 的標準做法。

安裝完成後，你的 `package.json` 會自動更新，記錄下這些開發相依套件與它們的版本。

#### 步驟 3: 建立專案資料夾結構

一個清晰的資料夾結構，能讓開發更有條理。我們建議在專案根目錄下建立以下結構：

```
my-custom-theme/
├── src/                  <-- 你的原始碼都放在這裡
│   ├── js/
│   │   └── main.js
│   └── scss/
│       └── main.scss
├── dist/                 <-- Webpack 編譯打包後的最終檔案會放在這裡 (此資料夾會自動生成)
├── functions.php
├── index.php
├── package.json
└── style.css
... 其他佈景主題檔案
```

*   `src` (Source): 存放我們實際要撰寫的原始碼。
*   `dist` (Distribution): 存放最終給瀏覽器使用的檔案，我們不會手動修改這個資料夾的任何內容。

請手動建立 `src/js/main.js` 和 `src/scss/main.scss` 並填入一些簡單的測試內容。

**src/js/main.js:**
```javascript
// 引入 SCSS 檔案，讓 Webpack 知道要處理它
import '../scss/main.scss';

// 使用 ES6+ 語法來測試 Babel
const sayHello = (name) => {
  console.log(`Hello, ${name}! Welcome to the MoksaWP course.`);
};

sayHello('Developer');
```

**src/scss/main.scss:**
```scss
// 使用 SCSS 語法來測試
body {
  background-color: #f0f0f0;

  h1 {
    color: #333;
    font-family: sans-serif;
  }
}
```

#### 步驟 4: 設定 Webpack (webpack.config.js)

Webpack 需要一份「設定檔」來告訴它該如何工作。在你的專案根目錄下，手動建立一個新檔案，命名為 `webpack.config.js`。

貼上以下設定內容：

```javascript
// 引入 Node.js 的 path 模組，方便處理路徑
const path = require('path');
// 引入 MiniCssExtractPlugin
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

module.exports = {
  // 模式: 'development' (開發模式) 或 'production' (生產模式)
  mode: 'development',

  // 進入點 (Entry): Webpack 從哪個檔案開始打包
  entry: './src/js/main.js',

  // 輸出 (Output): 打包後的檔案要放在哪裡、叫什麼名字
  output: {
    path: path.resolve(__dirname, 'dist'), // 輸出路徑為根目錄下的 'dist' 資料夾
    filename: 'main.js', // 輸出的 JS 檔名
  },

  // 模組 (Module): 設定不同類型的檔案要如何被處理 (使用 Loaders)
  module: {
    rules: [
      {
        // 規則 1: 處理 JavaScript 檔案
        test: /\.js$/, // 針對所有 .js 結尾的檔案
        exclude: /node_modules/, // 排除 node_modules 資料夾
        use: {
          loader: 'babel-loader', // 使用 babel-loader
          options: {
            presets: ['@babel/preset-env'], // 使用 @babel/preset-env 轉譯語法
          },
        },
      },
      {
        // 規則 2: 處理 SCSS/CSS 檔案
        test: /\.scss$/, // 針對所有 .scss 結尾的檔案
        use: [
          MiniCssExtractPlugin.loader, // 步驟 1: 將 CSS 抽離成獨立檔案
          'css-loader',                // 步驟 2: 解析 CSS 的 @import 和 url()
          'sass-loader',               // 步驟 3: 將 SCSS 編譯成 CSS
        ],
      },
    ],
  },

  // 外掛 (Plugins): 使用額外的工具來輔助 Webpack
  plugins: [
    new MiniCssExtractPlugin({
      filename: 'main.css', // 設定抽離出來的 CSS 檔名
    }),
  ],
};
```

這份設定檔告訴 Webpack：
1.  從 `./src/js/main.js` 開始分析。
2.  遇到 `.js` 檔案，用 Babel 處理。
3.  遇到 `.scss` 檔案，依序用 `sass-loader` -> `css-loader` -> `MiniCssExtractPlugin.loader` 處理。
4.  最後，將處理完的 JS 輸出到 `dist/main.js`，並將所有 CSS 抽離打包成 `dist/main.css`。

#### 步驟 5: 設定 NPM Scripts 並執行打包

最後一步，我們要設定簡單的指令來執行 Webpack。

打開 `package.json` 檔案，找到 `"scripts"` 這個區塊，修改成以下內容：

```json
"scripts": {
  "test": "echo \"Error: no test specified\" && exit 1",
  "build": "webpack --mode production",
  "watch": "webpack --watch --mode development"
},
```
`[截圖]`

我們新增了兩個非常實用的指令：
*   **`build`**: 執行一次性的「生產模式」打包。Webpack 會自動壓縮和最佳化程式碼。當你要將專案部署到正式站時，就執行這個指令。
*   **`watch`**: 啟動「監看模式」。Webpack 會持續監控你的 `src` 資料夾，一旦你儲存了任何檔案的變更，它就會**自動重新編譯打包**。這是開發時最常用的指令！

現在，讓我們來試試看！在終端機輸入：

```bash
npm run watch
```

`[截圖]`

如果一切順利，你會看到 Webpack 開始運作，並成功編譯。同時，你的專案中會自動出現一個 `dist` 資料夾，裡面包含了 `main.js` 和 `main.css` 兩個檔案。打開它們看看，你會發現 `main.css` 是編譯好的 CSS，而 `main.js` 則是轉譯過的 JavaScript。

#### 步驟 6: 在 WordPress 中引入打包後的資源

最後，也是最關鍵的一步，我們要讓 WordPress 去讀取 Webpack 產出的檔案。

打開你的佈景主題的 `functions.php` 檔案，加入以下 PHP 程式碼：

```php
function moksa_enqueue_assets() {
    // 取得打包後 CSS 的路徑
    $css_file_path = get_template_directory() . '/dist/main.css';
    $css_file_uri = get_template_directory_uri() . '/dist/main.css';

    // 取得打包後 JS 的路徑
    $js_file_path = get_template_directory() . '/dist/main.js';
    $js_file_uri = get_template_directory_uri() . '/dist/main.js';

    // Moksa 技巧: 使用 filemtime() 作為版本號，解決瀏覽器快取問題
    // 只要檔案有修改，時間戳就會變更，瀏覽器就會強制載入新檔案
    $css_version = file_exists($css_file_path) ? filemtime($css_file_path) : '1.0.0';
    $js_version = file_exists($js_file_path) ? filemtime($js_file_path) : '1.0.0';

    // 引入 CSS
    wp_enqueue_style(
        'moksa-main-style',      // 自訂一個獨一無二的 handle 名稱
        $css_file_uri,           // 檔案的 URL
        array(),                 // 相依性
        $css_version             // 版本號
    );

    // 引入 JS
    wp_enqueue_script(
        'moksa-main-script',     // 自訂一個獨一無二的 handle 名稱
        $js_file_uri,            // 檔案的 URL
        array(),                 // 相依性
        $js_version,             // 版本號
        true                     // true 代表在 </body> 前載入
    );
}

add_action('wp_enqueue_scripts', 'moksa_enqueue_assets');
```

**重點解釋：**

*   我們引入的是 **`dist` 資料夾**中的檔案，而不是 `src`。
*   **`filemtime()`** 是一個非常實用的 PHP 函式，它會取得檔案的最後修改時間。我們將這個時間戳作為版本號，這樣只要你透過 `npm run watch` 重新編譯了檔案，版本號就會自動更新，完美解決了瀏覽器快取問題！

現在，回到你的 WordPress 前台，重新整理頁面並打開開發者工具 (F12)。你會在 Console 中看到 "Hello, Developer!..." 的訊息，並且頁面的背景色也變了。這代表你已經成功地將一整套現代化前端開發流程整合進 WordPress 了！

### 總結

恭喜你！你已經完成了 WordPress 開發中非常重要的一個里程碑。雖然初次設定看起來有些繁瑣，但它帶來的好處是巨大的：

1.  **自動化:** `npm run watch` 讓你專注於寫程式，存檔後所有編譯、打包工作自動完成。
2.  **現代化:** 你可以自由地使用 SCSS 的變數、巢狀、Mixin 等強大功能，以及 JavaScript ES6+ 的箭頭函式、`const`/`let` 等新語法。
3.  **高效能:** `npm run build` 會自動幫你壓縮程式碼，優化網站載入速度。
4.  **好管理:** 所有前端套件都透過 `package.json` 統一管理，專案交接或協作變得非常輕鬆。

這只是一個基礎的 Webpack 設定，但已經足以應付絕大多數 WordPress 專案的需求。未來你還可以繼續擴充它，例如加入圖片壓縮、字體檔案處理等功能。熟練這套工作流程，將會大幅提升你的開發效率與程式碼品質。