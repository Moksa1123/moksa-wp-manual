# 04.02 (核心) 模板層級 (Template Hierarchy)

各位同學好！我是 Moksa 的首席課程導師。

在 WordPress 佈景主題開發的世界裡，如果說 The Loop (主循環) 是心跳，那麼 **模板層級 (Template Hierarchy)** 就是整個佈景主題的「大腦」與「決策中心」。它是一套 WordPress 內建的規則，用來決定當使用者瀏覽網站上任何一個網址 (URL) 時，到底該載入哪一個 PHP 模板檔案來呈現頁面內容。

理解並精通模板層級，是你從「網頁組裝師」蛻變為「專業佈景主題開發者」的**關鍵一步**。它能讓你精準控制網站上每一個頁面的外觀與功能，從而打造出真正客製化、高效能的網站。

這堂課的目標，就是帶你徹底搞懂這套系統的運作邏輯，並學會如何利用它來進行實務開發。

---

### 什麼是模板層級 (Template Hierarchy)？

簡單來說，模板層級就是一套 **WordPress 的決策流程圖**。當一個請求進來時，WordPress 會依循這個流程圖，由上至下、由左至右，去檢查你的佈景主題資料夾內是否存在對應的檔案。

它會從**最精確、最特定的模板**開始找起，如果找不到，就會退一步 (Fallback) 尋找**比較通用的模板**，直到最後，如果所有特定的模板都找不到，它一定會使用 **`index.php`** 這個最終的、**必備的**模板檔案。

**Moksa 技巧：** `index.php` 是所有佈景主題的「最後防線」。一個合法的 WordPress 佈景主題，**至少要包含 `style.css` 和 `index.php` 這兩個檔案**。缺少 `index.php` 會導致佈景主題無法正常運作。

你可以參考 WordPress 官方提供的模板層級圖來視覺化這個流程：

``
*WordPress 官方模板層級示意圖*
``

---

### 最常見的模板層級規則

讓我們來分解幾個最常見頁面類型的決策流程，幫助你更快地理解這個概念。

#### 1. 首頁 (Front Page)

當使用者瀏覽你的網站根目錄 (例如 `https://moksaweb.com`) 時，WordPress 會依照以下順序尋找模板：

1.  **`front-page.php`**: 無論你在「設定 > 閱讀」中設定首頁顯示「最新文章」還是「靜態頁面」，只要這個檔案存在，**它永遠是顯示網站首頁的第一優先選擇**。
2.  **`home.php`**: 如果 `front-page.php` 不存在，且你在後台設定首頁顯示「最新文章」，WordPress 就會尋找 `home.php`。
3.  **`page.php`**: 如果 `front-page.php` 不存在，且你在後台設定首頁顯示某個「靜態頁面」(例如：名為 "首頁" 的頁面)，WordPress 就會尋找 `page.php`。
4.  **`index.php`**: 如果以上檔案都不存在，WordPress 就會使用最終的 `index.php`。

#### 2. 單一內容頁面 (Singular Pages)

這包含了單篇「文章 (Post)」、「頁面 (Page)」以及任何你自訂的「文章類型 (Custom Post Type, CPT)」。

*   **單篇文章 (Post):**
    1.  `single-post-{slug}.php`: (例如：`single-post-hello-world.php`) - 針對特定 slug 的文章。
    2.  `single-post.php`: 針對所有「文章」類型。
    3.  `single.php`: 針對所有「單一內容頁面」(包含文章、CPT)。
    4.  `singular.php`: 比 `single.php` 更通用的單一頁面模板 (也包含「頁面」)。
    5.  `index.php`: 最終防線。

*   **單一頁面 (Page):**
    1.  `page-{slug}.php`: (例如：`page-about-us.php`) - 針對特定 slug 的頁面。
    2.  `page-{id}.php`: (例如：`page-2.php`) - 針對特定 ID 的頁面。
    3.  `page.php`: 針對所有「頁面」。
    4.  `singular.php`: 通用的單一頁面模板。
    5.  `index.php`: 最終防線。

#### 3. 彙整頁面 (Archive Pages)

彙整頁面是顯示文章列表的頁面，例如分類、標籤、作者、日期等。

*   **分類彙整 (Category Archive):**
    1.  `category-{slug}.php`: (例如：`category-news.php`) - 針對特定 slug 的分類。
    2.  `category-{id}.php`: (例如：`category-1.php`) - 針對特定 ID 的分類。
    3.  `category.php`: 針對所有「分類彙整」。
    4.  `archive.php`: 針對所有「彙整頁面」(包含分類、標籤、作者等)。
    5.  `index.php`: 最終防線。

#### 4. 特殊頁面 (Special Pages)

*   **404 錯誤頁面**: 當找不到對應內容時，WordPress 會直接尋找 `404.php`。如果找不到，你的網站可能會顯示一個很醜的伺服器預設錯誤頁面。
*   **搜尋結果頁面**: 當使用者進行搜尋後，WordPress 會尋找 `search.php` 來顯示結果列表。如果找不到，就會退回使用 `index.php`。

---

### (實作) 如何找出目前頁面正在使用哪個模板？

理論說了這麼多，在實際開發時，我們如何快速知道當前頁面到底是用哪個模板檔案渲染出來的呢？死記流程圖太慢了，我們要用專業的工具。

**Moksa 技巧：** 在開發環境中，**`Query Monitor`** 外掛是你的最佳夥伴。它可以清楚地告訴你目前頁面載入了哪個模板檔案，以及其完整的路徑。

#### 步驟 1: 安裝與啟用 Query Monitor

在你的 LocalWP 開發環境中，直接到「外掛 > 安裝外掛」，搜尋 `Query Monitor` 並啟用它。

``
*安裝 Query Monitor 外掛*
``

#### 步驟 2: 瀏覽網站前台

啟用後，以管理員身份登入並瀏覽你的網站前台。你會在頂部的管理員工具列看到多出一個新的區塊，上面顯示著頁面載入時間、記憶體用量等資訊。

``
*Query Monitor 顯示在管理員工具列*
``

#### 步驟 3: 查看模板資訊

將滑鼠移到 Query Monitor 的區塊上，會出現一個下拉選單。點擊「**Template**」。

``
*點擊 Query Monitor 的 Template 選項*
``

#### 步驟 4: 找到「模板」(Template) 資訊

在 Query Monitor 的主面板中，你會清楚看到目前頁面使用的**模板檔案 (Template File)**，以及所有透過 `get_template_part()` 載入的**模板組件 (Template Parts)**。

``
*Query Monitor 清晰地顯示出目前使用的模板檔案是 single.php*
``

這個技巧可以幫你節省大量猜測和除錯的時間，是我們 Moksa 團隊開發時的標準配備。

---

### (實作) 為「課程」自訂文章類型 (CPT) 建立專屬模板

現在，讓我們來應用剛剛學到的知識。假設我們在網站上用 ACF 或其他工具建立了一個名為「課程 (Course)」的自訂文章類型 (CPT)，它的 slug 是 `course`。我們不希望課程頁面跟一般部落格文章長得一樣，我們想為它建立一個專屬的版型。

#### **情境**

*   我們有一個 CPT，slug 為 `course`。
*   我們要建立一個專屬的單一課程頁面模板。
*   模板中要顯示課程的特有資訊，例如「課程講師」(一個自訂欄位)。

#### 步驟 1: 根據層級規則，決定檔案名稱

根據我們上面學到的單一內容頁面規則 (`single-{post-type}.php`)，我們知道要建立的檔案名稱應該是 **`single-course.php`**。

#### 步驟 2: 在佈景主題資料夾中建立檔案

1.  使用 VS Code 打開你的佈景主題資料夾。
2.  為了節省時間，你可以先複製一份 `single.php` 或 `singular.php` 的內容。
3.  在佈景主題的根目錄下，建立一個新檔案，並命名為 `single-course.php`。
4.  將剛剛複製的程式碼貼上。

``
*在 VS Code 中建立 single-course.php 檔案*
``

#### 步驟 3: 客製化模板內容

現在，`single-course.php` 就是課程頁面的專屬模板了。你可以在這裡面加入任何客製化程式碼。例如，我們在 `the_content()` 下方，使用 ACF 的函式來顯示「課程講師」這個自訂欄位。

```php
<?php
/**
 * The template for displaying all single courses
 */

get_header();
?>

<main id="primary" class="site-main">

    <?php
    while ( have_posts() ) :
        the_post();

        the_title( '<h1 class="entry-title">', '</h1>' );

        the_content();

        // Moksa 技巧：在這裡加入 CPT 的專屬內容
        // 假設我們用 ACF 建立了一個名為 course_instructor 的自訂欄位
        if ( get_field('course_instructor') ) {
            echo '<h2>課程講師：' . esc_html( get_field('course_instructor') ) . '</h2>';
        }

    endwhile; // End of the loop.
    ?>

</main><!-- #main -->

<?php
get_footer();
```

#### 步驟 4: 驗證結果

1.  儲存 `single-course.php` 檔案。
2.  到網站前台，隨便點開一篇你建立的「課程」內容。
3.  使用 Query Monitor 檢查，你會發現它現在載入的模板檔案正是 **`single-course.php`**！
4.  同時，你應該也能在頁面上看到你剛剛新增的「課程講師」資訊。

---

### 總結

恭喜你！你已經掌握了 WordPress 佈景主題開發中最核心、也最重要的概念之一。

**本章重點回顧：**

1.  **模板層級** 是 WordPress 決定載入哪個模板檔案的決策流程。
2.  它會從 **最特定** 的檔案開始找，找不到再退回到 **較通用** 的檔案。
3.  **`index.php`** 是最終的、必備的備用模板。
4.  **Query Monitor** 是你在開發中識別、除錯模板層級問題的最佳工具。
5.  你可以透過建立符合命名規則的檔案 (如 `single-course.php`, `page-about-us.php`)，來為特定內容建立專屬的版型。

熟練地運用模板層級，你就能隨心所欲地打造出任何你想要的頁面結構。在接下來的課程中，我們將會更深入地探討模板檔案內的 The Loop 運作以及如何使用 `get_template_part()` 來組織你的程式碼。