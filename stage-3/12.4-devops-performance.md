# 12.04 (實務) 網站效能極限優化 (Redis, Object Cache)

學員們好！我是 Moksa 的首席課程導師。

在之前的課程中，我們已經透過 WP Rocket 和 ShortPixel 處理了前端的「頁面快取」與「圖片壓縮」，這兩者主要優化的是「**首次載入網站的訪客**」的體驗。然而，當網站變得複雜，例如一個擁有大量商品、會員、或線上課程的 WooCommerce 網站時，效能瓶頸往往會轉移到伺服器後端的「**資料庫查詢**」。

這堂課，我們將深入探討一個專業開發者必備的進階武器：**Redis 物件快取 (Object Cache)**。它能將重複的、耗時的資料庫查詢結果暫存在記憶體中，大幅降低資料庫負載，顯著提升網站後台、登入會員的操作速度，以及動態內容的載入效能。

---

### 什麼是物件快取 (Object Cache)？

我們可以把 WordPress 的運作想像成一位廚師（PHP 程式）在廚房（伺服器）做菜。

*   **沒有快取時：** 每當有客人點菜（發出一個網頁請求），廚師都必須親自跑到儲藏室（資料庫）去拿食材（資料），即使是做同一道菜也要重複跑好幾趟。這非常耗時。
*   **WordPress 內建的 Object Cache：** WordPress 其實內建了一個基礎的物件快取。這位廚師會把「這一次點餐中」會用到的食材先放在手邊的料理台上。這樣在「同一次請求」中，就不用一直跑儲藏室。但問題是，下一位客人點餐時，料理台是空的，廚師還是要重跑一次儲藏室。這種快取是**非持久性 (Non-persistent)**的。
*   **Redis 物件快取：** 這就像是給廚房配備了一台超高速的智慧備料冰箱 (Redis)。廚師第一次從儲藏室 (資料庫) 拿來食材後，會順手把常用的食材（例如：網站設定、熱門商品資訊）放進這台冰箱。之後任何客人點菜，廚師會**優先**從這台超快的冰箱裡拿食材，只有冰箱裡沒有的，才需要跑回儲藏室。這台冰箱的內容會一直保留，直到被更新或清除，因此稱為**持久性 (Persistent)**物件快取。

**Moksa 技巧：** **頁面快取 (Page Caching)** 主要服務「未登入訪客」，提供靜態 HTML 頁面。而 **物件快取 (Object Caching)** 則是服務「所有請求」，包含後台操作、API 請求、以及已登入會員看到的動態內容，是解決**資料庫瓶頸**的關鍵。

---

### 什麼是 Redis？

**Redis** (Remote Dictionary Server) 是一個開源、高效能的「**記憶體內 (in-memory) 資料庫**」。簡單來說，它把資料儲存在伺服器的記憶體 (RAM) 中，而不是傳統的硬碟 (SSD/HDD)。因為記憶體的讀寫速度比硬碟快上百甚至上千倍，所以 Redis 非常適合用來做為高速快取伺服器。

---

### 何時該使用 Redis Object Cache？

當你的網站符合以下任一情境時，導入 Redis 將會帶來顯著的效能提升：

*   **大型 WooCommerce 商店：** 擁有數千種商品、大量訂單與客戶資料。
*   **會員制網站 (YITH Membership)：** 會員登入後，系統需要頻繁查詢會員等級、權限等專屬資料。
*   **線上學習平台 (LearnDash / LifterLMS)：** 學員登入後，需要查詢課程進度、測驗成績等個人化資訊。
*   **社群網站 (BuddyBoss)：** 大量用戶互動、訊息、活動等動態內容，會產生密集的資料庫讀寫。
*   **後台操作緩慢：** 當你在 `wp-admin` 感覺到明顯卡頓時，通常是資料庫查詢過於頻繁所致。

---

### (實作) 設定 Redis 物件快取

在開始之前，請務必了解：**啟用 Redis 需要主機環境的支援**。大部分優質的 WordPress 主機（如 Cloudways, Kinsta）都在其服務中內建了 Redis。如果你是使用自己的 VPS，則需要手動安裝 Redis 伺服器。

在本教學中，我們將以常見的雲端主機面板為例，並使用免費且廣受好評的 `Redis Object Cache` 外掛來進行設定。

#### **步驟 1：確認主機端的 Redis 服務已啟用**

登入你的主機管理後台 (例如 Cloudways)，找到你的伺服器設定。

1.  前往 `Servers` -> 選擇你的伺服器 -> `Settings & Packages` -> `Packages`。
2.  確認 `Redis` 已經是 **Installed** 狀態。如果沒有，請點擊安裝。
3.  回到 `Servers` -> `Manage Services`，確認 `Redis` 正在運行 (Running)。
4.  回到應用程式 (WordPress) 層級的 `Application Management` -> `Application Settings`。
5.  往下找到 `REDIS CACHE` 區塊，記下 **Host** (通常是 `127.0.0.1` 或 `redis`) 和 **Port** (通常是 `6379`)。這些資訊等一下會用到。

``

#### **步驟 2：安裝 Redis Object Cache 外掛**

1.  登入你的 WordPress 後台。
2.  前往 **外掛 > 安裝外掛**。
3.  搜尋「**Redis Object Cache**」。
4.  找到由 Till Krüss 開發的外掛，點擊 **立即安裝** 並 **啟用**。

``

#### **步驟 3：設定 `wp-config.php` 檔案**

這是最關鍵的一步。我們需要告訴 WordPress 如何連接到 Redis 伺服器。

1.  使用 FTP 或主機提供的檔案管理器，找到並編輯你網站根目錄下的 `wp-config.php` 檔案。
2.  在 `/* That's all, stop editing! Happy publishing. */` 這行註解的 **上方**，貼上以下程式碼：

```php
define('WP_REDIS_HOST', '127.0.0.1');
define('WP_REDIS_PORT', 6379);
// define('WP_REDIS_PASSWORD', 'your-password'); // 如果你的 Redis 有設定密碼，才需要取消這行的註解並填入密碼
define('WP_CACHE_KEY_SALT', 'your_unique_prefix_');
```

**欄位說明：**

*   `WP_REDIS_HOST`: 填入你在 **步驟 1** 中記下的 **Host**。
*   `WP_REDIS_PORT`: 填入你在 **步驟 1** 中記下的 **Port**。
*   `WP_CACHE_KEY_SALT`: **Moksa 技巧** - 這是非常重要的設定！請務必為每個網站設定一個**獨一無二的前綴** (例如：`moksa_prod_` 或 `myshop_`)。這可以防止在同一台伺服器上有多個網站時，彼此的快取資料互相干擾。

3.  儲存 `wp-config.php` 檔案。

#### **步驟 4：啟用並驗證物件快取**

1.  回到 WordPress 後台。
2.  前往 **設定 > Redis**。
3.  如果你的 `wp-config.php` 設定正確，你會看到 Redis 的相關資訊。
4.  點擊「**Enable Object Cache**」按鈕。

``

5.  成功啟用後，頁面會重新整理，你會看到狀態顯示為 **Connected**，並且有 Redis 的版本、記憶體用量等即時資訊。這代表你的物件快取已經開始運作了！

``

**進階驗證 (使用 WP-CLI):**

對於開發者，你可以透過 SSH 連線到主機，並使用 WP-CLI 指令來確認。

```bash
# 檢查快取類型，應該要回傳 'redis'
wp cache type

# 檢查 Redis 狀態，應該回傳 'PONG'
wp redis status
```

---

### 如何驗證效能提升？

啟用 Redis 後，最直接的感受會是在後台操作的流暢度。要量化數據，我們可以使用 **Query Monitor** 這個開發者工具。

1.  安裝並啟用 Query Monitor 外掛。
2.  在啟用 Redis **前後**，分別訪問幾個複雜的頁面（例如：商店主頁、我的帳號、編輯文章頁面）。
3.  觀察 Query Monitor 工具列顯示的 `Page generation time` 和 `Database queries` 數量。
4.  你會發現啟用 Redis 後，**DB Queries 數量**和**時間**都顯著下降，特別是在重複載入同一個頁面時。

**Moksa 技巧：** 在開發或進行重大網站更新時，有時候你會需要清除所有快取。你可以回到 **設定 > Redis** 頁面，點擊「**Flush Cache**」按鈕，即可立即清空 Redis 中的所有暫存資料。你也可以透過 WP-CLI 指令 `wp cache flush` 來完成。

---

### 總結

恭喜你！你已經掌握了 WordPress/WooCommerce 網站效能調校的關鍵進階技術。

導入 Redis 物件快取，是將一個內容豐富、高流量的動態網站從「堪用」提升到「流暢」的重要里程碑。它直接從網站運作的核心——資料庫層級——進行優化，為所有使用者（包含管理員、編輯、以及已登入的客戶）帶來更快的響應速度和更佳的操作體驗。這不僅是技術的展現，更是提升使用者滿意度和轉換率的實質投資。