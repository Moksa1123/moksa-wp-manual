# 06.04 (實務) 外掛的啟用 (Activation) 與停用 (Deactivation)

嗨，各位 Moksa 的開發者們！在上個章節，我們已經了解了外掛的基本結構與檔案標頭。今天，我們要深入探討一個外掛生命週期中至關重要的兩個階段：**啟用 (Activation)** 與 **停用 (Deactivation)**。

正確地處理這兩個事件，是區分「業餘作品」與「專業外掛」的關鍵。一個好的外掛應該在啟用時做好所有必要的準備工作，並在停用時清理環境，但又不能破壞使用者的資料。這堂課，我們將透過 WordPress 提供的「鉤點 (Hooks)」來學習如何管理這些生命週期事件。

---

### 核心觀念：什麼是啟用與停用鉤點？

想像一下，安裝一個外掛就像是邀請一位新員工加入你的公司網站。

*   **啟用 (Activation)**：就像是新員工的「到職日 (Onboarding)」。你需要為他準備辦公桌（建立資料庫表格）、給他公司的規章手冊（設定預設選項）、告訴他公司的打卡規則（註冊排程事件）。這些事情**只需要做一次**。
*   **停用 (Deactivation)**：就像是員工「暫時休假」。他可能明天就回來了。所以，你會暫時收回他的門禁卡（清除排程事件）、清空他的暫存文件（清除快取），但你**絕對不會**把他的人事資料和過去的專案文件給刪掉。
*   **刪除 (Deletion/Uninstall)**：這才是員工「離職」。這時候你才需要徹底清除他所有的相關資料，做到「好聚好散，不留痕跡」。

WordPress 提供了特定的函式，讓我們可以在這幾個關鍵時刻執行我們指定的程式碼。

*   `register_activation_hook()`: 在使用者按下「啟用」按鈕時，執行一次。
*   `register_deactivation_hook()`: 在使用者按下「停用」按鈕時，執行一次。
*   `uninstall.php` (或 `register_uninstall_hook()`): 在使用者按下「刪除」按鈕時，執行一次。

今天我們先專注於前兩者。

---

### 步驟一：處理外掛啟用 (`register_activation_hook`)

當使用者啟用你的外掛時，通常是你執行「初始化設定」的最佳時機。這些設定只需要在第一次啟用時執行即可。

**常見的啟用任務：**

1.  **檢查環境**：檢查 PHP 版本、WordPress 版本或相依的其他外掛是否存在。
2.  **建立資料庫表格**：如果你的外掛需要儲存複雜的資料，可以建立專屬的資料庫表格。
3.  **新增預設選項**：將外掛的預設設定值寫入 `wp_options` 資料庫表中。
4.  **刷新固定網址 (Permalinks)**：如果你註冊了新的自訂文章類型 (CPT) 或 Rewrite Rules，必須刷新一次，否則會出現 404 錯誤。
5.  **建立必要的資料夾或檔案**。
6.  **註冊預設的排程事件 (Cron Job)**。

#### 實作範例

讓我們在我們的主外掛檔案中，加入一段啟用時執行的程式碼。這段程式碼會在啟用時，新增一個選項到資料庫，並刷新固定網址規則。

```php
<?php
/**
 * Plugin Name: Moksa Super Plugin
 * Description: A demo plugin for Moksa course.
 * Version: 1.0
 * Author: Moksa Team
 */

// 防止直接存取檔案
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 外掛啟用時執行的函式
 *
 * @return void
 */
function moksa_super_plugin_activate() {
    // 1. 新增預設選項
    // add_option 會先檢查選項是否存在，如果不存在才會新增。
    // 這確保了這個設定只會被建立一次。
    $default_options = [
        'version'   => '1.0',
        'license_key' => '',
        'enabled'   => true,
    ];
    add_option( 'moksa_super_plugin_options', $default_options );

    // 2. 刷新固定網址規則
    // 如果你的外掛有註冊 Custom Post Type 或自訂路由，這一步非常重要！
    // 這裡我們假設已經註冊了，所以直接呼叫。
    flush_rewrite_rules();
}

// 註冊啟用鉤點
// __FILE__ 是一個 PHP 的魔術常數，它代表「目前這個檔案」的完整路徑。
// WordPress 需要知道是哪個外掛觸發了這個鉤點。
register_activation_hook( __FILE__, 'moksa_super_plugin_activate' );

```

**Moksa 技巧：**
*   函式命名非常重要！永遠在你的函式前面加上獨特的**前綴 (Prefix)**，例如 `moksa_super_plugin_`，以避免和 WordPress 核心或其他外掛的函式名稱衝突。
*   使用 `add_option()` 而不是 `update_option()`。`add_option()` 的特性是「如果選項已存在，則不做任何事」，這完美符合「啟用時只執行一次」的需求。

---

### 步驟二：處理外掛停用 (`register_deactivation_hook`)

停用是一個「暫時性」的動作。使用者很可能只是想測試一下停用後網站是否正常，然後馬上又會重新啟用。因此，**最重要的原則是：停用時，絕對不要刪除任何使用者資料或設定！**

**常見的停用任務：**

1.  **清除排程事件 (Cron Job)**：如果你的外掛有設定排程，停用時應該將它移除，避免主機在背景繼續執行一個已經被停用的外掛任務，造成資源浪費或錯誤。
2.  **清除快取/暫存 (Cache/Transients)**：清除外掛產生的暫存資料。
3.  **刷新固定網址 (Permalinks)**：同樣地，停用時也刷新一次，讓 WordPress 知道你註冊的 CPT 或路由規則暫時失效了。

#### 實作範例

接著，我們來加入停用的處理函式。

```php
<?php
/**
 * Plugin Name: Moksa Super Plugin
 * Description: A demo plugin for Moksa course.
 * Version: 1.0
 * Author: Moksa Team
 */

// ... (省略上面已有的程式碼) ...

/**
 * 外掛停用時執行的函式
 *
 * @return void
 */
function moksa_super_plugin_deactivate() {
    // 1. 清除我們設定的排程事件
    // 假設我們之前用 wp_schedule_event 設定了一個名為 'moksa_daily_check' 的排程
    // wp_clear_scheduled_hook 會找到並清除這個排程
    wp_clear_scheduled_hook( 'moksa_daily_check' );

    // 2. 刷新固定網址規則
    flush_rewrite_rules();
}

// 註冊停用鉤點
register_deactivation_hook( __FILE__, 'moksa_super_plugin_deactivate' );


// -------------------------------------------------------------
// 注意：為了範例的完整性，我們將啟用鉤點的程式碼也放在這裡
// -------------------------------------------------------------

/**
 * 外掛啟用時執行的函式
 *
 * @return void
 */
function moksa_super_plugin_activate() {
    // 1. 新增預設選項
    $default_options = [
        'version'   => '1.0',
        'license_key' => '',
        'enabled'   => true,
    ];
    add_option( 'moksa_super_plugin_options', $default_options );
    
    // 2. 刷新固定網址規則
    flush_rewrite_rules();
}

// 註冊啟用鉤點
register_activation_hook( __FILE__, 'moksa_super_plugin_activate' );

```

**Moksa 技巧：**
*   停用鉤點是你展現專業與否的舞台。一個專業的外掛會安靜地「暫停」，而不是「搗亂」。想像一下，如果 WooCommerce 在停用時刪除了你所有的商品資料，那將會是一場災難。
*   **永遠將資料的刪除留到 `uninstall.php` 中處理**，我們將在後續的課程中詳細介紹。

---

### 總結與最佳實踐

我們來回顧一下今天的重點：

1.  **生命週期管理**：啟用、停用、刪除是外掛生命週期的三個關鍵節點，開發者必須妥善管理。
2.  **啟用 (`register_activation_hook`)**：用於**一次性**的初始化設定，如建立資料庫、新增預設選項、刷新固定網址。
3.  **停用 (`register_deactivation_hook`)**：用於**暫時性**的清理工作，如清除排程、清除快取。**千萬不要刪除使用者資料！**
4.  **命名空間**：所有公開的函式都應該加上獨特的前綴，避免衝突。
5.  **檔案參照**：使用 `__FILE__` 常數來告訴 WordPress 是哪一個外掛正在註冊這些鉤點。

``
*(截圖位置：WordPress 後台 > 外掛 > 已安裝的外掛頁面，並用箭頭標示出「啟用」、「停用」、「刪除」的按鈕位置)*

現在，你已經掌握了如何讓你的外掛在安裝與停用時，表現得像一個訓練有素的專業人士。在下一個章節，我們將會探討最關鍵也最危險的一步：如何在外掛被**刪除**時，徹底、乾淨地移除它在網站上留下的所有痕跡。