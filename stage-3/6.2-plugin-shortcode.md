# 06.02 (實作) 打造您的第一個外掛 (短代碼 Shortcode)

嗨，歡迎來到 MoksaWP 外掛開發實戰課程！在之前的章節中，我們已經探討了 WordPress 運作的底層邏輯，包括 Hooks (Action & Filter)。現在，是時候動手打造屬於你自己的第一個功能性外掛了。

今天我們的目標非常明確：我們要建立一個外掛，它會註冊一個「**短代碼 (Shortcode)**」。這個短代碼可以讓網站管理員在任何文章或頁面中，輕鬆地插入預先設定好的公司資訊，例如電話、Email 或地址。

這個練習看似簡單，但它包含了外掛開發的幾個核心基礎：

1.  **標準的外掛檔案結構與標頭。**
2.  **編寫 PHP 函式來產生內容。**
3.  **使用 WordPress 核心函式 `add_shortcode()` 來註冊功能。**
4.  **了解短代碼屬性 (Attributes) 的應用。**

準備好了嗎？讓我們開始吧！

---

### 課前準備

在開始之前，請確保你的開發環境已經準備就緒：

*   **本地開發環境:** **LocalWP** 是我們推薦的工具，它能讓你快速建立一個乾淨的 WordPress 網站。
*   **程式碼編輯器:** **VS Code** 是我們的首選，它有豐富的擴充功能可以輔助 PHP 與 WordPress 開發。

---

### 步驟一：建立外掛的基礎結構

任何一個 WordPress 外掛，最基本的就是一個資料夾和一個主要的 PHP 檔案。

1.  開啟你的本地網站資料夾，導覽至 `wp-content/plugins/`。
2.  在這裡建立一個新的資料夾，用來存放我們的外掛。資料夾名稱應該是獨一無二且全小寫的，例如 `moksa-business-info`。
3.  在 `moksa-business-info` 資料夾內，建立一個同名的 PHP 檔案：`moksa-business-info.php`。

你的檔案結構現在應該是這樣：

```
/wp-content
  /plugins
    /moksa-business-info
      - moksa-business-info.php
```

### 步驟二：撰寫外掛標頭 (Plugin Header)

為了讓 WordPress 能夠辨識到我們的外掛，我們必須在 `moksa-business-info.php` 檔案的最上方，加入一段特殊格式的註解，這就是「**外掛標頭 (Plugin Header)**」。

用 VS Code 打開 `moksa-business-info.php`，並貼上以下內容：

```php
<?php
/**
 * Plugin Name:       Moksa - 商業資訊短代碼
 * Plugin URI:        https://moksaweb.com/
 * Description:       一個提供 [moksa_info] 短代碼來顯示公司聯絡資訊的簡單外掛。
 * Version:           1.0.0
 * Author:            Moksa Web Studio
 * Author URI:        https://moksaweb.com/
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       moksa-business-info
 * Domain Path:       /languages
 */
```

**這段標頭非常重要！** 每一行都有它的意義：

*   **Plugin Name:** 顯示在 WordPress 後台「外掛」頁面的名稱。
*   **Description:** 對這個外掛的簡短描述。
*   **Version:** 目前的版本號，當你更新外掛時應該要遞增。
*   **Author:** 作者名稱。
*   **Author URI:** 作者的網站連結。

寫好後儲存檔案。現在，你可以進到 WordPress 後台的「外掛」->「已安裝的外掛」頁面，你應該能看到我們剛剛建立的外掛了！

``

先別急著啟用它，因為我們還沒有寫任何功能。

### 步驟三：編寫短代碼的處理函式

我們的目標是建立一個 `[moksa_info]` 短代碼。當 WordPress 在內容中遇到這個短代碼時，它需要呼叫一個 PHP 函式來處理並回傳對應的內容。

現在，我們就來撰寫這個函式。在 `moksa-business-info.php` 的外掛標頭下方，加入以下 PHP 程式碼：

```php
// 安全性檢查：防止檔案被直接存取
if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

/**
 * 短代碼 [moksa_info] 的處理函式
 *
 * @param array $atts 短代碼的屬性
 * @return string 要顯示的 HTML 內容
 */
function moksa_display_business_info( $atts ) {
    // 1. 設定屬性的預設值
    $atts = shortcode_atts(
        array(
            'type' => 'phone', // 預設顯示 'phone'
        ),
        $atts,
        'moksa_info'
    );

    $output = ''; // 準備一個空字串來存放輸出內容

    // 2. 根據 'type' 屬性決定要回傳什麼內容
    switch ( $atts['type'] ) {
        case 'phone':
            $output = '02-1234-5678';
            break;
        case 'email':
            $output = '<a href="mailto:hello@moksaweb.com">hello@moksaweb.com</a>';
            break;
        case 'address':
            $output = '台北市信義區市府路45號';
            break;
        default:
            $output = '未知的資訊類型';
            break;
    }

    // 3. 回傳最終的內容
    return $output;
}
```

**Moksa 技巧：程式碼解析**

*   **`if ( ! defined( 'ABSPATH' ) )`**: 這是一個 WordPress 外掛的**標準安全措施**。它會檢查 PHP 常數 `ABSPATH` (由 WordPress 定義) 是否存在。如果不存在，代表這個 PHP 檔案可能被使用者直接透過網址存取，這是不安全的。此時 `exit;` 會直接中止程式執行。
*   **`function moksa_display_business_info( $atts )`**: 我們定義了一個函式，它接受一個參數 `$atts`，這是一個陣列，用來存放使用者在短代碼中傳入的屬性。
*   **`shortcode_atts()`**: 這是 WordPress 的內建函式，**強烈建議使用**。它可以幫我們合併「預設屬性」和「使用者傳入的屬性」。如果使用者沒有提供 `type` 屬性，它就會自動使用預設值 `'phone'`。
*   **`switch` 語法**: 我們用 `switch` 來判斷使用者傳入的 `type` 是什麼，並根據不同的值準備不同的輸出內容 `$output`。
*   **`return $output;`**: 這是短代碼函式中**最關鍵的一點**。短代碼函式**必須 `return` (回傳)** 內容，而**不是 `echo` (直接印出)**。因為 WordPress 需要先「收集」到這個回傳的字串，然後再把它放到文章內容的正確位置上。如果用 `echo`，內容會直接被印在頁面的最頂端，造成版面錯亂。

### 步驟四：註冊短代碼

我們已經有了處理函式，但還需要告訴 WordPress：「嘿！當你看到 `[moksa_info]` 這個標籤時，請去執行 `moksa_display_business_info` 這個函式喔！」

這一步很簡單，只需要一行程式碼。在 `moksa_display_business_info` 函式的下方，加入：

```php
/**
 * 註冊短代碼
 * 第一個參數是短代碼的名稱 (標籤)
 * 第二個參數是處理該短代碼的函式名稱
 */
add_shortcode( 'moksa_info', 'moksa_display_business_info' );
```

`add_shortcode()` 是 WordPress 的核心函式，專門用來建立短代碼。

### 步驟五：啟用外掛並測試成果

我們的第一個外掛已經完成了！完整的 `moksa-business-info.php` 檔案內容應該如下：

```php
<?php
/**
 * Plugin Name:       Moksa - 商業資訊短代碼
 * Plugin URI:        https://moksaweb.com/
 * Description:       一個提供 [moksa_info] 短代碼來顯示公司聯絡資訊的簡單外掛。
 * Version:           1.0.0
 * Author:            Moksa Web Studio
 * Author URI:        https://moksaweb.com/
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       moksa-business-info
 * Domain Path:       /languages
 */

// 安全性檢查：防止檔案被直接存取
if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

/**
 * 短代碼 [moksa_info] 的處理函式
 *
 * @param array $atts 短代碼的屬性
 * @return string 要顯示的 HTML 內容
 */
function moksa_display_business_info( $atts ) {
    // 1. 設定屬性的預設值
    $atts = shortcode_atts(
        array(
            'type' => 'phone', // 預設顯示 'phone'
        ),
        $atts,
        'moksa_info'
    );

    $output = ''; // 準備一個空字串來存放輸出內容

    // 2. 根據 'type' 屬性決定要回傳什麼內容
    switch ( $atts['type'] ) {
        case 'phone':
            $output = '02-1234-5678';
            break;
        case 'email':
            $output = '<a href="mailto:hello@moksaweb.com">hello@moksaweb.com</a>';
            break;
        case 'address':
            $output = '台北市信義區市府路45號';
            break;
        default:
            $output = '未知的資訊類型';
            break;
    }

    // 3. 回傳最終的內容
    return $output;
}

/**
 * 註冊短代碼
 * 第一個參數是短代碼的名稱 (標籤)
 * 第二個參數是處理該短代碼的函式名稱
 */
add_shortcode( 'moksa_info', 'moksa_display_business_info' );

```

現在，讓我們來驗證成果：

1.  回到 WordPress 後台的「外掛」頁面，找到「Moksa - 商業資訊短代碼」，點擊「**啟用**」。
2.  新增一篇「文章」或「頁面」。
3.  在內容編輯器 (無論是 Gutenberg、Kadence Blocks 還是 Elementor 的文字編輯器) 中，輸入以下內容：

    ```
    這是我們的聯絡資訊：

    公司電話：[moksa_info]
    公司信箱：[moksa_info type="email"]
    公司地址：[moksa_info type="address"]
    ```

    ``

4.  點擊「發佈」或「預覽」。

在前台頁面，你應該會看到短代碼被成功地替換成了我們在 PHP 函式中定義的內容！

``

*   `[moksa_info]` 因為沒有指定 `type`，所以會使用預設的 `phone`。
*   `[moksa_info type="email"]` 正確地顯示了 Email。
*   `[moksa_info type="address"]` 正確地顯示了地址。

---

### 總結與展望

恭喜你！你已經成功地從零到有，建立並啟用了一個功能正常的 WordPress 外掛。

透過這個練習，你學會了：
*   WordPress 外掛的檔案結構與必要標頭。
*   如何撰寫一個 PHP 函式來處理動態內容。
*   使用 `add_shortcode()` 將函式與短代碼標籤連結起來。
*   利用屬性 `$atts` 讓你的短代碼更有彈性。
*   **Moksa 核心觀念**：短代碼函式必須 `return` 內容，而不是 `echo`。

短代碼是一個非常強大且方便的工具，你可以想像未來將更複雜的邏輯（例如顯示最新的 WooCommerce 商品、目前登入使用者的資訊等）封裝在短代碼中，讓網站管理員可以輕鬆地在任何地方調用。

在下一個章節，我們將會探討如何為這個外掛建立一個設定頁面，讓使用者可以直接在後台修改電話、Email 等資訊，而不是寫死在程式碼裡。我們課程中見！