# 07.01 (實作) 客製化「後台」 (CPT, Custom Post Type)

嗨，歡迎來到佈景主題與外掛開發的實作章節！我是你在 Moksa 的課程導師。

在 WordPress 的世界裡，預設的內容類型只有「文章 (Posts)」和「頁面 (Pages)」。但這對於建立一個功能豐富的網站來說，往往是不夠的。例如，如果你想建立一個「作品集」、「團隊成員」或「房地產物件」的列表，用「文章」來管理顯然不太合適，因為它們有自己獨特的資料欄位和呈現方式。

這就是 **自訂文章類型 (Custom Post Type, CPT)** 派上用場的地方。CPT 讓我們可以建立全新的內容類型，讓它在 WordPress 後台擁有獨立的管理選單，就像「文章」和「頁面」一樣。

今天，我們將親手用程式碼來建立一個名為「**專案作品 (Portfolio)**」的 CPT，這是開發客製化網站最核心的技能之一。

---

### 為什麼需要自訂文章類型 (CPT)？

在開始動手前，讓我們先釐清為什麼要用 CPT，而不是用「文章分類」或「頁面」硬做。

*   **資料結構化：** 「專案作品」可能需要「客戶名稱」、「專案網址」、「完工日期」等特殊欄位。如果用「文章」，這些資訊只能塞在內文裡，非常雜亂且難以搜尋和篩選。CPT 讓每筆「專案作品」都是一個獨立的物件，可以附加專屬的自訂欄位 (Custom Fields)。
*   **後台管理清晰：** 在後台左側選單，你會看到一個獨立的「專案作品」管理區，而不是跟部落格文章混在一起。這讓網站管理者（或你的客戶）一目了然。
*   **前台顯示獨立：** 你可以為「專案作品」設計專屬的列表頁 (Archive Page) 和單一內容頁 (Single Page) 範本，風格可以跟部落格文章完全不同。
*   **權限控制：** 你可以針對這個 CPT 設定獨立的讀寫權限。

總之，**CPT 是將不同類型的內容進行邏輯上和物理上分離的最佳實踐**。

---

### 實作開始：建立你的第一個 CPT

在這個實作中，我們將會使用程式碼來註冊 CPT。雖然市面上有些外掛可以透過 UI 介面產生 CPT，但作為一個專業開發者，**直接用程式碼控制是更穩定、更高效、也更方便版本控制的做法**。這也是 **Moksa 的標準開發流程**。

**必備工具：**
*   本地開發環境 (例如：**LocalWP**)
*   程式碼編輯器 (例如：**VS Code**)

#### 步驟 1: 決定程式碼的放置位置

註冊 CPT 的 PHP 程式碼，你有兩個主要的地方可以放：

1.  **佈景主題的 `functions.php` 檔案：**
    *   **優點：** 簡單快速。
    *   **缺點：** 當你更換佈景主題時，這個 CPT 就會跟著**消失**！因為它被綁定在佈景主題上。這通常不是我們想要的。

2.  **自訂的功能性外掛 (Custom Plugin)：**
    *   **優點：** **與佈景主題脫鉤**。無論你怎麼換佈景主題，只要這個外掛是啟用的，「專案作品」的內容就會一直存在。這也是最專業、最推薦的做法。
    *   **缺點：** 需要多建立幾個檔案，但這點功夫絕對值得。

**Moksa 技巧：** 永遠優先選擇「自訂外掛」來放 CPT 註冊碼。這能確保你的核心功能（資料）和外觀（佈景主題）是分離的，符合 WordPress 的開發哲學。

在這個教學中，為了方便，我們先將程式碼放在**子佈景主題**的 `functions.php` 檔案中。在後續的課程裡，我們會再教你如何將它打包成一個獨立的外掛。

#### 步驟 2: 撰寫 CPT 註冊程式碼

請打開你的 `functions.php` 檔案，並在檔案的結尾 `?>` 之前（如果有的話）貼上以下程式碼。

```php
<?php
/**
 * Moksa CPT: 註冊「專案作品」自訂文章類型
 */
function moksa_register_portfolio_post_type() {

    // 設定 CPT 在後台顯示的各種標籤文字
    $labels = array(
        'name'                  => _x( '專案作品', 'Post type general name', 'moksa' ),
        'singular_name'         => _x( '專案作品', 'Post type singular name', 'moksa' ),
        'menu_name'             => _x( '專案作品', 'Admin Menu text', 'moksa' ),
        'name_admin_bar'        => _x( '專案作品', 'Add New on Toolbar', 'moksa' ),
        'add_new'               => __( '新增作品', 'moksa' ),
        'add_new_item'          => __( '新增專案作品', 'moksa' ),
        'new_item'              => __( '新作品', 'moksa' ),
        'edit_item'             => __( '編輯作品', 'moksa' ),
        'view_item'             => __( '查看作品', 'moksa' ),
        'all_items'             => __( '所有作品', 'moksa' ),
        'search_items'          => __( '搜尋作品', 'moksa' ),
        'parent_item_colon'     => __( '父層作品:', 'moksa' ),
        'not_found'             => __( '找不到作品', 'moksa' ),
        'not_found_in_trash'    => __( '在垃圾桶中找不到作品', 'moksa' ),
        'featured_image'        => _x( '作品封面圖片', 'Overrides the “Featured Image” phrase for this post type.', 'moksa' ),
        'set_featured_image'    => _x( '設定封面圖片', 'Overrides the “Set featured image” phrase for this post type.', 'moksa' ),
        'remove_featured_image' => _x( '移除封面圖片', 'Overrides the “Remove featured image” phrase for this post type.', 'moksa' ),
        'use_featured_image'    => _x( '作為封面圖片', 'Overrides the “Use as featured image” phrase for this post type.', 'moksa' ),
    );

    // 設定 CPT 的核心參數
    $args = array(
        'labels'             => $labels,
        'public'             => true, // 是否公開？前台使用者是否能看到
        'publicly_queryable' => true, // 是否能被查詢？
        'show_ui'            => true, // 是否顯示後台管理介面？
        'show_in_menu'       => true, // 是否顯示在後台主選單？
        'query_var'          => true, // 是否允許 query_var？
        'rewrite'            => array( 'slug' => 'portfolio' ), // 設定網址的代稱 (slug)
        'capability_type'    => 'post', // 權限類型，通常用 'post'
        'has_archive'        => true, // 是否要有列表頁 (作品集錦頁)？
        'hierarchical'       => false, // 是否像「頁面」一樣有層級關係？
        'menu_position'      => 5, // 在後台選單中的位置 (5=文章下方)
        'menu_icon'          => 'dashicons-portfolio', // 後台選單的圖示
        'supports'           => array( 'title', 'editor', 'thumbnail', 'excerpt', 'author' ), // CPT 支援的功能
        'show_in_rest'       => true, // 讓 Gutenberg 編輯器和 REST API 支援此 CPT
    );

    // 執行註冊
    register_post_type( 'portfolio', $args );
}

// 將我們的函式掛載到 WordPress 初始化的動作鉤點 (Action Hook) 上
add_action( 'init', 'moksa_register_portfolio_post_type' );
```

**程式碼重點解說：**

*   `function moksa_register_portfolio_post_type()`: 我們定義一個函式來包裝所有註冊邏輯。函式名稱加上 `moksa_` 前綴是為了避免跟其他外掛的函式名稱衝突，這是**非常重要的好習慣**。
*   `$labels`: 這個陣列定義了所有在後台會看到的文字，例如「新增作品」、「編輯作品」等等。把它們中文化可以讓後台體驗更好。
*   `$args`: 這是 CPT 的核心設定。
    *   `'public' => true`: 設為 `true` 大部分情況下就對了，這會讓 CPT 在前後台都可見。
    *   `'rewrite' => array( 'slug' => 'portfolio' )`: **極度重要**！這設定了你的作品集的網址結構。例如，單一作品的網址會是 `https://yourdomain.com/portfolio/project-a/`。
    *   `'has_archive' => true`: 這會自動產生一個作品集列表頁，網址會是 `https://yourdomain.com/portfolio/`。
    *   `'menu_icon' => 'dashicons-portfolio'`: 我們可以使用 WordPress 內建的 [Dashicons](https://developer.wordpress.org/resource/dashicons/) 來美化後台選單。
    *   `'supports'`: 決定這個 CPT 的編輯畫面要有哪些功能。我們啟用了標題、主編輯器 (Gutenberg)、特色圖片、摘要和作者。
    *   `'show_in_rest' => true`: **Moksa 技巧**：在現代 WordPress 開發中，**務必將此項設為 `true`**。這能確保你的 CPT 可以完美相容於 Gutenberg 區塊編輯器以及 REST API，方便未來做更多進階應用（例如串接手機 App）。
*   `register_post_type( 'portfolio', $args )`: 這是 WordPress 的核心函式，用來實際註冊 CPT。第一個參數 `'portfolio'` 是這個 CPT 在資料庫中的唯一識別碼，**只能用小寫英文和底線**。
*   `add_action( 'init', ... )`: 告訴 WordPress：「在網站初始化的時候，去執行我們定義的 `moksa_register_portfolio_post_type` 這個函式」。

#### 步驟 3: 驗證成果並更新固定網址

1.  儲存你的 `functions.php` 檔案。
2.  回到 WordPress 後台，重新整理頁面。你應該會看到左邊的主選單出現了一個新的「**專案作品**」選項！

    ``

3.  **【非常重要的一步】** 為了讓 WordPress 知道我們新增了 CPT 的網址規則 (`/portfolio/`)，需要去更新「固定網址」。
    *   到後台的「**設定**」>「**固定網址**」。
    *   **你不需要做任何修改**，只要直接點擊頁面下方的「**儲存設定**」按鈕即可。這個動作會讓 WordPress 重新整理內部的網址對應規則。

    ``

現在，你可以點擊「專案作品」>「新增作品」，試著新增你的第一筆作品資料了！你會發現它的編輯介面就跟編輯一般文章非常相似。

---

### 下一步？如何在前台顯示？

太棒了，你已經成功在後台建立了結構化的內容。但光這樣還不夠，我們還需要讓訪客能在前台看到這些作品。

WordPress 的「**範本階層 (Template Hierarchy)**」會自動尋找對應的範本檔案來顯示 CPT 內容：

*   **列表頁 (`/portfolio/`)**: 會尋找 `archive-portfolio.php` 檔案。如果找不到，就會用 `archive.php`，再找不到就用 `index.php`。
*   **單一作品頁 (`/portfolio/project-a/`)**: 會尋找 `single-portfolio.php` 檔案。如果找不到，就會用 `single.php`，再找不到就用 `singular.php`，最後是 `index.php`。

**Moksa 技巧：**
在我們的技術棧中，你可以有更視覺化的方式來打造範本，而不必手刻 PHP 檔案：
*   **Elementor Pro:** 使用它的 Theme Builder 功能，可以為 `Archive > portfolio` 和 `Single > portfolio` 建立專屬的視覺化範本。
*   **Kadence Blocks Pro:** 使用它的 Elements (Hooked Elements) 功能，同樣可以針對 `Portfolio Archive` 和 `Single Portfolio` 設計範本。

我們在後續的課程會詳細介紹如何使用頁面編輯器來客製化 CPT 的前台樣式。而在下一個章節，我們將學習如何使用 **ACF (Advanced Custom Fields)** 為「專案作品」加上「客戶名稱」、「專案網址」等專屬欄位，讓你的 CPT 真正變得強大！