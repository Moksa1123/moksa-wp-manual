# 04.03 (核心) The Loop (WP_Query) 詳解

嗨，歡迎來到 MoksaWP 開發課程！我是你的導師。

今天我們要來探討 WordPress 開發中最核心、最重要、也最無可迴避的觀念：**The Loop (迴圈)** 以及它的強大心臟 **WP_Query**。可以說，只要你想在 WordPress 中顯示任何文章、頁面、商品或自訂內容，你就一定會與 The Loop 打交道。

理解它，你就能隨心所欲地從資料庫中抓取並呈現任何你想要的資料；不理解它，你將在開發過程中處處碰壁。這堂課是成為一位合格 WordPress 開發者的基石，讓我們開始吧！

---

### 什麼是 The Loop？

簡單來說，**The Loop 是 WordPress 用來處理並顯示文章列表的標準 PHP 程式碼流程**。

想像一下你的部落格首頁，它需要顯示最新的 10 篇文章。WordPress 實際上在背後做了這幾件事：

1.  向資料庫詢問：「請給我最新的 10 篇『文章』」。
2.  資料庫回傳了這 10 篇文章的資料。
3.  WordPress 透過 The Loop，一篇一篇地「遍歷 (iterate)」這些文章資料。
4.  在每一圈的迴圈中，它會使用特定的範本標籤 (Template Tags) 來顯示該篇文章的標題、內容、作者、日期等資訊。
5.  直到所有文章都顯示完畢，迴圈結束。

這個「一篇一篇處理」的過程，就是 The Loop。

#### 標準的 The Loop 結構

在你的佈景主題檔案中 (例如 `index.php`, `archive.php`, `category.php`)，你會看到類似這樣的程式碼。這是最經典的 The Loop 寫法：

```php
<?php
if ( have_posts() ) :
    while ( have_posts() ) : the_post(); ?>

        // 在這裡放置每一篇文章要顯示的 HTML 和 PHP 範本標籤
        <h2><a href="<?php the_permalink(); ?>"><?php the_title(); ?></a></h2>
        <div><?php the_excerpt(); ?></div>

    <?php endwhile;

else :
    // 如果沒有任何文章，就顯示這段訊息
    echo '<p>很抱歉，這裡沒有任何文章。</p>';

endif;
?>
```

``

讓我們來拆解這段程式碼的關鍵函式：

*   `have_posts()`: 這是一個條件判斷式，它會回傳 `true` 或 `false`。它的作用是檢查「WordPress 當前執行的查詢 (Query) 是否有任何文章結果？」。
*   `the_post()`: **這是迴圈的關鍵！** 每當 `while` 迴圈執行一次，`the_post()` 就會從查詢結果中取出「下一篇」文章，並設定好所有相關的全域變數 (像是 `$post` 物件)。這讓我們接下來可以直接使用 `the_title()`、`the_content()` 等函式來輸出當前這篇文章的資料。
*   `the_title()`: 顯示當前文章的標題。
*   `the_permalink()`: 顯示當前文章的永久連結 (URL)。
*   `the_excerpt()`: 顯示當前文章的摘要。

這個標準的 The Loop 會自動執行 WordPress 根據當前頁面 URL 所決定的「**主查詢 (Main Query)**」。例如，當使用者瀏覽 `https://yourdomain.com/category/news/` 時，WordPress 會自動查詢 `news` 這個分類下的所有文章，並將結果交給 The Loop 處理。

---

### 什麼是 WP_Query？

如果標準的 The Loop 只能處理 WordPress 自動決定的「主查詢」，那當我們想要在任何地方顯示「我們自己定義的查詢結果」時，該怎麼辦？

例如：
*   在首頁的某個區塊，顯示最新的 3 篇「作品 (Portfolio)」。
*   在商品頁面的側邊欄，顯示 5 篇與該商品「相同標籤」的部落格文章。
*   建立一個頁面，只顯示所有評分為 5 顆星的「商品 (Product)」。

這時候，**WP_Query** 就登場了。

**WP_Query 是一個非常強大的 PHP Class (類別)，它允許你建立全新的、完全客製化的資料庫查詢**。你可以把它想像成一個精密的查詢產生器，你告訴它詳細的條件 (參數)，它就會去資料庫把符合條件的文章 (或任何文章類型) 給撈回來。

使用 `WP_Query` 建立的查詢，我們稱之為「**次查詢 (Secondary Query)**」或「**自訂查詢 (Custom Query)**」。

#### WP_Query 的標準使用流程

一個完整的自訂查詢流程包含三個主要步驟：

**步驟 1：設定查詢參數 (Arguments)**
首先，你需要建立一個 PHP 陣列 (`array`)，用來存放所有你想要的查詢條件。

**步驟 2：建立新的 WP_Query 物件**
接著，使用 `new WP_Query($args)` 來建立一個新的查詢物件，並把剛剛設定好的參數陣列傳遞給它。

**步驟 3：撰寫自訂的 The Loop**
這個迴圈的結構和標準迴圈非常相似，但呼叫函式的方式有些微不同，我們會從剛剛建立的物件 (`$the_query`) 來呼叫 `have_posts()` 和 `the_post()`。

**步驟 4：(最重要！) 重置文章資料**
在自訂迴圈結束後，**務必**、**絕對要**呼叫 `wp_reset_postdata()` 函式。

> **Moksa 技巧：** 為什麼 `wp_reset_postdata()` 這麼重要？因為自訂迴圈中的 `the_post()` 會修改全域的 `$post` 變數。如果你不重置它，它將會「污染」頁面上後續的其他查詢，尤其是 WordPress 的「主查詢」，導致各種奇怪的 Bug (例如頁面標題錯亂、留言功能異常等)。**養成寫完自訂迴圈就加上 `wp_reset_postdata()` 的習慣，是專業開發者的基本素養。**

#### 基礎範例：撈取最新的 3 篇文章

```php
<?php

// 步驟 1: 設定查詢參數
$args = array(
    'post_type'      => 'post',       // 查詢的文章類型是 'post' (一般文章)
    'posts_per_page' => 3,            // 只撈取 3 篇
    'orderby'        => 'date',       // 依照日期排序
    'order'          => 'DESC',       // 降冪排序 (最新的在前面)
);

// 步驟 2: 建立新的 WP_Query 物件
$the_query = new WP_Query( $args );

// 步驟 3: 撰寫自訂的 The Loop
if ( $the_query->have_posts() ) {
    echo '<ul>';
    while ( $the_query->have_posts() ) {
        $the_query->the_post(); // 注意！是從 $the_query 物件呼叫 the_post()
        echo '<li><a href="' . get_the_permalink() . '">' . get_the_title() . '</a></li>';
    }
    echo '</ul>';
} else {
    // 如果沒有任何文章
    echo '沒有找到任何文章。';
}

/* 步驟 4: (最重要！) 重置文章資料 */
wp_reset_postdata();

?>
```
``

---

### (實作) WP_Query 的常用參數詳解

`WP_Query` 的強大之處在於它擁有極其豐富的參數，讓我們能做出非常精細的查詢。以下是我們在 Moksa 專案中最常用到的幾組參數：

#### 1. 文章類型參數 (`post_type`)
用來指定你要查詢哪一種「文章類型」。
*   `'post'`：一般文章
*   `'page'`：頁面
*   `'product'`：WooCommerce 商品 (由 WooCommerce 外掛註冊)
*   `'portfolio'`：我們用 CPT UI 自訂的「作品集」文章類型
*   `array('post', 'portfolio')`：同時查詢多種類型

```php
$args = array(
    'post_type' => 'product',
    'posts_per_page' => 4,
);
```

#### 2. 分類法參數 (`tax_query`)
這是用來處理「分類」和「標籤」等分類法 (Taxonomy) 的查詢，功能非常強大。

**範例：撈取 `product_cat` (商品分類) 為 `clothing` 的商品**

```php
$args = array(
    'post_type' => 'product',
    'posts_per_page' => 10,
    'tax_query' => array(
        array(
            'taxonomy' => 'product_cat',    // 指定分類法 (商品分類是 product_cat)
            'field'    => 'slug',           // 用代稱 (slug) 來比對
            'terms'    => 'clothing',       // 代稱為 'clothing' 的分類
        ),
    ),
);
```

#### 3. 自訂欄位參數 (`meta_query`)
這是在處理 **ACF (Advanced Custom Fields)** 欄位時的利器！你可以根據 ACF 欄位的值來篩選文章。

**範例：撈取所有 ACF 欄位 `is_featured` (是否為精選) 被設定為 `true` 的「作品」**

```php
$args = array(
    'post_type' => 'portfolio',
    'posts_per_page' => -1, // -1 代表撈取全部
    'meta_key'   => 'is_featured',
    'meta_value' => true,
);
```

**更複雜的範例：撈取價格 (`_price`) 介于 1000 到 2000 之間的商品**

```php
$args = array(
    'post_type' => 'product',
    'meta_query' => array(
        array(
            'key'     => '_price',       // WooCommerce 的價格欄位 key
            'value'   => array( 1000, 2000 ), // 值的範圍
            'type'    => 'numeric',      // 值的類型是數字
            'compare' => 'BETWEEN',      // 比對方式是「介於之間」
        ),
    ),
);
```
``

#### 4. 排序參數 (`orderby` & `order`)
*   **`orderby`**:
    *   `'date'` (預設): 依據發佈日期
    *   `'title'`: 依據標題字母
    *   `'rand'`: 隨機排序
    *   `'comment_count'`: 依據留言數
    *   `'meta_value'`: 依據自訂欄位的值 (通常用於文字)
    *   `'meta_value_num'`: 依據自訂欄位的值 (當值為數字時，例如價格、評分)
*   **`order`**:
    *   `'DESC'` (預設): 降冪 (新到舊, Z-A)
    *   `'ASC'`: 升冪 (舊到新, A-Z)

**範例：依照商品價格，由高到低排序**

```php
$args = array(
    'post_type' => 'product',
    'posts_per_page' => 5,
    'meta_key' => '_price',        // 必須同時指定 meta_key
    'orderby'  => 'meta_value_num', // 用數字方式排序
    'order'    => 'DESC',          // 降冪 (高到低)
);
```

---

### 課後總結

今天我們學習了 WordPress 開發的命脈：The Loop 與 WP_Query。

*   **The Loop** 是顯示文章內容的標準流程，它會處理 WordPress 的「主查詢」。
*   **WP_Query** 是我們用來建立「自訂查詢」的強大工具，讓我們可以從資料庫撈取任何我們想要的資料。
*   一個標準的 `WP_Query` 流程包含：**設定參數 `($args)` -> 建立新物件 `(new WP_Query)` -> 執行自訂迴圈 -> 重置資料 `(wp_reset_postdata())`**。
*   `wp_reset_postdata()` 是絕對必要的步驟，可以避免污染主查詢，防止奇怪的錯誤發生。

請務必花時間親自動手練習，在你的 LocalWP 環境中，嘗試使用 `WP_Query` 撈取不同條件的文章、商品或你用 CPT UI 建立的自訂文章類型。當你能夠熟練地組合各種參數來抓取你想要的資料時，你就真正踏入了 WordPress 專業開發的大門。

下一堂課，我們將會探討如何將今天學到的 `WP_Query` 應用在建立自訂的 Elementor Widget 或 Kadence Block 中。下課！