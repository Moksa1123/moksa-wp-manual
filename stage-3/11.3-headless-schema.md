# 11.03 (實作) (進階) Schema (使用 PHP/JSON-LD) 實作

你好，我是 Moksa 的首席課程導師。在之前的 SEO 章節中，我們學會了如何使用 Rank Math 這類強大的外掛來自動產生大部分頁面所需的結構化資料 (Schema)。然而，身為一位專業的 WordPress 開發者，你總會遇到外掛功能無法滿足的特殊情境。

這堂進階課程的目標，就是讓你掌握**手動、且動態地**為網站添加自訂 Schema 的能力。我們將使用 PHP 搭配目前 Google 最推薦的 JSON-LD 格式，讓你能夠完全控制頁面上的結構化資料，進一步提升網站的 SEO 潛力，爭取更多樣化的複合式摘要 (Rich Results)。

---

### 為什麼需要手動撰寫 Schema？

在我們開始實作前，你可能會問：「既然 Rank Math 已經很強大了，為什麼我們還需要自己動手？」

**Moksa 技巧：** 手動撰寫 Schema 的時機點通常在於：

1.  **高度客製化的內容 (CPT)：** 當你自訂了特殊的「文章類型 (Custom Post Type)」，例如「活動 (Event)」、「課程 (Course)」、「食譜 (Recipe)」，Rank Math 的預設 Schema 可能不完全適用或缺乏特定欄位。
2.  **整合多方資料來源：** 你可能需要一個 Schema 物件，其內容來自於文章本身、ACF (Advanced Custom Fields) 欄位、甚至是外部 API。
3.  **在單一頁面中添加多種類型 Schema：** 例如，在一個 WooCommerce 商品頁面，除了 `Product` 類型，你可能還想加上 `FAQPage` (常見問答) 或 `VideoObject` (商品影片) 的 Schema。
4.  **覆寫外掛預設行為：** 在極少數情況下，你可能需要完全取代或修改由其他外掛（如 WooCommerce）產生的 Schema。

今天，我們將以一個常見的範例：「為自訂文章類型『課程』添加 `Course` Schema」來進行實作。

---

### 步驟 1：研究並準備你的 JSON-LD 結構

在動手寫程式碼之前，最重要的第一步永遠是「規劃」。我們需要知道最終要產生的 JSON-LD 是什麼樣子。

1.  **前往 Schema.org：** 這是所有結構化資料類型的官方文件庫。
2.  **尋找類型：** 在搜尋框中輸入「Course」，找到 [Course - Schema.org](https://schema.org/Course) 的說明頁面。
3.  **分析欄位：** 頁面下方會列出所有可用的屬性 (Properties)。我們挑選幾個重要的來實作：
    *   `@context`: 固定為 `https://schema.org`
    *   `@type`: 我們的類型是 `Course`
    *   `name`: 課程名稱
    *   `description`: 課程描述
    *   `provider`: 提供者 (例如：Moksa)
4.  **撰寫靜態範本：** 先用純文字寫出我們的目標 JSON-LD 結構。這有助於我們後續用 PHP 來動態產生。

```json
{
  "@context": "https://schema.org",
  "@type": "Course",
  "name": "MoksaWP - 佈景主題與外掛開發",
  "description": "這是一門長達 50 小時的深度課程，帶你從基礎到進階，掌握完整的 WordPress 開發技能。",
  "provider": {
    "@type": "Organization",
    "name": "Moksa Web",
    "sameAs": "https://moksaweb.com"
  }
}
```

---

### 步驟 2：使用 PHP 動態產生並注入 Schema

現在，我們要將上面的靜態 JSON 範本，改為用 PHP 動態生成，並只在「課程」這個自訂文章類型的單一頁面中顯示。

我們會將這段程式碼放在**子佈景主題的 `functions.php`** 檔案中，或是一個**自訂的功能外掛**裡。這是最標準且安全的作法。

1.  **建立掛載函式：** 我們使用 `wp_head` 這個 WordPress 的 Action Hook，它會在網站 `<head>` 標籤內執行我們的程式碼。

    ```php
    /**
     * 為自訂文章類型 'course' 添加 Course Schema
     */
    function moksa_add_custom_course_schema() {
        // 程式碼將會放在這裡
    }
    add_action( 'wp_head', 'moksa_add_custom_course_schema' );
    ```

2.  **加入條件判斷：** 我們不希望這個 Schema 出現在網站的每個頁面。使用 `is_singular()` 函式來判斷當前頁面是否為我們指定的自訂文章類型 (`course`) 的單一頁面。

    ```php
    function moksa_add_custom_course_schema() {
        // 只在 'course' CPT 的單一頁面執行
        if ( is_singular( 'course' ) ) {
            // 準備資料與輸出的邏輯會放在這裡
        }
    }
    add_action( 'wp_head', 'moksa_add_custom_course_schema' );
    ```

3.  **動態獲取資料：** 現在是核心部分。我們將使用 WordPress 內建函式和 ACF 函式來抓取頁面上的資料，並存入一個 PHP 陣列中。

    假設我們的 `course` CPT 有一個用 ACF 建立的自訂欄位，叫做 `provider_name` (欄位名稱)。

    ```php
    function moksa_add_custom_course_schema() {
        if ( is_singular( 'course' ) ) {
            // 取得目前文章的 ID
            $post_id = get_the_ID();
            
            // 準備一個 PHP 陣列來存放 Schema 資料
            $schema_data = [
                '@context' => 'https://schema.org',
                '@type'    => 'Course',
                // 動態取得文章標題
                'name'     => get_the_title( $post_id ), 
                // 動態取得文章摘要作為描述
                'description' => get_the_excerpt( $post_id ),
                'provider' => [
                    '@type'  => 'Organization',
                    // **Moksa 技巧：從 ACF 欄位取得資料**
                    'name'   => get_field( 'provider_name', $post_id ) ?: 'Moksa Web', // 如果 ACF 欄位為空，就使用預設值
                    'sameAs' => 'https://moksaweb.com'
                ]
            ];

            // 將 PHP 陣列轉換為 JSON 格式並輸出
            echo '<script type="application/ld+json">' . json_encode( $schema_data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ) . '</script>';
        }
    }
    add_action( 'wp_head', 'moksa_add_custom_course_schema' );
    ```
    **重要觀念：**
    *   我們使用 `get_the_title()` 和 `get_the_excerpt()` 來動態獲取文章的標題和摘要。
    *   我們使用 `get_field()` (ACF 外掛的函式) 來取得自訂欄位的內容。
    *   最後，使用 `json_encode()` 將 PHP 陣列轉換成 JSON 字串。`JSON_UNESCAPED_UNICODE` 確保中文字不會變成亂碼，`JSON_UNESCAPED_SLASHES` 確保網址中的斜線不會被跳脫，讓輸出更乾淨。

---

### 步驟 3：驗證你的 Schema 是否成功

寫完程式碼後，最重要的就是驗證它是否正確運作，以及是否符合 Google 的規範。

1.  **方法一：檢查原始碼**
    *   前往你的任一「課程」頁面。
    *   在瀏覽器中點擊右鍵，選擇「檢視網頁原始碼」。
    *   使用 `Ctrl + F` (或 `Cmd + F`) 搜尋 `application/ld+json`。
    *   你應該要能找到剛剛由 PHP 產生的那段 `<script>` 標籤，並確認裡面的資料是否正確。
    *   ``

2.  **方法二：使用 Google 複合式摘要測試工具**
    *   這是最權威的驗證方式。
    *   前往 [Google Rich Results Test](https://search.google.com/test/rich-results)。
    *   輸入你的「課程」頁面網址，並執行測試。
    *   ``
    *   如果一切順利，Google 會告訴你它成功偵測到「課程」這個項目，並顯示所有欄位。如果有任何錯誤或警告，工具也會明確指出問題所在，方便你回去修改程式碼。
    *   **Moksa 技巧：** 定期在 Google Search Console 的「強化」報告中，檢查你網站上所有 Schema 的健康狀況。

---

### 總結

恭喜你！你已經學會了如何跳脫外掛的限制，利用 PHP 和 JSON-LD 為你的網站量身打造結構化資料。這項進階技能不僅能讓你解決更複雜的 SEO 需求，更是區分普通使用者與專業開發者的關鍵能力。

**今日重點回顧：**

1.  **時機：** 針對 CPT、整合多方資料或需要多重 Schema 時，就該考慮手動實作。
2.  **流程：** 先在 Schema.org 研究結構 -> 撰寫靜態 JSON 範本 -> 使用 PHP 掛載到 `wp_head` -> 加入條件判斷 -> 動態獲取資料 -> `json_encode` 輸出。
3.  **驗證：** 永遠要使用 Google 的「複合式摘要測試工具」來確保你的程式碼是有效且被 Google 認可的。

現在，試著為你網站上的其他自訂內容類型，例如「常見問答」、「活動」，甚至是更複雜的 WooCommerce 商品組合，添加專屬的 Schema 吧！