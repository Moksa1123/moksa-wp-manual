# 06.03 (實作) 建立外掛的「設定頁面」 (Options API)

嗨，各位 Moksa 的學員，大家好！我是你們的課程導師。

在上一個章節，我們已經學會了如何建立一個基礎的外掛檔案。然而，一個強大的外掛通常需要讓使用者可以自訂一些選項，例如 API 金鑰、開關某個功能、或是輸入客製化文字等等。直接讓使用者修改程式碼是非常危險且不切實際的。

因此，這個章節的目標，就是要教大家如何使用 WordPress 內建、最標準、也最安全的 **Settings API**，為我們的外掛建立一個專業的「設定頁面」。這個頁面會出現在 WordPress 後台的「設定」選單中，讓使用者可以透過圖形化介面 (UI) 來輕鬆管理外掛的各種選項。

---

### 什麼是 Settings API？

在開始動手前，讓我們先理解一下 **Settings API** 的核心概念。

你可以把 Settings API 想像成 WordPress 提供的一套「標準作業流程 (SOP)」，用來處理後台設定頁面的所有大小事。這套 SOP 幫我們自動化處理了許多繁瑣且容易出錯的工作，包含：

1.  **建立頁面：** 在後台選單中新增一個我們的設定頁面。
2.  **欄位註冊：** 告訴 WordPress 我們有哪些設定欄位需要儲存。
3.  **資料驗證與清理 (Sanitization)：** **這是最重要的部分！** API 會確保使用者儲存的資料是安全的，自動過濾掉惡意程式碼，防止網站被攻擊。
4.  **權限檢查：** 自動確認目前登入的使用者是否有權限儲存這些設定。
5.  **儲存資料：** 將清理過的資料安全地儲存到資料庫的 `wp_options` 資料表中。
6.  **渲染表單：** 提供標準函式，讓我們能輕鬆地把設定欄位顯示在頁面上。

如果沒有 Settings API，我們就必須自己手動處理 `$_POST` 請求、撰寫 Nonce 安全驗證、手動清理每個欄位的資料、再手動存入資料庫，這非常複雜且容易產生安全漏洞。因此，**Moksa 技巧：永遠優先使用 Settings API 來建立外掛的設定頁面，這是 WordPress 開發的專業標準**。

### 核心函式概覽

我們會用到以下幾個核心函式來完成今天的任務：

*   `add_options_page()`: 將我們的設定頁面掛載到 WordPress 後台的「設定」選單底下。
*   `register_setting()`: 註冊一個設定選項群組，並指定資料清理 (Sanitize) 的回呼函式。
*   `add_settings_section()`: 在設定頁面中建立一個「區塊」，用來將相關的設定欄位群組在一起。
*   `add_settings_field()`: 在指定的「區塊」中，新增一個實際的設定欄位 (例如：文字輸入框、核取方塊)。

聽起來有點抽象？沒關係，我們馬上透過實作來一一破解。

---

### 實作：為「Moksa 超級外掛」建立設定頁

假設我們要為一個名為「Moksa Super Plugin」的外掛建立設定頁，這個頁面需要有兩個欄位：

1.  **API 金鑰 (API Key):** 一個純文字輸入欄位。
2.  **啟用歡迎訊息 (Enable Welcome Message):** 一個核取方塊 (Checkbox)。

#### 環境準備

請確保你已經在 **LocalWP** 環境中，並使用 **VS Code** 開啟了你的外掛資料夾。

#### 步驟 1：註冊選單頁面 (Menu Page)

首先，我們要先讓 WordPress 後台的「設定」選單下出現我們的外掛設定連結。

打開你的主外掛檔案 (e.g., `moksa-super-plugin.php`)，並加入以下程式碼：

```php
<?php
/**
 * Plugin Name: Moksa Super Plugin
 * Description: A demo plugin for learning settings API.
 * Version: 1.0
 * Author: Moksa Web
 */

// 1. 新增後台選單
// 我們使用 'admin_menu' 這個 action hook 來執行我們的函式
add_action('admin_menu', 'moksa_add_admin_menu');

function moksa_add_admin_menu() {
    // 使用 add_options_page() 將頁面加到「設定」底下
    add_options_page(
        'Moksa Super Plugin 設定', // 頁面的 <title>
        'Moksa Super Plugin',    // 顯示在選單上的文字
        'manage_options',        // 需要什麼權限才能看到這個頁面
        'moksa_super_plugin',    // 這個頁面的獨特代稱 (slug)
        'moksa_options_page_html' // 用來渲染頁面 HTML 的回呼函式
    );
}

// 2. 撰寫渲染頁面 HTML 的回呼函式
function moksa_options_page_html() {
    // 檢查使用者權限
    if (!current_user_can('manage_options')) {
        return;
    }
    ?>
    <div class="wrap">
        <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
        <form action="options.php" method="post">
            <?php
            // 輸出所有 WordPress 設定頁面需要的隱藏欄位 (例如 nonce)
            settings_fields('moksa_super_plugin_options');
            // 輸出我們註冊的所有設定區塊與欄位
            do_settings_sections('moksa_super_plugin');
            // 輸出儲存按鈕
            submit_button('儲存設定');
            ?>
        </form>
    </div>
    <?php
}

```

**程式碼解說：**

*   我們透過 `add_action('admin_menu', ...)`，告訴 WordPress 在建立後台選單時，要呼叫我們的 `moksa_add_admin_menu` 函式。
*   在 `moksa_add_admin_menu` 函式中，我們使用 `add_options_page()` 註冊了頁面。`'manage_options'` 是 WordPress 的一個標準權限，通常只有管理員才有。
*   `moksa_options_page_html` 函式是整個頁面的 HTML 骨架。
*   **Moksa 技巧：** 注意 `<form>` 的 `action` 屬性是 `options.php`。這是一個 WordPress 的核心檔案，它會自動處理所有來自設定頁面的請求，包含驗證 Nonce、權限、並呼叫我們註冊的儲存與清理函式。**千萬不要自己指向另一個 PHP 檔案**。
*   `settings_fields()` 和 `do_settings_sections()` 是 Settings API 的魔法棒，稍後我們會告訴 WordPress 該在這兩個地方輸出什麼內容。

現在回到後台，你會在「設定」選單下看到「Moksa Super Plugin」的連結，點進去會看到一個只有標題和儲存按鈕的空白頁面。

``

#### 步驟 2：註冊設定、區塊與欄位

接下來，我們要告訴 WordPress 我們需要哪些設定欄位。這部分的程式碼要掛載在 `admin_init` 這個 action hook 上，確保它們只在後台初始化時執行。

繼續在你的主外掛檔案中加入以下程式碼：

```php
// 3. 註冊設定、區塊、欄位
add_action('admin_init', 'moksa_settings_init');

function moksa_settings_init() {
    // 註冊一個設定群組
    register_setting(
        'moksa_super_plugin_options', // 選項群組名稱 (必須跟 settings_fields() 的參數一樣)
        'moksa_options',              // 儲存在資料庫 wp_options 表中的 option_name
        'moksa_options_sanitize'      // (可選) 用於資料清理的回呼函式
    );

    // 新增一個設定「區塊」
    add_settings_section(
        'moksa_general_section',             // 區塊的 ID
        '主要設定',                          // 區塊的標題 (會顯示在頁面上)
        'moksa_general_section_callback',    // (可選) 顯示在區塊標題下的說明文字的回呼函式
        'moksa_super_plugin'                 // 這個區塊要顯示在哪個頁面 (必須跟 add_options_page 的 slug 一樣)
    );

    // 在「主要設定」區塊中，新增「API 金鑰」欄位
    add_settings_field(
        'moksa_api_key',                     // 欄位的 ID
        'API 金鑰',                          // 欄位的標籤 (Label)
        'moksa_api_key_callback',            // 用來渲染這個欄位 HTML 的回呼函式
        'moksa_super_plugin',                // 這個欄位要顯示在哪個頁面
        'moksa_general_section'              // 這個欄位屬於哪個區塊
    );

    // 在「主要設定」區塊中，新增「啟用歡迎訊息」欄位
    add_settings_field(
        'moksa_enable_welcome_message',
        '啟用歡迎訊息',
        'moksa_enable_welcome_message_callback',
        'moksa_super_plugin',
        'moksa_general_section'
    );
}

```

**程式碼解說：**

*   `register_setting()`: 這是最關鍵的一步。我們定義了一個選項群組 `moksa_super_plugin_options`，並告訴 WordPress 所有屬於這個群組的資料，最終會被打包成一個陣列，儲存在 `wp_options` 資料表裡一個叫做 `moksa_options` 的欄位中。**Moksa 技巧：** 將外掛所有設定存在**單一陣列**中，而不是每個設定都佔用一個資料庫欄位，這樣可以讓資料庫保持乾淨，也方便管理。
*   `add_settings_section()`: 建立一個名為「主要設定」的視覺區塊。
*   `add_settings_field()`: 在上面建立的區塊中，註冊了兩個欄位。注意，這裡我們只「註冊」它們，還沒定義它們長什麼樣子。外觀將由它們各自的 callback 函式決定。

#### 步驟 3：撰寫欄位與區塊的回呼函式 (Callback)

現在，我們要來實作上一步定義的那些回呼函式，也就是真正產生 HTML 輸入框的地方。

繼續加入以下程式碼：

```php
// 4. 撰寫回呼函式

// 區塊的說明文字
function moksa_general_section_callback() {
    echo '<p>請在這裡輸入您的外掛主要設定。</p>';
}

// 取得儲存的選項值 (這是個好習慣，方便重複使用)
$moksa_options = get_option('moksa_options');

// API 金鑰欄位的 HTML
function moksa_api_key_callback() {
    global $moksa_options; // 取得全域變數
    $api_key = isset($moksa_options['api_key']) ? $moksa_options['api_key'] : '';
    ?>
    <input type="text" name="moksa_options[api_key]" value="<?php echo esc_attr($api_key); ?>" class="regular-text">
    <p class="description">請輸入您從服務商取得的 API 金鑰。</p>
    <?php
}

// 啟用歡迎訊息欄位的 HTML
function moksa_enable_welcome_message_callback() {
    global $moksa_options;
    $enable = isset($moksa_options['enable_welcome']) ? $moksa_options['enable_welcome'] : 0;
    ?>
    <label>
        <input type="checkbox" name="moksa_options[enable_welcome]" value="1" <?php checked(1, $enable, true); ?>>
        啟用後，將在網站前台顯示歡迎訊息。
    </label>
    <?php
}
```

**程式碼解說：**

*   `get_option('moksa_options')`: 我們使用這個 WordPress 核心函式來讀取之前儲存在資料庫中的設定值。
*   **欄位的 `name` 屬性非常重要！** 它的格式必須是 `儲存的選項名稱[欄位索引]`，例如 `moksa_options[api_key]`。這樣 WordPress 才能在儲存時，正確地將 `api_key` 和 `enable_welcome` 的值打包進 `moksa_options` 這個陣列中。
*   `esc_attr()`: 這是一個**安全函式**，用來清理要輸出到 HTML 屬性 (如 `value`) 中的文字，防止 XSS 攻擊。
*   `checked()`: 這是 WordPress 的輔助函式，用來判斷 checkbox 是否應該被勾選，非常方便。

現在，再次重新整理你的設定頁面，你會看到完整的表單已經出現了！

``

#### 步驟 4：撰寫資料清理函式 (Sanitization)

我們的頁面看起來完成了，但還差最重要的一步：**安全性**。我們要實作在 `register_setting` 中定義的 `moksa_options_sanitize` 回呼函式。

這個函式會在使用者點擊「儲存設定」按鈕後，WordPress 將資料存入資料庫**之前**被呼叫。它會收到使用者提交的原始資料 (`$input`)，我們的任務就是檢查並清理這些資料，然後回傳一個乾淨、安全的版本。

```php
// 5. 撰寫資料清理函式
function moksa_options_sanitize($input) {
    // 建立一個新的陣列來存放清理過的資料
    $sanitized_output = [];

    // 清理 API 金鑰
    if (isset($input['api_key'])) {
        // sanitize_text_field() 會移除所有不安全的 HTML 標籤與字元
        $sanitized_output['api_key'] = sanitize_text_field($input['api_key']);
    }

    // 清理核取方塊
    // 我們只接受 1 或 0 (或空值)
    if (isset($input['enable_welcome']) && $input['enable_welcome'] == 1) {
        $sanitized_output['enable_welcome'] = 1;
    } else {
        $sanitized_output['enable_welcome'] = 0;
    }

    return $sanitized_output;
}

```

**程式碼解說：**

*   `sanitize_text_field()`: WordPress 內建的超好用函式，專門用來清理純文字欄位。
*   對於 checkbox，我們做了一個嚴格的檢查，確保存進去的只會是 `1` 或 `0`。
*   這個函式**必須回傳**一個清理過的陣列，WordPress 才會將這個回傳的陣列存入資料庫。

現在，你可以試著在 API 金鑰欄位輸入一些惡意程式碼，例如 `<script>alert('hack');</script>`，然後儲存。你會發現儲存後，這些標籤都被移除了，這就是資料清理的功勞。

### 如何在你的外掛中使用這些設定？

當你想在你的外掛其他地方（例如一個 Shortcode 或是在前台顯示內容時）使用這些設定值，方法非常簡單：

```php
// 取得所有設定
$options = get_option('moksa_options');

// 取得 API 金鑰
$api_key = isset($options['api_key']) ? $options['api_key'] : '';

// 判斷是否啟用歡迎訊息
$is_welcome_enabled = isset($options['enable_welcome']) && $options['enable_welcome'] == 1;

if ($is_welcome_enabled) {
    echo "<h1>歡迎來到我們的網站！</h1>";
}

// 使用 API 金鑰...
// some_function_that_uses_api($api_key);
```

---

### Moksa 總結與技巧

恭喜你！你已經學會了使用 WordPress Settings API 建立一個功能完整、安全且專業的設定頁面。

讓我們回顧今天的重點：

1.  **標準流程：** Settings API 是建立設定頁面的**唯一標準**，它幫我們處理了安全、儲存、權限等所有雜事。
2.  **掛載點 (Hooks)：** 記住兩個重要的 action hook：`admin_menu` 用來新增選單，`admin_init` 用來註冊設定。
3.  **三大核心函式：** `register_setting` (註冊與清理)、`add_settings_section` (建立區塊)、`add_settings_field` (建立欄位)。
4.  **資料庫最佳實踐：** 將外掛的所有選項打包進**一個陣列**並儲存在**單一資料庫欄位** (`option_name`) 中，保持資料庫的整潔。
5.  **安全第一：** **永遠**要為你的 `register_setting` 提供一個資料清理函式 (Sanitize Callback)，並使用 WordPress 內建的 `sanitize_*` 系列函式來過濾使用者輸入。

在接下來的課程中，我們會接觸到更複雜的欄位類型，例如顏色選擇器、圖片上傳、下拉選單等等，但它們的底層邏輯都與今天學到的完全相同。只要掌握了 Settings API 的核心觀念，你就能為你的外掛打造出任何你想要的設定頁面。