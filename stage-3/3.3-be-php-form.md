# 03.03 (實作) PHP 表單處理 (GET vs POST)

嗨，各位 Moksa 的學員，大家好！我是你們的課程導師。

在 WordPress 開發的世界裡，處理使用者提交的資料是我們最常遇到的任務之一。無論是搜尋框、聯絡表單、會員登入，還是商品評論，背後都離不開「表單處理」。而處理表單的核心，就是要先理解兩種最基本的 HTTP 請求方法：**GET** 和 **POST**。

今天這堂實作課，我們將親手打造兩個簡單的表單，一個使用 GET，一個使用 POST，讓你徹底搞懂它們的差異、使用時機，以及**在 WordPress 中安全處理它們的最佳實踐**。

---

### 核心觀念：GET vs. POST 到底差在哪？

在我們開始寫程式碼之前，讓我們先用一個簡單的表格來理解這兩種方法的關鍵區別。這張表非常重要，請務必記在心裡。

| 特性 | GET | POST |
| :--- | :--- | :--- |
| **資料傳遞方式** | 透過 URL 的查詢字串 (Query String) 傳遞 | 透過 HTTP 請求的內文 (Request Body) 傳遞 |
| **資料可見性** | **公開可見**，會顯示在瀏覽器的網址列上 | **隱藏不可見**，不會顯示在網址列上 |
| **資料長度限制** | 有，通常約 2048 個字元 (因瀏覽器而異) | 理論上無限制 (受伺服器設定影響) |
| **書籤與快取** | 可以被加入書籤、保留在瀏覽器歷史紀錄中、可被快取 | 不可以被加入書籤、通常不會被快取 |
| **安全性** | **較低**。不應用於傳遞密碼等敏感資訊 | **較高**。適合傳遞敏感或大量資料 |
| **主要用途** | **請求 (Request)** 或 **取得 (Get)** 伺服器上的資料。例如：搜尋、篩選 | **提交 (Submit)** 或 **建立 (Create/Update)** 伺服器上的資料。例如：註冊、登入、發布文章 |

**Moksa 技巧：** 一個簡單的判斷法則是：如果這個操作**只是為了「看」資料**，而且沒有副作用（例如不會新增或修改資料庫內容），那就用 **GET**。如果這個操作會**「改變」伺服器上的某些東西**，那就用 **POST**。

---

### 實作一：GET 請求 (建立一個簡單的搜尋表單)

GET 最經典的應用就是「搜尋」。使用者輸入關鍵字，網址會變成像 `https://example.com/?s=my-keyword` 這樣的形式。讓我們來實作它。

**目標：** 建立一個表單，使用者輸入關鍵字後，頁面會顯示使用者搜尋了什麼。

#### 步驟 1：建立 HTML 表單

首先，我們需要一個基本的 HTML 表單。你可以將這段程式碼加到一個自訂的頁面範本 (Custom Page Template) 或是透過 Shortcode 的方式來呈現。

```html
<!-- search-form.html -->
<form action="" method="get">
    <label for="search_query">搜尋站內文章：</label>
    <input type="text" id="search_query" name="search_query" placeholder="請輸入關鍵字...">
    <button type="submit">搜尋</button>
</form>

<!-- 顯示結果的區塊 -->
<div class="search-result">
    <!-- PHP 處理結果會顯示在這裡 -->
</div>
```

**程式碼解說：**
*   `action=""`: 表示表單將會提交到**當前的頁面 URL**。
*   `method="get"`: **這是關鍵！**我們明確告訴瀏覽器使用 GET 方法來提交表單。
*   `name="search_query"`: **非常重要！**這個 `name` 屬性將會成為 URL 查詢字串中的「鍵」(key)，PHP 就是靠它來取得使用者輸入的「值」(value)。

#### 步驟 2：撰寫 PHP 處理邏輯

現在，我們在同一個檔案的上方（或邏輯處理區）加入 PHP 程式碼，用來接收和處理 GET 請求。

```php
<?php
// 宣告一個變數來存放結果訊息
$search_message = '';

// 檢查 'search_query' 是否存在於 URL 中
if ( isset( $_GET['search_query'] ) && ! empty( $_GET['search_query'] ) ) {

    // **Moksa 安全技巧：永遠不要相信使用者的輸入！**
    // 使用 WordPress 內建函式 sanitize_text_field() 來清理輸入值，防止 XSS 攻擊。
    $safe_query = sanitize_text_field( $_GET['search_query'] );

    // 準備要顯示的訊息
    $search_message = '<h3>您正在搜尋：' . esc_html( $safe_query ) . '</h3>';

} else {
    $search_message = '<h3>請輸入關鍵字進行搜尋。</h3>';
}
?>

<!-- 下方接續剛才的 HTML 表單 -->
<form action="" method="get">
    ...
</form>

<!-- 顯示結果的區塊 -->
<div class="search-result">
    <?php echo $search_message; ?>
</div>
```

**程式碼解說：**
*   `isset( $_GET['search_query'] )`: 我們使用 PHP 的 `isset()` 函式來判斷 URL 中是否存在 `search_query` 這個參數。這可以避免在頁面第一次載入、沒有任何搜尋行為時，程式碼報錯。
*   `$_GET`: 這是一個 PHP 的**超全域變數 (Superglobal)**，它是一個陣列，用來儲存所有透過 GET 方法傳遞過來的資料。
*   `sanitize_text_field()`: **這是 WordPress 開發的重中之重！** 這個函式會幫我們過濾掉潛在的惡意程式碼，只保留純文字。
*   `esc_html()`: 當你要在畫面上「顯示」任何可能來自使用者輸入的內容時，使用這個函式可以將 HTML 特殊字元轉換成實體，進一步確保安全。

#### 步驟 3：整合與測試

將這整段程式碼放到你的自訂頁面範本中，然後建立一個新頁面並套用此範本。

1.  當你第一次載入頁面時，會看到「請輸入關鍵字進行搜尋。」。
2.  在輸入框中輸入「Moksa 課程」然後按下搜尋。
3.  你會看到頁面重新整理，網址列變成了 `.../?search_query=Moksa+課程`，並且頁面上顯示「您正在搜尋：Moksa 課程」。

` `
*預期成果：輸入文字並提交後，網址和頁面內容都會更新。*

---

### 實作二：POST 請求 (建立一個簡易聯絡表單)

POST 用於提交資料，最常見的例子就是聯絡表單、登入或註冊。資料不會顯示在 URL 上，相對安全。

**目標：** 建立一個包含姓名和 Email 的聯絡表單，提交後顯示使用者填寫的資訊。

#### 步驟 1：建立 HTML 表單

這次我們將 `method` 改為 `post`。

```html
<!-- contact-form.html -->
<form action="" method="post">
    <div>
        <label for="user_name">您的姓名：</label>
        <input type="text" id="user_name" name="user_name" required>
    </div>
    <div style="margin-top: 10px;">
        <label for="user_email">您的 Email：</label>
        <input type="email" id="user_email" name="user_email" required>
    </div>
    <div style="margin-top: 10px;">
        <button type="submit">送出</button>
    </div>
</form>

<!-- 顯示結果的區塊 -->
<div class="form-response">
    <!-- PHP 處理結果會顯示在這裡 -->
</div>
```

**程式碼解說：**
*   `method="post"`: **關鍵差異！** 我們告訴瀏覽器這次要用 POST 方法。

#### 步驟 2：撰寫 PHP 處理邏輯 (含 WordPress 安全機制)

處理 POST 請求的邏輯和 GET 類似，但我們需要加入一個 **WordPress 專屬且極為重要的安全機制：Nonce**。

**什麼是 Nonce？**
Nonce (Number used once) 是一個安全權杖，用來驗證表單請求是否來自你的網站，而不是由惡意人士偽造的，可以有效防止 **CSRF (跨站請求偽造)** 攻擊。**Moksa 強烈建議：所有會改變資料庫的 POST 表單都必須加上 Nonce 驗證！**

```php
<?php
// 宣告一個變數來存放回覆訊息
$response_message = '';

// **步驟 2.1: 檢查請求方法是否為 POST，並驗證 Nonce**
// 使用 'REQUEST_METHOD' 檢查是否為 POST 請求
if ( 'POST' === $_SERVER['REQUEST_METHOD'] ) {
    // 檢查 nonce 欄位是否存在且驗證通過
    if ( isset( $_POST['contact_form_nonce'] ) && wp_verify_nonce( $_POST['contact_form_nonce'], 'moksa_contact_form_action' ) ) {

        // **步驟 2.2: 清理和處理提交的資料**
        $name = sanitize_text_field( $_POST['user_name'] );
        $email = sanitize_email( $_POST['user_email'] );

        if ( ! empty( $name ) && is_email( $email ) ) {
            // 在真實世界中，這裡會是 wp_mail() 寄信的程式碼
            // 今天我們先簡單地顯示成功訊息
            $response_message = '<p style="color: green;">感謝您，' . esc_html($name) . '！我們已收到您的訊息，將會透過 ' . esc_html($email) . ' 與您聯繫。</p>';
        } else {
            $response_message = '<p style="color: red;">請確認所有欄位都已正確填寫。</p>';
        }

    } else {
        // Nonce 驗證失敗
        $response_message = '<p style="color: red;">安全性驗證失敗，請重新整理頁面再試一次。</p>';
    }
}
?>

<!-- 下方接續 HTML 表單，並插入 Nonce 欄位 -->
<form action="" method="post">
    
    <!-- **步驟 2.3: 在表單中加入 Nonce 隱藏欄位** -->
    <?php wp_nonce_field( 'moksa_contact_form_action', 'contact_form_nonce' ); ?>

    <div>
        <label for="user_name">您的姓名：</label>
        <input type="text" id="user_name" name="user_name" required>
    </div>
    <div style="margin-top: 10px;">
        <label for="user_email">您的 Email：</label>
        <input type="email" id="user_email" name="user_email" required>
    </div>
    <div style="margin-top: 10px;">
        <button type="submit">送出</button>
    </div>
</form>

<!-- 顯示結果的區塊 -->
<div class="form-response">
    <?php echo $response_message; ?>
</div>
```

**程式碼解說：**
*   `$_POST`: 和 `$_GET` 對應，`$_POST` 是用來儲存所有 POST 方法傳遞資料的超全域變數。
*   `wp_nonce_field()`: WordPress 函式，它會自動產生一個隱藏的 `<input>` 欄位，裡面包含了我們的 Nonce 安全權杖。
    *   第一個參數 `'moksa_contact_form_action'` 是這個 Nonce 的「動作名稱」，自己定義即可。
    *   第二個參數 `'contact_form_nonce'` 是這個隱藏欄位的 `name` 屬性。
*   `wp_verify_nonce()`: 用來驗證表單送過來的 Nonce 是否正確且未過期。
*   `sanitize_email()`: 專門用來清理 Email 格式的函式。
*   `is_email()`: 檢查字串是否為有效的 Email 格式。

#### 步驟 3：整合與測試

同樣將程式碼放入自訂頁面範本中並預覽。

1.  填寫你的姓名和 Email，然後點擊送出。
2.  你會看到頁面重新整理，但**網址列保持乾淨，沒有任何表單資料**。
3.  頁面上會顯示我們設定的成功訊息。

` `
*預期成果：提交表單後，網址列不變，但頁面顯示成功訊息。*

---

### 總結與重點回顧

恭喜你完成了 GET 和 POST 表單的實作！這堂課是後續所有 WordPress 開發的基石。

請記住以下幾個**核心重點**：

1.  **分工明確：** **GET 用於「請求」數據（像看書），POST 用於「提交」數據（像寫信）。**
2.  **URL 會說話：** GET 的資料會暴露在 URL 上，POST 不會。
3.  **安全第一：**
    *   永遠、永遠、永遠要用 `sanitize_*` 系列函式**清理 (Sanitize)** 任何來自使用者的輸入。
    *   永遠、永遠、永遠要用 `esc_*` 系列函式**跳脫 (Escape)** 任何要顯示在畫面上的輸出。
    *   所有會改變網站狀態的 POST 表單，都**必須使用 Nonce** 來防止 CSRF 攻擊。

學會了如何安全地處理表單，你已經掌握了與使用者互動、建立動態功能的關鍵鑰匙。在接下來的課程中，我們將會不斷地運用今天所學的知識。

我們下堂課見！