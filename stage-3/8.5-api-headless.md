# 08.05 (實作) (Headless) 使用 JS (React/Vue) 抓取 WP 資料

哈囉，歡迎來到 MoksaWP 開發課程！

在之前的章節中，我們所有的開發都圍繞著 WordPress 傳統的 PHP 佈景主題與外掛。今天，我們要踏入一個更現代、更具彈性的領域：**Headless WordPress**。

**Headless (無頭模式)** 的核心概念是將 WordPress 的「後台管理 (身體)」與「前台顯示 (頭)」分離。WordPress 不再負責渲染 HTML 頁面，而是專心扮演一個強大的「**內容資料庫**」，透過 **REST API** 將資料（例如文章、商品、使用者）提供給任何前端應用程式。

這個前端可以是使用 React、Vue、Svelte 等現代 JavaScript 框架打造的網站，也可以是手機 App、甚至是物聯網裝置。這種架構帶來了極大的靈活性、更優異的效能以及更安全的部署方式。

今天這堂課，我們將動手實作，學習如何建立一個簡單的 React 應用程式，並透過 WordPress REST API 來抓取和顯示文章資料。

---

### 觀念建立：什麼是 WordPress REST API？

在我們開始寫程式之前，必須先理解我們與 WordPress 溝通的橋樑：**WordPress REST API**。

從 WordPress 4.7 版開始，REST API 就已經內建成為 WordPress 的核心功能。它提供了一組標準化的「**端點 (Endpoints)**」，讓我們可以透過 HTTP 請求來存取和操作網站的資料。

你可以把它想像成一個「**資料的得來速窗口**」。你不需要進入餐廳（WordPress 後台），只需要在窗口（API 端點）點餐（發送請求），服務生（WordPress）就會把餐點（JSON 格式的資料）遞給你。

**Moksa 技巧：** 要讓 REST API 正常運作，你的 WordPress 網站**必須**啟用「**固定網址 (Permalinks)**」，且不能是預設的「純文字」模式。請到後台的「設定」>「固定網址」，選擇「文章名稱」或任何其他非預設的結構。

你可以直接在瀏覽器中測試你的 API 是否運作正常。打開你的 WordPress 網站，並在網址後面加上 `/wp-json/wp/v2/posts`。

例如：`https://your-domain.com/wp-json/wp/v2/posts`

如果一切正常，你應該會看到一堆文字，這就是你的文章資料，格式為 **JSON (JavaScript Object Notation)**。這是目前網路上應用程式之間交換資料最主流的格式。

``
*（一張瀏覽器顯示 `.../wp-json/wp/v2/posts` 滿是 JSON 資料的截圖）*

---

### (實作) 環境準備

在開始串接資料之前，我們需要準備好後端 (WordPress) 與前端 (React) 的環境。

#### 步驟 1：準備 WordPress 後端資料

請確保你的 WordPress 開發環境（建議使用 **LocalWP**）已經準備就緒，並且裡面有幾篇測試文章。

1.  登入你的 WordPress 後台。
2.  前往「文章」>「新增文章」。
3.  建立 3-5 篇包含標題和內容的測試文章，並將它們發佈。
4.  再次訪問 `https://your-local-site.local/wp-json/wp/v2/posts` 確認可以看到剛剛新增的文章資料。

#### 步驟 2：建立 React 前端專案

我們將使用目前最流行的 `create-react-app` 工具來快速建立一個 React 開發環境。

1.  打開你的終端機 (Terminal) 或命令提示字元 (Command Prompt)。
2.  移動到你想要存放專案的資料夾。
3.  執行以下指令來建立一個名為 `moksa-headless-frontend` 的新專案：
    ```bash
    npx create-react-app moksa-headless-frontend
    ```
4.  等待安裝完成後，進入專案資料夾：
    ```bash
    cd moksa-headless-frontend
    ```
5.  啟動開發伺服器：
    ```bash
    npm start
    ```
    你的瀏覽器應該會自動打開 `http://localhost:3000` 並顯示 React 的歡迎頁面。

``
*（一張顯示 React 歡迎頁面的瀏覽器截圖）*

---

### (實作) 使用 React 串接 WP REST API 抓取文章

環境都準備好了，現在讓我們來寫程式吧！

#### 步驟 1：清理並設定我們的 React 組件

打開你的程式碼編輯器 (例如 **VS Code**)，找到 `src/App.js` 檔案。我們將修改這個檔案來抓取並顯示 WordPress 文章。

將 `src/App.js` 的內容完全替換成以下程式碼：

```javascript
import React from 'react';
import './App.css';

function App() {
  return (
    <div className="App">
      <header className="App-header">
        <h1>MoksaWP Headless Demo</h1>
        <p>從 WordPress 載入的文章列表：</p>
      </header>
      <main>
        {/* 文章列表將會顯示在這裡 */}
      </main>
    </div>
  );
}

export default App;
```

#### 步驟 2：使用 `useState` 和 `useEffect` 抓取資料

React 提供了兩個非常重要的 Hooks (鉤子) 來處理組件的狀態和副作用：

*   `useState`: 用來在組件中宣告一個「狀態 (state)」，當這個狀態改變時，組件會重新渲染。
*   `useEffect`: 用來處理「副作用 (side effect)」，例如發送 API 請求、設定計時器等。它會在組件渲染到畫面上之後執行。

現在，我們來修改 `App.js`，加入抓取資料的邏輯。

```javascript
import React, { useState, useEffect } from 'react'; // 1. 引入 useState 和 useEffect
import './App.css';

// 2. 記得替換成你自己的 WordPress 網站網址
const WP_API_URL = 'https://YOUR-SITE.local/wp-json/wp/v2/posts';

function App() {
  // 3. 宣告一個 state 來存放文章資料，初始值為一個空陣列
  const [posts, setPosts] = useState([]);
  
  // 4. 使用 useEffect 來發送 API 請求
  useEffect(() => {
    // 定義一個非同步函式來抓取資料
    async function fetchPosts() {
      try {
        const response = await fetch(WP_API_URL);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        setPosts(data); // 將抓取到的資料存入 state
      } catch (error) {
        console.error('Fetching posts failed:', error);
      }
    }
    
    fetchPosts(); // 執行函式
  }, []); // 傳入空陣列 [] 確保這個 effect 只會在組件第一次載入時執行一次

  return (
    <div className="App">
      <header className="App-header">
        <h1>MoksaWP Headless Demo</h1>
        <p>從 WordPress 載入的文章列表：</p>
      </header>
      <main>
        <div className="posts-list">
          {/* 我們將在這裡渲染文章 */}
        </div>
      </main>
    </div>
  );
}

export default App;
```

**Moksa 技巧：**
*   請務必將 `WP_API_URL` 常數中的網址替換成**你自己的 LocalWP 網站或線上網站的網址**。
*   `useEffect` 的第二個參數 `[]` 是一個依賴陣列 (dependency array)。傳入空陣列代表這個 effect 不依賴任何 props 或 state 的變化，因此它只會在組件掛載 (mount) 時執行一次，這正是我們抓取初始資料時想要的行為。

#### 步驟 3：將文章資料渲染到畫面上

我們已經成功將文章資料存在 `posts` 這個 state 中了。現在，我們需要用 `map()` 方法來遍歷這個陣列，並將每一篇文章的標題和內容顯示出來。

修改 `App.js` 中的 `return` 部分：

```javascript
// ... (前面的程式碼不變)

  return (
    <div className="App">
      <header className="App-header">
        <h1>MoksaWP Headless Demo</h1>
        <p>從 WordPress 載入的文章列表：</p>
      </header>
      <main>
        <div className="posts-list">
          {posts.map(post => (
            <article key={post.id} className="post-item">
              <h2 dangerouslySetInnerHTML={{ __html: post.title.rendered }} />
              <div dangerouslySetInnerHTML={{ __html: post.content.rendered }} />
            </article>
          ))}
        </div>
      </main>
    </div>
  );

// ... (後面的程式碼不變)
```

**重要觀念：`dangerouslySetInnerHTML`**

你會注意到我們使用了 `dangerouslySetInnerHTML` 這個屬性來顯示標題和內容。這是因為 WordPress API 回傳的內容 (`post.title.rendered`, `post.content.rendered`) 是包含 HTML 標籤的字串 (例如 `<h1>標題</h1>`, `<p>段落</p>`)。

React 預設會將所有字串當作純文字處理以防止 **XSS (跨站腳本攻擊)**。如果你直接顯示 `post.content.rendered`，你會在畫面上看到原始的 HTML 標籤。

`dangerouslySetInnerHTML` 是 React 提供的一個「後門」，讓我們可以告訴 React：「**我很清楚這些 HTML 的來源是可信的 (我自己的 WordPress 網站)，請直接將它渲染出來**」。因為有潛在的風險，所以 React 故意取了一個這麼危險的名字來提醒開發者。

現在，儲存你的 `App.js` 檔案，回到瀏覽器查看 `http://localhost:3000`。你應該會看到你 WordPress 網站上的文章列表已經成功顯示出來了！

``
*（一張瀏覽器截圖，顯示從 WordPress 抓取並渲染出來的文章標題和內容列表）*

---

### 進階主題：抓取自訂欄位 (ACF) 資料

在真實世界的專案中，我們很少只使用 WordPress 內建的欄位。**ACF (Advanced Custom Fields)** 是我們的老朋友了。預設情況下，ACF 建立的欄位並不會出現在 REST API 的回傳資料中。

要讓 ACF 欄位顯示在 API 中，最簡單的方式是安裝一個輔助外掛。

1.  **安裝外掛：** 在 WordPress 後台安裝並啟用「**ACF to REST API**」這個外掛。
2.  **設定 ACF 欄位：** 建立或編輯你的 ACF 欄位群組，確保在每個欄位的設定中，「**在 REST API 中顯示 (Show in REST API)**」這個選項是開啟的。
3.  **檢查 API 回應：** 啟用後，再次訪問 `.../wp-json/wp/v2/posts`，你會發現在每一個 post 物件底下，多出了一個名為 `acf` 的物件，裡面就包含了你設定的自訂欄位資料。
4.  **修改 React 程式碼：** 在你的 React 組件中，你現在可以透過 `post.acf.your_field_name` 來存取這些自訂欄位的值了。

---

### 課程總結與延伸思考

恭喜你！你已經成功踏出了 Headless WordPress 開發的第一步。

在這堂課中，我們學會了：
1.  理解 Headless CMS 的基本概念。
2.  認識 WordPress REST API 並知道如何測試它。
3.  建立一個基本的 React 開發環境。
4.  在 React 中使用 `fetch`、`useState`、`useEffect` 來非同步抓取並顯示 WordPress 文章資料。
5.  如何處理 WordPress 回傳的 HTML 內容。
6.  如何讓 ACF 自訂欄位也支援 REST API。

這僅僅是個開始，Headless 的世界非常廣闊。你可以繼續挑戰：
*   **路由 (Routing):** 如何點擊文章列表後，跳轉到顯示單一文章內容的頁面？ (提示: `react-router-dom`)
*   **效能優化:** 如何處理載入中 (Loading) 和錯誤 (Error) 的狀態？
*   **身分驗證:** 如何抓取需要登入才能看到的內容？ (提示: Application Passwords, JWT Auth)
*   **前端框架:** 除了 React，你也可以嘗試使用 Vue.js, Svelte 或是 Next.js (SSR/SSG) 來打造更強大的前端應用。

保持好奇心，繼續探索！我們下堂課見。