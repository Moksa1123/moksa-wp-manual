# 07.04 (實作) (客製化物流) 串接「黑貓 API」

嗨，歡迎來到 MoksaWP 的進階開發課程！在這一堂純技術的實作課程中，我們將會學習一個非常實用且常見的電商客製化需求：**直接透過 API 串接台灣主流的物流服務「黑貓宅急便」**。

雖然我們推薦的 **RY Tools** 已經整合了許多物流功能，但在某些特定情境下，例如：企業內部有特殊的 ERP 系統、需要更深度的客製化出貨流程、或是客戶指定要直接串接官方 API 時，身為專業的開發者，你就必須具備這個能力。

這堂課會帶你從零開始，建立一個專屬的小型外掛，用來處理 WooCommerce 訂單與黑貓 API 之間的溝通，實現「**在後台一鍵點擊，就自動建立黑貓託運單並取號**」的專業功能。

---

### 課程目標

*   了解串接第三方 API 的基本概念與流程。
*   學會如何為 WooCommerce 後台訂單編輯頁面新增「自訂區塊 (Meta Box)」。
*   學會使用 WordPress 核心函式 `wp_remote_post()` 來發送 API請求。
*   實作出一個可以建立黑貓託運單，並將託運單號寫回訂單的功能。
*   學習基本的錯誤處理與安全性（Nonce）觀念。

### 前置準備

在開始之前，請確認你已經準備好以下幾件事：

1.  **一個本地開發環境**：我們強烈建議使用 **LocalWP**。
2.  **基本的 PHP 與 WordPress Hooks 知識**：你需要了解什麼是 `action` 和 `filter`。
3.  **黑貓宅急便企業會員帳號**：你需要向黑貓申請一組 API 測試用的 **客戶代號 (CustomerID)** 與 **API 金鑰 (API Key)**。
4.  **黑貓 API 開發文件**：請先大致瀏覽過黑貓官方提供的 API 技術文件，了解他們需要哪些參數。

---

### 實作流程總覽

我們的實作流程會像這樣：

1.  **建立一個自訂外掛的基礎架構**。
2.  **在 WooCommerce 訂單後台新增一個操作面板 (Meta Box)**。
3.  **編寫一個按鈕，觸發建立託運單的動作**。
4.  **撰寫核心 PHP 函式，負責收集訂單資料並呼叫黑貓 API**。
5.  **處理 API 回傳的結果，將託運單號存入訂單的自訂欄位 (Custom Field)**。
6.  **將結果顯示在後台的操作面板上**。

準備好了嗎？讓我們開始吧！

### 步驟 1：建立你的第一個外掛

**Moksa 技巧：** 永遠不要將客製化程式碼直接寫在佈景主題的 `functions.php` 中。建立一個專屬的小外掛是更專業、更具可攜性的作法。

在你的 `wp-content/plugins/` 資料夾中，建立一個新的資料夾，例如 `moksa-tcat-shipping`。

在該資料夾內，建立一個主 PHP 檔案，例如 `moksa-tcat-shipping.php`，並貼上以下外掛標頭資訊：

```php
<?php
/**
 * Plugin Name:       Moksa - T-Cat Shipping Integration
 * Plugin URI:        https://moksaweb.com
 * Description:       A custom plugin to integrate T-Cat (Black Cat) API with WooCommerce.
 * Version:           1.0.0
 * Author:            Moksa Team
 * Author URI:        https://moksaweb.com
 * License:           GPL-2.0+
 * License URI:       http://www.gnu.org/licenses/gpl-2.0.txt
 * Text Domain:       moksa-tcat
 * Domain Path:       /languages
 */

// If this file is called directly, abort.
if ( ! defined( 'WPINC' ) ) {
    die;
}

// 在這裡開始我們的程式碼
```

完成後，到 WordPress 後台的「外掛」頁面啟用它。

### 步驟 2：在訂單頁面新增自訂 Meta Box

我們需要在 WooCommerce 的訂單編輯頁面，新增一個區塊來放置我們的操作按鈕和顯示託運單資訊。

將以下程式碼加入你的 `moksa-tcat-shipping.php` 檔案中：

```php
/**
 * Add a custom meta box to the WooCommerce order edit page.
 */
function moksa_add_tcat_meta_box() {
    add_meta_box(
        'moksa_tcat_shipping_box',                  // Meta Box ID
        '黑貓宅急便 - 出貨管理 (Moksa)',             // Meta Box Title
        'moksa_tcat_meta_box_callback',             // Callback function
        'shop_order',                               // Post Type (WooCommerce Order)
        'side',                                     // Context (side, normal, advanced)
        'high'                                      // Priority
    );
}
add_action( 'add_meta_boxes', 'moksa_add_tcat_meta_box' );

/**
 * Callback function to render the content of the meta box.
 *
 * @param WP_Post $post The current post object (the order).
 */
function moksa_tcat_meta_box_callback( $post ) {
    // **Moksa 技巧：** 永遠要加上 Nonce 欄位來確保安全性
    wp_nonce_field( 'moksa_create_tcat_shipment_action', 'moksa_tcat_nonce' );

    $order_id = $post->ID;
    // 從訂單的 meta data 中讀取已經存在的託運單號
    $tracking_number = get_post_meta( $order_id, '_moksa_tcat_tracking_number', true );

    if ( ! empty( $tracking_number ) ) {
        // 如果已經有託運單號，就顯示它
        echo '<h4>已成功建立託運單！</h4>';
        echo '<p><strong>託運單號：</strong> ' . esc_html( $tracking_number ) . '</p>';
        // 這裡可以再擴充，例如加上「列印託運單」的按鈕
    } else {
        // 如果還沒有託運單號，就顯示建立按鈕
        echo '<p>這筆訂單尚未建立黑貓託運單。</p>';
        
        // 我們用一個 form 來包住按鈕，這樣才能提交動作
        // 注意 action URL 的寫法，確保我們提交到目前的訂單編輯頁
        echo '<form method="post" action="' . esc_url( admin_url( 'post.php?post=' . $order_id . '&action=edit' ) ) . '">';
        
        // 重新加上 nonce，因為 form 會覆蓋
        wp_nonce_field( 'moksa_create_tcat_shipment_action', 'moksa_tcat_nonce' );
        
        // 隱藏一個欄位來告訴我們的處理函式要做什麼
        echo '<input type="hidden" name="moksa_action" value="create_tcat_shipment" />';
        
        // 提交按鈕
        echo '<button type="submit" class="button button-primary">建立黑貓託運單</button>';
        
        echo '</form>';
    }
}
```

現在，隨便點開一筆訂單，你應該會在右側看到一個新的「黑貓宅急便 - 出貨管理 (Moksa)」區塊，裡面有一個按鈕。

``

### 步驟 3：處理按鈕的點擊事件

當使用者按下按鈕後，我們需要一個函式來接收這個請求，並呼叫黑貓的 API。

我們使用 `save_post_shop_order` 這個 action hook，它在訂單儲存或更新時觸發，非常適合用來處理我們的自訂動作。

```php
/**
 * Handle the custom action when the "Create T-Cat Shipment" button is clicked.
 *
 * @param int $order_id The ID of the order being saved.
 */
function moksa_handle_tcat_shipment_creation( $order_id ) {
    // 1. 安全性檢查：檢查 Nonce
    if ( ! isset( $_POST['moksa_tcat_nonce'] ) || ! wp_verify_nonce( $_POST['moksa_tcat_nonce'], 'moksa_create_tcat_shipment_action' ) ) {
        return;
    }

    // 2. 動作檢查：確認是我們的按鈕被點擊
    if ( ! isset( $_POST['moksa_action'] ) || $_POST['moksa_action'] !== 'create_tcat_shipment' ) {
        return;
    }
    
    // 3. 狀態檢查：避免重複建立
    $existing_tracking = get_post_meta( $order_id, '_moksa_tcat_tracking_number', true );
    if ( ! empty( $existing_tracking ) ) {
        return; // 已經有託運單號了，直接跳出
    }

    // 4. 取得 WooCommerce 訂單物件
    $order = wc_get_order( $order_id );
    if ( ! $order ) {
        return;
    }
    
    // --- 這裡將是我們呼叫 API 的核心邏輯 ---
    // (下一段程式碼會填入這裡)
    
}
add_action( 'save_post_shop_order', 'moksa_handle_tcat_shipment_creation' );
```

### 步驟 4：撰寫核心 API 呼叫邏輯

這是最關鍵的一步。我們將模擬呼叫黑貓 API 的過程。

**注意：** 以下程式碼中的 API URL、客戶代號和金鑰都是**範例**，請務必換成你從黑貓官方取得的真實或測試資料。

將這段程式碼，放到上一步驟中「`// --- 這裡將是我們呼叫 API 的核心邏輯 ---`」的位置。

```php
    // --- 呼叫 API 的核心邏輯 ---

    // **重要觀念：** 絕對不要把金鑰寫死在程式碼裡。
    // 專業作法是存在 wp-config.php 或資料庫 options table。
    // 這裡為了教學簡化，我們先定義成變數。
    $api_url      = 'https://www.t-cat.com.tw/services/api/CreateShipment'; // 假設的 API URL
    $customer_id  = 'YOUR_CUSTOMER_ID'; // 你的客戶代號
    $api_key      = 'YOUR_API_KEY';     // 你的 API 金鑰

    // 準備要傳送給 API 的資料 (Data Payload)
    // 這些欄位需要對照黑貓的官方文件來填寫
    $payload = [
        'CustomerID' => $customer_id,
        'SenderName' => 'Moksa 網路商店',
        'SenderPhone' => '02-1234-5678',
        'SenderAddress' => '台北市信義區信義路五段7號',
        'ReceiverName' => $order->get_shipping_first_name() . ' ' . $order->get_shipping_last_name(),
        'ReceiverPhone' => $order->get_billing_phone(),
        'ReceiverAddress' => $order->get_formatted_shipping_address(),
        'PackageSize' => '0003', // 假設是 90cm
        'COD' => 0, // 是否代收貨款
        'OrderNumber' => $order->get_order_number(), // 我們的訂單編號
    ];
    
    // 設定 wp_remote_post 的參數
    $args = [
        'method'    => 'POST',
        'timeout'   => 15, // 等待 API 回應的秒數
        'headers'   => [
            'Content-Type'  => 'application/json; charset=utf-8',
            'Authorization' => 'Bearer ' . $api_key, // 假設是用 Bearer Token 驗證
        ],
        'body'      => json_encode( $payload ),
        'data_format' => 'body',
    ];

    // 使用 WordPress 的 HTTP API 函式來發送請求
    $response = wp_remote_post( $api_url, $args );

    // 檢查是否有 WordPress 層級的錯誤
    if ( is_wp_error( $response ) ) {
        $error_message = $response->get_error_message();
        $order->add_order_note( '建立黑貓託運單失敗 (WP Error): ' . $error_message );
        return;
    }

    // 取得 API 回應的內容
    $body = wp_remote_retrieve_body( $response );
    $data = json_decode( $body, true );

    // 根據 API 文件，判斷回應是否成功
    if ( isset( $data['Success'] ) && $data['Success'] === true && ! empty( $data['TrackingNumber'] ) ) {
        // 成功了！
        $tracking_number = $data['TrackingNumber'];
        
        // **將託運單號存到訂單的自訂欄位**
        update_post_meta( $order_id, '_moksa_tcat_tracking_number', $tracking_number );
        
        // **新增一筆訂單備註，方便店家追蹤**
        $order->add_order_note( '成功建立黑貓託運單，單號為：' . $tracking_number );

    } else {
        // 失敗了！
        $error_from_api = isset( $data['ErrorMessage'] ) ? $data['ErrorMessage'] : '未知的 API 錯誤';
        $order->add_order_note( '建立黑貓託運單失敗 (API Error): ' . $error_from_api );
    }
```

### 步驟 5：測試與驗證

現在，整個流程已經串起來了！

1.  回到你的任一筆訂單編輯頁面。
2.  點擊右側的「**建立黑貓託運單**」按鈕。
3.  頁面會重新整理。如果一切順利，你會看到 Meta Box 的內容更新了，顯示出「已成功建立託運單！」以及模擬的託運單號。
4.  同時，在訂單的「訂單備註」區塊，你會看到一筆由系統自動新增的備註。

``

### 總結與未來優化方向

恭喜你！你已經成功地為 WooCommerce 網站客製化了一個串接第三方物流 API 的功能。這是一個非常強大的技能，可以應用在各種不同的 API 串接場景。

**Moksa 技巧與未來優化方向：**

1.  **金鑰管理：** 在實務上，我們會建立一個外掛設定頁面，讓使用者可以從後台輸入並儲存 API 金鑰，而不是寫死在程式碼裡。
2.  **錯誤處理：** 目前的錯誤處理只是在訂單備註中留下紀錄。更進階的作法是可以在 Meta Box 中直接顯示紅色的錯誤訊息，讓管理者一目了然。
3.  **批次處理：** 在訂單列表頁面，新增一個「批次建立黑貓託運單」的選項，讓管理者可以一次勾選多筆訂單，一鍵全部處理。
4.  **非同步處理：** 當訂單量很大時，同步呼叫 API 可能會讓後台卡頓。這時可以導入 WordPress 的 **Action Scheduler**，將 API 呼叫的任務放到背景排程執行，提升後台操作體驗。
5.  **列印託運單：** 黑貓 API 通常也會提供一個列印託運單的 API。你可以在我們的 Meta Box 中，當託運單號存在時，多顯示一個「列印託運單」的按鈕，點擊後就呼叫該 API，直接在新分頁開啟託運單的 PDF 檔案。

這堂課的內容比較硬核，但完成後你獲得的經驗值絕對是爆表的。請務必親手實作一遍，並試著挑戰看看上面提到的優化方向！