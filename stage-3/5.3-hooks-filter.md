# 05.03 (實作) add_filter (在特定時間點「修改」)

---

你好，我是 Moksa 的首席課程導師。

在上一堂課，我們學會了如何使用 `add_action` 在 WordPress 的特定時間點「執行」一段程式碼。今天，我們要來學習另一個同樣重要，但用途截然不同的核心函式：`add_filter`。

`add_action` 像是設定一個鬧鐘，時間到了就去做某件事。而 `add_filter` 更像是在一個生產線的關卡上，**攔截**正在傳遞的物品，對它**加工、修改、過濾**後，再放回生產線，讓流程繼續下去。

簡單來說：
*   `add_action`：**執行**動作 (Do something)。
*   `add_filter`：**修改**資料 (Modify something)。

在 WordPress 與 WooCommerce 的開發中，`add_filter` 是客製化功能的靈魂，它讓我們能夠不修改核心程式碼，就能改變網站上幾乎任何顯示的文字、價格、內容或行為。

### `add_filter` 的基本語法

`add_filter` 的函式結構如下：

```php
add_filter( string $hook_name, callable $callback_function, int $priority = 10, int $accepted_args = 1 );
```

*   `$hook_name` (字串, **必填**): 你想要掛勾的「過濾點」名稱。例如 `the_title` (修改文章標題)、`woocommerce_get_price_html` (修改商品價格的 HTML 顯示)。
*   `$callback_function` (函式名稱, **必填**): 當程式執行到 `$hook_name` 這個過濾點時，要呼叫的自訂函式。**這個函式必須接收至少一個參數（被過濾的原始資料），並且必須 `return` (回傳) 修改後的新資料**。
*   `$priority` (整數, 選填): 執行優先順序，數字越小越先執行。預設是 `10`。
*   `$accepted_args` (整數, 選填): 你的自訂函式 (`$callback_function`) 準備接收多少個參數。預設是 `1`，也就是只接收被過濾的資料本身。有些 filter hook 會提供額外的參數讓你判斷情境，這時候就需要調整這個數字。

**Moksa 技巧：** `add_filter` 的核心關鍵在於「**有進有出**」。你的自訂函式接收（進）一個值，處理完後，**務必**要用 `return` 回傳（出）一個值。如果你忘了 `return`，原本的資料就會變成 `null`，網站上對應的地方可能會變空白或直接出錯！

---

### 實作一：修改商品頁的「加入購物車」按鈕文字

這是最經典的入門練習。假設我們想把單一商品頁上的「加入購物車」按鈕，改成更吸引人的「立即搶購」。

``
*（示意圖：原始的 WooCommerce「加入購物車」按鈕）*

#### 步驟 1：找到對應的 Filter Hook

透過查閱 WooCommerce 的官方文件或原始碼，我們可以找到控制這個按鈕文字的 hook 是 `woocommerce_product_single_add_to_cart_text`。

#### 步驟 2：撰寫回呼函式 (Callback Function)

我們的函式需要接收原始的按鈕文字（例如 "加入購物車"），然後回傳我們想要的新文字。

```php
function moksa_change_single_add_to_cart_text( $original_text ) {
    // 函式接收原始文字 $original_text
    
    // 定義我們的新文字
    $new_text = '立即搶購';
    
    // 回傳新文字
    return $new_text;
}
```

#### 步驟 3：使用 `add_filter` 掛上函式

現在，我們把這個函式掛到 `woocommerce_product_single_add_to_cart_text` 這個 hook 上。

你可以將這段程式碼加到你的子佈景主題的 `functions.php` 檔案，或是自訂的功能外掛中。

```php
/**
 * 修改單一商品頁的「加入購物車」按鈕文字
 */
function moksa_change_single_add_to_cart_text( $original_text ) {
    return '立即搶購';
}
add_filter( 'woocommerce_product_single_add_to_cart_text', 'moksa_change_single_add_to_cart_text' );

```
*註：為了精簡，我們將步驟 2 的函式直接簡化成一行 return。*

#### 步驟 4：查看結果

重新整理你的任何一個單一商品頁，你會發現按鈕上的文字已經成功被修改了！

``
*（示意圖：成功修改為「立即搶購」的按鈕）*

---

### 實作二：在所有商品價格後方加上「(含稅)」

這個練習會用到傳入的參數，並對其進行加工。假設我們網站的所有商品價格都已含稅，為了讓顧客更清楚，我們希望在每個價格後面都加上「(含稅)」字樣。

``
*（示意圖：原始的 WooCommerce 商品價格，例如 NT$1,200）*

#### 步驟 1：找到價格的 Filter Hook

控制商品價格 HTML 輸出的 hook 是 `woocommerce_get_price_html`。這個 hook 傳遞的參數是**包含貨幣符號和價格的完整 HTML 字串**。

#### 步驟 2：撰寫並掛上 Filter 函式

這個函式會接收原始的價格 HTML (例如 `"<span class='woocommerce-Price-amount amount'><bdi><span class='woocommerce-Price-currencySymbol'>&#36;</span>1,200</bdi></span>"`)，我們要做的是在字串後面加上我們的文字。

```php
/**
 * 在 WooCommerce 商品價格後方加上 "(含稅)"
 * @param string $price_html 原始的價格 HTML
 * @param object $product 商品物件
 * @return string 修改後的價格 HTML
 */
function moksa_add_tax_suffix_to_price( $price_html, $product ) {
    // 透過 PHP 的字串串接符號 (.) 來加上我們的文字
    $new_price_html = $price_html . ' <small>(含稅)</small>';
    
    return $new_price_html;
}
// 注意：這個 hook 提供了 2 個參數，所以我們在 add_filter 的第四個參數要設定為 2
add_filter( 'woocommerce_get_price_html', 'moksa_add_tax_suffix_to_price', 10, 2 );

```

**Moksa 技巧：** 注意到這次 `add_filter` 的最後我們加了 `10, 2` 嗎？
*   `10` 是預設的優先序，可以不寫。
*   `2` 代表我們的函式 `moksa_add_tax_suffix_to_price` 準備接收 **2 個參數** (`$price_html` 和 `$product`)。`woocommerce_get_price_html` 這個 hook 除了傳遞價格 HTML 外，還會傳遞整個商品物件 (`$product`)，讓我們可以根據商品本身做更複雜的判斷（例如：只針對特定分類的商品加字樣）。

#### 步驟 3：查看結果

重新整理商店頁面或商品頁，你會看到所有價格後面都出現了「(含稅)」字樣。

``
*（示意圖：價格成功顯示為 "NT$1,200 (含稅)"）*

---

### 實作三 (Moksa 整合應用)：為特定會員等級顯示專屬價格標示

現在，讓我們來做一個更進階、更貼近真實營運需求的範例。我們將結合 Moksa 技術棧中的 **YITH WooCommerce Membership** 外掛。

**目標：** 當使用者是「VIP 會員」時，在價格旁加上一個醒目的「VIP 專屬價」標籤。

#### 步驟 1：了解 YITH Membership 的判斷函式

要實現這個功能，我們需要一個方法來判斷當前使用者是否為特定等級的會員。YITH Membership 提供了一個方便的函式：`yith_wcms_is_member()`。如果傳入會員方案的 ID，它會回傳 `true` 或 `false`。

假設我們的「VIP 會員」方案 ID 是 `123`。

#### 步驟 2：沿用價格 Filter Hook 進行修改

我們一樣使用 `woocommerce_get_price_html` 這個 hook，但在函式內部加上條件判斷。

```php
/**
 * 為 VIP 會員在價格後方加上專屬標籤
 * @param string $price_html 原始的價格 HTML
 * @param object $product 商品物件
 * @return string 修改後的價格 HTML
 */
function moksa_add_vip_label_for_members( $price_html, $product ) {
    
    // 我們的 VIP 會員方案 ID
    $vip_plan_id = 123;
    
    // 判斷：使用者是否登入？ 並且，他是否是 VIP 會員？
    // function_exists 確保 YITH 外掛啟用中，避免網站出錯
    if ( is_user_logged_in() && function_exists('yith_wcms_is_member') && yith_wcms_is_member( get_current_user_id(), $vip_plan_id ) ) {
        
        // 如果是 VIP 會員，加上 VIP 標籤
        $price_html .= ' <span class="vip-price-label">VIP 專屬價</span>';
        
    }
    
    // **重要**：無論條件是否成立，都要回傳 $price_html
    // 如果不是會員，就回傳原始的價格 HTML
    return $price_html;
}
add_filter( 'woocommerce_get_price_html', 'moksa_add_vip_label_for_members', 20, 2 ); // 將 priority 設為 20，確保在 "(含稅)" 之後執行

```

**Moksa 技巧：**
1.  **防呆處理**：使用 `function_exists('yith_wcms_is_member')` 是一個非常好的習慣。這樣一來，即使你未來停用了 YITH Membership 外掛，網站也不會因為找不到函式而直接發生嚴重錯誤 (Fatal Error)。
2.  **調整 Priority**：我們將優先序設為 `20`，比上一個範例的 `10` 更晚執行。這樣可以確保標籤會出現在 `(含稅)` 字樣的後面，讓最終結果變成 `NT$1,200 (含稅) VIP 專屬價`。

#### 步驟 3：加入 CSS 讓標籤更美觀

為了讓標籤更好看，我們可以到「自訂」>「附加的 CSS」中，加入一些樣式。

```css
.vip-price-label {
    background-color: #D4AF37; /* 金色 */
    color: #fff;
    padding: 2px 6px;
    font-size: 0.8em;
    border-radius: 4px;
    margin-left: 8px;
}
```

#### 步驟 4：用 VIP 會員帳號登入並查看結果

現在，登入你的 VIP 會員帳號，瀏覽商品頁，你就會看到專為會員設計的價格標籤了！

``
*（示意圖：VIP 會員看到的價格，後面跟著漂亮的金色標籤）*

---

### 如何尋找更多 Filter Hooks？

你可能會問，我要怎麼知道有哪些 hook 可以用？

1.  **官方文件**：WordPress Codex 和 WooCommerce Developer Resources 是你的第一站。
2.  **直接看原始碼**：這是最直接的方式。在 WordPress 或外掛的程式碼中，搜尋 `apply_filters(` 這個函式，你就能找到所有可用的過濾點。
3.  **使用開發者工具**：**Moksa 技巧**，安裝我們技術棧中推薦的 **Query Monitor** 外掛。啟用後，它會在上方管理列顯示一個數據面板。點開後找到 "Hooks & Actions" 分頁，你可以看到目前頁面執行了哪些 actions 和 filters，以及它們的參數，這是開發時的超級利器。

``
*（示意圖：Query Monitor 外掛的 Hooks & Actions 介面，顯示了當前頁面所有的 filter hooks）*

恭喜你！今天你學會了 WordPress 開發中最強大的武器之一 `add_filter`。掌握它，意味著你幾乎可以客製化網站上的任何資料。請務必多加練習，試著去修改看看網站上其他你感興趣的部分。