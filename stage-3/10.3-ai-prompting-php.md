# 10.03 (實務) 如何「詠唱」(Prompt) AI 幫您寫 WP 程式碼 (PHP, Hooks)

嗨，歡迎來到 Moksa 開發者課程！我是你的導師。

在現代的開發流程中，善用 AI (例如：ChatGPT, Claude, GitHub Copilot) 已經不再是加分題，而是必備技能。它就像一位 24 小時待命的資深程式設計師，能為你解答疑惑、產生程式碼片段、甚至幫你除錯。

然而，AI 的能力取決於你「**詠唱**」的能力，也就是你下達 **Prompt (提示詞)** 的品質。一個好的 Prompt 能讓你得到精準、安全、高效的程式碼；一個差的 Prompt 可能會給你過時、有漏洞，甚至完全錯誤的答案。

這堂課，我們將專注於如何**有策略地詠唱**，讓 AI 成為你開發 WordPress 外掛與佈景主題時最強大的「副駕駛」。

---

## 什麼是好的「詠唱」？Moksa C.R.A.F.T. 詠唱框架

要讓 AI 精準理解你的需求，你需要提供足夠的資訊。我們在 Moksa 內部總結出了一套有效的詠唱框架，稱為「**C.R.A.F.T.**」，幫助你結構化你的問題。

*   **C - Context (情境):** **告訴 AI 它在哪裡。** 這包括 WordPress 版本、PHP 版本、相關外掛 (例如 WooCommerce, ACF)、以及你的目標是什麼。
*   **R - Role (角色):** **賦予 AI 一個專家身份。** 要求它扮演「一位資深的 WordPress / WooCommerce 開發專家」，這會讓它傾向於提供更專業、更符合最佳實踐的答案。
*   **A - Action (行動):** **明確指出你要 AI 做什麼。** 例如：「撰寫一個 PHP 函式」、「解釋這段程式碼的作用」、「重構 (refactor) 以下程式碼讓它更有效率」、「找出這段程式碼可能的 bug」。
*   **F - Format (格式):** **指定你希望的回覆格式。** 例如：「請提供完整的 PHP 程式碼片段」、「使用 Markdown 格式」、「請加上詳細的程式碼註解」、「請用條列式說明步驟」。
*   **T - Task (任務):** **詳細、具體地描述你的任務。** 這是最重要的部分，越具體越好。包含函式名稱、要使用的 WordPress Hook (Action/Filter)、預期的輸入與輸出等。

---

## 實戰演練：三個從淺入深的詠唱範例

接下來，我們將透過三個常見的開發場景，實際應用 **C.R.A.F.T. 框架**。

### 範例一：(基礎) 修改 WooCommerce 商品頁的「加入購物車」按鈕文字

這是一個非常常見的客製化需求，我們來看看如何詠唱。

*   **情境分析：** 我們想在單一商品頁上，把預設的「加入購物車」文字，改成「立即購買」。
*   **詠唱 Prompt:**

> **[角色]**
> 你是一位精通 WordPress 與 WooCommerce 的資深 PHP 開發專家。
>
> **[情境]**
> 我正在開發一個基於 WordPress 6.4 和 WooCommerce 8.5 的網站。我需要在「單一商品頁面」上修改「加入購物車」按鈕的顯示文字。
>
> **[任務]**
> 請撰寫一個 PHP 函式，使用 WooCommerce 提供的 Filter Hook，將按鈕文字從「加入購物車」改為「立即購買」。
>
> **[格式]**
> 請提供完整的 PHP 程式碼片段，並附上簡潔的中文註解，解釋這段程式碼是如何運作的。

*   **AI 可能的產出:**

```php
<?php
/**
 * 修改單一商品頁面的「加入購物車」按鈕文字
 *
 * 使用 'woocommerce_product_single_add_to_cart_text' filter hook.
 */
add_filter( 'woocommerce_product_single_add_to_cart_text', 'moksa_custom_add_to_cart_text' );

function moksa_custom_add_to_cart_text() {
    // 回傳你想要顯示的新文字
    return __( '立即購買', 'woocommerce' );
}
```

*   **Moksa 技巧：** 這段程式碼應該放在哪裡？最好的做法是放在你自訂的佈景主題 `functions.php` 檔案中，或是透過像 [Code Snippets](https://wordpress.org/plugins/code-snippets/) 這類外掛來管理，這樣可以避免佈景主題更新時遺失你的客製化程式碼。

`[截圖：修改後商品頁面上「立即購買」按鈕的畫面]`

---

### 範例二：(進階) 當訂單完成時，發送一個 LINE Notify 通知

這個範例整合了 WooCommerce 的 Action Hook 與第三方服務 (LINE Notify)。

*   **情境分析：** 我們希望當任何一筆 WooCommerce 訂單的狀態變為「已完成」(Completed) 時，能自動發送一則通知到指定的 LINE Notify 聊天室，通知管理者有新訂單完成。
*   **詠唱 Prompt:**

> **[角色]**
> 你是一位資深的 WordPress/WooCommerce 後端開發工程師，熟悉如何串接外部 API。
>
> **[情境]**
> 我的網站使用 WordPress 和 WooCommerce。我已經申請了 LINE Notify 的權杖 (Token)，想要在訂單完成時收到通知。
>
> **[任務]**
> 1.  請撰寫一個 PHP 函式，掛載到 `woocommerce_order_status_completed` 這個 Action Hook 上。
> 2.  這個函式接收 `$order_id` 參數。
> 3.  在函式內部，取得該訂單的物件 (`WC_Order`)。
> 4.  組合一條通知訊息，內容包含：「新訂單完成！訂單編號：#XXXX，總金額：$YYYY」。
> 5.  使用 WordPress 的 `wp_remote_post()` 函式，將這條訊息透過 LINE Notify API 發送出去。
> 6.  請在程式碼中預留一個變數讓我填寫我的 LINE Notify Token。
>
> **[格式]**
> 請提供完整的、可直接使用的 PHP 程式碼片段，並加上詳細的中文註解說明每個步驟。

*   **AI 可能的產出:**

```php
<?php
/**
 * 當 WooCommerce 訂單狀態變為「已完成」時，發送 LINE Notify 通知。
 *
 * @param int $order_id 訂單 ID.
 */
add_action( 'woocommerce_order_status_completed', 'moksa_send_line_notify_on_order_completion', 10, 1 );

function moksa_send_line_notify_on_order_completion( $order_id ) {
    // 1. 請在此處填入你的 LINE Notify 權杖
    $line_notify_token = 'YOUR_LINE_NOTIFY_TOKEN_HERE';

    // 如果沒有訂單 ID 或 Token，則直接返回
    if ( ! $order_id || empty( $line_notify_token ) ) {
        return;
    }

    // 2. 透過訂單 ID 取得訂單物件
    $order = wc_get_order( $order_id );

    // 如果無法取得訂單物件，則返回
    if ( ! $order ) {
        return;
    }

    // 3. 組合要發送的訊息
    $order_number = $order->get_order_number();
    $order_total = $order->get_formatted_order_total();
    $message = sprintf( "\n新訂單完成！\n訂單編號：%s\n訂單總額：%s", $order_number, $order_total );

    // 4. 設定 LINE Notify API 的請求參數
    $api_url = 'https://notify-api.line.me/api/notify';
    $body    = array( 'message' => $message );
    $headers = array(
        'Authorization' => 'Bearer ' . $line_notify_token,
    );

    $args = array(
        'body'    => $body,
        'headers' => $headers,
        'timeout' => 5, // 設定超時時間
    );

    // 5. 使用 wp_remote_post() 發送請求
    $response = wp_remote_post( $api_url, $args );

    // (可選) 記錄日誌，方便除錯
    if ( is_wp_error( $response ) ) {
        error_log( 'LINE Notify failed: ' . $response->get_error_message() );
    }
}
```
*   **Moksa 技巧：** 這個範例展示了如何詠唱來處理更複雜的邏輯，包括 API 串接。**永遠不要**在 Prompt 中提供你真實的 API 金鑰或權杖。另外，實務上我們會推薦使用像 **OrderChatz** 或 **Order Notify** 這類專門處理 LINE 通知的成熟外掛，它們提供了更完整的介面與錯誤處理機制，但了解其背後的原理對開發者至關重要。

---

## AI 不是萬能的：驗證與除錯的必要性

**這是本堂課最重要的觀念：絕對不要盲目地複製貼上 AI 產生的程式碼！**

AI 的知識有時間限制，它可能提供基於舊版 WordPress 或外掛的寫法，也可能忽略了某些安全性考量。你，身為開發者，有最終的責任。

**步驟 1：在安全環境測試**
*   **絕對不要**在正式上線的網站直接貼上 AI 程式碼。
*   請務必在你的 **LocalWP** 開發環境或一個獨立的測試站 (Staging Site) 上進行測試。

**步驟 2：使用偵錯工具**
*   安裝並啟用 **Query Monitor** 外掛。如果 AI 的程式碼產生了 PHP 錯誤、警告 (Warning) 或通知 (Notice)，Query Monitor 會在頂部管理列清楚地顯示出來。
*   開啟 WordPress 的除錯模式。在 `wp-config.php` 檔案中，將 `WP_DEBUG` 設為 `true`。
    `define( 'WP_DEBUG', true );`
    `define( 'WP_DEBUG_LOG', true );` // 這會將錯誤記錄到 wp-content/debug.log 檔案中

`[截圖：Query Monitor 顯示 PHP 錯誤的畫面]`

**步驟 3：理解每一行程式碼**
*   在貼上程式碼之前，花時間閱讀它。如果你看不懂某個函式 (例如 `wp_remote_post`)，就接著問 AI：「請詳細解釋 `wp_remote_post` 函式的作用、參數和回傳值。」
*   **Moksa 技巧：** 把 AI 當成你的程式碼導師 (Code Tutor)，利用它來學習新的 WordPress API 和最佳實踐。

**步驟 4：檢查程式碼風格與安全性**
*   檢查程式碼是否符合 [WordPress Coding Standards](https://developer.wordpress.org/coding-standards/)。
*   思考安全性：這個程式碼是否有處理好權限問題？是否有對使用者的輸入進行清理 (Sanitization)？是否有對輸出進行跳脫 (Escaping)？

---

## 詠唱心法：Moksa 的最佳實踐與注意事項

1.  **迭代與細化：** 第一次的 Prompt 不一定完美。如果 AI 的回覆不符合預期，不要放棄。試著修正你的 Prompt，提供更多細節，或指出它回答的錯誤之處，引導它給你正確的答案。
2.  **提供範例：** 如果你有一個理想的程式碼風格或結構，可以直接貼給 AI，並告訴它：「請參考以下程式碼的風格，為我完成我的任務。」
3.  **拆解複雜任務：** 如果你的需求很複雜 (例如：寫一個完整的外掛)，不要試圖用一個 Prompt 完成。把它拆解成數個小任務，例如：「第一步：幫我註冊一個自訂文章類型 (CPT)」、「第二步：為這個 CPT 新增一個 Metabox」、「第三步：...」。
4.  **注意隱私：** **絕對不要**將客戶的敏感資料、網站帳密、或任何私密資訊貼到 Prompt 中。

## 總結

學會如何與 AI 高效協作，是提升開發效率的關鍵。透過 **Moksa C.R.A.F.T. 詠唱框架**，你可以更有結構地提出問題，獲得更高品質的程式碼。

但請永遠記住，AI 是一個強大的「工具」和「副駕駛」，而不是你的替代品。最終的程式碼品質、安全性與效能，仍然掌握在你這位專業開發者的手中。

現在，打開你的 **VS Code** 和 **LocalWP**，開始練習詠唱吧！