# 08.04 (實務) API 驗證 (Nonce, JWT, 應用程式密碼)

嗨，歡迎來到 MoksaWP 開發課程！在前面的章節中，我們學會了如何建立自訂的 REST API 端點 (Endpoint)，但那些多半是公開、任何人都可以存取的資料。在實務開發中，我們更常需要處理需要「驗證身份」才能執行的操作，例如：新增文章、更新使用者資料、或是處理 WooCommerce 訂單等。

如果沒有驗證機制，任何人都可以透過 API 任意竄改你的網站資料，後果不堪設想。因此，學會如何保護你的 API 端點是開發者最重要的課題之一。

這堂課，我們將深入探討 WordPress REST API 中最主流的三種驗證方式：**Nonce**、**應用程式密碼**、以及 **JWT**。我們將分析它們各自的原理、使用情境，並提供實作範例，讓你能夠根據專案需求，選擇最適合的驗證方案。

---

## 方法一：Nonce 驗證 (Cookie-based)

**Nonce (Number used once)** 是 WordPress 內建的核心安全機制，主要用來防止 **跨站請求偽造 (CSRF)** 攻擊。它的原理是為每一個登入的使用者 Session 產生一個獨一無二、有時效性的臨時金鑰。當使用者執行敏感操作時，必須一併提供這個金鑰，WordPress 後端驗證通過後才會執行。

*   **核心觀念**：Nonce 驗證是**基於 Cookie** 的。這意味著它只適用於**已經登入 WordPress 的使用者**，並且操作是從網站前端或後台發起的 (瀏覽器會自動帶上 Cookie)。
*   **最佳使用情境**：
    *   在 WordPress 後台儀表板內，透過 JavaScript (AJAX) 執行的非同步操作。
    *   在網站前台，讓登入的使用者執行特定操作 (例如：將商品加入願望清單、對文章按讚)。

### (實作) 如何在 AJAX 請求中加入 Nonce 驗證

假設我們要在主題或外掛中，透過 AJAX 呼叫一個需要驗證的 API。

#### 步驟 1：在 PHP 中將 Nonce 傳遞給 JavaScript

我們不能直接在 JS 檔案中寫死 Nonce，因為它是動態產生的。最標準的做法是使用 `wp_localize_script()` 函式，將 Nonce 作為一個 JavaScript 物件變數傳遞到前端。

```php
// 在你的 theme/functions.php 或 plugin 主檔案中

function moksa_enqueue_custom_scripts() {
    // 假設你的 JS 檔案叫做 main.js
    wp_enqueue_script(
        'moksa-main-js',
        get_template_directory_uri() . '/assets/js/main.js', // 請根據你的路徑修改
        array('wp-api-fetch'), // 依賴 wp-api-fetch 函式庫
        '1.0.0',
        true
    );

    // **Moksa 技巧：使用 wp_localize_script 傳遞資料給 JS**
    // 這會產生一個名為 moksaData 的全域 JS 物件
    wp_localize_script(
        'moksa-main-js', // 要附加在哪個 script handle 上
        'moksaData',     // JS 物件的名稱
        array(
            'nonce' => wp_create_nonce('wp_rest'), // 產生給 REST API 使用的 Nonce
            'api_url' => rest_url('moksa/v1/my-endpoint'), // 也可以順便把 API URL 傳過去
        )
    );
}
add_action('wp_enqueue_scripts', 'moksa_enqueue_custom_scripts');
```

#### 步驟 2：在 JavaScript 中發送帶有 Nonce 的請求

現在，在我們的 `main.js` 檔案中，就可以透過 `moksaData.nonce` 來取得這個金鑰，並將它放在 HTTP 請求的 `X-WP-Nonce` Header 中。

```javascript
// 在你的 main.js 檔案中

document.addEventListener('DOMContentLoaded', () => {
    const myButton = document.getElementById('my-action-button');

    if (myButton) {
        myButton.addEventListener('click', async () => {
            try {
                const response = await fetch(moksaData.api_url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // **重點：將 Nonce 放在 X-WP-Nonce Header**
                        'X-WP-Nonce': moksaData.nonce 
                    },
                    body: JSON.stringify({
                        'some_data': 'hello world'
                    })
                });

                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }

                const result = await response.json();
                console.log('API 回應:', result);
                alert('操作成功！');

            } catch (error) {
                console.error('錯誤:', error);
                alert('操作失敗！');
            }
        });
    }
});
```

當 WordPress REST API 收到這個請求時，會自動檢查 `X-WP-Nonce` Header 的值是否有效，如果無效或過期，將會回傳 `403 Forbidden` 錯誤。

---

## 方法二：應用程式密碼 (Application Passwords)

從 WordPress 5.6 版開始，核心新增了「應用程式密碼」功能。這是一種**專門為外部應用程式**設計的驗證機制，允許你為某個特定的應用程式產生一組專用的密碼，而不需要暴露你的主要登入密碼。

*   **核心觀念**：應用程式密碼使用 **HTTP Basic Authentication**。它讓外部應用 (如：手機 APP、第三方服務、在另一台主機上執行的排程腳本) 可以代表某個**特定使用者**來跟你的網站 API 互動。
*   **最佳使用情境**：
    *   連接 Zapier 或 Make (Integromat) 等自動化服務。
    *   開發手機 App，需要連回 WordPress 讀取或寫入資料。
    *   在 CI/CD 流程中，由腳本自動發佈文章。
    *   **Moksa 技巧：** 這是取代傳統帳號密碼驗證的最佳方案，因為它可以隨時在後台針對單一應用程式撤銷存取權，而不會影響到使用者本人的登入。

### (實作) 如何使用應用程式密碼

#### 步驟 1：在 WordPress 後台產生應用程式密碼

1.  登入 WordPress 後台，前往「**使用者**」>「**個人資料**」。
2.  捲動到頁面下方的「**應用程式密碼**」區塊。
3.  在「**新應用程式密碼名稱**」欄位中，輸入一個好辨識的名稱 (例如：My Awesome App)。
4.  點擊「**新增應用程式密碼**」。

``

5.  系統會產生一組**只會顯示一次**的密碼，格式為 `xxxx xxxx xxxx xxxx xxxx xxxx`。**請立刻複製並妥善保管**，因為關閉頁面後就再也看不到了。

``

#### 步驟 2：使用 Basic Auth 發送請求

發送請求時，你需要將「**使用者名稱**」和「**應用程式密碼**」(不含空格) 用冒號 `:` 串接，然後進行 **Base64 編碼**，最後放在 `Authorization` Header 中。

以下是一個使用 `cURL` (常用於伺服器端腳本) 的範例：

```bash
# 使用者名稱: oberon
# 應用程式密碼: abcd efgh ijkl mnop qrst uvwx (記得移除空格)
# 組合字串: oberon:abcdefghijklmnopqrstuvwx
# Base64 編碼後: b2Jlcm9uOmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eA==

curl -X POST \
  https://your-domain.com/wp-json/wp/v2/posts \
  -H "Authorization: Basic b2Jlcm9uOmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eA==" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "透過應用程式密碼發佈的文章",
    "content": "這篇文章是由外部應用程式自動發佈的。",
    "status": "publish"
  }'
```

---

## 方法三：JWT (JSON Web Tokens)

**JWT** 是一種開放標準 (RFC 7519)，它定義了一種簡潔且獨立的方式，用於在各方之間安全地傳輸資訊，這些資訊被打包成一個 JSON 物件。這個 JSON 物件經過數位簽章，因此可以被驗證和信任。

*   **核心觀念**：JWT 是**無狀態 (Stateless)** 的。使用者先用帳號密碼向特定端點換取一個有時效性的 Token，之後的每次請求都必須在 Header 中帶上這個 Token。伺服器端只需驗證 Token 的簽章是否合法，不需要查詢資料庫來確認使用者 Session，效能極佳。
*   **最佳使用情境**：
    *   **無頭 (Headless) CMS 架構**：前端使用 React, Vue, Angular 等框架，與後端 WordPress 完全分離。
    *   **單頁應用程式 (SPA, Single-Page Application)**。
    *   需要讓使用者在你的服務生態系中 (例如網站和 App) 實現**單一登入 (SSO)**。

### (實作) 如何設定並使用 JWT

WordPress 核心本身不支援 JWT，我們需要透過外掛來實現。Moksa 推薦使用 **JWT Authentication for WP REST API** 這支老牌且穩定的外掛。

#### 步驟 1：安裝與設定外掛

1.  從 WordPress 後台安裝並啟用 **JWT Authentication for WP REST API** 外掛。
2.  **（極度重要）** 為了讓簽章更安全，你必須在 `wp-config.php` 檔案中定義一個**密鑰 (Secret Key)**。請使用一個高強度的隨機字串。

```php
// 在你的 wp-config.php 檔案中，加在 WordPress 金鑰區塊的下方

define('JWT_AUTH_SECRET_KEY', 'your-highly-secure-and-long-random-string-here');
define('JWT_AUTH_CORS', true); // 允許跨域存取，對於 Headless 架構是必須的
```

#### 步驟 2：取得 JWT Token

應用程式需要先用使用者的帳號密碼，向外掛提供的端點 `/wp-json/jwt-auth/v1/token` 發送一個 POST 請求來獲取 Token。

```javascript
// 使用 fetch 取得 Token
async function loginAndGetToken(username, password) {
    try {
        const response = await fetch('https://your-domain.com/wp-json/jwt-auth/v1/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        });

        if (!response.ok) {
            throw new Error('登入失敗，請檢查帳號密碼。');
        }

        const data = await response.json();
        
        // **Moksa 技巧：將 Token 儲存在 localStorage 或 sessionStorage 中**
        // 這樣下次就不用重新登入了
        localStorage.setItem('jwt_token', data.token);

        console.log('登入成功，取得 Token:', data.token);
        return data.token;

    } catch (error) {
        console.error(error);
    }
}
```

#### 步驟 3：使用 JWT Token 進行驗證

取得 Token 後，之後的每一次請求，都必須在 `Authorization` Header 中以 `Bearer` 的形式帶上這個 Token。

```javascript
async function createPostWithToken() {
    const token = localStorage.getItem('jwt_token');

    if (!token) {
        alert('請先登入！');
        return;
    }

    try {
        const response = await fetch('https://your-domain.com/wp-json/wp/v2/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // **重點：使用 Bearer Token 進行驗證**
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                title: '用 JWT 發佈的文章',
                content: '這是一篇透過 JWT 驗證後發佈的文章。',
                status: 'publish'
            })
        });

        if (!response.ok) {
            // 如果 Token 過期或無效，這裡通常會收到 403 錯誤
            throw new Error('請求失敗，Token 可能已過期。');
        }

        const newPost = await response.json();
        console.log('文章已建立:', newPost);

    } catch (error) {
        console.error(error);
    }
}
```

---

## 總結比較與 Moksa 選擇指南

| 特性 | Nonce 驗證 | 應用程式密碼 | JWT |
| :--- | :--- | :--- | :--- |
| **核心/外掛** | WordPress **核心內建** | WordPress **核心內建** | 需要**外掛** |
| **狀態** | 有狀態 (Stateful)，依賴 Cookie | 無狀態 (Stateless) | 無狀態 (Stateless) |
| **主要場景** | WP 後台 AJAX、已登入使用者 | 外部應用、伺服器對伺服器 | **Headless CMS**、SPA、手機 App |
| **安全性** | 高 (防止 CSRF) | 高 (可隨時撤銷) | 高 (需保護好 Secret Key) |
| **設定難易度** | 簡單 | 非常簡單 | 中等 (需設定 Secret Key) |
| **時效性** | 短 (預設 24 小時) | 永久有效 (直到被撤銷) | 可自訂 (通常是幾小時到幾天) |

### Moksa 技巧：何時該用哪一種？

*   **情境一：** 你正在開發一個外掛，需要在文章編輯頁面加入一個按鈕，點擊後會非同步儲存一些自訂的中繼資料。
    *   **答案：** **Nonce 驗證**。因為操作發生在 WordPress 後台，使用者已經登入，Nonce 是最直接、最安全、也最符合 WordPress 規範的做法。

*   **情境二：** 公司希望每天凌晨自動從內部 ERP 系統同步產品庫存到 WooCommerce 網站。
    *   **答案：** **應用程式密碼**。因為這是伺服器對伺服器的溝通，沒有使用者互動。為 ERP 系統建立一個專屬的應用程式密碼，既安全又方便管理。

*   **情境三：** 你正在為客戶打造一個全新的形象網站，前端使用 Next.js (React 框架) 開發，以達到極致的效能與互動體驗，內容則全部由 WordPress 後台管理。
    *   **答案：** **JWT**。這是典型的 Headless CMS 架構。前端需要一個無狀態的驗證機制來處理使用者登入、留言等操作，JWT 是這個場景下的業界標準。

恭喜你完成了 API 驗證的課程！掌握這三種驗證方式，你就能夠自信地建構出各種安全、可靠、且架構靈活的 WordPress 應用程式。