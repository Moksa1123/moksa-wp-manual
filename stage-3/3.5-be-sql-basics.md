# 03.05 SQL 查詢基礎 (SELECT, JOIN, WHERE)

歡迎來到 MoksaWP 開發課程的資料庫章節。在之前的課程中，我們學習了如何透過 WordPress 後台和 PHP 函式來操作資料。然而，作為一名專業的開發者，理解數據在底層是如何儲存與互動的至關重要。這堂課，我們將深入 WordPress 的心臟——MySQL 資料庫，並學習使用 SQL (Structured Query Language) 來直接查詢我們需要的資訊。

理解 SQL 不僅能讓你更有效率地進行偵錯 (debug)，還能讓你撰寫更高效能的複雜查詢，這是在處理大量 WooCommerce 訂單、商品或會員資料時不可或缺的技能。

---

### 什麼是 SQL？為什麼我們需要它？

WordPress 使用 MySQL 作為其資料庫管理系統。網站上所有的內容，從文章、頁面、使用者帳號、商品資訊到訂單紀錄，全都儲存在這個資料庫的「資料表 (Tables)」中。

SQL 是一種專門用來與資料庫溝通的語言。透過 SQL，我們可以進行：

*   **查詢 (Querying):** 讀取資料。
*   **插入 (Inserting):** 新增資料。
*   **更新 (Updating):** 修改資料。
*   **刪除 (Deleting):** 移除資料。

在這堂入門課中，我們將專注於最常用且最關鍵的操作：**查詢**。我們將使用 `SELECT`, `WHERE`, `JOIN` 這三個核心指令來從資料庫中精準地撈出我們想要的資訊。

**Moksa 技巧：** 在開發環境中（例如 LocalWP），通常會內建像 **Adminer** 或 **phpMyAdmin** 這類的資料庫管理工具。你可以透過這些工具的 GUI 介面直接執行 SQL 查詢語法，這對於學習和測試來說非常方便。

`[SCREENSHOT]`
*Adminer 的介面，左側是資料表列表，右側是執行 SQL 指令的區域。*

---

### WordPress 核心資料表結構簡介

在開始查詢之前，我們需要對 WordPress 的資料庫結構有一個基本的認識。WordPress 的資料表名稱通常會有一個前綴，預設是 `wp_`。以下是幾個最核心的資料表：

*   `wp_posts`: 這可以說是 WordPress 最重要的資料表。它不僅儲存文章 (post) 和頁面 (page)，還包括 WooCommerce 的**商品 (product)**、**訂單 (shop_order)**、優惠券 (shop_coupon) 等，都是透過 `post_type` 這個欄位來區分的。
*   `wp_postmeta`: 用來儲存 `wp_posts` 資料表的「後設資料 (Metadata)」。例如，一個商品的**價格、庫存數量、SKU** 等資訊都儲存在這裡。它透過 `post_id` 欄位與 `wp_posts` 關聯。
*   `wp_users`: 儲存網站上所有使用者的基本資訊，如**帳號、密碼 (已加密)、Email**。
*   `wp_usermeta`: 儲存 `wp_users` 的後設資料。例如，使用者的**姓名、地址、電話**等 WooCommerce 結帳欄位資訊。它透過 `user_id` 欄位與 `wp_users` 關聯。
*   `wp_options`: 儲存全站的設定值，例如網站標題、管理員 Email、外掛設定等。

---

### 1. `SELECT` - 讀取資料

`SELECT` 是 SQL 的基礎，用於從資料表中選取你需要的欄位 (Columns)。

#### 語法

*   選取所有欄位：`SELECT * FROM table_name;`
*   選取指定欄位：`SELECT column1, column2, ... FROM table_name;`

#### 實作範例

**步驟 1：查詢所有使用者**

假設我們想看到 `wp_users` 資料表裡的所有資料，我們可以使用 `*` (星號) 代表「所有欄位」。

```sql
SELECT * FROM wp_users;
```

`[SCREENSHOT]`
*執行結果的表格，顯示了所有使用者的 ID, user_login, user_email 等欄位。*

**步驟 2：只查詢使用者的登入名稱和 Email**

如果我們只關心特定資訊，明確指定欄位名稱會更有效率。

```sql
SELECT user_login, user_email FROM wp_users;
```

**Moksa 技巧：** 在查詢大量資料時，**永遠優先指定你需要的欄位**，避免使用 `SELECT *`。這樣可以減少資料庫的負載，提升查詢效能。

---

### 2. `WHERE` - 篩選條件

`WHERE` 子句用於過濾記錄，只取出符合特定條件的資料列 (Rows)。

#### 語法

`SELECT column1, column2, ... FROM table_name WHERE condition;`

#### 實作範例

**步驟 1：找出所有 WooCommerce 商品**

我們知道商品是儲存在 `wp_posts` 資料表中，且其 `post_type` 欄位的值是 `product`。

```sql
SELECT ID, post_title, post_status FROM wp_posts WHERE post_type = 'product';
```
這條指令會回傳所有 `post_type` 為 `product` 的文章，並只顯示它們的 `ID`、`post_title` (商品名稱) 和 `post_status` (發布狀態)。

**步驟 2：找出價格大於 1000 元的商品 ID**

這個查詢稍微複雜一點。商品的價格儲存在 `wp_postmeta` 資料表中，`meta_key` 是 `_price`。

```sql
SELECT post_id FROM wp_postmeta WHERE meta_key = '_price' AND meta_value > 1000;
```
這裡我們用 `AND` 來結合兩個條件：`meta_key` 必須是 `_price` **而且** `meta_value` (價格) 必須大於 1000。

**常用的 `WHERE` 運算子：**
*   `=`：等於
*   `!=` 或 `<>`：不等於
*   `>`：大於
*   `<`：小於
*   `>=`：大於等於
*   `<=`：小於等於
*   `LIKE`：模糊比對 (e.g., `WHERE post_title LIKE '%WordPress%'`)
*   `IN`：符合清單中的任何一個值 (e.g., `WHERE ID IN (1, 5, 10)`)

---

### 3. `JOIN` - 關聯多個資料表

`JOIN` 是 SQL 中威力最強大也最關鍵的指令之一。它能讓我們將多個資料表根據相關的欄位「連接」起來，進行跨資料表的查詢。

這在 WordPress 中尤其重要，因為核心資料 (如商品標題) 和後設資料 (如商品價格) 是分開儲存的。

#### `INNER JOIN` (內部連接)

`INNER JOIN` 會回傳兩個資料表中，**連接欄位的值都相符**的記錄。

`[SCREENSHOT]`
*一個圖解，顯示兩個圓圈交集的部分，代表 INNER JOIN 的結果。*

#### 實作練習：查詢所有「已發佈」商品的「名稱」與「價格」

這個需求需要同時從 `wp_posts` (取得商品名稱、發佈狀態) 和 `wp_postmeta` (取得價格) 撈取資料。

*   **目標：**
    1.  商品必須是 `product` 類型 (`wp_posts.post_type = 'product'`)。
    2.  商品必須是 `publish` 狀態 (`wp_posts.post_status = 'publish'`)。
    3.  我們要從 `wp_postmeta` 抓取價格 (`wp_postmeta.meta_key = '_price'`)。
    4.  兩個資料表必須透過 `ID` 和 `post_id` 關聯起來。

**步驟 1：撰寫 SQL 查詢**

```sql
SELECT
    p.ID,
    p.post_title,
    pm.meta_value AS price
FROM
    wp_posts AS p
INNER JOIN
    wp_postmeta AS pm ON p.ID = pm.post_id
WHERE
    p.post_type = 'product'
    AND p.post_status = 'publish'
    AND pm.meta_key = '_price';
```

**語法解析：**
*   `AS p` 和 `AS pm`：這是為資料表設定「**別名 (Alias)**」，讓我們在後續的查詢中可以用更短的名稱來引用它們。
*   `INNER JOIN ... ON p.ID = pm.post_id`：這是 `JOIN` 的核心。它告訴資料庫，請將 `wp_posts` (別名 p) 的 `ID` 欄位與 `wp_postmeta` (別名 pm) 的 `post_id` 欄位進行比對，只保留兩者相等的資料列。
*   `pm.meta_value AS price`：我們將 `meta_value` 欄位重新命名為 `price`，讓回傳的結果更具可讀性。

`[SCREENSHOT]`
*執行結果的表格，包含三欄：ID, post_title, price。*

---

### 整合應用：一個更複雜的查詢

現在，讓我們挑戰一個更貼近實務的 WooCommerce 查詢。

**情境：** 我們需要找出所有透過「**綠界科技 ECPay 信用卡**」付款，且訂單狀態為「**處理中 (Processing)**」的**訂購者 Email**。

這個查詢將會用到 `wp_posts`、`wp_postmeta` 和 `wp_users` 三個資料表。

*   `wp_posts`: 篩選出 `post_type = 'shop_order'` 且 `post_status = 'wc-processing'` 的訂單。
*   `wp_postmeta`:
    1.  找出訂單的付款方式 (`meta_key = '_payment_method'` 且 `meta_value = 'ecpay_credit'`)。
    2.  找出訂單的顧客 ID (`meta_key = '_customer_user'`)。
*   `wp_users`: 根據從 `wp_postmeta` 找到的顧客 ID，找出對應的 `user_email`。

#### 實作步驟與最終查詢

```sql
SELECT
    p.ID AS order_id,
    u.user_email
FROM
    wp_posts AS p
INNER JOIN
    wp_postmeta AS pm_payment ON p.ID = pm_payment.post_id
INNER JOIN
    wp_postmeta AS pm_customer ON p.ID = pm_customer.post_id
INNER JOIN
    wp_users AS u ON pm_customer.meta_value = u.ID
WHERE
    p.post_type = 'shop_order'
    AND p.post_status = 'wc-processing'
    AND pm_payment.meta_key = '_payment_method'
    AND pm_payment.meta_value = 'ecpay_credit'
    AND pm_customer.meta_key = '_customer_user';
```

**Moksa 技巧：**
*   我們對 `wp_postmeta` 使用了兩次 `INNER JOIN` 並給予了不同的別名 (`pm_payment` 和 `pm_customer`)。這是因為一張訂單在 `wp_postmeta` 中有多筆記錄 (付款方式、顧客 ID、總金額等)，我們需要分別針對不同的 `meta_key` 進行條件篩選。
*   最後，我們 `INNER JOIN wp_users`，連接條件是顧客 ID (`pm_customer.meta_value`) 必須等於使用者資料表中的 `ID` (`u.ID`)。

---

### 重要！Moksa 技巧與注意事項

直接操作資料庫是一把雙面刃，威力強大但風險也很高。請務必遵守以下原則：

1.  **安全性 (Security):** 在你的 PHP 程式碼中，**絕對、絕對不要**將使用者輸入的內容（例如 `$_GET` 或 `$_POST` 的值）直接拼接到 SQL 字串中。這會造成嚴重的 **SQL Injection (SQL 隱碼攻擊)** 漏洞。在 WordPress 開發中，請務必使用 `$wpdb->prepare()` 方法來安全地處理變數。

2.  **效能 (Performance):** 複雜的 `JOIN` 和沒有使用資料庫索引 (Index) 的 `WHERE` 條件在大數據量的網站上可能會非常慢。進行複雜查詢前，請先評估其對網站效能的影響。

3.  **WordPress 的方式 (The WordPress Way):** 在絕大多數情況下，你應該優先使用 WordPress 內建的函式和類別來取得資料，例如：
    *   `WP_Query` 或 `get_posts()` 用於查詢文章/商品。
    *   `WP_User_Query` 或 `get_users()` 用於查詢使用者。
    *   WooCommerce 提供的 `wc_get_orders()` 和 `wc_get_products()` 函式。
    *   `$wpdb` 全域物件 (`$wpdb->get_results()`, `$wpdb->get_var()` 等) 是在需要高度客製化查詢時的官方推薦方法。

    直接下 Raw SQL 查詢，通常只保留給**偵錯、數據分析、特殊的一次性批次處理、或確定內建函式無法滿足效能需求**的極端情境。

### 課程總結

恭喜你！你已經掌握了 SQL 中最核心的三個指令：`SELECT`、`WHERE` 和 `JOIN`。你現在有能力直接窺探 WordPress 資料庫的內部，並理解資料是如何被組織和關聯的。這項技能將為你後續學習更進階的後端開發、效能調校與問題排查打下堅實的基礎。