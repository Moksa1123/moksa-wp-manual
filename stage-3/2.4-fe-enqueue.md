# 02.04 (實作) 如何在 WordPress 正確引入 (Enqueue) CSS/JS

嗨，我是 Moksa 的首席課程導師。在上一堂課中，我們理解了子佈景主題的運作原理。今天，我們將進入一個極為重要的開發實作主題：如何在 WordPress 中「正確地」載入你的 CSS 樣式表與 JavaScript 腳本。

直接在 `header.php` 或 `footer.php` 中寫死 `<link>` 或 `<script>` 標籤，是**非常不專業且錯誤的做法**。這會導致外掛衝突、版本管理困難，以及效能低落等問題。

WordPress 提供了一套標準的「佇列系統」(Enqueue System)，讓我們可以優雅、有系統地管理網站所有的靜態資源 (Assets)。學會這套系統，是你從「網頁組裝工」邁向「WordPress 開發者」的**關鍵第一步**。

---

### 為什麼要使用 Enqueue System？

在我們動手實作前，你必須先理解為什麼我們要這麼做。使用 WordPress 的 Enqueue 系統有以下幾個核心優點：

1.  **依賴性管理 (Dependency Management):** 你可以指定你的腳本依賴於某個其他腳本（例如：你的 `main.js` 需要在 jQuery 載入後才能執行）。WordPress 會自動確保它們的載入順序是正確的。
2.  **避免重複載入:** 如果有兩個外掛都試圖載入同一個版本的 jQuery，WordPress 的系統會足夠聰明，只載入一次，避免資源浪費與潛在衝突。
3.  **版本控制與快取清除:** 你可以為你的 CSS/JS 檔案指定版本號。當你更新檔案時，只要更改版本號，就能強制使用者的瀏覽器下載新檔案，而不是讀取舊的快取。
4.  **擴充性與靈活性:** 其他開發者可以透過 Hook 來移除或修改你載入的腳本，增加了佈景主題與外掛的整合彈性。
5.  **效能優化:** 允許你將 JavaScript 腳本放在頁尾 (footer) 載入，這有助於加快頁面的首次渲染速度 (First Contentful Paint)。

---

### 核心觀念：`wp_enqueue_scripts` Hook

WordPress 透過「掛鉤 (Hook)」系統來執行特定時間點的程式碼。若要在**網站前台**載入 CSS 或 JS，我們最主要會用到的 Hook 是 `wp_enqueue_scripts`。

我們的標準做法是：
1.  建立一個自訂的 PHP 函式 (Function)。
2.  在這個函式內部，使用 WordPress 提供的 `wp_enqueue_style()` 和 `wp_enqueue_script()` 函式來註冊我們的檔案。
3.  最後，將這個自訂函式掛到 `wp_enqueue_scripts` 這個動作 (Action) 上。

聽起來有點抽象？別擔心，我們馬上來實作。

---

### (實作) 引入 CSS 樣式表

#### 步驟 1: 建立你的 CSS 檔案

首先，在你的子佈景主題資料夾中，建立一個 `assets` 資料夾，並在其中再建立一個 `css` 資料夾。然後，新增一個名為 `style.css` 的檔案。

你的路徑看起來應該像這樣： `/wp-content/themes/your-child-theme/assets/css/style.css`

為了方便測試，在 `style.css` 檔案中加入以下程式碼：

```css
/* My Custom Stylesheet */
body {
    border-top: 5px solid #FF5733; /* 在網站頂部加上一個橘色的框線 */
}
```

#### 步驟 2: 在 `functions.php` 中加入 Enqueue 程式碼

打開你子佈景主題的 `functions.php` 檔案，加入以下 PHP 程式碼：

```php
<?php
/**
 * Moksa Child Theme Functions
 */

function moksa_enqueue_assets() {
    /**
     * 註冊並載入 CSS 樣式表
     *
     * wp_enqueue_style( $handle, $src, $deps, $ver, $media );
     * $handle: (字串) (必填) 樣式的唯一識別名稱，例如 'moksa-main-style'。
     * $src:    (字串) (必填) CSS 檔案的 URL 路徑。
     * $deps:   (陣列) (選填) 此樣式依賴的其他樣式 handle 陣列。
     * $ver:    (字串/布林) (選填) 樣式的版本號，用於快取清除。
     * $media:  (字串) (選填) 指定媒體類型，例如 'all', 'screen', 'print'。
     */
    wp_enqueue_style(
        'moksa-main-style', // 1. 給它一個獨一無二的名稱 (Handle)
        get_stylesheet_directory_uri() . '/assets/css/style.css', // 2. 檔案的正確路徑
        array(), // 3. 這個 CSS 不依賴任何其他 CSS
        '1.0.0', // 4. 版本號
        'all' // 5. 適用於所有設備
    );
}

// 將我們的函式掛載到 'wp_enqueue_scripts' 這個 Hook 上
add_action( 'wp_enqueue_scripts', 'moksa_enqueue_assets' );
```

**Moksa 技巧：**
*   `get_stylesheet_directory_uri()`: 這個函式會**自動取得當前啟用「子佈景主題」的資料夾網址**。如果你是開發主佈景主題，則會用 `get_template_directory_uri()`。使用這個函式可以確保無論你的 WordPress 安裝在哪個網域，路徑永遠是正確的。**這是一個非常重要的專業習慣**。

#### 步驟 3: 驗證結果

儲存 `functions.php` 後，回到你的網站前台並重新整理。你應該會看到頁面最上方出現了一條 5px 寬的橘色線條。

``

你也可以在瀏覽器中「檢視原始碼」，然後搜尋 `moksa-main-style`，你會找到類似下面這行 HTML，它被 WordPress 自動加到 `<head>` 區塊裡了：

```html
<link rel='stylesheet' id='moksa-main-style-css' href='https://your-domain.com/wp-content/themes/your-child-theme/assets/css/style.css?ver=1.0.0' media='all' />
```
你看，WordPress 自動幫我們產生了完整的 `<link>` 標籤，並加上了版本號！

---

### (實作) 引入 JavaScript 腳本

引入 JS 的流程幾乎一模一樣，只是函式名稱不同。

#### 步驟 1: 建立你的 JS 檔案

在 `/assets/` 資料夾中，建立一個 `js` 資料夾，並新增一個 `main.js` 檔案。

路徑： `/wp-content/themes/your-child-theme/assets/js/main.js`

在 `main.js` 中加入以下程式碼：

```javascript
// My Custom JavaScript
console.log('Moksa JS Loaded!');

// 使用 jQuery (因為我們會將它設定為依賴項目)
jQuery(document).ready(function($) {
    console.log('jQuery is ready and working!');
    $('body').on('click', function() {
        console.log('Body clicked!');
    });
});
```

#### 步驟 2: 在 `functions.php` 中加入 Enqueue 程式碼

我們回到 `functions.php`，在剛剛的 `moksa_enqueue_assets` 函式中，繼續加入 `wp_enqueue_script` 的部分。

```php
<?php
/**
 * Moksa Child Theme Functions
 */

function moksa_enqueue_assets() {
    // ... (剛剛的 wp_enqueue_style 程式碼保留) ...
    wp_enqueue_style(
        'moksa-main-style',
        get_stylesheet_directory_uri() . '/assets/css/style.css',
        array(),
        '1.0.0',
        'all'
    );


    /**
     * 註冊並載入 JavaScript 腳本
     *
     * wp_enqueue_script( $handle, $src, $deps, $ver, $in_footer );
     * $handle:    (字串) (必填) 腳本的唯一識別名稱。
     * $src:       (字串) (必填) JS 檔案的 URL 路徑。
     * $deps:      (陣列) (選填) 此腳本依賴的其他腳本 handle 陣列。
     * $ver:       (字串/布林) (選填) 腳本的版本號。
     * $in_footer: (布林) (選填) 是否在頁尾 </body> 前載入，預設是 false (在 <head>)。
     */
    wp_enqueue_script(
        'moksa-main-script', // 1. 獨一無二的名稱 (Handle)
        get_stylesheet_directory_uri() . '/assets/js/main.js', // 2. 檔案路徑
        array('jquery'), // 3. **重要！**指定此腳本依賴於 WordPress 內建的 jQuery
        '1.0.0', // 4. 版本號
        true // 5. **Moksa 技巧：**設定為 true，將腳本放在頁尾載入，提升效能
    );
}

// 將我們的函式掛載到 'wp_enqueue_scripts' 這個 Hook 上
add_action( 'wp_enqueue_scripts', 'moksa_enqueue_assets' );
```

**Moksa 技巧：**
*   **依賴 jQuery:** WordPress 內建了許多常用的 JS 函式庫，例如 jQuery。它的 handle 就叫做 `jquery`。在 `$deps` 參數中填入 `array('jquery')`，可以確保 WordPress 一定會先載入 jQuery，再載入我們的 `main.js`，這樣我們的 JS 程式碼中才能安全地使用 `jQuery` 或 `$` 符號。
*   **在頁尾載入 (`$in_footer` = `true`):** 將 JS 放在頁尾載入是一個重要的**網站效能優化技巧**。這能讓瀏覽器優先渲染頁面的 HTML/CSS 內容，讓使用者更快看到畫面，而不會被載入 JS 的過程卡住。除非你的 JS 必須在頁面渲染前就執行，否則**強烈建議永遠設定為 `true`**。

#### 步驟 3: 驗證結果

儲存檔案後，回到網站前台，打開瀏覽器的「開發者工具 (Developer Tools)」並切換到「主控台 (Console)」分頁。

``

重新整理頁面，你應該會看到我們寫的兩行 `console.log`訊息被印出來了。接著，在頁面的任何地方點擊一下，你還會看到 `Body clicked!` 的訊息。這證明我們的 JS 不僅成功載入，而且依賴的 jQuery 也正常運作。

同時，檢視原始碼，你會發現 `<script>` 標籤被正確地放在 `</body>` 標籤之前。

---

### Moksa 技巧與進階應用

#### 技巧 1: 自動化版本號 (快取清除)

每次修改 CSS/JS 後都要手動改版本號很麻煩。在開發階段，我們可以用 `filemtime()` 函式來自動化這件事。它會讀取檔案的「最後修改時間」作為版本號。

```php
// ... 在你的函式中 ...
wp_enqueue_style(
    'moksa-main-style',
    get_stylesheet_directory_uri() . '/assets/css/style.css',
    array(),
    filemtime( get_stylesheet_directory() . '/assets/css/style.css' ), // 自動版本號
    'all'
);

wp_enqueue_script(
    'moksa-main-script',
    get_stylesheet_directory_uri() . '/assets/js/main.js',
    array('jquery'),
    filemtime( get_stylesheet_directory() . '/assets/js/main.js' ), // 自動版本號
    true
);
```
**注意：** `filemtime()` 需要的是**伺服器上的實體路徑**，所以我們要用 `get_stylesheet_directory()` (沒有 `_uri`)。這樣每次你儲存檔案，版本號都會自動更新，完美解決開發時的快取問題。但在正式上線的網站，建議還是使用固定的語意化版本號 (如 `1.0.1`, `1.1.0`)。

#### 技巧 2: 從 PHP 傳遞資料到 JavaScript (`wp_localize_script`)

有時候，我們需要在 JS 中使用一些 PHP 才能取得的資料，例如網站的 AJAX URL、使用者的登入狀態、多國語言翻譯字串等。這時，`wp_localize_script` 就是你的好朋友。

它可以在頁面上輸出一小段 JavaScript 物件，讓你的 JS 檔案可以讀取。

**PHP (`functions.php`):**
```php
// ... 在 wp_enqueue_script('moksa-main-script', ...) 之後 ...

// 準備要傳遞的資料陣列
$php_data_for_js = array(
    'ajax_url' => admin_url( 'admin-ajax.php' ),
    'nonce'    => wp_create_nonce( 'moksa_ajax_nonce' ),
    'site_title' => get_bloginfo('name')
);

// 將資料 '附加' 到我們的 moksa-main-script 上
wp_localize_script(
    'moksa-main-script', // **目標 handle：**要附加到哪個 script 上
    'moksa_ajax_object', // **物件名稱：**在 JS 中要用什麼名稱來存取這些資料
    $php_data_for_js // **資料來源：**我們的 PHP 陣列
);
```

**JavaScript (`main.js`):**
現在，你可以在 `main.js` 中直接使用 `moksa_ajax_object` 這個全域物件了。
```javascript
// My Custom JavaScript
// ...

console.log('Site title from PHP is: ' + moksa_ajax_object.site_title);
console.log('The AJAX URL is: ' + moksa_ajax_object.ajax_url);
```
這是一個極其強大且安全的資料傳遞方式，是開發 AJAX 功能或與 WordPress 後端互動時的**必備技能**。

---

### 總結

今天我們學會了 WordPress 開發中最基礎也最重要的技能之一：如何使用 Enqueue System 來載入 CSS 和 JS。

請記住以下重點：
*   **永遠**使用 `add_action('wp_enqueue_scripts', 'your_function_name')` 的模式。
*   使用 `wp_enqueue_style()` 載入 CSS，`wp_enqueue_script()` 載入 JS。
*   善用 `$deps` 參數管理依賴性，特別是 `jquery`。
*   為了效能，**永遠**將 JS 放在頁尾載入 (`$in_footer = true`)。
*   使用 `get_stylesheet_directory_uri()` 來確保路徑永遠正確。
*   學習使用 `filemtime()` 和 `wp_localize_script` 等進階技巧，讓你的開發更專業、更有效率。

掌握了這個技巧，你就能確保你的程式碼乾淨、高效，並且能與 WordPress 生態系中的數萬個外掛和平共處。在接下來的課程中，我們將不斷地運用今天所學的知識。