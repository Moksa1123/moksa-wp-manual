# 12.02 (實務) 自動化測試 (PHPUnit)

嗨，歡迎來到 MoksaWP 開發課程的進階章節。我是你在 Moksa 的課程導師。

在前面的章節中，我們學會了如何撰寫高品質、可維護的 PHP 程式碼。但我們要如何確保在未來新增功能或重構程式碼時，不會意外地弄壞現有的功能呢？答案就是「**自動化測試**」。

本章節，我們將深入探討如何為你的 WordPress 外掛或佈景主題導入 PHPUnit 這個業界標準的測試框架，建立起一道堅實的品質防線。這項技能不僅能大幅提升你專案的穩定性，更是頂尖 WordPress 開發者與普通開發者之間的重要分水嶺。

---

### 為什麼需要自動化測試？

在開始實作之前，讓我們先理解為什麼要花時間寫測試：

1.  **確保程式碼品質**：測試能驗證你的程式碼是否如預期般運作。
2.  **減少迴歸錯誤 (Regression Bug)**：當你修改或新增功能時，可以快速執行所有測試，確保舊有的功能沒有被意外破壞。
3.  **提升重構信心**：有了完整的測試覆蓋，你可以大膽地重構和優化程式碼，而不用擔心會產生新的錯誤。
4.  **清晰的文件**：測試案例本身就是一種「可執行的文件」，它清楚地說明了某個函式或類別應該如何被使用。
5.  **節省手動測試時間**：相較於每次修改後都要手動點擊網站介面來檢查功能，自動化測試可以在幾秒鐘內完成數百個驗證。

在 WordPress 的世界裡，最普及的測試框架就是 **PHPUnit**。WordPress 核心本身也使用 PHPUnit 進行大量的自動化測試。接下來，我們就來學習如何將這套強大的工具整合到我們的外掛開發流程中。

### 環境準備與設定

我們將使用官方推薦的工具 `wp-cli` 來快速建立測試環境。這個過程會自動下載一個獨立的 WordPress、測試資料庫以及 WordPress 核心測試套件。

**先決條件：**

*   你已經透過 LocalWP 建立了一個本地開發站點。
*   你已經在 VS Code 中開啟了你的外掛專案資料夾。
*   你已經開啟了終端機 (Terminal) 或 VS Code 內建的終端機，並且路徑切換到你的**外掛根目錄**。

---

#### 步驟 1：使用 Composer 安裝 PHPUnit

雖然 WordPress 測試套件會包含 PHPUnit，但現代化的開發流程建議使用 Composer 來管理專案的開發依賴。這能確保你的團隊成員都使用相同版本的測試工具。

如果你的外掛還沒有 `composer.json` 檔案，請先執行初始化指令：

```bash
composer init
```
接下來，安裝 PHPUnit 作為開發依賴項 (dev dependency)：

```bash
composer require --dev phpunit/phpunit
```

安裝完成後，你的外掛目錄下會多出 `vendor` 資料夾、`composer.json` 與 `composer.lock` 檔案。

**Moksa 技巧**：請務必將 `vendor/` 目錄加入到你的 `.gitignore` 檔案中，我們不應該把依賴套件的原始碼納入版本控制。

---

#### 步驟 2：使用 WP-CLI 建立測試鷹架 (Scaffold)

WP-CLI 是 WordPress 開發者的瑞士刀，它提供了一個強大的指令來一鍵生成測試所需的檔案。

在你的**外掛根目錄**下，執行以下指令 (請將 `<plugin-slug>` 替換成你的外掛名稱，例如 `my-awesome-plugin`)：

```bash
wp scaffold plugin-tests <plugin-slug>
```

執行後，你會看到類似以下的輸出，並且你的專案中會多出幾個新檔案和資料夾：

```
Success: Created test files.
```

``

這些新建立的檔案包含：

*   `.travis.yml`: Travis CI 的設定檔，用於持續整合 (CI)。
*   `bin/install-wp-tests.sh`: 用來安裝 WordPress 測試環境的腳本。
*   `phpunit.xml.dist`: PHPUnit 的主要設定檔。
*   `tests/`: 存放所有測試案例的資料夾。
*   `tests/bootstrap.php`: 測試環境的啟動檔案。
*   `tests/test-sample.php`: 一個範例測試檔案。

---

#### 步驟 3：安裝 WordPress 測試環境

現在，我們需要執行剛剛產生的 `install-wp-tests.sh` 腳本。這個腳本會在本機建立一個專門用來跑測試的資料庫和 WordPress 環境。

首先，你需要從 LocalWP 取得資料庫的連線資訊。

1.  開啟 LocalWP。
2.  點擊你的站點，進入 "Database" 分頁。
3.  你會看到 Host, Port, Database Name, Username, Password。

``

接著，在終端機中執行安裝腳本。

```bash
# 語法: bash bin/install-wp-tests.sh <db_name> <db_user> <db_pass> [db_host] [wp_version]
# 範例 (使用 LocalWP 的預設資訊):
bash bin/install-wp-tests.sh moksa_test_db root root localhost:10014
```

*   **<db_name>**: 測試用的資料庫名稱，請**務必**使用一個新的、不存在的名稱，例如 `moksa_test_db`，腳本會自動建立它。**絕對不要**使用你正在開發中的資料庫，否則資料會被清空！
*   **<db_user>**: 資料庫使用者，在 LocalWP 中通常是 `root`。
*   **<db_pass>**: 資料庫密碼，在 LocalWP 中通常是 `root`。
*   **[db_host]**: 資料庫主機和 Port，在 LocalWP 中，你需要填寫 `localhost:PORT_NUMBER` 的格式。
*   **[wp_version]**: (可選) 指定要測試的 WordPress 版本，預設為最新版。

腳本執行成功後，你應該會看到類似以下的訊息，代表 WordPress 測試核心和資料庫都已經準備就緒。

``

### 撰寫你的第一個單元測試

環境設定好了，現在讓我們來寫一個真正的測試案例。

假設我們的外掛中有一個簡單的函式，用於計算商品的含稅價格。

#### 步驟 1：建立一個被測試的函式

在你的外掛主檔案 (`my-awesome-plugin.php`) 或其他載入的檔案中，加入以下函式：

```php
<?php
/**
 * Calculate the price with tax included.
 *
 * @param float $price The original price.
 * @param float $tax_rate The tax rate (e.g., 0.05 for 5%).
 * @return float The price with tax.
 */
function moksa_get_price_with_tax( $price, $tax_rate = 0.05 ) {
    if ( ! is_numeric( $price ) || $price < 0 ) {
        return 0;
    }
    return $price * ( 1 + $tax_rate );
}
```

這個函式很簡單，但包含了幾個邏輯：正常計算、處理非數字輸入、處理負數價格。這些都是單元測試的絕佳目標。

#### 步驟 2：建立測試檔案與類別

`wp-cli` 已經為我們建立了一個範例檔案 `tests/test-sample.php`。我們可以刪除它，或者重新命名。讓我們建立一個新的檔案，專門用來測試我們的價格計算功能。

建立檔案：`tests/test-price-calculator.php`

檔案內容結構如下：

```php
<?php
class Test_Price_Calculator extends WP_UnitTestCase {
    // 測試案例會寫在這裡
}
```

*   **命名慣例**：測試類別的名稱通常是 `Test_` 加上你要測試的物件或功能名稱。
*   **繼承 `WP_UnitTestCase`**：這是關鍵！繼承 `WP_UnitTestCase` 讓我們可以使用 WordPress 提供的各種測試工具函式，例如操作資料庫、模擬登入使用者等。

#### 步驟 3：撰寫測試案例 (Test Case)

在 `Test_Price_Calculator` 類別中，我們來為 `moksa_get_price_with_tax` 函式撰寫幾個測試案例。每一個公開 (public) 且名稱以 `test_` 開頭的方法，都會被 PHPUnit 視為一個獨立的測試案例。

```php
<?php
/**
 * Class Test_Price_Calculator
 *
 * @package My_Awesome_Plugin
 */

class Test_Price_Calculator extends WP_UnitTestCase {

	/**
	 * 測試正常價格與稅率的計算
	 */
	public function test_calculates_price_with_tax_correctly() {
		// 準備：定義輸入值
		$base_price = 100;
		$tax_rate = 0.05;

		// 執行：呼叫我們要測試的函式
		$final_price = moksa_get_price_with_tax( $base_price, $tax_rate );

		// 斷言：驗證結果是否符合預期
		$this->assertEquals( 105, $final_price );
	}

	/**
	 * 測試當輸入為負數時，應回傳 0
	 */
	public function test_returns_zero_for_negative_price() {
		$this->assertEquals( 0, moksa_get_price_with_tax( -50 ) );
	}

	/**
	 * 測試當輸入非數字時，應回傳 0
	 */
	public function test_returns_zero_for_non_numeric_price() {
		$this->assertEquals( 0, moksa_get_price_with_tax( 'not-a-number' ) );
	}
}
```

**Moksa 技巧：認識 AAA 測試模式與斷言 (Assertion)**

*   **Arrange (準備)**：設定測試前的環境與變數。
*   **Act (執行)**：呼叫你想要測試的程式碼。
*   **Assert (斷言)**：驗證執行的結果是否跟你預期的一樣。`$this->assertEquals( $expected, $actual )` 就是一個**斷言**，它會判斷 `$expected` (預期結果) 和 `$actual` (實際結果) 是否相等。如果不想等，測試就會失敗。PHPUnit 提供了非常多種斷言方法，例如 `assertTrue()`, `assertCount()`, `assertArrayHasKey()` 等。

### 執行測試與解讀結果

萬事俱備，只欠東風！讓我們來執行測試。

#### 步驟 1：開啟終端機並執行 PHPUnit

回到你的終端機，確認路徑依然是在**外掛根目錄**。執行以下指令：

```bash
./vendor/bin/phpunit
```

#### 步驟 2：解讀測試結果

**成功的結果**

如果你的所有測試都通過了，你會看到綠色的成功訊息，告訴你執行了多少個測試和多少個斷言。

``
```
PHPUnit 9.5.10 by Sebastian Bergmann and contributors.

...                                                                 3 / 3 (100%)

Time: 00:00.123, Memory: 26.00 MB

OK (3 tests, 3 assertions)
```

**失敗的結果**

現在，讓我們故意弄壞一個測試。把 `test_calculates_price_with_tax_correctly` 中的預期結果 `105` 改成 `106`，然後再執行一次 `./vendor/bin/phpunit`。

你會看到紅色的失敗訊息。

``
```
PHPUnit 9.5.10 by Sebastian Bergmann and contributors.

F..                                                                 3 / 3 (100%)

Time: 00:00.456, Memory: 26.00 MB

There was 1 failure:

1) Test_Price_Calculator::test_calculates_price_with_tax_correctly
Failed asserting that 105.0 matches expected 106.

/path/to/your/plugin/tests/test-price-calculator.php:19

FAILURES!
Tests: 3, Assertions: 3, Failures: 1.
```

這個報告非常清楚地告訴你：
1.  哪一個測試案例失敗了 (`Test_Price_Calculator::test_calculates_price_with_tax_correctly`)。
2.  失敗的原因 (`Failed asserting that 105.0 matches expected 106`)。
3.  失敗發生在哪個檔案的第幾行 (`test-price-calculator.php:19`)。

這就是自動化測試的威力！你可以立刻定位問題、修復它，然後重新執行測試，直到看到綠色的成功訊息為止。

### 總結與下一步

恭喜你！你已經成功地為你的 WordPress 外掛設定了 PHPUnit 測試環境，並撰寫及執行了你的第一個單元測試。

在這個章節中，我們學到了：

*   自動化測試對於維護專案品質的重要性。
*   如何使用 `wp-cli` 和 `Composer` 快速建立 WordPress 測試環境。
*   遵循 **AAA (Arrange-Act-Assert)** 模式撰寫清晰的測試案例。
*   如何執行測試並解讀成功與失敗的結果。

這只是自動化測試的開始。在接下來的開發工作中，請養成習慣，為每一個你撰寫的新功能都補上對應的測試案例。這會讓你的專案更加健壯、可靠，也讓你成為一名更專業的 WordPress 開發者。

接下來你可以繼續探索更進階的測試主題，例如：

*   **整合測試 (Integration Tests)**：測試與 WordPress 資料庫、API 互動的程式碼。
*   **模擬物件 (Mocking Objects)**：隔離外部依賴，讓測試更單純、更快速。
*   **測試覆蓋率 (Code Coverage)**：分析你的測試涵蓋了多少百分比的程式碼。
*   **持續整合 (Continuous Integration)**：設定如 GitHub Actions 的服務，在每次推送到 Git 儲存庫時自動執行所有測試。