# 12.01 (實務) WP Multisite (多站點) 網路

嗨，歡迎來到 MoksaWP 的進階開發課程！我是你的導師。

在之前的章節中，我們所有的操作都是基於一個「單一」的 WordPress 網站。然而，在某些特定的商業情境下，你可能需要用一套核心程式碼來管理數十個、甚至數百個功能相似但內容各自獨立的網站。這就是 **WordPress Multisite (多站點) 網路** 發揮作用的地方。

本章節將帶你深入了解 Multisite 的核心概念、使用時機，並一步步完成啟用與管理的實務操作。對於一個 WordPress 開發者來說，掌握 Multisite 是區分專業與否的重要里程碑。

---

## 什麼是 WordPress Multisite？

**WordPress Multisite** 不是一個外掛，而是 WordPress 核心內建的一項進階功能。啟用後，它能讓你用「**同一套 WordPress 核心檔案、同一套外掛、同一套佈景主題**」來建立並管理一個由多個獨立網站組成的「**網路 (Network)**」。

想像一下，你不再需要為每個客戶或每個部門安裝一次 WordPress，而是建立一個「母體」，然後從中快速「複製」出許多子網站。

**Moksa 技巧：** 這與你管理多個獨立的 WordPress 網站有本質上的不同。在 Multisite 中，所有網站**共享同一個資料庫** (但有獨立的資料表) 和**同一個使用者資料庫**。這意味著一個使用者帳號可以在整個網路中的多個網站中擁有不同的權限。

``
*（示意圖：單一網站架構 vs. Multisite 網路架構的對比圖）*

---

## 使用時機 (Use Cases)

雖然 Multisite 功能強大，但並非所有情況都適用。以下是一些非常適合使用 Multisite 的商業情境：

1.  **企業內部網路：** 一家大公司可以為每個部門（如：行銷部、人資部、技術部）建立一個獨立的子網站，由總部的「超級管理員」統一管理。
2.  **學術機構：** 大學可以為每個系所、每個教授的研究室建立專屬網站，方便管理。
3.  **多語言網站：** 雖然有專門的多語言外掛，但有些開發者偏好使用 Multisite，為每種語言建立一個子網站 (e.g., `example.com/en/`, `example.com/jp/`)，實現內容的完全分離。
4.  **平台即服務 (PaaS)：** 類似於 `WordPress.com` 或 `Wix.com` 的服務，讓使用者註冊後就能立即擁有一個自己的部落格或網站。
5.  **連鎖加盟店：** 總部建立一個網路，為每個加盟分店開設一個子網站，統一品牌形象，但各分店可獨立發布各自的促銷活動。

## 不適合使用 Multisite 的情境

在決定使用前，務必了解其限制：

*   **網站差異性太大：** 如果每個網站都需要截然不同的外掛、佈景主題和客製化功能，那麼獨立安裝會是更好的選擇。
*   **客戶需要完全控制權：** 在 Multisite 中，只有「超級管理員」能安裝外掛和佈景主題。子網站管理員無法自行安裝，這可能會限制客戶的自由度。
*   **資料庫隔離要求：** 如果每個網站的資料需要物理上完全隔離（例如出於法規或資安考量），則不應使用共享資料庫的 Multisite。
*   **主機效能限制：** 一個網路中的所有網站共享主機資源。如果其中一個子網站流量暴增或被攻擊，可能會影響到整個網路的穩定性。

---

## 啟用 Multisite 的標準流程 (SOP)

接下來，我們將進入本章節的核心——實作。我們將使用 **LocalWP** 這個開發環境來建立一個全新的 Multisite 網路。

**重要前提：**
*   只能在「**全新**」的 WordPress 網站上啟用 Multisite。雖然技術上可以在現有網站上啟用，但過程複雜且風險高，不建議初學者嘗試。
*   在開始前，請確保你已停用所有外掛。

### 步驟 1：允許 Multisite 安裝

首先，我們需要告訴 WordPress：「我準備要啟用 Multisite 功能了」。

1.  打開你的 WordPress 網站根目錄。
2.  找到並用 VS Code 等編輯器打開 `wp-config.php` 檔案。
3.  在 `/* That's all, stop editing! Happy publishing. */` 這行註解的**上方**，加入以下程式碼：

    ```php
    /* Multisite */
    define( 'WP_ALLOW_MULTISITE', true );
    ```
4.  儲存並關閉 `wp-config.php` 檔案。

### 步驟 2：網路設定

完成上一步後，重新整理你的 WordPress 後台。

1.  前往「**工具 (Tools)**」 > 「**網路設定 (Network Setup)**」。
``
*（示意圖：WordPress 後台的「工具」選單中出現了「網路設定」選項）*

2.  在這個頁面，你需要做一個**至關重要的決定**：子網站的網址結構。
    *   **子目錄 (Sub-directories):** 子網站的網址會像 `your-domain.com/site1`、`your-domain.com/site2`。
        *   **優點：** 設定簡單，不需要額外的主機設定。
        *   **適用情境：** 內部網路、功能區分。
    *   **子網域 (Sub-domains):** 子網站的網址會像 `site1.your-domain.com`、`site2.your-domain.com`。
        *   **優點：** 網站獨立性更強，看起來更專業。
        *   **缺點：** 需要主機支援**萬用字元 DNS (Wildcard DNS)** 設定。
        *   **Moksa 技巧：** 在 **LocalWP** 環境中，它會自動處理 `*.local` 的萬用字元設定，所以你可以放心選擇子網域進行測試。

3.  選擇你想要的結構。在本教學中，我們選擇較為普遍的「**子目錄**」。
4.  填寫「**網路標題**」和「**網路管理員電子郵件**」。
5.  點擊「**安裝 (Install)**」。

### 步驟 3：修改核心設定檔

安裝後，WordPress 會產生兩段非常重要的程式碼。你**必須**按照指示，將它們分別複製到 `wp-config.php` 和 `.htaccess` 檔案中。

``
*（示意圖：WordPress 顯示兩段程式碼，分別給 wp-config.php 和 .htaccess）*

1.  **修改 `wp-config.php`：**
    複製第一段程式碼，再次打開 `wp-config.php`，將其貼在 `/* That's all, stop editing! Happy publishing. */` 的**上方**。它看起來會像這樣：

    ```php
    define('MULTISITE', true);
    define('SUBDOMAIN_INSTALL', false); // 如果你選子網域，這裡會是 true
    define('DOMAIN_CURRENT_SITE', 'your-local-site.local');
    define('PATH_CURRENT_SITE', '/');
    define('SITE_ID_CURRENT_SITE', 1);
    define('BLOG_ID_CURRENT_SITE', 1);
    ```

2.  **修改 `.htaccess`：**
    複製第二段程式碼。在你的網站根目錄下找到 `.htaccess` 檔案（如果找不到，請確認你的檔案管理器顯示了隱藏檔案）。用你現有的 WordPress 規則**完全取代**它。新的規則看起來會像這樣：

    ```apache
    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]

    # add a trailing slash to /wp-admin
    RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]

    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $2 [L]
    RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ $2 [L]
    RewriteRule . index.php [L]
    ```

### 步驟 4：重新登入並驗證

完成上述修改後，儲存檔案。你需要**重新登入** WordPress 後台。

登入後，你會發現頂部的管理列多了一個「**我的網站 (My Sites)**」選單。這代表你的 Multisite 網路已經成功啟用了！恭喜你！

``
*（示意圖：WordPress 後台頂部管理列出現了「我的網站」和「網路管理員」選單）*

---

## 開發者視角的 Multisite (Moksa 技巧)

對於開發者而言，僅僅會啟用是不夠的。你需要了解如何在 Multisite 環境下高效工作。

### 1. 使用 WP-CLI 管理網路

**WP-CLI** 是管理 Multisite 的神器。當你需要一次建立或管理大量網站時，命令列遠比圖形介面高效。

*   **列出所有網站：**
    ```bash
    wp site list
    ```
*   **建立一個新網站：**
    ```bash
    # 格式: wp site create --slug=<slug> --title=<title> --email=<email>
    wp site create --slug=marketing --title="行銷部門" --email=marketing@example.com
    ```
*   **刪除一個網站：**
    ```bash
    # 需要先取得 site ID，可從 wp site list 看到
    wp site delete 2 --yes
    ```
*   **在整個網路上啟用佈景主題：**
    ```bash
    wp theme enable kadence --network
    ```

### 2. Multisite 專用的函式

在開發外掛或佈景主題時，你可能會需要與網路中的其他網站互動。WordPress 提供了一組非常有用的函式。

*   `get_current_blog_id()`: 取得當前所在網站的 ID。
*   `switch_to_blog( $blog_id )`: **這是最重要的函式。** 它能將程式的執行環境「切換」到指定的子網站。切換後，所有標準的 WordPress 函式 (如 `get_posts`, `get_option`) 都會從目標網站讀取資料。
*   `restore_current_blog()`: 將執行環境切換回原始的網站。**請務必記得使用它**，與 `switch_to_blog()` 成對出現，避免造成資料錯亂。

**實務範例：** 在主網站上，顯示「行銷部門」網站 (假設 ID 為 2) 的最新三篇文章。

```php
<?php
// 假設我們目前在主網站 (ID: 1)
$marketing_blog_id = 2;

// 切換到行銷部門的網站
switch_to_blog( $marketing_blog_id );

// 現在，所有 WP 函式都會從 ID 為 2 的網站撈資料
$args = array(
    'post_type' => 'post',
    'posts_per_page' => 3,
);
$marketing_posts = new WP_Query( $args );

if ( $marketing_posts->have_posts() ) {
    echo '<h3>來自「行銷部門」的最新消息</h3>';
    echo '<ul>';
    while ( $marketing_posts->have_posts() ) {
        $marketing_posts->the_post();
        echo '<li><a href="' . get_permalink() . '">' . get_the_title() . '</a></li>';
    }
    echo '</ul>';
    wp_reset_postdata();
}

// **非常重要！** 將執行環境切換回原來的網站
restore_current_blog();

// 在此之後的程式碼，又會從主網站 (ID: 1) 撈資料
?>
```

### 3. 資料庫結構的變化

作為開發者，了解資料庫的變化至關重要。啟用 Multisite 後：

*   會新增幾個全域資料表，如 `wp_blogs`, `wp_sitemeta`, `wp_users`, `wp_usermeta` 等，用來儲存網路和使用者資訊。
*   當你建立一個新的子網站（例如 ID 為 2），WordPress 會為該網站複製一整套與內容相關的資料表，並加上前綴，例如 `wp_2_posts`, `wp_2_options`, `wp_2_postmeta` 等。

``
*（示意圖：資料庫管理工具中顯示了 wp_posts, wp_2_posts, wp_3_posts 等資料表）*

了解這個結構，能幫助你在進行複雜查詢或資料遷移時，準確地找到目標資料。

## 總結

在本章節中，我們從概念到實作，完整地走過了一遍 WordPress Multisite 的建置流程。你學習了它的適用情境、標準安裝步驟，以及最重要的——從開發者的角度如何利用 WP-CLI 和專用函式來高效地管理和客製化你的網站網路。

Multisite 是一把雙面刃，用得好，它能極大地提升你的管理效率；但若規劃不當，也可能帶來維護上的挑戰。請務必在充分理解其運作原理後，再將其應用於正式的專案中。

在下一個章節，我們將探討如何開發一個「Multisite-aware」的外掛，讓你的作品能在多站點環境下完美運作。