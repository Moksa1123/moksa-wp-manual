# 07.03 (實作) (客製化金流) 串接「藍新 Pay」

嗨，歡迎來到 MoksaWP 的進階開發課程！

在之前的課程中，我們主要使用 Moksa 技術棧推薦的「綠界 ECPay」金流外掛，它能滿足絕大多數電商網站的需求。然而，作為一位專業的 WordPress 開發者，你總會遇到客戶指定使用特定金流服務的狀況。「藍新 NewebPay」就是台灣另一個非常主流的金流服務商。

這堂課的目標，就是要帶你從零開始，學習如何遵循 WooCommerce 的官方規範，親手打造一個串接「藍新 Pay」的客製化金流外掛。這不僅僅是完成一個功能，更是深入理解 WooCommerce 運作核心的絕佳機會。

**學習目標：**

*   理解 WooCommerce Payment Gateway API 的基本架構。
*   學會如何建立一個獨立的金流外掛，並讓 WooCommerce 能夠識別。
*   掌握藍新 Pay (MPG) API 的串接流程，包含「送出訂單」與「接收付款回呼 (Callback)」。
*   學會如何處理 API 所需的加密與驗證機制 (AES 加密與 SHA256 雜湊)。
*   了解如何進行金流串接的測試與偵錯。

**前置準備：**

1.  **藍新測試商店帳號：** 請先至 [藍新金流服務平台](https://www.newebpay.com/) 申請一個測試用的商店帳號。申請成功後，你將會取得三組最重要的資訊：
    *   **商店代號 (MerchantID)**
    *   **雜湊金鑰 (HashKey)**
    *   **雜湊 IV (HashIV)**
2.  **開發環境：** 確認你的 LocalWP 環境已經準備就緒，並安裝好 WooCommerce。
3.  **基礎知識：** 這是一堂進階課程，我們假設你已經具備 PHP 基礎、了解 WordPress 的 Action/Filter Hooks，以及對物件導向程式設計 (OOP) 有基本概念。

---

## 步驟 1：建立你的金流外掛基本架構

首先，我們需要建立一個 WordPress 能辨識的標準外掛檔案結構。

1.  進入你的開發環境，導覽至 `wp-content/plugins/` 資料夾。
2.  建立一個新的資料夾，命名為 `moksa-newebpay-gateway`。
3.  在 `moksa-newebpay-gateway` 資料夾內，建立一個主要的 PHP 檔案，命名為 `moksa-newebpay-gateway.php`。
4.  打開 `moksa-newebpay-gateway.php`，並在檔案最上方貼上 WordPress 外掛的標準標頭資訊：

```php
<?php
/**
 * Plugin Name: Moksa - NewebPay Gateway for WooCommerce
 * Plugin URI: https://moksaweb.com
 * Description: Custom NewebPay (藍新) MPG payment gateway for WooCommerce.
 * Version: 1.0.0
 * Author: Moksa Web
 * Author URI: https://moksaweb.com
 * License: GPLv2 or later
 * License URI: http://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: moksa-newebpay
 * Domain Path: /languages
 * WC requires at least: 5.0
 * WC tested up to: 8.0
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

// 我們的程式碼將會從這裡開始...
```

**Moksa 技巧：** `if ( ! defined( 'ABSPATH' ) )` 是一個重要的**安全措施**，可以防止你的 PHP 檔案被直接透過 URL 存取，確保它只能在 WordPress 的環境下執行。

---

## 步驟 2：建立 WooCommerce 金流閘道類別 (Class)

WooCommerce 的金流是透過「類別 (Class)」來管理的。我們需要建立一個 Class，並讓它繼承 (extends) WooCommerce 內建的 `WC_Payment_Gateway` 基礎類別。

1.  在 `moksa-newebpay-gateway.php` 中，我們需要先檢查 WooCommerce 是否啟用，然後才載入我們的金流類別。

```php
// ... 在外掛標頭下方 ...

add_action( 'plugins_loaded', 'moksa_newebpay_init_gateway_class' );

function moksa_newebpay_init_gateway_class() {

    if ( ! class_exists( 'WC_Payment_Gateway' ) ) {
        return;
    }

    class WC_Gateway_Moksa_NewebPay extends WC_Payment_Gateway {
        // 類別的內容將會寫在這裡
    }
}
```

2.  接下來，我們要實作這個類別的**建構子 (Constructor)** `__construct()`。建構子會在物件被建立時自動執行，我們在這裡定義金流的所有基本設定。

```php
// ... 在 class WC_Gateway_Moksa_NewebPay extends WC_Payment_Gateway { ... } 裡面 ...

public function __construct() {
    $this->id                 = 'moksa_newebpay'; // 金流的唯一 ID
    $this->icon               = apply_filters('woocommerce_newebpay_icon', ''); // 可設定金流圖示
    $this->has_fields         = false; // 結帳頁面是否顯示額外欄位
    $this->method_title       = __( '藍新 NewebPay 金流', 'moksa-newebpay' );
    $this->method_description = __( '透過藍新 NewebPay 進行信用卡、ATM 等多元支付。', 'moksa-newebpay' );

    // 載入後台設定欄位
    $this->init_form_fields();
    $this->init_settings();

    // 從設定中讀取標題與描述
    $this->title        = $this->get_option( 'title' );
    $this->description  = $this->get_option( 'description' );

    // 當管理員儲存設定時，觸發的 action
    add_action( 'woocommerce_update_options_payment_gateways_' . $this->id, array( $this, 'process_admin_options' ) );
    
    // 處理藍新回傳的付款結果
    add_action( 'woocommerce_api_wc_gateway_moksa_newebpay', array( $this, 'handle_newebpay_response' ) );
}
```

**重要觀念：**
*   `$this->id`：**必須是唯一的**，這是 WooCommerce 識別不同金流的方式。
*   `$this->method_title`：顯示在 WooCommerce 金流設定頁面的標題。
*   `$this->title`：顯示在**前端結帳頁面**給顧客看的付款方式名稱。
*   `woocommerce_api_{$this->id}`：這是 WooCommerce 內建用來處理金流回呼 (Callback/Notify) 的標準 Action Hook，非常重要！

---

## 步驟 3：定義後台設定欄位

為了讓商店管理員可以方便地輸入藍新的 MerchantID、HashKey 等資訊，我們需要在 WooCommerce 後台提供設定欄位。

在 `WC_Gateway_Moksa_NewebPay` Class 中加入 `init_form_fields()` 方法 (Method)。

```php
// ... 在 class WC_Gateway_Moksa_NewebPay ... 裡面 ...

public function init_form_fields() {
    $this->form_fields = array(
        'enabled' => array(
            'title'   => __( '啟用/停用', 'moksa-newebpay' ),
            'type'    => 'checkbox',
            'label'   => __( '啟用藍新 NewebPay 金流', 'moksa-newebpay' ),
            'default' => 'no',
        ),
        'title' => array(
            'title'       => __( '標題', 'moksa-newebpay' ),
            'type'        => 'text',
            'description' => __( '這是在結帳頁面，顧客會看到的付款方式標題。', 'moksa-newebpay' ),
            'default'     => __( '藍新 NewebPay (信用卡/ATM)', 'moksa-newebpay' ),
            'desc_tip'    => true,
        ),
        'description' => array(
            'title'       => __( '描述', 'moksa-newebpay' ),
            'type'        => 'textarea',
            'description' => __( '這是在結帳頁面，顧客會看到的付款方式描述。', 'moksa-newebpay' ),
            'default'     => __( '使用藍新金流進行安全付款。', 'moksa-newebpay' ),
        ),
        'merchant_id' => array(
            'title'       => __( '商店代號 (MerchantID)', 'moksa-newebpay' ),
            'type'        => 'text',
            'description' => __( '請輸入你的藍新商店代號。', 'moksa-newebpay' ),
        ),
        'hash_key' => array(
            'title'       => __( 'HashKey', 'moksa-newebpay' ),
            'type'        => 'text',
            'description' => __( '請輸入你的藍新 HashKey。', 'moksa-newebpay' ),
        ),
        'hash_iv' => array(
            'title'       => __( 'HashIV', 'moksa-newebpay' ),
            'type'        => 'text',
            'description' => __( '請輸入你的藍新 HashIV。', 'moksa-newebpay' ),
        ),
        'test_mode' => array(
            'title'   => __( '測試模式', 'moksa-newebpay' ),
            'type'    => 'checkbox',
            'label'   => __( '啟用測試模式', 'moksa-newebpay' ),
            'default' => 'yes',
            'description' => __( '測試模式將會把訂單送到藍新的測試環境，不會產生實際扣款。', 'moksa-newebpay' ),
        ),
    );
}
```

``
*（示意圖：WooCommerce 後台金流設定頁面，顯示上面定義的各個欄位）*

---

## 步驟 4：處理付款請求 (`process_payment`)

這是整個流程最核心的部分。當顧客在結帳頁面點擊「下單購買」時，WooCommerce 會呼叫我們定義的 `process_payment()` 方法。我們的工作就是：
1.  取得訂單資訊。
2.  組合要傳送給藍新的資料。
3.  產生加密過的驗證碼。
4.  將使用者重新導向至藍新付款頁面。

在 `WC_Gateway_Moksa_NewebPay` Class 中加入 `process_payment()` 方法。

```php
// ... 在 class WC_Gateway_Moksa_NewebPay ... 裡面 ...

public function process_payment( $order_id ) {
    global $woocommerce;
    $order = wc_get_order( $order_id );

    // 取得藍新 API 端點 URL
    $api_url = $this->get_option('test_mode') === 'yes' ? 'https://ccore.newebpay.com/MPG/mpg_gateway' : 'https://core.newebpay.com/MPG/mpg_gateway';

    // 組合要送出的資料
    $trade_info_data = [
        'MerchantID' => $this->get_option('merchant_id'),
        'RespondType' => 'JSON',
        'TimeStamp' => time(),
        'Version' => '2.0',
        'MerchantOrderNo' => 'moksa' . $order_id . 'T' . time(), // Moksa 技巧：加上前綴與時間戳，避免重複訂單號
        'Amt' => $order->get_total(),
        'ItemDesc' => 'MoksaWeb 網站商品一批',
        'Email' => $order->get_billing_email(),
        'NotifyURL' => WC()->api_request_url('WC_Gateway_Moksa_NewebPay'), // **非常重要：這是接收付款結果的網址**
        'ReturnURL' => $this->get_return_url( $order ), // 付款成功後，使用者被導回的網址
    ];

    // **Moksa 技巧：產生加密資料 (TradeInfo)**
    // 藍新要求將交易資料先組成字串，再用 AES 加密
    $trade_info_str = http_build_query($trade_info_data);
    $trade_info_encrypted = trim(bin2hex(openssl_encrypt($this->add_padding($trade_info_str), "aes-256-cbc", $this->get_option('hash_key'), OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING, $this->get_option('hash_iv'))));

    // **Moksa 技巧：產生驗證碼 (TradeSha)**
    // 將加密後的 TradeInfo 字串前後加上 HashKey 跟 HashIV 再進行 SHA256 雜湊
    $trade_sha_str = "HashKey=" . $this->get_option('hash_key') . "&" . $trade_info_encrypted . "&HashIV=" . $this->get_option('hash_iv');
    $trade_sha_encrypted = strtoupper(hash("sha256", $trade_sha_str));
    
    // 將訂單狀態更新為 on-hold (等待付款)
    $order->update_status( 'on-hold', __( '等待藍新 NewebPay 付款中。', 'moksa-newebpay' ) );
    
    // 清空購物車
    $woocommerce->cart->empty_cart();

    // 回傳包含重導向 URL 的陣列
    return array(
        'result'   => 'success',
        'redirect' => $api_url . '?MerchantID=' . $this->get_option('merchant_id') . '&TradeInfo=' . $trade_info_encrypted . '&TradeSha=' . $trade_sha_encrypted . '&Version=2.0'
    );
}

// 藍新 AES 加密需要的 Padding 輔助函式
private function add_padding($string, $blocksize = 32) {
    $len = strlen($string);
    $pad = $blocksize - ($len % $blocksize);
    $string .= str_repeat(chr($pad), $pad);
    return $string;
}
```

---

## 步驟 5：處理藍新付款回呼 (`handle_newebpay_response`)

當顧客在藍新頁面完成付款後，藍新會透過我們在步驟 4 設定的 `NotifyURL`，以 `POST` 方式將付款結果傳送回來。我們要做的就是接收、驗證並更新訂單狀態。

在 `WC_Gateway_Moksa_NewebPay` Class 中加入 `handle_newebpay_response()` 方法。

```php
// ... 在 class WC_Gateway_Moksa_NewebPay ... 裡面 ...

public function handle_newebpay_response() {
    // 從 POST 中取得藍新回傳的資料
    $response = $_POST;

    if ( isset($response['Status']) && $response['Status'] === 'SUCCESS' && isset($response['TradeInfo']) ) {
        
        // **Moksa 技巧：解密 TradeInfo 來取得訂單詳細資訊**
        $trade_info_decrypted_str = openssl_decrypt(hex2bin($response['TradeInfo']), "aes-256-cbc", $this->get_option('hash_key'), OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING, $this->get_option('hash_iv'));
        $trade_info = json_decode(rtrim($trade_info_decrypted_str, "\x01..\x1F"), true);

        // 從 MerchantOrderNo 中解析出我們的訂單 ID
        $order_id_parts = explode('T', $trade_info['Result']['MerchantOrderNo']);
        $order_id = str_replace('moksa', '', $order_id_parts[0]);
        
        $order = wc_get_order( $order_id );

        if ( $order ) {
            // 新增訂單備註，記錄交易資訊
            $order->add_order_note(
                '藍新 NewebPay 付款成功！' . PHP_EOL .
                '交易序號: ' . $trade_info['Result']['TradeNo'] . PHP_EOL .
                '支付方式: ' . $trade_info['Result']['PaymentType']
            );

            // **重要：將訂單狀態更新為「處理中」**
            $order->payment_complete();

            // 如果有使用 RY Tools，可以觸發出貨通知
            if ( class_exists('RY_Tools') ) {
                // do_action('ry_tools_send_shipping_notification_on_payment_complete', $order_id);
            }

            // 如果有使用綠界發票，可以觸發開立發票
            if ( class_exists('Ecpay_Invoice') ) {
                // do_action('ecpay_auto_issue_invoice', $order_id);
            }

            // 回應給藍新，告知已收到通知
            echo 'SUCCESS';
            exit;
        }
    }
    
    // 如果驗證失敗或狀態不為 SUCCESS
    wp_die( '藍新 NewebPay 回應錯誤', 'NewebPay Error', array( 'response' => 400 ) );
}
```

---

## 步驟 6：將金流閘道註冊到 WooCommerce

最後一個步驟，就是告訴 WooCommerce：「嘿！我寫好了一個新的金流，請把它加到你的選項裡！」

我們需要在 `moksa-newebpay-gateway.php` 檔案的**最外層（全域範圍）**加入以下程式碼：

```php
// ... 在 function moksa_newebpay_init_gateway_class() { ... } 的外面 ...

add_filter( 'woocommerce_payment_gateways', 'add_moksa_newebpay_gateway' );

function add_moksa_newebpay_gateway( $gateways ) {
    $gateways[] = 'WC_Gateway_Moksa_NewebPay';
    return $gateways;
}
```

---

## 總結與測試

恭喜你！你已經完成了客製化串接藍新 Pay 金流的所有核心程式碼。

**完整的 `moksa-newebpay-gateway.php` 檔案應該包含：**
1.  外掛標頭。
2.  `plugins_loaded` action hook，用來初始化我們的金流 Class。
3.  `WC_Gateway_Moksa_NewebPay` 類別，包含：
    *   `__construct()` 建構子
    *   `init_form_fields()` 方法
    *   `process_payment()` 方法
    *   `handle_newebpay_response()` 方法
    *   `add_padding()` 輔助方法
4.  `woocommerce_payment_gateways` filter hook，用來註冊金流。

**如何測試：**

1.  到 WordPress 後台 > 外掛，啟用你剛剛建立的「Moksa - NewebPay Gateway for WooCommerce」外掛。
2.  到 WooCommerce > 設定 > 付款，你會看到「藍新 NewebPay 金流」的選項。
    ``
3.  點擊「管理」，進入設定頁面。**啟用**金流，並填寫你從藍新後台取得的**測試**用 **MerchantID**、**HashKey**、**HashIV**，並**勾選「啟用測試模式」**。
4.  儲存設定。
5.  回到你的商店前台，將商品加入購物車，並進入結帳頁面。
6.  在付款方式選擇「藍新 NewebPay」，並點擊「下單購買」。
7.  如果一切順利，你將會被導向藍新的測試付款頁面。
8.  使用藍新提供的測試信用卡號碼完成付款。
9.  付款成功後，你應該會被導回你的網站，並且後台對應的訂單狀態會更新為「處理中」。
10. **Moksa 偵錯技巧：** 如果過程中遇到問題，例如導向失敗或回呼沒反應，請檢查：
    *   **WooCommerce 系統狀態 > 紀錄：** 從下拉選單中尋找是否有 `fatal-errors` 相關紀錄。
    *   **啟用 WP_DEBUG：** 在 `wp-config.php` 中將 `WP_DEBUG` 設為 `true`，看看是否有任何 PHP 錯誤訊息。
    *   **檢查 API 資料：** 在 `process_payment` 中，可以暫時用 `wp_die(print_r($trade_info_data, true))` 的方式來印出你送出的資料，確認格式是否正確。

這堂課涵蓋了相當進階的開發技巧，成功完成代表你對 WooCommerce 的底層運作又有了更深的理解。這項技能將讓你在面對各種客製化需求時，都更有信心與能力去解決！