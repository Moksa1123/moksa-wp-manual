# 08.03 (實作) 建立「自訂」的 API 端點 (register_rest_route)

嗨，歡迎來到 MoksaWP 開發課程！在前面的章節中，我們已經了解了 WordPress REST API 的基本概念以及如何「使用」它來獲取或操作資料。然而，WordPress 的強大之處在於其無與倫比的擴充性。今天，我們將深入探討一個非常強大的開發技巧：**建立屬於你自己的、完全客製化的 REST API 端點**。

這項技能將為你開啟一扇新的大門，無論是打造一個給手機 App 使用的後端、串接第三方服務、或是建立一個基於 React/Vue.js 的「Headless」WordPress 網站，都離不開自訂 API 端點。

我們將會使用 WordPress 核心函式 `register_rest_route` 來完成這個任務。準備好了嗎？讓我們開始吧！

---

### 為什麼需要「自訂」API 端點？

雖然 WordPress 和 WooCommerce 內建了非常豐富的 API 端點（例如：取得文章、取得產品），但在實務開發中，你很快會遇到內建 API 不敷使用的情況：

1.  **資料格式不符：** 你可能需要一個端點，它回傳的資料是多個來源（例如：產品、作者資訊、相關 ACF 欄位）組合而成的，內建的 API 無法一次性提供。
2.  **效能考量：** 內建的 `/wp/v2/posts` 端點會回傳非常大量的欄位，但你的前端可能只需要標題和特色圖片。自訂一個只回傳必要資料的端點，可以大幅提升載入速度。
3.  **商業邏輯封裝：** 某些操作可能包含複雜的商業邏輯，例如「計算會員的終身消費總額並更新其等級」。與其讓前端進行多次 API 呼叫和複雜計算，不如在後端建立一個 `/update-member-level` 端點來封裝這一切。
4.  **安全性：** 你可以建立一個端點，它只對特定權限的使用者開放，並執行特定的安全檢查，提供比內建端點更精細的權限控制。

### 核心函式：`register_rest_route()` 詳解

要在 WordPress 中註冊一個新的 API 端點，我們主要會使用 `register_rest_route()` 這個函式。

**重要觀念：** 這個函式**必須**掛載在 `rest_api_init` 這個 action hook 上執行，確保它在 WordPress REST API 初始化時被正確註冊。

```php
add_action( 'rest_api_init', function () {
  register_rest_route( $namespace, $route, $args );
});
```

這個函式需要傳入三個主要參數：

1.  `$namespace` (字串): **命名空間**。
    *   這是你的 API 的一個群組名稱，用來避免和 WordPress 核心或其他外掛的 API 路由衝突。
    *   格式通常是 `vendor/v1`、`my-plugin-name/v2` 等。例如，我們可以定義為 `moksa/v1`。
    *   **Moksa 技巧：** 版本號 (v1, v2) 是個好習慣，當未來 API 有重大變動時，你可以推出 `moksa/v2`，同時讓舊的 `v1` 繼續運作，確保向下相容性。

2.  `$route` (字串): **路由**。
    *   這是端點的具體路徑，接在命名空間後面。例如 `/latest-posts`。
    *   完整的 API 路徑會是 `https://yourdomain.com/wp-json/moksa/v1/latest-posts`。
    *   路由也可以包含動態參數，例如 `/posts/(?P<id>\d+)`，這裡的 `(?P<id>\d+)` 是一個正規表示法，用來捕捉一個名為 `id` 的數字參數。

3.  `$args` (陣列): **設定參數**。
    *   這是一個陣列，用來定義這個端點的行為，其中最重要的幾個鍵值是：
    *   `'methods'`: (字串/陣列) 允許的 HTTP 方法，例如 `GET`, `POST`, `PUT`, `DELETE`。最常用的是 `WP_REST_Server::READABLE` (等同於 `GET`) 和 `WP_REST_Server::CREATABLE` (等同於 `POST`)。
    *   `'callback'`: (可呼叫的函式) **核心中的核心**。當這個端點被請求時，要執行的 PHP 函式。這個函式負責處理邏輯、抓取資料，並回傳結果。
    *   `'permission_callback'`: (可呼叫的函式) **極度重要的安全性**。這是一個用來檢查「當前使用者是否有權限存取此端點」的函式。它**必須**回傳 `true` 或 `false`。如果沒有設定，預設是公開的，任何人都可以存取，這可能造成嚴重的安全漏洞。

---

### (實作) 建立一個取得「最新 5 筆 WooCommerce 訂單」的 API 端點

接下來，我們來實作一個非常實用的範例：建立一個 `/latest-orders` 端點，讓具備特定權限的管理員可以快速取得網站最新的 5 筆訂單資訊（訂單 ID、狀態、總金額）。

#### 步驟 1：決定程式碼放置位置

對於這類型的客製化功能，我們有幾個選擇：

*   **佈景主題的 `functions.php`：** 適合快速測試，但不建議用於正式環境。因為更換佈景主題時，功能就會消失。
*   **自訂外掛 (Custom Plugin)：** **最佳實踐**。將所有客製化功能打包成一個獨立的外掛，方便管理、啟用或停用，且不受佈景主題更換影響。

在這個教學中，我們假設你已經建立了一個名為 `moksa-custom-functions` 的自訂外掛。我們將把程式碼加入到這個外掛的主 PHP 檔案中。

#### 步驟 2：註冊 API 端點 (`register_rest_route`)

打開你的自訂外掛檔案，加入以下程式碼。

```php
<?php
/**
 * Plugin Name: Moksa Custom Functions
 * Description: 用於存放客製化 API 端點與其他功能的專屬外掛。
 * Version: 1.0
 * Author: Moksa Web
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

// 將我們的註冊函式掛載到 rest_api_init action 上
add_action( 'rest_api_init', 'moksa_register_custom_api_routes' );

/**
 * 註冊所有 Moksa 的自訂 API 路由
 */
function moksa_register_custom_api_routes() {
    register_rest_route( 'moksa-orders/v1', '/latest-orders', array(
        'methods'             => WP_REST_Server::READABLE, // 等同於 'GET'
        'callback'            => 'moksa_get_latest_orders_callback',
        'permission_callback' => 'moksa_api_permission_check',
    ) );
}

```

在這段程式碼中，我們定義了：
*   **Namespace:** `moksa-orders/v1`
*   **Route:** `/latest-orders`
*   **Method:** `GET`
*   **Callback Function:** `moksa_get_latest_orders_callback` (我們下一步會建立它)
*   **Permission Callback Function:** `moksa_api_permission_check` (我們下一步也會建立它)

#### 步驟 3：撰寫權限回呼函式 (`permission_callback`)

安全性第一！我們不希望任何人都能看到網站的訂單資訊。我們設定只有具備「檢視 WooCommerce 報表」權限的使用者才能存取。

在剛剛的程式碼下方，加入權限檢查函式：

```php
/**
 * API 權限檢查回呼函式
 *
 * @return bool|WP_Error
 */
function moksa_api_permission_check() {
    // 只有具備 'view_woocommerce_reports' 權限的使用者才能存取
    // 這個權限通常是商店管理員 (Shop manager) 或管理員 (Administrator) 才有
    if ( ! current_user_can( 'view_woocommerce_reports' ) ) {
        // 如果權限不足，回傳一個 WP_Error 物件，會自動轉成 403 Forbidden 錯誤
        return new WP_Error( 'rest_forbidden', esc_html__( '抱歉，您沒有權限執行此操作。', 'moksa-plugin' ), array( 'status' => 403 ) );
    }

    // 權限檢查通過
    return true;
}
```
**Moksa 技巧：** `permission_callback` 應該總是回傳 `true` 或是一個 `WP_Error` 物件。直接回傳 `false` 也可以，但回傳 `WP_Error` 可以讓你自訂錯誤訊息和 HTTP 狀態碼，提供更友善的錯誤提示。

#### 步驟 4：撰寫主要回呼函式 (`callback`)

現在來撰寫真正處理資料的函式。我們需要使用 WooCommerce 的函式 `wc_get_orders` 來查詢訂單。

在權限函式的下方，加入以下程式碼：

```php
/**
 * 取得最新訂單的主要回呼函式
 *
 * @param WP_REST_Request $request 請求物件，包含所有請求參數
 * @return WP_REST_Response
 */
function moksa_get_latest_orders_callback( WP_REST_Request $request ) {
    
    // 使用 wc_get_orders 查詢訂單
    $orders = wc_get_orders( array(
        'limit'   => 5,         // 最多 5 筆
        'orderby' => 'date',    // 依日期排序
        'order'   => 'DESC',    // 降冪 (最新的在前面)
    ) );

    // 如果找不到訂單，回傳空陣列
    if ( empty( $orders ) ) {
        return new WP_REST_Response( [], 200 );
    }

    // 準備要回傳的資料
    $data = [];
    foreach ( $orders as $order ) {
        $data[] = array(
            'id'     => $order->get_id(),
            'status' => $order->get_status(),
            'total'  => $order->get_total(),
            'date'   => $order->get_date_created()->date( 'Y-m-d H:i:s' ),
        );
    }

    // 使用 WP_REST_Response 來回傳資料，這是最佳實踐
    // 它會自動將 PHP 陣列轉換為 JSON 格式，並設定正確的 HTTP Header
    return new WP_REST_Response( $data, 200 );
}
```
**Moksa 技巧：**
1.  **永遠不要直接回傳整個 `$order` 物件！** WordPress 的物件通常包含大量內部資料和方法，直接回傳會有安全風險且浪費頻寬。永遠只挑選你需要的欄位，整理成一個乾淨的陣列再回傳。
2.  **使用 `WP_REST_Response`** 而不是直接 `return $data;`。這讓你能夠更精準地控制 HTTP 狀態碼 (例如 `200` 代表成功, `404` 代表找不到)，並確保回應格式的正確性。

#### 步驟 5：測試你的 API 端點

儲存你的外掛檔案並啟用它。現在，要如何測試呢？

1.  **清除固定網址快取：**
    *   到 WordPress 後台 > 「設定」 > 「固定網址」。
    *   **不需要做任何修改**，直接點擊「儲存設定」按鈕。這個動作會刷新 WordPress 的路由規則，讓系統知道你註冊了新的 API 端點。
    *   **這是最常見的「404 Not Found」錯誤原因！**

2.  **使用瀏覽器或 API 測試工具：**
    *   首先，確保你已經登入具備「商店管理員」或更高權限的帳號。
    *   打開一個新的瀏覽器分頁，輸入以下網址（請將 `yourdomain.com` 換成你的 LocalWP 測試站網址）：
        `https://yourdomain.com/wp-json/moksa-orders/v1/latest-orders`

    *   如果一切順利，你應該會看到類似下方的 JSON 格式輸出：

    ``

    ```json
    [
        {
            "id": 125,
            "status": "processing",
            "total": "1500.00",
            "date": "2023-10-27 15:30:00"
        },
        {
            "id": 124,
            "status": "completed",
            "total": "880.00",
            "date": "2023-10-27 14:20:15"
        },
        // ... 其他訂單
    ]
    ```

3.  **使用專業工具：**
    *   對於更複雜的 API (例如 `POST` 請求)，建議使用 **Postman** 或 **Insomnia** 這類 API 測試工具。它們可以讓你輕鬆設定 Header、Body、驗證方式等。

---

### 總結與偵錯技巧

恭喜你！你已經成功地使用 `register_rest_route` 建立並測試了你的第一個自訂 API 端點。

讓我們回顧一下重點：
*   **註冊時機：** 永遠在 `rest_api_init` hook 中執行 `register_rest_route`。
*   **命名空間：** 使用獨特且包含版本號的命名空間，例如 `your-plugin/v1`。
*   **安全性：** **永遠**設定 `permission_callback`，這是保護你網站資料的第一道防線。
*   **資料處理：** 在 `callback` 函式中處理邏輯，並且只回傳前端需要的乾淨資料。
*   **回應格式：** 使用 `WP_REST_Response` 來回傳資料，以獲得最大的控制權。

**Moksa 偵錯技巧：**
*   **遇到 404 錯誤？** 馬上到「設定」>「固定網址」頁面，點擊「儲存設定」來刷新路由。
*   **遇到 `rest_forbidden` 或 403 錯誤？** 檢查你的 `permission_callback` 函式邏輯是否正確，以及你當前登入的使用者是否真的具備所需權限。
*   **API 回傳空白或非預期結果？** 在你的 `callback` 函式中使用 `error_log(print_r($your_variable, true));` 來將變數內容輸出到伺服器的錯誤日誌中進行偵錯。同時，**Query Monitor** 外掛在偵測 REST API 請求時也非常好用，可以顯示請求的詳細資訊和任何 PHP 錯誤。

建立自訂 API 端點是 WordPress 開發者邁向更進階應用的關鍵一步。多多練習，嘗試建立更多不同功能的端點，你會發現 WordPress 的可能性遠超你的想像！