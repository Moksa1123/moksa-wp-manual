# 01.05 WordPress 檔案結構與資料庫結構 (wp_posts, wp_options)

嗨，歡迎來到佈景主題與外掛開發的第一個核心章節。我是 Moksa 的首席課程導師。在我們開始撰寫任何程式碼之前，最重要的一步是理解我們即將工作的「環境」——也就是 WordPress 的檔案與資料庫結構。

這就像學開車前，必須先知道引擎蓋底下有什麼，儀表板上的燈號代表什麼意思一樣。理解這些底層結構，能讓你在開發時知道要去哪裡找檔案、去哪裡存取資料，並在除錯時迅速定位問題。

---

## 一、WordPress 檔案結構：程式碼的家

當你透過 FTP 或檔案管理員看到 WordPress 的資料夾時，你會看到三大核心目錄與一些重要的根目錄檔案。我們可以把檔案結構想像成一棟房子的藍圖。

``
*(示意圖：WordPress 根目錄的檔案與資料夾列表)*

### 1. 根目錄 (Root Directory) 的關鍵檔案

*   `wp-config.php`：**這是 WordPress 最重要的設定檔**。它包含了資料庫的連線資訊 (主機、使用者名稱、密碼)、安全金鑰，以及一些進階設定。**Moksa 技巧**：我們通常會在這裡設定 `WP_DEBUG` 為 `true` 來開啟開發模式下的錯誤回報，但在正式站上線時，務必將其設為 `false`。
*   `.htaccess`：這是 Apache 伺服器的設定檔。WordPress 主要用它來處理「**永久連結 (Permalinks)**」。當你發現網站的頁面連結出現 404 錯誤時，第一步通常是到後台「設定」>「永久連結」重新儲存一次，讓 WordPress 重建這個檔案。
*   `index.php`：這是 WordPress 的主要入口檔案。所有的頁面請求基本上都是先通過它來載入整個 WordPress 環境。

### 2. 核心資料夾 (你幾乎不會去動它們)

*   `/wp-admin/`：這個資料夾包含了所有 WordPress **後台儀表板**的檔案。當你登入後台時，看到的所有介面、功能都在這裡。
*   `/wp-includes/`：這是 WordPress 的**核心函式庫**。包含了 WordPress 運作所需的大部分核心功能、類別與 API (例如 `WP_Query`、`add_action` 等)。

**重要觀念**：除非你在進行核心開發 (Core Development)，否則**絕對不要去修改 `wp-admin` 和 `wp-includes` 裡的任何檔案**。因為只要 WordPress 一更新，你所有的修改都會被覆寫，而且這也可能導致網站不穩定或產生安全性漏洞。

### 3. /wp-content/ 資料夾 (開發者的遊樂場)

**這是我們身為開發者，99% 的時間會待的地方**。這個資料夾存放了所有「使用者自訂」的內容，它被刻意與核心檔案分開，確保在 WordPress 核心升級時，你的客製化內容不會遺失。

*   `/plugins/`：所有你安裝的**外掛**都存放在這裡。當你開發一個新外掛時，你需要在這裡建立一個新的資料夾來存放你的外掛檔案。
*   `/themes/`：所有你安裝的**佈景主題**都存放在這裡。我們開發的佈景主題，也就是一個獨立的資料夾，會放在此處。
*   `/uploads/`：所有你透過媒體庫上傳的圖片、影片、文件，都會依照年/月的結構存放在這裡。
*   `/languages/`：存放佈景主題與外掛的 `.mo` 和 `.po` 語系檔。

---

## 二、WordPress 資料庫結構：所有資料的倉庫

如果說檔案是網站的「骨架與器官」，那資料庫就是網站的「血液與記憶」。你寫的每一篇文章、上傳的每一張圖片資訊、設定的每一個選項，全都儲存在資料庫裡。

WordPress 使用 MySQL (或 MariaDB) 資料庫。一個標準的 WordPress 安裝會包含約 12 個核心資料表 (Table)，它們通常以 `wp_` 作為前綴 (Prefix)。

**Moksa 技巧**：在安裝 WordPress 時，將預設的資料表前綴 `wp_` 改成其他隨機的字串 (例如 `mksawp_`)，可以稍微提升網站的安全性，避免被針對性的 SQL 注入攻擊。

接下來，我們來認識幾個開發中最常用到的核心資料表。

### 1. `wp_posts`：內容的核心

`wp_posts` 是 WordPress 資料庫中**最重要也最繁忙的資料表**。你可能會以為它只儲存「文章 (Posts)」，但事實上它儲存了網站中絕大多數的內容類型。

**重要觀念**：WordPress 使用一個叫做「**Post Type (文章類型)**」的欄位來區分儲存在 `wp_posts` 裡的不同內容。

常見的 Post Types 包含：
*   `post`：部落格文章
*   `page`：頁面
*   `attachment`：媒體庫裡的每個項目 (圖片、檔案)
*   `revision`：文章的修訂版本
*   `nav_menu_item`：選單中的每一個項目
*   `product`：**WooCommerce 的商品** (由 WooCommerce 外掛新增的 Custom Post Type)
*   `lesson`：**LearnDash 的課程** (由 LMS 外掛新增的 Custom Post Type)

``
*(示意圖：使用 phpMyAdmin 查看 `wp_posts` 資料表的結構與內容，並高亮 `post_type` 欄位)*

**`wp_posts` 的重要欄位：**

| 欄位名稱 | 用途 |
| :--- | :--- |
| **ID** | 獨一無二的識別碼，也是主鍵 (Primary Key)。 |
| **post_author** | 作者的 User ID (對應到 `wp_users` 資料表)。 |
| **post_date** | 發佈日期與時間。 |
| **post_content** | **主要內容** (例如：文章內文、頁面內容)。 |
| **post_title** | **標題** (例如：文章標題、頁面標題、商品名稱)。 |
| **post_status** | 狀態，例如 `publish` (已發佈)、`draft` (草稿)、`trash` (垃圾桶)。 |
| **post_name** | **文章代稱 (Slug)**，也就是 URL 的一部分。 |
| **post_type** | **內容類型**，如上所述，這是區分內容的關鍵。 |
| **post_parent** | 父項目的 ID。例如，一個頁面的「父級頁面」。 |

### 2. `wp_postmeta`：內容的補充資訊

`wp_postmeta` 存在的目的，是為了儲存 `wp_posts` 中不適合放在主要欄位的「**後設資料 (Meta Data)**」。它採用一種 key-value 的形式來儲存。

每一個 `wp_postmeta` 的紀錄都透過 `post_id` 欄位與 `wp_posts` 中的一筆紀錄關聯。

**Moksa 實務範例**：
*   一個 WooCommerce **商品**的「價格」、「庫存數量 (SKU)」、「重量」等資訊，都儲存在 `wp_postmeta`。
*   一篇使用 Rank Math SEO 外掛的文章，其設定的「SEO 標題」、「Meta 描述」也儲存在這裡。
*   使用 ACF (Advanced Custom Fields) 外掛新增的「自訂欄位」的值，也都儲存在 `wp_postmeta`。

### 3. `wp_options`：網站的全域設定

`wp_options` 資料表儲存的是**整個網站的全域設定**，這些設定通常不是針對某一篇文章或頁面，而是適用於全站。這也是一個 key-value 形式的資料表。

``
*(示意圖：使用 phpMyAdmin 查看 `wp_options` 資料表，顯示 `siteurl`、`blogname` 等選項)*

**常見的 Options 範例：**
*   `siteurl`：網站的網址。
*   `blogname`：網站的標題。
*   `admin_email`：管理員的電子郵件。
*   `current_theme`：目前啟用的佈景主題名稱。
*   `active_plugins`：目前啟用中的外掛列表。
*   **Moksa 技巧**：這個資料表中有一個 `autoload` 欄位。被設定為 `yes` 的選項會在每一個頁面載入時，都被 WordPress 自動載入到記憶體中。如果外掛開發者將非常龐大的資料存到一個 `autoload` 為 `yes` 的 option 中，將會嚴重影響網站效能。

### 4. 其他重要資料表 (簡介)

*   `wp_users` & `wp_usermeta`：分別儲存使用者基本資料 (帳號、密碼、Email) 與額外資訊 (姓名、暱稱)。
*   `wp_terms`, `wp_term_taxonomy`, `wp_term_relationships`：這三個資料表共同組成了 WordPress 的**分類系統 (Taxonomy)**，用來管理文章分類、標籤，以及 WooCommerce 的商品分類等。

---

## 三、串連一切：檔案如何與資料庫溝通

現在我們知道了檔案在哪、資料在哪，最後一步就是理解它們是如何協同運作的。

讓我們以「**瀏覽一篇 WooCommerce 商品頁面**」為例：

**步驟 1：發送請求**
使用者在瀏覽器輸入一個商品網址，例如 `https://moksaweb.com/product/ry-tools/`。

**步驟 2：WordPress 解析 URL**
WordPress 透過 `.htaccess` 檔案的規則，知道這個請求要交給 `index.php` 處理。接著，它會解析 URL 中的代稱 `ry-tools`。

**步驟 3：查詢資料庫 (`wp_posts`)**
WordPress 會到 `wp_posts` 資料表中，尋找 `post_name` 欄位等於 `ry-tools` 且 `post_type` 欄位等於 `product` 的那筆資料，並取得其 **ID**。

**步驟 4：載入佈景主題範本檔案**
WordPress 發現這是一個 `product` (商品)，於是它會到啟用中的佈景主題資料夾 (`/wp-content/themes/your-theme/`) 中尋找對應的範本檔案，可能是 `single-product.php` 或 `woocommerce.php`。

**步驟 5：在範本中取得並顯示資料**
在 `single-product.php` 檔案中，開發者會使用 WordPress 提供的函式 (The Loop) 來顯示內容：
*   呼叫 `the_title()`：這個函式會根據 **ID** 從 `wp_posts` 撈取 `post_title` (商品名稱) 並顯示出來。
*   呼叫 `the_content()`：這個函式會撈取 `post_content` (商品描述)。
*   WooCommerce 的函式 (例如 `wc_get_product()`) 會被呼叫，它會根據 **ID** 到 `wp_postmeta` 資料表撈取 `_price` (價格)、`_sku` (庫存單位) 等後設資料並顯示。

**步驟 6：生成 HTML 並回傳**
伺服器上的 PHP 執行完所有程式碼、撈完所有資料庫內容後，會將它們組合成一份完整的 HTML 文件，回傳給使用者的瀏覽器，最終呈現出我們看到的網頁。

---

恭喜你！你已經掌握了 WordPress 開發最基礎也最核心的知識。理解檔案與資料庫的運作模式，是從「網站使用者」晉升為「網站開發者」的關鍵一步。在接下來的課程中，我們將會不斷地在這兩個結構上進行操作。