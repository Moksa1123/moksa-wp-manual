# 09.04 (實作) 打造您的第一個「動態 Block」 (ServerSideRender)

嗨，歡迎來到 MoksaWP 開發課程！在前幾個章節，我們已經了解了 Gutenberg Block 的基本結構，特別是基於 JavaScript (React) 的**靜態 Block**。靜態 Block 的內容一旦儲存，就會以 HTML 的形式寫入資料庫的 `post_content` 欄位。

然而，在許多情境下，我們需要顯示**動態的、即時的內容**。例如：最新文章列表、熱門商品、目前登入的使用者資訊等。這些內容不應該被「寫死」在文章裡，而是應該在每次頁面載入時，由伺服器端（也就是 PHP）動態生成。

這就是「**動態 Block**」的用武之地。在本章節中，我們將會使用 WordPress 核心提供的 `ServerSideRender` 元件，從零開始打造一個「**Moksa 最新文章**」的動態區塊。

---

### 學習目標

*   了解**靜態 Block** 與 **動態 Block** 的核心差異。
*   學會如何設定 `block.json` 以啟用伺服器端渲染 (Server-Side Rendering)。
*   掌握撰寫 PHP **Render Callback** 函式來產生區塊的前台 HTML。
*   學會在區塊編輯器中使用 `<ServerSideRender />` 元件，實現所見即所得的後台預覽。
*   學會如何從編輯器傳遞屬性 (Attributes) 到 PHP，讓區塊更具彈性。

### 環境準備

在開始之前，請確認你已經準備好以下開發環境：

1.  **本機環境:** **LocalWP** 已經啟動並建立好一個測試站點。
2.  **程式碼編輯器:** **VS Code** 已開啟，並指向你的外掛資料夾。
3.  **終端機 (Terminal):** 已開啟，並確認 `node`, `npm`, `wp` (WP-CLI) 指令可以正常運作。

---

### 步驟 1：使用 WP-CLI 快速建立 Block 鷹架

建立 Block 最快、最標準的方式就是使用 `@wordpress/create-block` 這個官方工具，我們可以透過 `wp scaffold block` 指令來使用它。

首先，請透過終端機進入你的外掛資料夾路徑。假設我們的外掛叫做 `moksa-dynamic-blocks`。

```bash
# 進入外掛目錄
cd wp-content/plugins/moksa-dynamic-blocks

# 使用 WP-CLI 建立一個名為 'latest-posts' 的區塊
wp scaffold block latest-posts --title="Moksa 最新文章" --category="moksa-blocks"
```

執行成功後，你會看到一個 `build` 和 `src` 資料夾，以及一個 `latest-posts.php` 檔案。

*   `src/`: 這是我們主要的開發目錄，包含 `block.json`, `index.js`, `edit.js`, `save.js` 等檔案。
*   `latest-posts.php`: 這是用來註冊區塊的 PHP 檔案。

``
*(截圖：終端機成功執行 `wp scaffold block` 指令的畫面)*

### 步驟 2：修改 `block.json`，宣告為動態區塊

這是將靜態 Block 轉變為動態 Block 的**關鍵步驟**。我們需要告訴 WordPress，這個區塊的 HTML 不是由 `save.js` 產生的，而是由一個 PHP 函式在伺服器端生成的。

請打開 `src/block.json` 檔案，並進行以下修改：

1.  **移除 `"editorScript": "file:./index.js"`**：因為 `viewScript` 將會被用在前後台，我們可以簡化引用。
2.  **新增 `"render": "file:./render.php"`**：這個屬性是宣告動態區塊的核心。它告訴 WordPress，當需要在前台（或後台預覽）渲染這個區塊時，要去執行 `render.php` 這個檔案。
3.  **定義屬性 (Attributes)**：我們需要一個屬性來控制要顯示幾篇文章。讓我們新增一個叫做 `numberOfPosts` 的屬性。

修改後的 `src/block.json` 看起來會像這樣：

```json
{
	"$schema": "https://schemas.wp.org/trunk/block.json",
	"apiVersion": 3,
	"name": "moksa-dynamic-blocks/latest-posts",
	"version": "0.1.0",
	"title": "Moksa 最新文章",
	"category": "moksa-blocks",
	"icon": "megaphone",
	"description": "一個動態顯示最新文章的區塊。",
	"attributes": {
		"numberOfPosts": {
			"type": "number",
			"default": 5
		}
	},
	"supports": {
		"html": false
	},
	"textdomain": "moksa-dynamic-blocks",
	"editorScript": "file:./index.js",
	"editorStyle": "file:./index.css",
	"style": "file:./style-index.css",
	"render": "file:./render.php"
}
```

**Moksa 技巧：** 注意我們移除了 `save` 函式的相關設定，並加入了 `"render"` 屬性。對於動態區塊，`save.js` 檔案裡的 `save()` 函式將會被 WordPress **完全忽略**。它的回傳值應該是 `null`。

### 步驟 3：撰寫 PHP Render Callback 函式

根據 `block.json` 的設定，我們需要在 `src` 資料夾下建立一個 `render.php` 檔案。這個檔案將包含生成區塊 HTML 的所有 PHP 邏輯。

請在 `src` 目錄下新增 `render.php` 檔案，並貼上以下程式碼：

```php
<?php
/**
 * @see https://github.com/WordPress/gutenberg/blob/trunk/docs/reference-guides/block-api/block-metadata.md#render
 */

// 使用 WP_Query 查詢最新文章
// $attributes 是從編輯器傳過來的屬性陣列
$args = array(
    'post_type'      => 'post',
    'posts_per_page' => $attributes['numberOfPosts'], // 使用從屬性傳來的文章數量
    'post_status'    => 'publish',
);

$latest_posts_query = new WP_Query( $args );

// 開始產生 HTML
// 使用 get_block_wrapper_attributes() 可以自動加上區塊的 wrapper class 等屬性
?>
<div <?php echo get_block_wrapper_attributes(); ?>>
    <?php if ( $latest_posts_query->have_posts() ) : ?>
        <ul>
            <?php while ( $latest_posts_query->have_posts() ) : $latest_posts_query->the_post(); ?>
                <li>
                    <a href="<?php the_permalink(); ?>">
                        <?php the_title(); ?>
                    </a>
                </li>
            <?php endwhile; ?>
        </ul>
        <?php wp_reset_postdata(); // 重設 Post Data ?>
    <?php else : ?>
        <p>找不到任何文章。</p>
    <?php endif; ?>
</div>

```

**重點說明：**

*   這個 PHP 檔案可以存取一個名為 `$attributes` 的變數，它是一個陣列，包含了我們在 `block.json` 中定義的所有屬性值。
*   我們使用標準的 `WP_Query` 來抓取文章，這是 WordPress 開發的基礎。
*   `get_block_wrapper_attributes()` 是一個很方便的函式，它會幫我們輸出區塊所需的外層 HTML 屬性（例如 `class`），讓我們的區塊樣式可以正常運作。

### 步驟 4：修改 `edit.js` 以實現後台預覽

現在，我們的前台邏輯已經完成了。但如果在編輯器中插入這個區塊，會看到一片空白或錯誤，因為我們還沒告訴編輯器該如何「預覽」這個動態內容。

這時候，`@wordpress/server-side-render` 套件就派上用場了。它提供了一個 React 元件 `<ServerSideRender />`，可以在編輯器中發送一個 API 請求到後端，執行我們的 `render.php`，並將結果即時顯示回來。

同時，我們也需要建立一個設定介面，讓使用者可以調整 `numberOfPosts` 這個屬性。

請打開 `src/edit.js` 並用以下程式碼取代其內容：

```jsx
import { __ } from '@wordpress/i18n';
import { useBlockProps, InspectorControls } from '@wordpress/block-editor';
import { PanelBody, RangeControl } from '@wordpress/components';
import ServerSideRender from '@wordpress/server-side-render';
import './editor.scss';

export default function Edit({ attributes, setAttributes }) {
	const { numberOfPosts } = attributes;

	return (
		<>
			{/* 右側邊欄設定 */}
			<InspectorControls>
				<PanelBody title={__('文章設定', 'moksa-dynamic-blocks')}>
					<RangeControl
						label={__('顯示文章數量', 'moksa-dynamic-blocks')}
						value={numberOfPosts}
						onChange={(value) => setAttributes({ numberOfPosts: value })}
						min={1}
						max={10}
					/>
				</PanelBody>
			</InspectorControls>

			{/* 區塊主要預覽畫面 */}
			<div {...useBlockProps()}>
				<ServerSideRender
					block="moksa-dynamic-blocks/latest-posts"
					attributes={attributes}
				/>
			</div>
		</>
	);
}
```

**重點說明：**

*   我們從 `@wordpress/components` 匯入了 `PanelBody` 和 `RangeControl` 來建立右側邊欄的設定選項。
*   `InspectorControls` 是用來包裹所有側邊欄設定的標準元件。
*   **`ServerSideRender` 是核心**。我們需要傳入兩個重要的 props:
    *   `block`: 我們區塊的完整名稱，也就是 `moksa-dynamic-blocks/latest-posts`。
    *   `attributes`: 將目前區塊的 `attributes` 物件整個傳下去。這樣一來，當我們在側邊欄調整 `numberOfPosts` 時，`ServerSideRender` 會自動偵測到變化，並帶著新的屬性值重新向後端請求內容，實現**即時預覽**。

### 步驟 5：移除 `save.js` 內容

由於這是個動態區塊，`save.js` 不再需要。為了保持專案乾淨，請打開 `src/save.js`，並將其內容簡化為只回傳 `null`。

```jsx
import { useBlockProps } from '@wordpress/block-editor';

export default function save() {
	return null;
}
```

### 步驟 6：編譯與測試

萬事俱備！現在回到你的終端機，確保你還在外掛的根目錄，然後執行編譯指令。

```bash
# 如果是開發中，執行這個指令，它會自動監看檔案變化並編譯
npm start

# 如果是要打包上線，執行這個
npm run build
```

編譯完成後，回到你的 WordPress 後台：

1.  新增或編輯一篇文章/頁面。
2.  點擊「+」新增區塊，搜尋「**Moksa 最新文章**」並插入它。
3.  你應該會看到區塊內立刻顯示了最新的 5 篇文章列表。
4.  點擊該區塊，檢查右邊的「區塊」設定側邊欄。
5.  你會看到一個「顯示文章數量」的滑桿，試著拖動它。
6.  觀察區塊內的文章列表是不是隨著你的調整即時更新了！
7.  最後，發布頁面，到前台檢查，內容應該與你在後台預覽的完全一致。

``
*(截圖：在 Gutenberg 編輯器中，左側是 Moksa 最新文章區塊的預覽，右側是 InspectorControls 中的文章數量滑桿)*

---

### Moksa 技巧與總結

恭喜你！你已經成功打造了第一個功能完整的動態 Block。這項技能為你的 WordPress 開發能力開啟了全新的大門。

**重點回顧：**

1.  **動態區塊的核心** 是在 `block.json` 中使用 `"render"` 屬性指向一個 PHP 檔案。
2.  **PHP Render Callback (`render.php`)** 負責所有後端資料處理與 HTML 生成，它可以接收 `$attributes` 變數。
3.  **後台預覽的關鍵** 是在 `edit.js` 中使用 `<ServerSideRender />` 元件，它能模擬前台的渲染結果，提供絕佳的編輯體驗。
4.  對於動態區塊，`save()` 函式**沒有作用**，應回傳 `null`。

動態區塊的應用非常廣泛，幾乎所有需要與資料庫或其他 API 互動的內容顯示，都應該使用動態區塊來實現。例如：WooCommerce 的商品區塊、會員系統的個人資料區塊、或是串接外部 API 的天氣資訊區塊等等。

在接下來的課程中，我們將會探索更多動態區塊的進階應用，包含更複雜的屬性、與 WordPress REST API 的互動等等。