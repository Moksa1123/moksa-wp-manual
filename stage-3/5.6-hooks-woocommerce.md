# 05.06 (實務) WooCommerce 常用 Hooks (客製化結帳、商品頁)

嗨，歡迎來到 MoksaWP 的開發者課程！在前幾堂課中，我們已經了解了 WordPress Hooks (Action & Filter) 的基本概念。今天，我們將把這些理論應用在電商開發的核心——WooCommerce 上。

WooCommerce 之所以如此強大且受歡迎，很大一部分歸功於它提供了極其豐富的 Hooks，讓開發者可以在不修改核心程式碼的前提下，深度客製化商店的每一個角落。這堂課的目標，就是帶你學會如何**找到**並**使用**最常見的商品頁與結帳頁 Hooks，完成客戶最常提出的客製化需求。

---

### 課前準備 (Prerequisites)

在開始動手前，請確保你的開發環境已準備就緒：

1.  **本機環境:** **LocalWP** 安裝並運行一個測試站。
2.  **程式碼編輯器:** **VS Code** 或你習慣的編輯器。
3.  **偵錯工具:** 在測試站安裝並啟用 **Query Monitor** 外掛。這是一個**Moksa 技巧**，它可以視覺化頁面上所有執行的 Hooks，是開發時尋找 Hook 名稱的神器。
4.  **範例商品:** 在 WooCommerce 中建立至少一個簡單商品。

---

### 第一部分：客製化商品頁 (Single Product Page)

商品頁是顧客決定是否購買的關鍵。我們常常需要在此處新增額外資訊或調整現有元素的顯示。

#### 尋找正確 Hook 的方法

在動手寫程式碼前，首要任務是「找到對的 Hook」。你有三種主要方法：

1.  **官方資源 (Visual Hook Guides):** WooCommerce 官方和許多開發者社群都製作了視覺化的 Hook 指南，直接標示出 Hook 在頁面上的位置。這是最快、最直觀的方式。
    *   推薦資源: [Business Bloomer - WooCommerce Visual Hook Guide](https://www.businessbloomer.com/category/woocommerce-tips/visual-hook-guides/)
    ``
    *(示意圖: Business Bloomer 網站上關於商品頁 Hook 位置的圖解)*

2.  **閱讀原始碼 (Template Files):** 直接打開 WooCommerce 的模板檔案 (template files) 是最根本的方法。你可以在 `wp-content/plugins/woocommerce/templates/` 目錄下找到對應的檔案。在檔案中，你會看到 `do_action('hook_name');` 或 `apply_filters('hook_name', $variable);` 的語法。這就是 Hook 的定義位置。
    *   **Moksa 技巧:** **絕對不要**直接修改這些原始檔案！你應該將需要修改的檔案複製到你的子佈景主題下的 `woocommerce` 資料夾中來覆寫它，或者（更好的方法）是使用 Hook 來掛載你的功能。

3.  **使用 Query Monitor:** 啟用 Query Monitor 後，以前台管理員身份瀏覽你的商品頁。點擊上方工具列的 Query Monitor 區域，找到 "Hooks & Actions" 選項。這裡會列出當前頁面執行的所有 Hooks，你可以透過關鍵字搜尋來定位。
    ``
    *(示意圖: Query Monitor 後台介面，顯示商品頁執行的 Hooks 列表)*

#### 實作一：在「加入購物車」按鈕後新增提示文字 (Action Hook)

這是一個非常常見的需求，例如新增「預計出貨日」、「安心保證」等文字。

*   **目標:** 在加入購物車按鈕下方，顯示一行文字：「本商品為預購品，預計 7-14 個工作天出貨。」
*   **使用的 Hook:** `woocommerce_after_add_to_cart_button`

**步驟 1：找到要放置程式碼的地方**

為了保持專案整潔，我們建議你建立一個自訂的功能外掛 (custom functionality plugin) 或在子佈景主題的 `functions.php` 中加入。這裡我們以後者為例。

**步驟 2：撰寫程式碼**

打開你的子佈景主題的 `functions.php` 檔案，在最下方加入以下 PHP 程式碼：

```php
/**
 * Moksa 範例：在加入購物車按鈕後新增預購提示
 * 使用 action hook: woocommerce_after_add_to_cart_button
 */
add_action( 'woocommerce_after_add_to_cart_button', 'moksa_add_preorder_notice_after_add_to_cart' );

function moksa_add_preorder_notice_after_add_to_cart() {
    // 透過 is_product() 檢查，確保只在特定商品頁顯示 (此處以商品 ID 123 為例)
    // 如果所有商品都要顯示，可以移除 if 判斷
    if ( is_product( 123 ) ) {
        echo '<div class="moksa-preorder-notice" style="margin-top: 15px; color: #e2401c;">本商品為預購品，預計 7-14 個工作天出貨。</div>';
    }
}
```

**步驟 3：儲存並驗證結果**

儲存 `functions.php` 檔案，然後回到你的商品頁面重新整理。你應該會在「加入購物車」按鈕下方看到我們新增的提示文字。

``
*(示意圖: 商品頁面上，「加入購物車」按鈕下方出現了紅色的預購提示文字)*

#### 實作二：修改「加入購物車」按鈕的文字 (Filter Hook)

如果我們想改變既有的內容，而不是新增內容，這時候就該使用 `Filter Hook`。

*   **目標:** 將「加入購物車」按鈕的文字改為「立即預購」。
*   **使用的 Hook:** `woocommerce_product_single_add_to_cart_text`

**步驟 1：撰寫程式碼**

同樣在 `functions.php` 中加入以下程式碼：

```php
/**
 * Moksa 範例：修改單一商品頁的加入購物車按鈕文字
 * 使用 filter hook: woocommerce_product_single_add_to_cart_text
 */
add_filter( 'woocommerce_product_single_add_to_cart_text', 'moksa_change_single_add_to_cart_text' );

function moksa_change_single_add_to_cart_text( $text ) {
    // Filter hook 的函式通常會接收一個參數 (原始值)
    // 我們要做的就是回傳一個新的值來取代它
    global $product;

    // 舉例：如果商品是特定分類 'pre-order'，才改變文字
    if ( has_term( 'pre-order', 'product_cat', $product->get_id() ) ) {
        return '立即預購';
    }

    // 如果不符合條件，記得要回傳原始的 $text
    return $text;
}
```

**步驟 2：儲存並驗證**

儲存檔案後，前往一個被設定為 `pre-order` 分類的商品頁面，你會發現按鈕文字已經被成功修改了。

**Moksa 技巧：** Filter Hook 的函式**務必**要有一個 `return` 值。如果你在某些條件下不想修改它，請務必 `return` 傳進來的原始參數 (`$text`)，否則可能會導致該處內容變為空白，造成網站錯誤。

---

### 第二部分：客製化結帳頁面 (Checkout Page)

結帳頁是成交的最後一哩路，任何的客製化都需格外小心。在這裡，我們將實作一個完整的流程：新增自訂欄位，並將其儲存到訂單資料中。

#### 實作：新增「收件備註」欄位

*   **目標:** 在結帳頁的「訂單備註」下方，新增一個「管理員專用備註」欄位，讓顧客可以填寫一些給內部人員看的資訊 (例如希望指定特定人員處理)。這個欄位的資料需要儲存到訂單後台，並顯示給店家看。

這是一個多步驟的任務，會用到多個不同的 Hooks。

**步驟 1：新增欄位到結帳表單**

我們使用 `woocommerce_after_order_notes` 這個 action hook 來輸出 HTML 欄位。

```php
/**
 * Moksa 範例：在結帳頁新增自訂欄位
 */
add_action( 'woocommerce_after_order_notes', 'moksa_add_custom_checkout_field' );

function moksa_add_custom_checkout_field( $checkout ) {
    echo '<div id="moksa_custom_checkout_field_wrapper">';
    echo '<h3>' . __('管理員專用備註') . '</h3>';

    woocommerce_form_field( 'moksa_admin_note', array(
        'type'          => 'textarea',
        'class'         => array('moksa-admin-note-field form-row-wide'),
        'label'         => __('若有特殊需求希望指定人員處理，請在此填寫'),
        'placeholder'   => __('例如：希望由客服人員 John 協助處理...'),
        ), $checkout->get_value( 'moksa_admin_note' ));

    echo '</div>';
}
```
*   **Moksa 技巧:** 我們使用了 WooCommerce 內建的 `woocommerce_form_field()` 函式來建立欄位。這能確保欄位的 HTML 結構和樣式與佈景主題一致，是**最佳實踐**。

**步驟 2：(可選) 驗證欄位內容**

如果這個欄位是必填，或需要特定格式，你可以使用 `woocommerce_checkout_process` hook 來驗證。

```php
/**
 * Moksa 範例：驗證自訂結帳欄位
 * (此範例為非必填，故註解。若要改為必填可取消註解)
 */
// add_action('woocommerce_checkout_process', 'moksa_validate_custom_checkout_field');
//
// function moksa_validate_custom_checkout_field() {
//     // 如果欄位是空的，且我們設定為必填
//     if ( ! $_POST['moksa_admin_note'] ) {
//         wc_add_notice( __( '「管理員專用備註」為必填欄位，請填寫內容。' ), 'error' );
//     }
// }
```

**步驟 3：儲存欄位資料到訂單中**

當顧客點擊「下單購買」後，我們需要將欄位的值存成訂單的 meta data。

```php
/**
 * Moksa 範例：儲存自訂結帳欄位的值
 */
add_action( 'woocommerce_checkout_update_order_meta', 'moksa_save_custom_checkout_field' );

function moksa_save_custom_checkout_field( $order_id ) {
    if ( ! empty( $_POST['moksa_admin_note'] ) ) {
        // 使用 update_post_meta 將資料存入訂單
        // 前方加上底線 "_" 代表這是一個內部使用的 meta field，預設不會顯示在後台的自訂欄位區
        update_post_meta( $order_id, '_moksa_admin_note', sanitize_textarea_field( $_POST['moksa_admin_note'] ) );
    }
}
```

**步驟 4：在後台訂單頁面顯示欄位資料**

資料存進去了，但我們還需要在後台訂單編輯頁面把它顯示出來，方便管理者查看。

```php
/**
 * Moksa 範例：在後台訂單頁面顯示自訂欄位的值
 */
add_action( 'woocommerce_admin_order_data_after_shipping_address', 'moksa_display_custom_field_in_admin_order', 10, 1 );

function moksa_display_custom_field_in_admin_order( $order ){
    $admin_note = get_post_meta( $order->get_id(), '_moksa_admin_note', true );
    if ( ! empty( $admin_note ) ) {
        echo '<p><strong>' . __('管理員專用備註') . ':</strong><br>' . esc_html( $admin_note ) . '</p>';
    }
}
```

現在，將以上所有程式碼片段加入你的 `functions.php`，然後走一遍完整的結帳流程。你會看到結帳頁出現了新欄位，填寫後送出訂單，最後在 WordPress 後台的訂單編輯頁面，就可以看到顧客填寫的備註了！

``
*(示意圖: 後台訂單編輯頁，在送貨地址下方，顯示了「管理員專用備註」及其內容)*

---

### 總結與 Moksa 開發最佳實踐

今天我們透過實作，掌握了客製化 WooCommerce 商品頁與結帳頁的核心技巧。請永遠記住以下幾點開發原則：

*   **絕不修改核心檔案:** 永遠使用 Hook 或覆寫模板 (Override templates) 的方式進行客製化。
*   **優先使用 Hook:** 相比覆寫整個模板檔案，使用 Hook 對目標進行微調通常是更有效率且未來升級時更不容易出錯的作法。
*   **程式碼組織:** 隨著功能增加，`functions.php` 會變得臃腫。**Moksa 最佳實踐**是為你的網站建立一個專屬的功能性外掛 (functionality plugin) 來存放這些程式碼片段，便於管理與維護。
*   **加上判斷式:** 在你的程式碼外層包上 `if ( class_exists( 'WooCommerce' ) ) { ... }` 可以避免在 WooCommerce 未啟用的情況下產生 PHP Fatal Error。
*   **註解是你的好朋友:** 清晰的註解能幫助未來的你（或你的同事）快速理解這段程式碼的用途。

熟悉 WooCommerce Hooks 是成為一位合格電商開發者的必經之路。多練習、多查詢、多利用 Query Monitor 這類工具，你將能應對各式各樣的客製化挑戰。下堂課，我們將會探討如何建立自訂的短代碼 (Shortcode)。