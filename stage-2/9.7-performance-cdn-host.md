# 09.07 CDN/主機端優化策略 (Cloudflare 設定)

嗨，歡迎來到 MoksaWP 進階客製化課程！在這個章節，我們將探討一個對於網站效能與安全性至關重要的服務：CDN。具體來說，我們將深入學習如何設定業界最受歡迎的 CDN 服務——**Cloudflare**，並將它與我們的 WordPress 網站 (特別是 **WP Rocket** 快取外掛) 完美整合。

---

### 什麼是 CDN？為什麼你需要它？

CDN 的全名是 **Content Delivery Network**，中文稱作「**內容傳遞網路**」。

你可以把它想像成一個全球性的「**物流倉儲系統**」。一般情況下，當訪客瀏覽你的網站時，他們所有的請求都必須送到你網站主機所在的「單一倉庫」（例如：主機在台灣）。如果訪客來自美國，數據傳輸的距離就非常遙遠，導致網站載入速度變慢。

而 CDN 在全球各地都設有「**中繼倉庫**」（稱為 PoP - Point of Presence）。它會把你網站的靜態資源（如圖片、CSS、JavaScript 檔案）預先複製一份，存放在這些全球倉庫中。當美國的訪客來訪時，Cloudflare 會自動從離他最近的美國倉庫提供資料，大幅縮短傳輸距離，進而**顯著提升網站載入速度**。

**使用 Cloudflare 的核心優勢：**

1.  **速度提升：** 透過全球節點加速內容傳遞。
2.  **安全性增強：** 免費提供基礎的防火牆 (WAF) 與 DDoS 攻擊防護。
3.  **節省主機資源：** 由 Cloudflare 提供大部分靜態資源，可以降低你主機的流量與負載。
4.  **免費方案強大：** 對於絕大多數的中小企業網站與電商，Cloudflare 的免費方案就已經非常夠用。

### 步驟 1：註冊 Cloudflare 並新增你的網站

首先，我們需要建立一個 Cloudflare 帳號並將我們的網域加入其中。

1.  前往 [Cloudflare 官方網站](https://www.cloudflare.com/)，點擊右上角的「Sign Up」註冊一個新帳號。
2.  登入後，點擊「+ Add a site」按鈕。
    `[SCREENSHOT]`
3.  在輸入框中，輸入你的網站**根網域名稱** (例如 `yourdomain.com`)，然後點擊「Add site」。
4.  接著，Cloudflare 會請你選擇方案。請直接選擇最下方的 **Free (免費)** 方案，然後點擊「Continue」。
    `[SCREENSHOT]`
5.  Cloudflare 會自動掃描你網域目前的 DNS 紀錄。掃描完成後，直接點擊「Continue」即可。如果你的 DNS 紀錄很複雜，請確認重要紀錄（例如 `A` 紀錄和 `MX` 紀錄）都有被正確掃描進來。

### 步驟 2：變更網域的名稱伺服器 (Name Server)

這是整個設定流程中**最關鍵的一步**。我們必須告訴全球的網域名稱系統，以後要透過 Cloudflare 來解析我們的網站。

1.  在上一步驟完成後，Cloudflare 會提供給你**兩組新的名稱伺服器 (Name Servers)**。它們通常看起來像 `xxxx.ns.cloudflare.com`。請將這兩組伺服器位址複製下來。
    `[SCREENSHOT]`

2.  登入你當初購買網域的**網域註冊商**後台（例如：GoDaddy, Namecheap, Google Domains, PChome, 網路中文...等）。

3.  在網域註冊商的後台，找到管理你網域的 DNS 設定區域，尋找「**名稱伺服器**」或「**Name Servers (NS)**」的管理選項。

4.  將原本的名稱伺服器，**替換**成剛剛從 Cloudflare 複製的那兩組新的位址。通常會有主要 (Primary) 和次要 (Secondary) 兩個欄位，請一一對應貼上。

5.  儲存設定。

> **Moksa 技巧：**
> 名稱伺服器的變更**不是立即生效**的。這個變更需要時間在全球的 DNS 系統中「**傳播 (Propagation)**」。通常在 30 分鐘內會完成，但最長可能需要 24-48 小時。
> 你可以在 Cloudflare 儀表板點擊「Done, check nameservers」按鈕，Cloudflare 會定期檢查是否生效。當你收到來自 Cloudflare 的確認 Email，或是在儀表板上看到綠色打勾的成功訊息時，就代表設定完成了！

`[SCREENSHOT]`

### 步驟 3：Cloudflare 核心設定 (WordPress 最佳化)

當名稱伺服器成功指向 Cloudflare 後，我們需要進行一些關鍵設定，確保它能與我們的 WordPress 網站完美協作。

#### 一、SSL/TLS 加密模式

這個設定決定了訪客 > Cloudflare > 你的主機之間的連線加密方式。

1.  在 Cloudflare 儀表板左側選單，點選「**SSL/TLS**」 > 「**Overview**」。
2.  在右側選擇你的 SSL/TLS 加密模式。
3.  **Moksa 技巧：** 請務必選擇「**Full (Strict) / 完整 (嚴格)**」。
    *   `Flexible`：不安全，僅加密訪客到 Cloudflare 的連線。
    *   `Full`：加密全程連線，但不驗證你主機上的 SSL 憑證是否有效。
    *   **`Full (Strict)`**：最安全的選項。它會加密全程連線，**並且**會驗證你主機上的 SSL 憑證是有效且受信任的（現今大部分優質主機商都提供免費的 Let's Encrypt 憑證，所以這個是最佳選擇）。
    `[SCREENSHOT]`

4.  接著切換到「**Edge Certificates**」分頁。
5.  確認「**Always Use HTTPS**」這個選項是**開啟 (On)** 的。這會將所有 `http://` 的請求強制轉址到 `https://`，確保網站全程加密。

#### 二、速度 (Speed) > 最佳化 (Optimization)

1.  在左側選單點選「**Speed**」 > 「**Optimization**」。
2.  找到「**Auto Minify**」區塊。
    *   **Moksa 技巧：** 僅勾選 **JavaScript** 和 **CSS**。**不要**勾選 HTML。因為我們的快取外掛 **WP Rocket** 會更有效率地處理 HTML 的壓縮，同時勾選可能會導致衝突或頁面破版。
    `[SCREENSHOT]`
3.  往下捲動，找到「**Brotli**」，將它**開啟 (On)**。Brotli 是比 Gzip 更現代、壓縮率更高的演算法，能讓你的網站檔案變得更小。
4.  找到「**Early Hints**」，將它**開啟 (On)**。這是一個較新的 Web 標準，可以讓瀏覽器在收到主要 HTML 文件前就開始預先載入資源，進一步提升感知載入速度。

#### 三、頁面規則 (Page Rules) - 進階必學技巧

頁面規則是 Cloudflare 的強大功能，允許我們針對特定的 URL 路徑套用不同的設定。對於 WordPress 網站，設定好頁面規則可以避免很多問題，並達到最佳效能。免費方案提供 3 條規則，對我們來說剛剛好。

1.  在左側選單點選「**Rules**」 > 「**Page Rules**」。
2.  點擊「Create Page Rule」。

**【規則 1：保護 WordPress 後台】**

*   **If the URL matches:** `*yourdomain.com/wp-admin/*` (請將 `yourdomain.com` 換成你自己的網域)
*   **Then the settings are:**
    *   `Security Level` -> **High**
    *   `Cache Level` -> **Bypass** (後台內容不應被快取)
    *   `Disable Apps`
    *   `Disable Performance`
*   **目的：** 增強後台安全性，並確保後台功能不會因為快取或效能優化而出錯。
    `[SCREENSHOT]`

**【規則 2：保護登入頁面】** (重複上述步驟新增第二條)

*   **If the URL matches:** `*yourdomain.com/wp-login.php*`
*   **Then the settings are:** (同規則 1)
    *   `Security Level` -> **High**
    *   `Cache Level` -> **Bypass**
    *   `Disable Apps`
    *   `Disable Performance`

**【規則 3：強制快取所有前台內容 (進階)】** (這條規則順序必須在最後)

*   **If the URL matches:** `*yourdomain.com/*`
*   **Then the settings are:**
    *   `Cache Level` -> **Cache Everything**
*   **目的：** 這是一個非常強大的效能優化技巧。它會告訴 Cloudflare 不僅快取靜態檔案，連 HTML 頁面本身也進行快取。這會讓訪客再次訪問相同頁面時速度極快，因為頁面是直接從 Cloudflare 的節點提供，完全沒有請求到你的主機。
*   **注意：** 使用此規則後，當你在網站上更新內容時，**必須**手動到 Cloudflare 清除快取，訪客才能看到最新的內容。不過別擔心，下一步我們會將它與 WP Rocket 整合，實現自動化。

### 步驟 4：整合 Cloudflare 與 WP Rocket

我們的技術棧使用 **WP Rocket** 作為伺服器端的頁面快取外掛。WP Rocket 與 Cloudflare 不是競爭關係，而是**最佳拍檔**。WP Rocket 負責在你的伺服器上生成快取頁面，而 Cloudflare 負責將這些頁面內容分發到全球。

將它們整合後，最大的好處是：當你在 WordPress 後台清除 WP Rocket 快取時，它會**自動同步清除 Cloudflare 上的快取**，省去你兩邊操作的麻煩。

1.  回到你的 WordPress 後台，進入「**設定**」 > 「**WP Rocket**」。
2.  切換到「**附加功能 (Add-Ons)**」分頁。
3.  找到 **Cloudflare** 附加功能，將它的狀態切換為「**ON**」。
    `[SCREENSHOT]`
4.  點擊下方的「**修改選項 (Modify Options)**」按鈕。
5.  現在你需要填寫三項資訊，這些資訊都可以在 Cloudflare 儀表板找到：
    *   **Global API Key (通用 API 金鑰):** 在 Cloudflare 儀表板，點擊右上角你的頭像 > 「My Profile」 > 左側選單「API Tokens」 > 在「Global API Key」處點擊「View」來取得。
    *   **Account e-mail (帳號電子郵件):** 就是你註冊 Cloudflare 的 Email。
    *   **Zone ID (區域 ID):** 在 Cloudflare 儀表板管理你網域的「Overview」頁面，右下角就可以找到。
    `[SCREENSHOT]`
6.  將這三項資訊填入 WP Rocket 的對應欄位後，開啟「**最佳化設定**」選項，最後點擊「**儲存變更**」。

`[SCREENSHOT]`

恭喜你！現在你的 WordPress 網站已經成功與 Cloudflare 整合。WP Rocket 會自動套用最適合的設定，並且你只需要在 WordPress 後台就能同時管理兩邊的快取。

### 結論

設定 Cloudflare 是現代網站經營的標準作業流程。它不僅能免費地為你的網站帶來全球性的速度提升，還增加了一層重要的安全防護。透過本章節的學習，你已經掌握了如何為 WordPress/WooCommerce 網站設定 Cloudflare，並透過頁面規則進行了專業級的優化，更重要的是，你學會了如何讓它與我們推薦的快取外掛 WP Rocket 天衣無縫地協同工作。

這項設定將為你的使用者帶來更流暢的瀏覽體驗，同時也為主機分擔了大量的工作，是所有網站主都應該學習的必備技能。